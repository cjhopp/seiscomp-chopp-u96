!function(r){"use strict";var i=r||{},e=navigator.userAgent;i.ISFF=-1!=e.indexOf("Firefox"),i.ISOPERA=-1!=e.indexOf("Opera"),i.ISCHROME=-1!=e.indexOf("Chrome"),i.ISSAFARI=-1!=e.indexOf("Safari")&&!i.ISCHROME,i.ISWEBKIT=-1!=e.indexOf("WebKit"),i.ISIE=0<e.indexOf("Trident")||0<navigator.userAgent.indexOf("MSIE"),i.ISIE6=0<e.indexOf("MSIE 6"),i.ISIE7=0<e.indexOf("MSIE 7"),i.ISIE8=0<e.indexOf("MSIE 8"),i.ISIE9=0<e.indexOf("MSIE 9"),i.ISIE10=0<e.indexOf("MSIE 10"),i.ISOLD=i.ISIE6||i.ISIE7||i.ISIE8,i.ISIE11UP=-1==e.indexOf("MSIE")&&0<e.indexOf("Trident"),i.ISIE10UP=i.ISIE10||i.ISIE11UP,i.ISIE9UP=i.ISIE9||i.ISIE10UP,r.module("browsercheck",[]).directive("browserCheck",function(){return{restrict:"E",template:'<div class="alert" ng-if="warn"><span ng-click="close()" class="close"><i class="icon glyphicon glyphicon-remove"></i></span><div class="symbol"><i class="icon glyphicon glyphicon-warning-sign"></i></div><div class="text"><strong>Your browser is not supported officially!</strong><br/>You can use it at your own risk but be aware that visual distortions or even browser crashes or freezes may occur. We recommend to use Firefox or Chromium.</div></div>',scope:{},link:function(i,e,n){i.warn=!r.ISFF&&!r.ISCHROME,i.close=function(){i.warn=!1}}}})}((window,window.angular));
!function(){"use strict";angular.module("gm.date",[]).factory("gmDate",function(){var e=!1;return{toLocalString:function(t,n){return new Date(t).strftime(n)},toUTCString:function(t,n){return new Date(t).strftime(n,!0)},toString:function(t,n,e){return new Date(t).strftime(n,e)},toDefaultString:function(t,n){return new Date(t).strftime(n,e)},setDefaultToLocal:function(){e=!1},setDefaultToUTC:function(){e=!0}}}).filter("gmdate",["gmDate",function(e){return function(t,n){return e.toDefaultString(t,n)}}])}();
!function(o){function t(e){var t=e||window.event,i=[].slice.call(arguments,1),a=0,n=0,r=0;return(e=o.event.fix(t)).type="mousewheel",t.wheelDelta&&(a=t.wheelDelta/120),r=a=t.detail?-t.detail/3:a,void 0!==t.axis&&t.axis===t.HORIZONTAL_AXIS&&(r=0,n=-1*a),void 0!==t.wheelDeltaY&&(r=t.wheelDeltaY/120),void 0!==t.wheelDeltaX&&(n=-1*t.wheelDeltaX/120),i.unshift(e,a,n,r),(o.event.dispatch||o.event.handle).apply(this,i)}var i=["DOMMouseScroll","mousewheel"];if(o.event.fixHooks)for(var e=i.length;e;)o.event.fixHooks[i[--e]]=o.event.mouseHooks;o.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var e=i.length;e;)this.addEventListener(i[--e],t,!1);else this.onmousewheel=t},teardown:function(){if(this.removeEventListener)for(var e=i.length;e;)this.removeEventListener(i[--e],t,!1);else this.onmousewheel=null}},o.fn.extend({mousewheel:function(e){return e?this.bind("mousewheel",e):this.trigger("mousewheel")},unmousewheel:function(e){return this.unbind("mousewheel",e)}})}(jQuery),function(m){m.fn.drag=function(e,t,i){var a="string"==typeof e?e:"",n=m.isFunction(e)?e:m.isFunction(t)?t:null;return 0!==a.indexOf("drag")&&(a="drag"+a),i=(e==n?t:i)||{},n?this.bind(a,i,n):this.trigger(a)};var u=m.event,a=u.special,h=a.drag={defaults:{which:1,distance:0,not:":input",handle:null,relative:!1,drop:!0,click:!1},datakey:"dragdata",noBubble:!0,add:function(e){var i=m.data(this,h.datakey),a=e.data||{};i.related+=1,m.each(h.defaults,function(e,t){void 0!==a[e]&&(i[e]=a[e])})},remove:function(){--m.data(this,h.datakey).related},setup:function(){var e;m.data(this,h.datakey)||(e=m.extend({related:0},h.defaults),m.data(this,h.datakey,e),u.add(this,"touchstart mousedown",h.init,e),this.attachEvent&&this.attachEvent("ondragstart",h.dontstart))},teardown:function(){(m.data(this,h.datakey)||{}).related||(m.removeData(this,h.datakey),u.remove(this,"touchstart mousedown",h.init),h.textselect(!0),this.detachEvent&&this.detachEvent("ondragstart",h.dontstart))},init:function(e){if(!h.touched){var t,i=e.data;if(!(0!=e.which&&0<i.which&&e.which!=i.which)&&!m(e.target).is(i.not)&&(!i.handle||m(e.target).closest(i.handle,e.currentTarget).length)&&(h.touched="touchstart"==e.type?this:null,i.propagates=1,i.mousedown=this,i.interactions=[h.interaction(this,i)],i.target=e.target,i.pageX=e.pageX,i.pageY=e.pageY,i.dragging=null,t=h.hijack(e,"draginit",i),i.propagates))return(t=h.flatten(t))&&t.length&&(i.interactions=[],m.each(t,function(){i.interactions.push(h.interaction(this,i))})),i.propagates=i.interactions.length,!1!==i.drop&&a.drop&&a.drop.handler(e,i),h.textselect(!1),h.touched?u.add(h.touched,"touchmove touchend",h.handler,i):u.add(document,"mousemove mouseup",h.handler,i),!(!h.touched||i.live)&&void 0}},interaction:function(e,t){t=m(e)[t.relative?"position":"offset"]()||{top:0,left:0};return{drag:e,callback:new h.callback,droppable:[],offset:t}},handler:function(e){var t=e.data;switch(e.type){case!t.dragging&&"touchmove":e.preventDefault();case!t.dragging&&"mousemove":if(Math.pow(e.pageX-t.pageX,2)+Math.pow(e.pageY-t.pageY,2)<Math.pow(t.distance,2))break;e.target=t.target,h.hijack(e,"dragstart",t),t.propagates&&(t.dragging=!0);case"touchmove":e.preventDefault();case"mousemove":if(t.dragging){if(h.hijack(e,"drag",t),t.propagates){!1!==t.drop&&a.drop&&a.drop.handler(e,t);break}e.type="mouseup"}default:h.touched?u.remove(h.touched,"touchmove touchend",h.handler):u.remove(document,"mousemove mouseup",h.handler),t.dragging&&(!1!==t.drop&&a.drop&&a.drop.handler(e,t),h.hijack(e,"dragend",t)),h.textselect(!0),!1===t.click&&t.dragging&&m.data(t.mousedown,"suppress.click",(new Date).getTime()+5),t.dragging=h.touched=!1}},hijack:function(i,a,n,e,t){if(n){var r,o,s,l={event:i.originalEvent,type:i.type},d=a.indexOf("drop")?"drag":"drop",x=e||0,c=isNaN(e)?n.interactions.length:e;i.type=a,i.originalEvent=null,n.results=[];do{if(o=n.interactions[x]){if("dragend"!==a&&o.cancelled)continue;s=h.properties(i,n,o),o.results=[],m(t||o[d]||n.droppable).each(function(e,t){if(s.target=t,!(i.isPropagationStopped=function(){return!1})===(r=t?u.dispatch.call(t,i,s):null)?("drag"==d&&(o.cancelled=!0,--n.propagates),"drop"==a&&(o[d][e]=null)):"dropinit"==a&&o.droppable.push(h.element(r)||t),"dragstart"==a&&(o.proxy=m(h.element(r)||o.drag)[0]),o.results.push(r),delete i.result,"dropinit"!==a)return r}),n.results[x]=h.flatten(o.results),"dropinit"==a&&(o.droppable=h.flatten(o.droppable)),"dragstart"!=a||o.cancelled||s.update()}}while(++x<c);return i.type=l.type,i.originalEvent=l.event,h.flatten(n.results)}},properties:function(e,t,i){var a=i.callback;return a.drag=i.drag,a.proxy=i.proxy||i.drag,a.startX=t.pageX,a.startY=t.pageY,a.deltaX=e.pageX-t.pageX,a.deltaY=e.pageY-t.pageY,a.originalX=i.offset.left,a.originalY=i.offset.top,a.offsetX=a.originalX+a.deltaX,a.offsetY=a.originalY+a.deltaY,a.drop=h.flatten((i.drop||[]).slice()),a.available=h.flatten((i.droppable||[]).slice()),a},element:function(e){if(e&&(e.jquery||1==e.nodeType))return e},flatten:function(e){return m.map(e,function(e){return e&&e.jquery?m.makeArray(e):e&&e.length?h.flatten(e):e})},textselect:function(e){m(document)[e?"unbind":"bind"]("selectstart",h.dontstart).css("MozUserSelect",e?"":"none"),document.unselectable=e?"off":"on"},dontstart:function(){return!1},callback:function(){}};h.callback.prototype={update:function(){a.drop&&this.available.length&&m.each(this.available,function(e){a.drop.locate(this,e)})}};var t=u.dispatch;u.dispatch=function(e){if(!(0<m.data(this,"suppress."+e.type)-(new Date).getTime()))return t.apply(this,arguments);m.removeData(this,"suppress."+e.type)};var n=u.fixHooks.touchstart=u.fixHooks.touchmove=u.fixHooks.touchend=u.fixHooks.touchcancel={props:"clientX clientY pageX pageY screenX screenY".split(" "),filter:function(i,e){var a;return!e||(a=e.touches&&e.touches[0]||e.changedTouches&&e.changedTouches[0]||null)&&m.each(n.props,function(e,t){i[t]=a[t]}),i}};a.draginit=a.dragstart=a.dragend=h}(jQuery),angular.module("timeseries",["gm.date"]).directive("timeseries",["$compile","$rootScope","gmDate",function(s,A,N){return{restrict:"A",scope:{data:"=",markers:"=",options:"=",status:"=",api:"="},link:function(y,b,e){var t=s('<canvas style="display:block"></canvas>')(y);b.append(t);function M(e,t,i,a,n){var r=t/((n*=.001)-(a*=.001));if(!(r<=0)){var o,s=l.length;for(P.drx=[l[s-1].major,l[s-1].minor],P.primaryTimeFormat=l[s-1][2],P.secondaryTimeFormat=l[s-1][3],P.relativeTimeFormat=l[s-1][4],P.fontHeight=(i-8)/2,12<P.fontHeight?P.fontHeight=12:P.fontHeight<8&&(P.fontHeight=8),P.longTick=i-8-2*P.fontHeight,P.longTick<0&&(P.longTick=0),P.shortTick=.5*P.longTick,e.font=P.fontHeight+"px Sans-Serif",P.minLabelWidth=e.measureText("  XXXX-XX-XX.X  ").width,o=0;o<s;++o)if(l[o][0]*r>=P.minLabelWidth){P.drx[0]=l[o][0],P.drx[1]=l[o][1],P.primaryTimeFormat=l[o][2],P.secondaryTimeFormat=l[o][3],P.relativeTimeFormat=l[o][4];break}if(o===s&&0<r)for(P.drx[0]=l[s-1][0],P.drx[1]=l[s-1][1],P.primaryTimeFormat=l[s-1][2],P.secondaryTimeFormat=l[s-1][3],P.relativeTimeFormat=l[s-1][4];P.drx[0]*r<P.minLabelWidth;)P.drx[0]*=2,P.drx[1]*=2}}function S(e,t,i,a,n,r,o,s,l,d,x){var c=a/((o*=.001)-(r*=.001));if(!(c<=0)){d<x&&(x=(.001*x-r)*c,(d=(.001*d-r)*c)<a&&0<x&&(e.fillStyle="rgba(0,0,0,0.2)",e.fillRect(t+d,i+n-20,x-d,20)));for(var m=r+0,u=m-m%P.drx[0],h=Math.floor((u-m)*c);h<a;)0<=h&&(e.beginPath(),e.moveTo(t+h+.5,i+.5),e.lineTo(t+h+.5,i+n+.5),e.stroke()),u+=P.drx[0],h=Math.floor((u-m)*c)}}function Y(t,e,i,a,n,r,o,s,l,d){if(!(n<=0)){var x=a/((o*=.001)-(r*=.001));if(!(x<=0)){t.beginPath(),t.moveTo(e+.5,i+.5),t.lineTo(e+a+.5,i+.5),t.stroke(),t.textBaseline="top",t.textAlign="center";for(var c=r+0,m=i+P.longTick+4+.5,u=i+P.longTick+4+P.fontHeight+2-1+.5,h="",f=0;f<2;++f)if(!(P.drx[f]<=0))for(var p,g,v,T=c-c%P.drx[f],k=0===f?P.longTick:P.shortTick,w=Math.floor((T-c)*x);w<a;)0<=w&&(t.beginPath(),t.moveTo(e+w+.5,i+.5),t.lineTo(e+w+.5,i+k+.5),t.stroke(),0===f&&(d?(g=parseFloat((1e-6*Math.floor(Math.round(1e6*T))).toFixed(3)),e<=w-(v=.5*t.measureText(g).width)&&w+v<=a&&t.fillText(g,e+w+.5,m)):(p=1e3*T,g=void 0!==l.xaxis.ruler.useUTC?N.toString(p,P.primaryTimeFormat,l.xaxis.ruler.useUTC):N.toDefaultString(p,P.primaryTimeFormat),e<=w-(v=.5*t.measureText(g).width)&&w+v<=a&&t.fillText(g,e+w+.5,m),P.secondaryTimeFormat&&w-.5*P.minLabelWidth>=e&&w+.5*P.minLabelWidth<=a&&((p=void 0!==l.xaxis.ruler.useUTC?N.toString(p,P.secondaryTimeFormat,l.xaxis.ruler.useUTC):N.toDefaultString(p,P.secondaryTimeFormat))!==h&&(t.fillText(p,e+w+.5,u),h=p))))),T+=P.drx[f],w=Math.floor((T-c)*x);if(s){t.save(),t.font="bold "+P.fontHeight+"px Sans-Serif";for(var y=s?s.length:0,b=0;b<y;++b){var M=s[b];w=C(.001*(M.x-d),r,o,a);var S=2;try{t.strokeStyle=l.marker[M.type].color}catch(e){t.strokeStyle="#f00"}try{S=l.marker[M.type].lineWidth}catch(e){}t.lineWidth=S,t.fillText(M.annotation,e+w-.5,u)}t.restore()}}}}var D=t[0],H=0,X=[],R={xaxis:{min:null,max:null},yaxis:{min:null,max:null},trace:{sampleCount:null,fromRecord:null,toRecord:null,offset:null}},a="default",L=null,F=null,E=null,l=[[.001,2e-4,"%S.%3","%Y-%m-%d %H:%M",""],[.005,.001,"%S.%3","%Y-%m-%d %H:%M",""],[.01,.002,"%S.%2","%Y-%m-%d %H:%M",""],[.05,.01,"%S.%2","%Y-%m-%d %H:%M",""],[.1,.02,"%T.%1","%Y-%m-%d",""],[.5,.1,"%T.%1","%Y-%m-%d",""],[1,.2,"%T","%Y-%m-%d",""],[2,.5,"%T","%Y-%m-%d",""],[5,1,"%T","%Y-%m-%d",""],[10,2,"%T","%Y-%m-%d",""],[15,3,"%T","%Y-%m-%d",""],[30,5,"%T","%Y-%m-%d",""],[60,10,"%T","%Y-%m-%d",""],[120,20,"%T","%Y-%m-%d",""],[300,60,"%T","%Y-%m-%d",""],[600,120,"%T","%Y-%m-%d",""],[900,300,"%T","%Y-%m-%d",""],[1800,300,"%T","%Y-%m-%d",""],[3600,600,"%T","%Y-%m-%d",""],[7200,1200,"%T","%Y-%m-%d",""],[21600,3600,"%T","%Y-%m-%d",""],[43200,7200,"%T","%Y-%m-%d",""],[86400,21600,"%b, %d","%Y",""],[172800,43200,"%b, %d","%Y",""],[604800,86400,"%b, %d","%Y",""],[1209600,172800,"%b, %d","%Y",""]],P={fontHeight:0,longTick:0,shortTick:0,drx:[0,0],primaryTimeFormat:"",secondaryTimeFormat:"",relativeTimeFormat:"",minLabelWidth:0},W={update:function(){x()},setCursor:function(e){e!==L&&(e?(L=e,b.css("cursor","crosshair")):(L=null,b.css("cursor","pointer")),x())},currentMarker:null},C=function(e,t,i,a){return Math.floor((e-t)*a/(i-t))},z=0,x=function(){var t=D.getContext("2d");t.clearRect(0,0,D.width,D.height);var e={interactive:!0,showAllData:!0,xaxis:{color:"black",ruler:{enable:!0,height:36,drawMarker:!1},referenceTime:null},yaxis:{autoScale:!1},grid:{color:"lightGray",show:!0,relative:!1}};$.extend(!0,e,y.options),e.interactive||(null!==e.xaxis.min?(R.xaxis.min=e.xaxis.min,null!==e.xaxis.max?R.xaxis.max=e.xaxis.max:R.xaxis.max=e.xaxis.min+6e5):null!==e.xaxis.max&&(R.xaxis.max=e.xaxis.max,null!==e.xaxis.min?R.xaxis.min=e.xaxis.min:R.xaxis.min=e.xaxis.max-6e5)),null!==R.xaxis.max&&null!==R.xaxis.min&&R.xaxis.max-R.xaxis.min<100&&(p=.5*(R.xaxis.min+R.xaxis.max),R.xaxis.min=p-50,R.xaxis.max=50+p),D.width!==b.width()&&(D.width=b.width()),D.height!==b.height()&&(D.height=b.height());var i=e.xaxis.ruler.height;e.xaxis.ruler.enable||(i=0),z=0,e.xaxis.referenceTime&&e.grid.relative&&(z=e.xaxis.referenceTime);var a=(e.xaxis.smin||0)-z,n=(e.xaxis.smax||0)-z;if(X.length=0,y.data){var r=y.data.length;H=D.height-i;for(var o=0,s=0;s<r;++s)(e.showAllData||y.data[s].active)&&++o;var l=H/o,d=0;t.save();var x,c,m,u,h,f,p,g=0;for(s=0;s<r;++s)e.showAllData||y.data[s].active?(X[s]=[d,d+l],h=y.data[s].records?function(e,t,i){var a={timeMin:null,timeMax:null,amplMin:null,amplMax:null,samples:0,firstRecord:-1,lastRecord:-1,offset:0};if(!e)return a;for(var n=0,r=0;r<e.length;++r){var o=e[r];if(0!==o.samples.length&&!(t&&o.endTime<=t)){if(i&&o.startTime>=i)break;var s=t?.001*(t-o.startTime):0,l=i?.001*(o.endTime-i):0,d=0,x=o.samples.length;if(0<s){if(x<=(d=Math.floor(s*o.srNum/o.srDen)))continue;x-=d}if(!(0<l&&(x-=Math.floor(l*o.srNum/o.srDen))<=0)){a.firstRecord<0&&(a.firstRecord=r),a.lastRecord=r,(null===a.timeMin||a.timeMin>o.startTime)&&(a.timeMin=o.startTime),(null===a.timeMax||a.timeMax<o.endTime)&&(a.timeMax=o.endTime),null===a.amplMin&&(a.amplMin=o.samples[d]),null===a.amplMax&&(a.amplMax=o.samples[d]);for(var c=d,m=0;m<x;++m,++c)o.samples[c]<a.amplMin&&(a.amplMin=o.samples[c]),o.samples[c]>a.amplMax&&(a.amplMax=o.samples[c]),n+=o.samples[c];a.samples+=x}}}return 0<a.samples&&(a.offset=n/a.samples),a}(y.data[s].records,e.yaxis.autoScale?R.xaxis.min+(z||0):null,e.yaxis.autoScale?R.xaxis.max+(z||0):null):{samples:0,offset:0,firstRecord:-1,lastRecord:-1,timeMin:R.xaxis.min,timeMax:R.xaxis.max,amplMin:-1,amplMax:1},g||(R.trace.sampleCount=h.samples,R.trace.fromRecord=h.firstRecord,R.trace.toRecord=h.lastRecord,R.trace.offset=h.offset),null===R.xaxis.min&&(R.xaxis.min=h.timeMin),null===R.xaxis.max&&(R.xaxis.max=h.timeMax),(null===R.yaxis.min||e.yaxis.autoScale&&h.amplMin)&&(R.yaxis.min=h.amplMin),(null===R.yaxis.max||e.yaxis.autoScale&&h.amplMax)&&(R.yaxis.max=h.amplMax),null!==R.xaxis.min&&null!==R.xaxis.max&&(x=R.yaxis.min,c=R.yaxis.max,m=1e3*+D.width/(R.xaxis.max-R.xaxis.min),0===g&&(M(t,D.width,i,R.xaxis.min,R.xaxis.max),e.grid.show&&(t.strokeStyle=e.grid.color,S(t,0,0,+D.width,D.height-i,R.xaxis.min,R.xaxis.max,0,0,a,n)),e.xaxis.referenceTime&&(u=C(e.xaxis.referenceTime-z,R.xaxis.min,R.xaxis.max,+D.width)+0+.5,t.strokeStyle="red",t.beginPath(),t.moveTo(u,0),t.lineTo(u,H),t.stroke())),f=h.offset,h=Math.floor(l-(f-x)*l/(c-x)),f={color:"#eee",offsetColor:"lightBlue",lineWidth:1,optimize:!0},$.extend(!0,f,y.data[s].options),0<=h&&h<l&&(t.strokeStyle=f.offsetColor,t.beginPath(),t.moveTo(0,d+h+.5),t.lineTo(+D.width,d+h+.5),t.stroke()),t.strokeStyle=f.color,t.lineWidth=f.lineWidth,function(e,t,i,a,n,r,o,s,l,d,x,c){if(null!==t&&0!==t.length){var n=r-n,m=0==n?0:(d-1)/n;c&&(i+=c,a+=c);for(var u=null,h=!1,f=100,p=f,g=t.length,v=0;v<g;++v){var T=t[v];if(0!==T.samples.length&&!(i&&T.endTime<=i)){if(a&&T.startTime>=a)break;u&&.001*Math.abs(T.startTime-u.endTime)*T.srNum>T.srDen&&h&&(e.stroke(),h=!1);var k=.001*(i?i-T.startTime:t[0].startTime-T.startTime),w=.001*(a?T.endTime-a:0),y=0,b=T.samples.length;if(0<k){if(b<=(y=Math.floor(k*T.srNum/T.srDen)))continue;b-=y,k-=y*T.srDen/T.srNum}if(!(0<w&&(b-=Math.floor(w*T.srNum/T.srDen))<=0)){var M,k=Math.floor(o*k),S=o*T.srDen/T.srNum,$=s-k,Y=Math.floor(m*(r-T.samples[y]))+.5+l,D=Y,H=Y,X=$,R=Y,u=T;h?e.lineTo($,Y):(e.beginPath(),e.moveTo($,Y),h=!0);var L=S+s-k,F=y+1;if(x){for(M=1;M<b;++M,L+=S,++F){var E=Math.floor(L)+.5,P=Math.floor(m*(r-T.samples[F]))+.5+l;P!==R?(X!==$&&(X=$,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R))),X!==E?(D!==R&&(R=D,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R))),H!==R&&(R=H,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R))),Y!==R&&(R=Y,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R))),X=E,P!==R&&(e.lineTo(X,R=P),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R))),D=H=R):P<D?D=P:H<P&&(H=P)):(D!==R&&(R=D,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R)),D=R),H!==R&&(R=H,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R)),H=R),Y!==R&&(R=D=H=Y,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R)))),$=E,Y=P}X!==$&&e.lineTo($,Y)}else for(M=1;M<b;++M)X=L,R=m*(r-T.samples[F])+l,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R)),L+=S,++F}}}h&&e.stroke()}}(t,y.data[s].records,R.xaxis.min,R.xaxis.max,x,c,m,0,d,l,f.optimize,z),d+=l,++g)):X[s]=null;if(y.markers){t.textBaseline="top",t.textAlign="left",t.font="12px sans-serif";for(var v=y.markers?y.markers.length:0,T=0;T<v;++T){var k=y.markers[T],w=2;try{t.strokeStyle=e.marker[k.type].color}catch(e){t.strokeStyle="#f00"}try{if(!(w=e.marker[k.type].lineWidth))continue}catch(e){}t.lineWidth=w,u=C(k.x-z,R.xaxis.min,R.xaxis.max,+D.width)+0-.5*w,k===W.currentMarker&&(t.fillStyle="rgba(0,0,0,0.2)",t.fillRect(u-3,0,6,D.height-i)),t.beginPath(),t.moveTo(u,0),t.lineTo(u,D.height-i),t.stroke(),k.annotation&&(w=k.align||0,t.fillStyle=t.strokeStyle,w?1===w?t.fillText(k.annotation,u+2,.5*(D.height-i-12)):2===w&&t.fillText(k.annotation,u+2,D.height-i-12-2):t.fillText(k.annotation,u+2,0))}}F&&L&&(t.strokeStyle="#000",t.fillStyle=t.strokeStyle,t.lineWidth=1,u=C(F,R.xaxis.min,R.xaxis.max,+D.width)+0+.5,t.beginPath(),t.moveTo(u,0),t.lineTo(u,D.height-i),t.stroke(),t.fillText(L,u+2,0),p=void 0!==e.xaxis.ruler.useUTC?N.toString(F,"%H:%M:%S.%3",e.xaxis.ruler.useUTC):N.toDefaultString(F,"%H:%M:%S.%3"),null!=E&&y.data[E].id&&(p+=" #"+y.data[E].id),t.fillStyle="#fff",t.rect(u,D.height-i-14,t.measureText(p).width+4,14),t.stroke(),t.fill(),t.fillStyle="#000",t.fillText(p,u+2,D.height-i-12-2)),t.restore(),t.strokeStyle=e.xaxis.color,t.fillStyle=e.xaxis.color,Y(t,0,D.height-i,+D.width,i,R.xaxis.min,R.xaxis.max,e.xaxis.ruler.drawMarker?y.markers:null,e,z)}else null!==R.xaxis.min&&null!==R.xaxis.max&&(H=0,M(t,D.width,i,R.xaxis.min,R.xaxis.max),e.grid.show&&(t.strokeStyle=e.grid.color,S(t,0,0,+D.width,D.height-i,R.xaxis.min,R.xaxis.max,0,0,a,n)),t.strokeStyle=e.xaxis.color,t.fillStyle=e.xaxis.color,Y(t,0,D.height-i,+D.width,i,R.xaxis.min,R.xaxis.max,e.xaxis.ruler.drawMarker?y.markers:null,e,z));y.status&&("$digest"===A.$$phase||"$apply"===A.$$phase?y.status=R:y.$apply(y.status=R))};try{null!==y.options.xaxis.min?(R.xaxis.min=y.options.xaxis.min,null!==y.options.xaxis.max?R.xaxis.max=y.options.xaxis.max:R.xaxis.max=y.options.xaxis.min+6e5):null!==y.options.xaxis.max&&(R.xaxis.max=y.options.xaxis.max,null!==y.options.xaxis.min?R.xaxis.min=y.options.xaxis.min:R.xaxis.min=y.options.xaxis.max-6e5)}catch(e){}e.complete&&y.$parent.$last&&y.$parent.$evalAsync(e.complete),e.deferUpdate||x(),window.addResizeListener?window.addResizeListener(b[0],x):y.$watch(function(){return b.innerWidth()+";"+b.innerHeight()},function(e,t){x()}),y.api&&(y.api.timeSeries=W);var i,n,t=!0;try{y.options.hasOwnProperty("interactive")&&(t=y.options.interactive)}catch(e){}t&&(W.evWheel=b.bind("mousewheel",function(e,t,i,a){if(e.preventDefault&&e.preventDefault(),R.xaxis.min&&R.xaxis.max){var n,e=(e.pageX-$(D).offset().left)/D.width,e=(R.xaxis.max-R.xaxis.min)*e+R.xaxis.min;if(0<t)n=.6;else{if(!(t<0))return;n=1.4}R.xaxis.min=(R.xaxis.min-e)*n+e,R.xaxis.max=(R.xaxis.max-e)*n+e,x()}}),W.evDragStart=b.bind("dragstart",function(e,t){var i=b.css("cursor");i&&(a=i),b.css("cursor","move")}),W.evDragEnd=b.bind("dragend",function(e,t){b.css("cursor",a)}),W.evDrag=b.bind("drag",function(e,t){var i;R.xaxis.min&&R.xaxis.max&&(i=void 0!==t.lastDeltaX?t.deltaX-t.lastDeltaX:t.deltaX,t.lastDeltaX=t.deltaX,i=i/D.width*(R.xaxis.max-R.xaxis.min),R.xaxis.min-=i,R.xaxis.max-=i,x())}),n=i=void 0,W.evTouchStart=b.bind("touchstart",function(e){e.preventDefault&&e.preventDefault();e=b.css("cursor");e&&(a=e),b.css("cursor","move")}),W.evTouchEnd=b.bind("touchend",function(e){b.css("cursor",a),n=i=void 0}),W.evTouchMove=b.bind("touchmove",function(e){var t;e.preventDefault&&e.preventDefault(),R.xaxis.min&&R.xaxis.max&&(!e.originalEvent.touches||e.originalEvent.touches.length<1||(i=i||[e.originalEvent.touches[0].pageX,e.originalEvent.touches[0].pageY],t=[e.originalEvent.touches[0].pageX,e.originalEvent.touches[0].pageY][0]-i[0],e=void 0!==n?t-n:t,n=t,e=e/D.width*(R.xaxis.max-R.xaxis.min),R.xaxis.min-=e,R.xaxis.max-=e,x()))}),y.api&&(W.evMove=b.bind("mousemove",function(e){if(R.xaxis.min&&R.xaxis.max){var t=R.xaxis.max-R.xaxis.min,i=e.pageY-$(D).offset().top;if(!(H<=i)){for(var a=e.pageX-$(D).offset().left,n=!1,r=!1,o=y.markers?y.markers.length:0,s=0;s<o;++s){var l=y.markers[s],d=l.x-R.xaxis.min;if(!(d<0||t<d)&&(d/=t,d*=D.width,Math.abs(d-a-1)<3&&(r=!0,l!==W.currentMarker))){W.currentMarker=l,n=!0;break}}if(!r&&W.currentMarker&&(n=!(W.currentMarker=null)),L){e=(e.pageX-$(D).offset().left)/D.width;if(F=t*e+R.xaxis.min,E=null,y.data)for(o=X.length,s=0;s<o;++s)if(X[s]&&i>=X[s][0]&&i<X[s][1]){E=s;break}n=!0}n&&x()}}}),W.evClick=b.bind("click",function(e){try{b[0].focus()}catch(e){}if(R.xaxis.min&&R.xaxis.max&&y.api.clicked){var t,i=(e.pageX-$(D).offset().left)/D.width,a=e.pageY-$(D).offset().top;if(!(H<=a)){if(y.data)for(var n=X.length,r=0;r<n;++r)if(X[r]&&a>=X[r][0]&&a<X[r][1]){t=r;break}i=(R.xaxis.max-R.xaxis.min)*i+R.xaxis.min;y.api.clicked(e,i,t,W.currentMarker)}}}),W.evDblClick=b.bind("dblclick",function(e){if(R.xaxis.min&&R.xaxis.max&&y.api.selected){var t,i=(e.pageX-$(D).offset().left)/D.width,a=e.pageY-$(D).offset().top;if(!(H<=a)){if(y.data)for(var n=X.length,r=0;r<n;++r)if(X[r]&&a>=X[r][0]&&a<X[r][1]){t=r;break}i=(R.xaxis.max-R.xaxis.min)*i+R.xaxis.min;y.api.selected(e,i,t,W.currentMarker)}}}))),e.plotreset&&setTimeout(function(){$("#"+e.plotreset).click(function(){R.xaxis.min=null,R.xaxis.max=null,x()})},10);function r(e,t){e!==t&&x()}var o=[];y.$watch("data",function(e,t){for(var i=o.length,a=0;a<i;++a)o[a]();if(o.length=0,y.data){for(i=y.data.length,a=0;a<i;++a)o.push(y.$watch("data["+a+"].records",r)),o.push(y.$watch("data["+a+"].records.length",r)),o.push(y.$watch("data["+a+"].options",r)),o.push(y.$watch("data["+a+"].active",r));x()}}),y.$watch("markers",r),y.$watch("markers.length",r),y.$watch("options",function(e,t){y.status&&y.options&&(null!==y.options.xaxis.min&&(y.status.xaxis.min=y.options.xaxis.min),null!==y.options.xaxis.max&&(y.status.xaxis.max=y.options.xaxis.max)),r(e,t)},!0),y.$on("updateLayout",function(){x()}),y.$on("$destroy",function(){y.data=null,y.api&&(y.api.timeSeries=null,y.api=null),window.removeResizeListener&&window.removeResizeListener(b[0],x),W.evWheel&&b.unbind("mousewheel"),W.evDragStart&&b.unbind("dragstart"),W.evDragEnd&&b.unbind("dragend"),W.evDrag&&b.unbind("drag"),W.evTouchStart&&b.unbind("touchstart"),W.evTouchEnd&&b.unbind("touchend"),W.evTouchMove&&b.unbind("touchmove"),W.evMove&&b.unbind("mousemove"),W.evClick&&b.unbind("click"),W.evDblClick&&b.unbind("dblclick")})}}}]).directive("autoHeight",function(){return{restrict:"A",link:function(s,l,d){function i(){d.minHeight&&(c=parseFloat(s.$eval(d.minHeight)))<10&&(c=10)}var x=-1,c=30;i();function a(e){var t=l.innerHeight();if(e||t!==x){x=t;var i=0,e=l.children(d.children);if(e.each(function(){"none"!==$(this).css("display")&&++i}),!(t<=0||0===i)){var a=t/i;try{a<c&&(a=c)}catch(e){}var n,r=0,o=0;e.each(function(e,t){r+=a;var i=(n=Math.floor(r))-o;$(t).height(i),o=n}),0<o&&d.layoutComplete&&s.$evalAsync(d.layoutComplete)}}}d.rows&&s.$watch(d.rows,function(e,t){a(!0)}),d.minHeight&&s.$watch(d.minHeight,function(e,t){i(),a(!0)}),window.addResizeListener?window.addResizeListener(l[0],a):s.$watch(function(){return 1e6*l.innerWidth()+l.innerHeight()},function(e,t){a()}),s.$on("updateLayout",function(){a(!0)}),s.$on("$destroy",function(){window.removeResizeListener&&window.removeResizeListener(l[0],a)}),a()}}}).directive("autoHeightNoScope",function(){return{restrict:"A",link:function(e,s,i){function a(){i.minHeight&&(d=parseFloat(e.$eval(i.minHeight)))<10&&(d=10)}var l=-1,d=30;a();function n(e){var t=s.innerHeight();if(e||t!==l){l=t;e=s.children(i.children).size();if(!(t<=0||0===e)){var a=t/e;try{a<d&&(a=d)}catch(e){}var n,r=0,o=0;s.children(i.children).each(function(e,t){r+=a;var i=(n=Math.floor(r))-o;$(t).height(i),o=n})}}}i.rows&&e.$watch(i.rows,function(e,t){n(!0)}),i.minHeight&&e.$watch(i.minHeight,function(e,t){a(),n(!0)}),window.addResizeListener?window.addResizeListener(s[0],n):e.$watch(function(){return 1e6*s.innerWidth()+s.innerHeight()},function(e,t){n()}),i.hasOwnProperty("stretchY")&&e.$watch(function(){return s.parent().innerWidth()+";"+s.parent().innerHeight()},function(e,t){var i=s.parent().innerHeight()-s.position().top;i!==l&&s.height(i)}),e.$on("updateLayout",function(){n(!0)}),e.$on("$destroy",function(){window.removeResizeListener&&window.removeResizeListener(s[0],n)})}}});
"use strict";angular.module("quakelink",[]).factory("quakelink",["$http","$q",function(r,i){function p(e){var t,n=0,r=[1,4,5,6,7,10,11];if(t=/^(\d{4}|[+\-]\d{6})(?:-(\d{2})(?:-(\d{2}))?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(?:\.(\d+))?)?(?:(Z)|([+\-])(\d{2})(?::(\d{2}))?)?)?$/.exec(e)){for(var i,a=t[7].length,o=0;i=r[o];++o)t[i]=+t[i]||0;for(t[2]=(+t[2]||1)-1,t[3]=+t[3]||1,"Z"!==t[8]&&void 0!==t[9]&&(n=60*t[10]+t[11],"+"===t[9]&&(n=0-n)),o=a;o<3;++o)t[7]*=10;for(o=3;o<a;++o)t[7]/=10;return Date.UTC(t[1],t[2],t[3],t[4],t[5]+n,t[6],t[7])}return null}function a(e,t){if(window.ActiveXObject)(n=new ActiveXObject("Microsoft.XMLDOM")).async="false",n.loadXML(e);else{if(!document.implementation||!document.implementation.createDocument)return null;var n=(new DOMParser).parseFromString(e,"text/xml")}if(n.hasChildNodes())for(var r=0;r<n.childNodes.length;++r){var i=n.childNodes[r];if("seiscomp"===i.nodeName&&i.hasChildNodes())for(var a=0;a<i.childNodes.length;++a){var o=i.childNodes[a];if(o.nodeName===t)return o}}return null}function v(e,t){var n=[];if(!e.hasChildNodes())return n;for(var r=e.childNodes.length,i=0;i<r;++i)e.childNodes[i].nodeName===t&&n.push(e.childNodes[i]);return n}function m(e,t){if(!t||!e.hasChildNodes())return null;for(var n=e.childNodes.length,r=0;r<n;++r)if(e.childNodes[r].getAttribute("publicID")===t)return e.childNodes[r];return null}function g(e,t){if(!e.hasChildNodes())return null;for(var n=e.childNodes.length,r=0;r<n;++r)if(e.childNodes[r].nodeName===t){var i=e.childNodes[r];if(!i.hasChildNodes())return null;for(var a=i.childNodes.length,o=0;o<a;++o)if(3===i.childNodes[o].nodeType)return i.childNodes[o].data;break}return null}function o(r,e){var i=[];return angular.forEach(e,function(e,t){var n;switch(e=angular.isDate(e)?(n=e).getUTCFullYear()+","+(1+n.getUTCMonth())+","+n.getUTCDate()+","+n.getUTCHours()+","+n.getUTCMinutes()+","+n.getUTCSeconds()+","+n.getUTCMilliseconds():e,t){case"min":i.push(r+">="+e);break;case"max":i.push(r+"<"+e)}}),i.join(" and ")}function s(e){var n=[],r=["otime","lat","lon","depth","mag","tspan"];return angular.forEach(e,function(e,t){r.indexOf(t)<0||("tspan"===t?n.push(o("otime",{min:new Date(Date.now()-3600*e*1e3)})):n.push(o(t,e)))}),n.join(" and ")}function n(e,t){var n;this.url=e,this.url.endsWith("/")&&(this.url+="events/query"),this.query=(t=t,n=[],angular.isArray(t)?(angular.forEach(t,function(e){n.push("("+s(e)+")")}),n.join(" or ")):s(t)),this.needStop=!1,this.lastEventUpdate=this.rcb=this.ercb=null}return angular.extend(n.prototype,{start:function(){return this.canceller=i.defer(),this.lastEventUpdate=void 0,this.resume(),this},stop:function(){this.needStop=!0,this.canceller.resolve("stop")},resume:function(){var d=this,t=this.query;this.needStop=!1,function u(){var e=d.url;void 0===d.lastEventUpdate?e+="?archived":null!==d.lastEventUpdate&&(t="("+d.query+") and updated>"+d.lastEventUpdate),r.post(e,t,{timeout:d.canceller.promise}).then(function(e){if(200===e.status){var t=e.data,e=e.headers("Content-Type"),n=!1;if(e)for(var r=e.split(";"),i=r.length,a=0;a<i;++a){var o=r[a].trim();0===o.indexOf("version=")&&2<=(0|o.substr(8))&&(n=!0)}if(d.post=null,n)for(i=t.seiscomp.events.length,a=0;a<i;++a){var s=t.seiscomp.events[a];s.otime=new Date(s.otime).getTime(),s.updated=new Date(s.updated).getTime(),s.fm&&(s.fm.otime=new Date(s.fm.otime).getTime())}t.seiscomp.lastUpdate?d.lastEventUpdate=t.seiscomp.lastUpdate:d.lastEventUpdate=null,d.rcb&&d.rcb(t.seiscomp.events)}d.needStop?d.ercb&&d.ercb(t,"Poller stopped on demand."):u()}).catch(function(e){d.post=null,d.ercb&&d.ercb(e.data,e.status,d.needStop)})}()},receive:function(e){return this.rcb=e,this},error:function(e){return this.ercb=e,this}}),{createStream:function(e,t){if(void 0===t)throw new Error("You must pass at least one configuration object!");return new n(e,t)},getEventOnsets:function(e,t){var n=i.defer();return r.get(e+"?id="+t+"&include=picks,arrs").then(function(e){e=function(e,t){var n=[];if(t=m(e,t)){t=g(t,"preferredOriginID");if(t)for(var r=v(m(e,t),"arrival"),i=r.length,a=0;a<i;++a){var o,s,u,d,l,c=r[a],h=parseFloat(g(c,"distance")),f=g(c,"phase");f&&(o=1e3*parseFloat(g(c,"timeResidual")),!(s=m(e,g(c,"pickID")))||(d=v(s,"waveformID")).length&&(!(u=v(s,"time")).length||(l=(l=g(u[0],"value"))&&p(l))&&(s=(c=d[0]).getAttribute("networkCode")||"",u=c.getAttribute("stationCode")||"",d=c.getAttribute("locationCode")||"",c=c.getAttribute("channelCode")||"",n.push({net:s,sta:u,loc:d,cha:c.length<3?c+"Z":c,time:l,ph:f,residual:o,dist:h}))))}}return n}(a(e.data,"EventParameters"),t);e.sort(function(e,t){return e.time-t.time}),n.resolve(e)}).catch(function(e){n.reject(e.status)}),n.promise},shortPhaseName:function(e){for(var t=e.length-1;0<=t;--t)if(e[t]===e[t].toUpperCase())return e[t];return""},getEvent:function(e,t){var n=i.defer();return r.get(e+"?id="+t+"&include=picks,arrs").then(function(e){e=a(e.data,"EventParameters");n.resolve(e)}).catch(function(e){n.reject(e.status)}),n.promise},isoptime:p}}]);
"use strict";angular.module("recordstream",[]).factory("recordstream",["$q","$http","$timeout",function(e,D,s){return{run:function(p,f,h,g){var v="",w=e.defer(),m="Refused",q="WebSocket"in window;g.forceHTTP&&(q=!1);var y=null,t=null,j=!1;function n(e){return e<10?"0"+e:e}function T(e){return e.getUTCFullYear()+"-"+n(e.getUTCMonth()+1)+"-"+n(e.getUTCDate())+"T"+n(e.getUTCHours())+":"+n(e.getUTCMinutes())+":"+n(e.getUTCSeconds())}function r(){return v?(D.get(p+"query/streams/"+v+".json").then(function(e){e=e.data;0<e.request.records.length&&!j&&w.notify(e.request.records),e=null,m="Finished",t=s(r,0)}).catch(function(e){e.data;v=null,e.status<=0?(m="Disconnected",w.resolve(m)):502===e.status?(m="Proxy",w.resolve(m)):404===e.status?w.resolve(m):(v=null,m="Error",w.resolve(m,e.status))}),!0):(w.reject("No request to continue"),!1)}function C(e){D.post(p+"query/streams.json",e).then(function(e){e=e.data;v=e.request.id,0<e.request.records.length&&w.notify(e.request.records),e=null,r()}).catch(function(e){var t=e.data;e.status<=0||502===e.status?(m="Disconnected",w.resolve(m)):503===e.status?(m="Error",w.resolve(m)):w.reject(t)})}return{promise:w.promise,request:function(){if(!h||0===h.length)return w.reject("Empty request"),"";var e,t;g.start&&(e=T(g.start)),g.end&&(t=T(g.end));var n=[];g.spec&&n.push("spec=true"),g.spec&&g.raw&&n.push("raw=true"),g.specLength&&n.push("spec-window-length="+g.specLength),g.specOverlap&&n.push("spec-window-overlap="+g.specOverlap),g.specN&&n.push("spec-n-samples="+g.specN);for(var r,s,o,c,u=0;u<h.length;++u){var a,l,i,d=h[u];if(d instanceof Array?(a=d[0].split("."),1<d.length&&(l=T(d[1])),2<d.length&&(i=T(d[2]))):a=d.split("."),l=l||e,i=i||t,4!==a.length)return void w.reject("Invalid streamID: "+d);d=a[0]+" "+a[1]+" "+(a[2]||"--")+" "+a[3];l&&(d+=" "+l,i&&(d+=" "+i)),n.push(d)}return n=n.join("\n"),r=n,q?(y&&(y.close(),y=null),j=!1,"ws://"!==(s=f||p).slice(0,5)&&"wss://"!==s.slice(0,6)&&(c=-1!==(o=(c=window.location.pathname).lastIndexOf("/"))?c.substr(0,o+1):"/",c+=s,s=window.location.host+c,s="https:"===window.location.protocol?"wss://"+s:"ws://"+s),s+="query/streams",(y=new WebSocket(s,"acqui-json")).onopen=function(){if("acqui-json"!==y.protocol)return console.log("Protocol mismatch"),m="Wrong server protocol",void y.close();m="Finished",y.send(r)},y.onerror=function(e){w.resolve("Disconnected"),y=null},y.onmessage=function(e){if(!j)try{var t=JSON.parse(e.data);0<t.request.records.length&&w.notify(t.request.records)}catch(e){m=e.toString(),y.close()}},y.onclose=function(e){y=null,j||1006===e.code&&(m="Disconnected"),w.resolve(m)}):v?D.get(p+"purge/streams/"+v+".json").then(function(e){C(r)}).catch(function(e){console.error("Failed to purge request: "+e.data+"("+e.status+")"),C(r)}):C(r),n}(),cancel:function(){t&&(s.cancel(t),t=null),q?y&&(m="Cancelled",j=!0,y.close()):v&&(j=!0,D.get(p+"purge/streams/"+v+".json").then(function(e){}).catch(function(e){console.error("Failed to purge request: "+e.data+"("+e.status+")")}).finally(function(){w.resolve("Cancelled")}))}}}}}]);
L.Map.mergeOptions({boxSelect:!1}),L.Map.BoxSelect=L.Handler.extend({initialize:function(t){this._map=t,this._container=t._container,this._pane=t._panes.objectsPane,this._multiple=!1},addHooks:function(){L.DomEvent.on(this._container,"mousedown",this._onMouseDown,this),L.DomEvent.on(this._container,"touchstart",this._onTouchStart,this)},removeHooks:function(){L.DomEvent.off(this._container,"mousedown",this._onMouseDown),L.DomEvent.off(this._container,"touchstart",this._onTouchStart)},_onMouseDown:function(t){if(1!==t.which&&1!==t.button)return!1;t.shiftKey?this._multiple=!0:this._multiple=!1,this._startLayerPoint=this._map.mouseEventToLayerPoint(t),this._startDragging(t)},_onTouchStart:function(t){!t.touches||t.touches.length<1||(this._multiple=!1,this._startLayerPoint=this._map.mouseEventToLayerPoint(t.touches[0]),this._startDragging(t))},_startDragging:function(t){L.DomUtil.disableTextSelection(),this._box||(this._box=L.DomUtil.create("div","leaflet-select-box",this._pane)),L.DomUtil.setPosition(this._box,this._startLayerPoint),this._box.style.width="0px",this._box.style.height="0px",this._container.style.cursor="crosshair",L.DomEvent.on(document,"mousemove",this._onMouseMove,this).on(document,"mouseup",this._onMouseUp,this).on(document,"touchmove",this._onTouchMove,this).on(document,"touchend",this._onTouchEnd,this).on(document,"keydown",this._onKeyDown,this).preventDefault(t),this._map.fire("boxselectstart")},_onMouseMove:function(t){this._onMove(this._map.mouseEventToLayerPoint(t))},_onTouchMove:function(t){this._moveLayerPoint=this._map.mouseEventToLayerPoint(t.touches[0]),this._onMove(this._moveLayerPoint)},_onMove:function(t){var e=this._startLayerPoint,s=this._box,n=t.subtract(e),e=new L.Point(Math.min(t.x,e.x),Math.min(t.y,e.y));L.DomUtil.setPosition(s,e),s.style.width=Math.max(0,Math.abs(n.x)-4)+"px",s.style.height=Math.max(0,Math.abs(n.y)-4)+"px"},_finish:function(){this._pane.removeChild(this._box),delete this._box,this._container.style.cursor="",L.DomUtil.enableTextSelection(),L.DomEvent.off(document,"mousemove",this._onMouseMove).off(document,"mouseup",this._onMouseUp).off(document,"touchmove",this._onTouchMove).off(document,"touchend",this._onTouchEnd).off(document,"keydown",this._onKeyDown)},_onMouseUp:function(t){this._finishDragging(this._map.mouseEventToLayerPoint(t))},_onTouchEnd:function(t){this._finishDragging(this._moveLayerPoint)},_finishDragging:function(t){this._finish();var e=this._map,t=t;this._startLayerPoint.equals(t)||(t=new L.LatLngBounds(e.layerPointToLatLng(this._startLayerPoint),e.layerPointToLatLng(t)),e.fire("boxselectend",{boxSelectBounds:t,boxSelectMultiple:this._multiple}))},_onKeyDown:function(t){27===t.keyCode&&this._finish()}}),L.Map.addInitHook("addHandler","boxSelect",L.Map.BoxSelect),L.PolygonMarker=L.Polyline.extend({options:{fill:!0,lineJoin:"miter"},initialize:function(t,e,s){L.Path.prototype.initialize.call(this,s),this._latlng=L.latLng(t),this.setPoints(e)},setPoints:function(t){this._points=t,this._originalPoints=[];for(var e=0;e<this._points.length;++e)this._originalPoints[e]=new L.Point(0,0);this._bounds=new L.Bounds(this._originalPoints)},getLatLng:function(){return this._latlng},setLatLng:function(t){return this._latlng=t,this.redraw()},projectLatlngs:function(){for(var t=this._map.latLngToLayerPoint(this._latlng),e=0,s=this._points.length;e<s;e++)this._originalPoints[e].x=t.x+this._points[e][0],this._originalPoints[e].y=t.y-this._points[e][1]},getBounds:function(){var t=this._map,e=this._bounds.max.x-this._bounds.min.x,s=this._bounds.max.y-this._bounds.min.y,n=e*Math.cos(Math.PI/4),i=s*Math.sin(Math.PI/4),e=t.project(this._latlng),s=new L.Point(e.x-n,e.y+i),i=new L.Point(e.x+n,e.y-i),s=t.unproject(s),i=t.unproject(i);return new L.LatLngBounds(s,i)},_getPathPartStr:function(t){return L.Polyline.prototype._getPathPartStr.call(this,t)+(L.Browser.svg?"z":"x")},_clipPoints:function(){this.projectLatlngs(),L.Polyline.prototype._clipPoints.call(this)}}),L.PolygonMarker=L.Path.SVG&&!window.L_PREFER_CANVAS||!L.Browser.canvas?L.PolygonMarker:L.PolygonMarker.extend({_drawPath:function(){var t,e,s,n,i;for(this._ctx.beginPath(),t=0,s=this._parts.length;t<s;t++){for(e=0,n=this._parts[t].length;e<n;e++)i=this._parts[t][e],this._ctx[(0===e?"move":"line")+"To"](i.x,i.y);this._ctx.closePath()}}}),L.polygonMarker=function(t,e,s){return new L.PolygonMarker(t,e,s)},L.ClusterIcon=L.Icon.extend({options:{iconSize:[50,50],className:"leaflet-div-icon",fill:["white",.4],cluster:void 0,text:void 0,textColor:"white"},createIcon:function(t){var e=t&&"DIV"===t.tagName?t:document.createElement("div"),s='<svg viewBox="0 0 100 100" ><polygon points="10,85 90,85 50,15"',n=this.options.fill,t=this.options.textColor;return this.options.cluster&&(this.options.cluster._ll_color&&(n=this.options.cluster._ll_color instanceof Array?this.options.cluster._ll_color:[this.options.cluster._ll_color,1]),this.options.cluster._textColor&&(t=this.options.cluster._textColor)),s+=' fill="'+n[0]+'" fill-opacity="'+n[1]+'"',s+="/>",this.options.text&&(s+='<text x="50" y="72" fill="'+t+'" font-size="24" text-anchor="middle">'+this.options.text+"</text>"),e.innerHTML=s+="</svg>",this._setIconStyles(e,"icon"),e},createShadow:function(){return null}}),L.clusterIcon=function(t){return new L.ClusterIcon(t)},L.EventIcon=L.Icon.extend({options:{fillColor:[0,0,255,255],blankColor:[255,255,255,255],color:[0,0,0,255],radius:16,weight:2,fm:null},createIcon:function(t){return this._canvas=t&&"CANVAS"===t.tagName?t:document.createElement("canvas"),this._canvas.className="leaflet-marker-icon",this._ctx=this._canvas.getContext("2d"),this._applySize(),this._updateImage(),this._canvas},createShadow:function(){return null},setStyle:function(t){var e=t.radius&&this.options.radius!==t.radius;L.setOptions(this,t),this._ctx&&(e&&this._applySize(),this._updateImage())},_applySize:function(){var t=L.point([2*this.options.radius|0,2*this.options.radius|0]),e=t.divideBy(2,!0);this._canvas.width=t.x,this._canvas.height=t.y,this._canvas.style.marginLeft=-e.x+"px",this._canvas.style.marginTop=-e.y+"px",this._canvas.style.width=this._canvas.width+"px",this._canvas.style.height=this._canvas.height+"px"},_updateImage:function(){var t=this.options.fm?new G.Tensor(this.options.fm.strike,this.options.fm.dip,this.options.fm.rake):new G.Tensor(0,0,0);this._ctx.strokeStyle="rgba(0,0,0,0)",this._ctx.fillStyle="rgba(0,0,0,0)",this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height);var e=this._ctx.getImageData(0,0,this._canvas.width,this._canvas.height);t.render(e,this.options.fillColor,this.options.fm?this.options.blankColor:this.options.fillColor,this.options.color,.5*this.options.weight,this.options.weight),this._ctx.putImageData(e,0,0)}}),L.eventIcon=function(t){return new L.EventIcon(t)},L.EventMarker=L.Marker.extend({setStyle:function(t){this.options.icon.setStyle(t)},bringToFront:function(){this.setZIndexOffset(1e4)},restoreOrder:function(){this.setZIndexOffset(0)}}),L.eventMarker=function(t,e){return new L.EventMarker(t,{clickable:e.clickable,icon:L.eventIcon(e)})},L.StarMarker=L.PolygonMarker.extend({initialize:function(t,e){L.PolygonMarker.prototype.initialize.call(this,t,[],e)},setStyle:function(t){if(t.radius){var e=[],s=2*t.radius,n=.5*s;e.length=10;for(var i=0;i<5;++i)e[2*i]=[s*Math.sin(72*i*Math.PI/180),s*Math.cos(72*i*Math.PI/180)],e[2*i+1]=[n*Math.sin((360*i+180)/5*Math.PI/180),n*Math.cos((360*i+180)/5*Math.PI/180)];this.setPoints(e)}L.PolygonMarker.prototype.setStyle.call(this,t)}}),angular.module("mapwidget-ll",[]).directive("mapLl",["$timeout","$interval",function(V,j){return{restrict:"EA",template:'<div><span class="ll-pos" ng-if="cursor && options.currentPosition">{{cursor.text}}</span></div>',replace:!0,scope:{inventory:"=",events:"=",select:"=",currentFeature:"=",options:"=",mapInterface:"="},link:function(r,t,o){var a,s,n=t[0],l={maxZoom:14,showEvents:!1,blinking:!0,autoCenterLastEvent:!1,triggerDuration:6e5,mapURI:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",interactive:!0,zoomControl:!1,currentPosition:!1,maxBounds:[[-90,-225],[90,225]],minimap:{enable:!1},features:{geoJSON:null},inventory:{cluster:{enable:!1,radius:50,maxZoom:7,showCoverageOnHover:!1},allowAll:!1,normalStyle:{fillColor:"#2d69bf"}},events:{showFM:!0,updateInterval:60,colorByAge:!1},magnitudes:{scaleM:4.9,scaleN:-5.88,minSize:6},depths:[[50,[255,0,0]],[100,[255,128,0]],[250,[255,255,0]],[600,[0,127,0]],[null,[0,0,255]]],ages:[[3600,[255,0,0],"hour"],[86400,[255,128,0],"day"],[604800,[255,255,0],"week"],[2592e3,[255,255,255],"month"],[null,[128,128,128],"older"]]};angular.merge(l,r.options),o.hasOwnProperty("clusterInventory")&&(l.inventory.cluster.enable=!0),o.hasOwnProperty("allowAll")&&(l.inventory.allowAll=!0);var c=6e5;l.triggerDuration&&(c=l.triggerDuration);var u,h={lineJoin:"miter",fill:!0,innerRadius:0,opacity:.5,fillOpacity:1,gradient:!1,dropShadow:!0},e={fillColor:"#fff"},f={fillColor:"#edd400"},d={opacity:.5,color:"#444",weight:1.5},m={color:"#f00",weight:5},v=[[0,12],[12*Math.sin(240*Math.PI/180),12*Math.cos(240*Math.PI/180)],[12*Math.sin(120*Math.PI/180),12*Math.cos(120*Math.PI/180)]],p=null,_=null,g=null;function y(t){return t._color?t._color instanceof Array?{fillColor:t._color[0],fillOpacity:t._color[1]}:{fillColor:t._color,fillOpacity:1}:l.inventory.normalStyle}function b(t){if(t._ll_color)return t._ll_color instanceof Array?t._ll_color:[t._ll_color,1];t=t.getChildCount();return 100<=t?["#000",.4]:10<=t?["#111",.4]:["#222",.4]}function x(t){return t._textColor||"white"}function k(t){t.target.setStyle(e),o.currentFeature&&r.$apply(r.currentFeature=t.target)}function w(t){t.target.setStyle(t.target._sta._selected?f:y(t.target._sta)),o.currentFeature&&r.$apply(r.currentFeature=null)}function C(t){t.target._sta._selected=!0,t.target.setStyle(f)}function S(t){t.target._sta._selected=!1,t.target.setStyle(y(t.target._sta))}function M(t){var e=t instanceof Array?t[0]:t;if(void 0===e||"string"!=typeof e)return"white";t=[];return e.startsWith("rgb")?t=e.match(/\d+/g):e.startsWith("#")&&(4===e.length||5===e.length?t=[parseInt(e.substring(1,1),16),parseInt(e.substring(2,1),16),parseInt(e.substring(3,1),16)]:7!==e.length&&9!==e.length||(t=[parseInt(e.substring(1,2),16),parseInt(e.substring(3,2),16),parseInt(e.substring(5,2),16)])),3<=t.length&&125<Math.round((299*parseInt(t[0])+587*parseInt(t[1])+114*parseInt(t[2]))/1e3)?"black":"white"}function P(t){var e,s;t._icon&&(e=b(t),(s=t._icon.firstChild).firstChild.style.fill=e[0],s.firstChild.style.fillOpacity=e[1],1<s.children.length&&(s.children[1].style.fill=x(t)))}function I(t,e){for(var s,n,i,o=t._markers.length,r=0;r<o;++r)i=t._markers[r],(!s||void 0!==i._sta._color_value&&i._sta._color_value>s)&&(s=i._sta._color_value,n=i._sta._color);for(o=t._childClusters.length,r=0;r<o;++r){var a=t._childClusters[r];e&&I(a,!0),(!s||void 0!==a._ll_value&&a._ll_value>s)&&(s=a._ll_value,n=a._ll_color)}t._ll_value=s,t._ll_color=n,t._textColor=M(n),P(t)}function E(t){if(t){if(t[0][1]<=t[1][1])return L.latLngBounds(t);for(var e=t[0][1],s=t[1][1];s<e;)s+=360;return L.latLngBounds([[t[0][0],e],[t[1][0],s]])}}function T(t){var e=!1;try{s=r.options.features.geoJSON}catch(t){s=null}l.features.geoJSON!==s&&(e=!0),angular.merge(l,r.options);var s=E(l.maxBounds);s?(t&&t.fitBounds(s,{animate:!1}),_=s.getWest(),g=s.getEast()):_=g=null,t&&(p&&(t.removeLayer(p),p=null),l.showMaxBounds&&(p=L.rectangle(s,{color:"black",fill:!1,weight:2,dashArray:"2, 4",clickable:!1})).addTo(t),e&&(t=t,u&&(t.removeLayer(u),u=void 0),l.features.geoJSON&&((u=L.geoJson(l.features.geoJSON,{style:function(t){var e=t.properties,t={color:B(e.pen.color),weight:e.pen.width||1,opacity:3<e.pen.color.length?e.pen.color[3]/255:1,clickable:!1};return e.brush?(t.fill=!0,t.fillColor=B(e.brush.color),t.fillOpacity=3<e.brush.color.length?e.brush.color[3]/255:1):t.fill=!1,t}})).setZIndex(-2e7),u.addTo(t))))}function D(t,e,s){for(var n=e.length,i=0;i<n;++i){var o=e[i];if(null===o[0]||t<=o[0])return s?o[1]:"rgb("+o[1][0]+","+o[1][1]+","+o[1][2]+")"}return s?[0,0,0]:"#000"}function O(t,e){return l.events.colorByAge?D(t._age,l.ages,e):D(t._event.depth,l.depths,e)}function A(t){t=l.magnitudes.scaleM*t+l.magnitudes.scaleN;return.5*(t=t<l.magnitudes.minSize?l.magnitudes.minSize:t)}function B(t){return 3<=t.length?"rgb("+t[0]+","+t[1]+","+t[2]+")":"#000"}var z={map:null,tileLayer:null,blinkerActive:!1,stations:{features:{},markers:[],cluster:null,triggers:[],dirty:!1,queuedTriggers:[]},events:{features:{},dirty:!1,current:null},fitBounds:function(t){t=E(t);t&&this.map&&this.map.fitBounds(t,{animate:!1})},clearStations:function(){this.stations.features={};for(var t=this.stations.markers.length,e=0;e<t;++e){var s=this.stations.markers[e];s.off("mouseover",k),s.off("mouseout",w),s.off("selected",C),s.off("unselected",S),s.off("click",Z),s.unbindPopup(),this.map.removeLayer(s)}this.stations.cluster&&(this.stations.cluster.clearLayers(),this.map.removeLayer(this.stations.cluster),this.stations.cluster=null),this.stations.markers=[],this.stations.triggers=[]},addStation:function(t,e,s,n,i){if(!l.inventory.allowAll&&!i)return null;var o=s.code+"."+n.code;if(this.stations.features.hasOwnProperty(o))return null;if(null!==_)for(;e<_;)e+=360;if(null!==g)for(;g<e;)e-=360;null!==_&&null!==g&&(180<(i=e-.5*(_+g))?e-=360:i<-180&&(e+=360));t=L.polygonMarker([t,e],v,h);return t._net=s,t._sta=n,t._staid=o,t._staid2=t._staid+" ",t.on("mouseover",k),t.on("mouseout",w),t.on("selected",C),t.on("unselected",S),this.listener&&this.listener.getStationInfo||t.bindPopup("<strong>"+t._staid+"</strong><br/><i>"+t._sta.description+"<br/>"+t._net.description+"</i>"),t.on("click",Z),t.setStyle(y(t._sta)),t.setStyle(d),this.stations.features[t._staid]=[s,n,t],this.stations.markers.push(t),t},updateStations:function(){if(this.clearStations(),r.inventory){var t=new Date;l.inventory.cluster.enable?this.stations.cluster=L.markerClusterGroup({maxClusterRadius:l.inventory.cluster.radius,showCoverageOnHover:l.inventory.cluster.showCoverageOnHover,spiderfyOnMaxZoom:!0,disableClusteringAtZoom:l.inventory.cluster.maxZoom,iconCreateFunction:function(t){var e=100<=t.getChildCount()?50:10<=t.getChildCount()?40:30;return L.clusterIcon({className:"marker-cluster",fill:b(t),cluster:t,text:t.getChildCount(),textColor:x(t),iconSize:[e,e]})}}):this.stations.cluster=null;for(var e=r.inventory,s=0;s<e.network.length;++s)for(var n=e.network[s],i=0;i<n.station.length;++i){var o=n.station[i];new Date(o.start)>t||o.end&&new Date(o.end)<t||this.addStation(o.latitude,o.longitude,n,o,o.detecStream)}this.stations.markers.sort(function(t,e){return e._sta.latitude-t._sta.latitude}),this.addStationsToMap()}},addStationsToMap:function(){if(this.map){var t;if(this.stations.dirty=!1,this.stations.cluster){for(t=0;t<this.stations.markers.length;++t)this.stations.cluster.addLayer(this.stations.markers[t]);this.map.addLayer(this.stations.cluster)}else for(t=0;t<this.stations.markers.length;++t)this.stations.markers[t].addTo(this.map);z.listener&&z.listener.stationsAdded&&z.listener.stationsAdded()}else this.stations.dirty=!0},clearEvents:function(){if(this.map)for(var t in this.events.features){t=this.events.features[t];t.off("click",F),this.map.removeLayer(t)}this.events.features={}},addEvent:function(t){var e,s,n=t.hasOwnProperty("mag")?A(t.mag):l.magnitudes.minSize,i=t.lon;if(null!==_)for(;i<_;)i+=360;if(null!=g)for(;g<i;)i-=360;return null!==_&&null!==g&&(180<(s=i-.5*(_+g))?i-=360:s<-180&&(i+=360)),(e=new(t._latest?L.StarMarker:L.CircleMarker)([t.lat,i]))._event=t,e._age=.001*((new Date).getTime()-t.otime),n={color:s=O(e),fillColor:s,weight:2,opacity:1,fillOpacity:.5,radius:n,clickable:!o.hasOwnProperty("static")},e._style=n,e.setStyle(e._style),e.on("mouseover",N),e.on("mouseout",$),e.on("click",F),this.events.features[t.eventID]=e},removeEvent:function(t){var e;t in this.events.features&&(this.map&&((e=this.events.features[t]).off("mouseover",N),e.off("mouseout",$),e.off("click",F),this.map.removeLayer(e)),delete this.events.features[t])},updateEvent:function(t){var e,s,n;if(t.eventID in this.events.features){(e=this.events.features[t.eventID])._age=.001*((new Date).getTime()-t.otime),s=t.hasOwnProperty("mag")?A(t.mag):l.magnitudes.minSize,n=O(e),e._style.color=n,e._style.fillColor=n,e._style.radius=s;var i=t.lon;if(null!==_)for(;i<_;)i+=360;if(null!=g)for(;g<i;)i-=360;e.setLatLng([t.lat,i]),e.setStyle(e._style)}else(e=this.addEvent(t))&&this.map&&l.showEvents&&e.addTo(this.map)},setEventSpecialSymbol:function(t,e){var s;t.eventID in this.events.features&&(s=this.events.features[t.eventID],(e=new(e?L.StarMarker:L.CircleMarker)(s.getLatLng()))._event=s._event,e._age=s._age,e._style=s._style,e.setStyle(s._style),s.off("mouseover",N),s.off("mouseout",$),s.off("click",F),e.on("mouseover",N),e.on("mouseout",$),e.on("click",F),this.events.features[t.eventID]=e,this.map&&(this.map.removeLayer(s),e.addTo(this.map)),this.events.current===s&&(this.events.current=e))},bringToFront:function(t){t.bringToFront()},restoreOrder:function(t){t.restoreOrder&&t.restoreOrder()},centerEvent:function(t){var e,s=t.lon;if(null!==_)for(;s<_;)s+=360;if(null!=g)for(;g<s;)s-=360;null!==_&&null!==g&&(180<(e=s-.5*(_+g))?s-=360:e<-180&&(s+=360)),this.map.panTo([t.lat,s],null,{animate:!0})},setCurrentEvent:function(t,e){this.events.current&&(this.events.current.setStyle(this.events.current._style),this.events.current._map&&this.restoreOrder(this.events.current)),t?t in this.events.features?(this.events.current=this.events.features[t],this.events.current._map&&this.bringToFront(this.events.current),e&&this.map&&(e=this.events.current._event,this.centerEvent(e)),l.blinking&&this.setBlinkState()):console.debug("Cannot set current event: "+t+" not found"):this.events.current=null},updateEvents:function(){if(this.clearEvents(),r.events){for(var t in r.events){var e=r.events[t];this.addEvent(e)}this.addEventsToMap(),l.autoCenterLastEvent&&e&&this.setCurrentEvent(e.eventID,!0)}},addEventsToMap:function(){this.map?(this.events.dirty=!1,this.setEventsVisible(l.showEvents),z.listener&&z.listener.eventsAdded&&z.listener.eventsAdded()):this.events.dirty=!0},updateColorsOfEvents:function(){if(l.events.colorByAge){var t=(new Date).getTime();for(i in this.events.features){var e=this.events.features[i];e._age=.001*(t-e._event.otime),color=O(e),e._style.color=color,e._style.fillColor=color,e.setStyle(e._style)}}},setEventsVisible:function(t){if(t){for(var e in this.events.features)this.events.features[e].addTo(this.map);!s&&l.events.updateInterval&&l.events.colorByAge&&(this.updateColorsOfEvents(),s=j(this.updateColorsOfEvents.bind(this),1e3*l.events.updateInterval))}else{for(e in this.events.features)this.map.removeLayer(this.events.features[e]);s&&(j.cancel(s),s=void 0)}},removeBlinkState:function(){if(this.blinkerActive){this.stations.cluster&&!function t(e,s){for(var n=e._childClusters.length-1;0<=n;--n){var i=e._childClusters[n];i._icon&&(i._icon.firstChild.firstChild.style.stroke="rgb(255,255,255)",i._icon.firstChild.firstChild.style.strokeWidth="1",i._icon.firstChild.firstChild.style.strokeOpacity="0.4"),i._ll_opacity=0,t(i,s)}}(this.stations.cluster._topClusterLevel,"marker-cluster-triggering");for(var t=this.stations.triggers.length,e=0;e<t;++e)this.stations.triggers[e].setStyle(d);this.events.current&&this.events.current.setStyle(this.events.current._style),this.blinkerActive=!1}},setBlinkState:function(){if(!this.blinkerActive){for(var t=(new Date).getTime(),e=!1,s=this.stations.triggers.length,n=0;n<s;++n){var i,o=t-this.stations.triggers[n]._sta._trigger;!this.stations.triggers[n]._sta._trigger||c<o?(this.stations.triggers[n]._sta._trigger=void 0,this.stations.triggers[n].setStyle(d),this.stations.triggers.splice(n,1),--n,--s):(i=this.stations.triggers[n],(o=(c-o)/c)<0?o=0:1<o&&(o=1),i.setStyle(m),i.setStyle({opacity:o}),!this.stations.cluster||(i=this.stations.cluster.getVisibleParent(i))&&(!i._ll_opacity||i._ll_opacity<o)&&(i._ll_opacity=o),e=!0)}e&&this.stations.cluster&&!function t(e,s){for(var n=e._childClusters.length-1;0<=n;--n){var i=e._childClusters[n];i._icon&&0<i._ll_opacity&&(i._icon.firstChild.firstChild.style.stroke="rgb(255,0,0)",i._icon.firstChild.firstChild.style.strokeWidth="10%",i._icon.firstChild.firstChild.style.strokeOpacity=i._ll_opacity),t(i,s)}}(this.stations.cluster._topClusterLevel,"marker-cluster-triggering"),this.events.current&&(this.events.current.setStyle({color:"rgb(33,53,81)",fillColor:"rgb(122,212,226)",fillOpacity:.8}),e=!0),this.blinkerActive=e&&l.blinking,!a&&this.blinkerActive&&(a=j(function(){z.blinkerActive?z.removeBlinkState():z.setBlinkState()},1e3))}},addTriggers:function(t){if(0!==t.length)if(this.map){for(var e=0<this.stations.triggers.length,s=(new Date).getTime(),n=t.length,i=0;i<n;++i){var o,r,a=t[i],l=a.waveformID.networkCode+"."+a.waveformID.stationCode;l in this.stations.features&&(o=a._time,(a=(r=this.stations.features[l])[1])._trigger?a._trigger>o||(a._trigger=o):c<(l=s-o)||(a._trigger=o,(r=r[2]).setStyle(m),this.stations.triggers.push(r),(l=(c-l)/c)<0?l=0:1<l&&(l=1),r.setStyle({opacity:l})))}e||this.setBlinkState()}else this.stations.queuedTriggers=t},setColor:function(t,e,s){if(!(t in z.stations.features))return!1;var n=z.stations.features[t],t=n[2];if(n[1]._color!==e){if(void 0===e?delete n[1]._color:n[1]._color=e,void 0===s?delete n[1]._color_value:n[1]._color_value=s,t.setStyle(t._sta._selected?f:y(t._sta)),this.stations.cluster){var i=t.__parent;if(!i)return!0;for(!i._ll_value||s>i._ll_value?(i._ll_value=s,i._ll_color=e,i._textColor=M(e),P(i)):I(i,!1),i=i.__parent;i;)I(i,!1),i=i.__parent}return!0}},resetStationColors:function(){for(var t in z.stations.features){var e=z.stations.features[t],t=e[2];delete e[1]._color,delete e[1]._color_value,t.setStyle(t._sta._selected?f:y(t._sta))}this.stations.cluster&&!function t(e){for(var s=e._childClusters.length-1;0<=s;--s){var n=e._childClusters[s];delete n._ll_color,delete n._ll_value,delete n._textColor,P(n),t(n)}}(this.stations.cluster._topClusterLevel)},setClusterEnabled:function(t){if(l.inventory.cluster.enable!==t){l.inventory.cluster.enable=t,this.updateStations();for(var e=0;e<z.stations.markers.length;++e)z.stations.markers[e]._sta._trigger&&z.stations.triggers.push(z.stations.markers[e]);this.stations.cluster&&I(this.stations.cluster._topClusterLevel,!0)}}};function Z(t){var e,s;z.listener&&(z.listener.getStationInfo&&(e=t.target,(s=z.listener.getStationInfo(e._net,e._sta))&&L.popup().setLatLng(e.getLatLng()).setContent(s).openOn(z.map)),z.listener.stationClicked&&(e=t.target,z.listener.stationClicked(e._net,e._sta)))}function N(t){z.listener&&z.listener.eventMouseOver&&((t=t.target)._symbol&&(t=t._symbol),z.listener.eventMouseOver(t._event))}function $(t){z.listener&&z.listener.eventMouseOut&&((t=t.target)._symbol&&(t=t._symbol),z.listener.eventMouseOut(t._event))}function F(t){z.listener&&z.listener.eventClicked&&((t=t.target)._symbol&&(t=t._symbol),z.listener.eventClicked(t._event))}function U(t){for(var e=z.stations.markers.length,s=0;s<e;++s){var n=z.stations.markers[s];t.boxSelectBounds.contains(n.getLatLng())?z.stations.features[n._staid][1]._selected||(n.fire("selected"),z.stations.features[n._staid][1]._selected=!0):t.boxSelectMultiple||z.stations.features[n._staid][1]._selected&&(n.fire("unselected"),z.stations.features[n._staid][1]._selected=!1)}}function H(t){z.listener&&z.listener.mapClicked&&r.$apply(function(){z.listener.mapClicked(t)})}function J(t){r.$apply(function(){if(t.originalEvent.shiftKey){for(r.cursor=t.latlng;r.cursor.lng<-180;)r.cursor.lng+=360;for(;180<r.cursor.lng;)r.cursor.lng-=360;r.cursor.text=Math.abs(r.cursor.lat).toFixed(4)+"° "+(r.cursor.lat<0?"S":"N")+" "+Math.abs(r.cursor.lng).toFixed(4)+"° "+(r.cursor.lng<0?"W":"E"),z.listener&&z.listener.mapMouseMove&&z.listener.mapMouseMove(t)}else r.cursor=null})}function R(t){r.$apply(function(){r.cursor=null})}r.$watch("options",function(t,e){z.map&&t!==e&&T(z.map)}),r.$watch("options.mapURI",function(t,e){!z.tileLayer&&r.options&&r.options.mapURI&&(z.tileLayer=L.tileLayer(r.options.mapURI,{attribution:"Map data © OpenStreetMap contributors",minZoom:0,maxZoom:l.maxZoom,maxNativeZoom:l.maxLevel}),z.map&&z.map.addLayer(z.tileLayer))}),r.$watch("options.showEvents",function(t){l.showEvents=t,z.setEventsVisible(t)}),T(z.map),V(function(){if(z.map=L.map(n,{zoomControl:l.zoomControl,boxZoom:!0,boxSelect:!0,center:[0,0],zoom:3,worldCopyJump:!1,attributionControl:!1}),z.tileLayer&&z.map.addLayer(z.tileLayer),T(z.map),r.select?(z.map.boxZoom.disable(),z.map.dragging.disable(),z.map.boxSelect.enable()):(z.map.boxZoom.enable(),z.map.dragging.enable(),z.map.boxSelect.disable()),o.hasOwnProperty("static")&&(z.map.dragging.disable(),z.map.touchZoom.disable(),z.map.doubleClickZoom.disable(),z.map.scrollWheelZoom.disable(),z.map.boxZoom.disable(),z.map.keyboard.disable()),z.map.on("boxselectend",U),z.map.on("click",H),z.map.on("mousemove",J),z.map.on("mouseout",R),l.minimap.enable)try{z.minimap=L.control.minimap(l.minimap),z.map.addControl(z.minimap)}catch(t){console.error(t.message)}if(r.mapInterface&&r.mapInterface.initialized&&r.mapInterface.initialized(),z.stations.dirty&&z.addStationsToMap(),z.events.dirty&&z.addEventsToMap(),l.autoCenterLastEvent){var t,e;for(e in r.events)t=r.events[e];t&&z.setCurrentEvent(t.eventID,!0)}0<z.stations.queuedTriggers.length&&(z.addTriggers(z.stations.queuedTriggers),z.stations.queuedTriggers=[])},100),o.hasOwnProperty("mapInterface")&&r.mapInterface&&((r.mapInterface.map=z).listener=r.mapInterface,r.$watch("mapInterface",function(t,e){e&&(e.map=null),r.mapInterface&&(r.mapInterface.map=z),z.listener=r.mapInterface})),r.$watch("events",function(t,e){z.updateEvents()}),r.$watch("inventory",function(t,e){z.updateStations()}),r.$watch("select",function(t,e){z.map&&(t?(z.map.boxZoom.disable(),z.map.dragging.disable(),z.map.boxSelect.enable()):(z.map.boxZoom.enable(),z.map.dragging.enable(),z.map.boxSelect.disable()))}),r.$on("$destroy",function(){angular.isDefined(a)&&(j.cancel(a),a=void 0),angular.isDefined(s)&&(j.cancel(s),s=void 0),z.clearStations(),z.clearEvents(),z.map&&(z.map.off("boxselectend",U),z.map.off("click",H),z.map.off("mousemove",J),z.map.off("mouseout",R),z.map.remove()),r.mapInterface&&(r.mapInterface.map=null),z.listener=null})}}}]).directive("legendLl",function(){return{restrict:"EA",scope:{items:"="},template:'<div class="title">{{items.title}}</div>',link:function(r,a,t){r.$watch("items.labels",function(){a.children().remove(".entries");var t=angular.element('<div class="entries"></div>');if(a.append(t),r.items){for(var e="",s=null,n=0;n<r.items.labels.length;++n){var i,o=Array.isArray&&Array.isArray(r.items.labels[n][1])?(i="background-color:rgb("+r.items.labels[n][1].join(",")+")","color"):angular.isNumber(r.items.labels[n][1])?(i="width:"+r.items.labels[n][1]+"px;height:"+r.items.labels[n][1]+"px","box"):(i="background-color:"+r.items.labels[n][1],"color");e+='<div class="entry"><i class="'+o+'" style="'+i+'"></i> ',2<r.items.labels[n].length?(angular.isNumber(r.items.labels[n][0])&&(s=r.items.labels[n][0]),e+=r.items.labels[n][2]):angular.isNumber(r.items.labels[n][0])?e+="&lt;="+(s=r.items.labels[n][0]):r.items.labels[n][0]?e+=r.items.labels[n][0]:e+="&gt;"+s,e+="</div>"}t.append(e)}})}}});
"use strict";!function(o){o.extend({noticeAdd:function(t){var e=o.extend({},{inEffect:{opacity:"show"},inEffectDuration:600,stayTime:3e3,title:"Notice",text:"",stay:!1,type:"notice"},t),i=o(".notice-wrap").length?o(".notice-wrap"):o("<div></div>").addClass("notice-wrap").appendTo("body"),t=o("<div></div>").addClass("notice-item-wrapper"),n=o("<div></div>").hide().addClass("notice-item "+e.type).appendTo(i).html('<p><span class="notice-title">'+e.title+"</span>"+e.text+"</p>").animate(e.inEffect,e.inEffectDuration).wrap(t);o("<div></div>").addClass("notice-item-close").prependTo(n).html("&times;").click(function(){o.noticeRemove(n)});e.stay||setTimeout(function(){o.noticeRemove(n)},e.stayTime)},noticeRemove:function(t){t.animate({opacity:"0"},600,function(){t.parent().animate({height:"0px"},300,function(){t.parent().remove()})})}})}(jQuery),angular.module("notice-service",[]).factory("gmNotice",function(){var o={stayTime:5e3};function n(t,e,i,n){i={text:e,stay:!1,title:t,stayTime:void 0!==n?n:o.stayTime,type:"notice-"+i,rawtype:i};$.noticeAdd(i)}return{error:function(t,e,i){n(t,e,"error",i)},warning:function(t,e,i){n(t,e,"warning",i)},info:function(t,e,i){n(t,e,"info",i)},success:function(t,e,i){n(t,e,"success",i)},defaults:function(t){o=t}}});
Date.ext={},Date.ext.util={},Date.ext.util.xPad=function(e,t,a){for(void 0===a&&(a=10);parseInt(e,10)<a&&1<a;a/=10)e=t.toString()+e;return e.toString()},Date.prototype.locale="en-GB",document.getElementsByTagName("html")&&document.getElementsByTagName("html")[0].lang&&(Date.prototype.locale=document.getElementsByTagName("html")[0].lang),Date.ext.locales={},Date.ext.locales.en={a:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],A:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],b:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],B:["January","February","March","April","May","June","July","August","September","October","November","December"],c:"%a %d %b %Y %T %Z",p:["AM","PM"],P:["am","pm"],x:"%d/%m/%y",X:"%T"},Date.ext.locales["en-US"]=Date.ext.locales.en,Date.ext.locales["en-US"].c="%a %d %b %Y %r %Z",Date.ext.locales["en-US"].x="%D",Date.ext.locales["en-US"].X="%r",Date.ext.locales["en-GB"]=Date.ext.locales.en,Date.ext.locales["en-AU"]=Date.ext.locales["en-GB"],Date.ext.formats={1:function(e){return Math.round(.01*e.getMilliseconds())},2:function(e){return Date.ext.util.xPad(Math.round(.1*e.getMilliseconds()),0,10)},3:function(e){return Date.ext.util.xPad(Math.round(e.getMilliseconds()),0,100)},a:function(e){return Date.ext.locales[e.locale].a[e.getDay()]},A:function(e){return Date.ext.locales[e.locale].A[e.getDay()]},b:function(e){return Date.ext.locales[e.locale].b[e.getMonth()]},B:function(e){return Date.ext.locales[e.locale].B[e.getMonth()]},c:"toLocaleString",C:function(e){return Date.ext.util.xPad(parseInt(e.getFullYear()/100,10),0)},d:["getDate","0"],e:["getDate"," "],g:function(e){return Date.ext.util.xPad(parseInt(Date.ext.util.G(e)/100,10),0)},G:function(e){var t=e.getFullYear(),a=parseInt(Date.ext.formats.V(e),10),e=parseInt(Date.ext.formats.W(e),10);return a<e?t++:0===e&&52<=a&&t--,t},H:["getHours","0"],I:function(e){e=e.getHours()%12;return Date.ext.util.xPad(0==e?12:e,0)},j:function(e){var t=e-new Date(e.getFullYear()+"/1/1 GMT");t+=6e4*e.getTimezoneOffset();t=parseInt(t/6e4/60/24,10)+1;return Date.ext.util.xPad(t,0,100)},m:function(e){return Date.ext.util.xPad(e.getMonth()+1,0)},M:["getMinutes","0"],p:function(e){return Date.ext.locales[e.locale].p[12<=e.getHours()?1:0]},P:function(e){return Date.ext.locales[e.locale].P[12<=e.getHours()?1:0]},S:["getSeconds","0"],u:function(e){e=e.getDay();return 0===e?7:e},U:function(e){var t=parseInt(Date.ext.formats.j(e),10),e=6-e.getDay(),e=parseInt((t+e)/7,10);return Date.ext.util.xPad(e,0)},V:function(e){var t=parseInt(Date.ext.formats.W(e),10),a=new Date(e.getFullYear()+"/1/1").getDay(),a=t+(4<a||a<=1?0:1);return 53==a&&new Date(e.getFullYear()+"/12/31").getDay()<4?a=1:0===a&&(a=Date.ext.formats.V(new Date(e.getFullYear()-1+"/12/31"))),Date.ext.util.xPad(a,0)},w:"getDay",W:function(e){var t=parseInt(Date.ext.formats.j(e),10),e=7-Date.ext.formats.u(e),e=parseInt((t+e)/7,10);return Date.ext.util.xPad(e,0,10)},y:function(e){return Date.ext.util.xPad(e.getFullYear()%100,0)},Y:"getFullYear",z:function(e){e=e.getTimezoneOffset();return(0<e?"-":"+")+Date.ext.util.xPad(parseInt(Math.abs(e/60),10),0)+Date.ext.util.xPad(e%60,0)},Z:function(e){return e.toString().replace(/^.*\(([^)]+)\)$/,"$1")},"%":function(e){return"%"}},Date.ext.aggregates={c:"locale",D:"%m/%d/%y",h:"%b",n:"\n",r:"%I:%M:%S %p",R:"%H:%M",t:"\t",T:"%H:%M:%S",x:"locale",X:"locale"},Date.ext.aggregates.z=Date.ext.formats.z(new Date),Date.ext.aggregates.Z=Date.ext.formats.Z(new Date),Date.ext.unsupported={},Date.prototype.strftime=function(e,t){if(t)return new Date(this.getTime()+60*this.getTimezoneOffset()*1e3).strftime(e);this.locale in Date.ext.locales||(this.locale.replace(/-[a-zA-Z]+$/,"")in Date.ext.locales?this.locale=this.locale.replace(/-[a-zA-Z]+$/,""):this.locale="en-GB");for(var n=this;e.match(/%[cDhnrRtTxXzZ]/);)e=e.replace(/%([cDhnrRtTxXzZ])/g,function(e,t){var a=Date.ext.aggregates[t];return"locale"==a?Date.ext.locales[n.locale][t]:a});t=e.replace(/%([123aAbBCdegGHIjmMpPSuUVwWyY%])/g,function(e,t){var a=Date.ext.formats[t];return"string"==typeof a?n[a]():"function"==typeof a?a.call(n,n):"object"==typeof a&&"string"==typeof a[0]?Date.ext.util.xPad(n[a[0]](),a[1]):t}),n=null;return t};
!function(){var n=document.attachEvent,o=!1;var i,t,e=(i=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(e){return window.setTimeout(e,20)},function(e){return i(e)}),r=(t=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.clearTimeout,function(e){return t(e)});function a(e){var i=e.__resizeTriggers__,t=i.firstElementChild,e=i.lastElementChild,i=t.firstElementChild;e.scrollLeft=e.scrollWidth,e.scrollTop=e.scrollHeight,i.style.width=t.offsetWidth+1+"px",i.style.height=t.offsetHeight+1+"px",t.scrollLeft=t.scrollWidth,t.scrollTop=t.scrollHeight}function _(i){var t=this;a(this),this.__resizeRAF__&&r(this.__resizeRAF__),this.__resizeRAF__=e(function(){var e;(e=t).offsetWidth==e.__resizeLast__.width&&e.offsetHeight==e.__resizeLast__.height||(t.__resizeLast__.width=t.offsetWidth,t.__resizeLast__.height=t.offsetHeight,t.__resizeListeners__.forEach(function(e){e.call(t,i)}))})}if(!n){var s=!1,d="",l="animationstart",c="Webkit Moz O ms".split(" "),m="webkitAnimationStart animationstart oAnimationStart MSAnimationStart".split(" "),g="",h=document.createElement("fakeelement");if(!1===(s=void 0!==h.style.animationName?!0:s))for(var f=0;f<c.length;f++)if(void 0!==h.style[c[f]+"AnimationName"]){g=c[f],d="-"+g.toLowerCase()+"-",l=m[f],s=!0;break}var z="resizeanim",v="@"+d+"keyframes "+z+" { from { opacity: 0; } to { opacity: 0; } } ",u=d+"animation: 1ms "+z+"; "}window.addResizeListener=function(i,e){var t,r,s;n?i.attachEvent("onresize",e):(i.__resizeTriggers__||("static"==getComputedStyle(i).position&&(i.style.position="relative"),o||(t=(v||"")+".resize-triggers { "+(u||"")+'visibility: hidden; opacity: 0; } .resize-triggers, .resize-triggers > div, .contract-trigger:before { content: " "; display: block; position: absolute; top: 0; left: 0; height: 100%; width: 100%; overflow: hidden; } .resize-triggers > div { background: #eee; overflow: auto; } .contract-trigger:before { width: 200%; height: 200%; }',r=document.head||document.getElementsByTagName("head")[0],(s=document.createElement("style")).type="text/css",s.styleSheet?s.styleSheet.cssText=t:s.appendChild(document.createTextNode(t)),r.appendChild(s),o=!0),i.__resizeLast__={},i.__resizeListeners__=[],(i.__resizeTriggers__=document.createElement("div")).className="resize-triggers",i.__resizeTriggers__.innerHTML='<div class="expand-trigger"><div></div></div><div class="contract-trigger"></div>',i.appendChild(i.__resizeTriggers__),a(i),i.addEventListener("scroll",_,!0),l&&i.__resizeTriggers__.addEventListener(l,function(e){e.animationName==z&&a(i)})),i.__resizeListeners__.push(e))},window.removeResizeListener=function(e,i){n?e.detachEvent("onresize",i):(e.__resizeListeners__.splice(e.__resizeListeners__.indexOf(i),1),e.__resizeListeners__.length||(e.removeEventListener("scroll",_),e.__resizeTriggers__=!e.removeChild(e.__resizeTriggers__)))}}();
"use strict";var G={};
"use strict";!function(){G.Filter={_factory:{},create:function(t){return G.Filter._factory.hasOwnProperty(t)?new G.Filter._factory[t]:null}};var q=0;function x(t,e){this.real=t,this.img=e}function t(t){return.5*(Math.pow(Math.E,t)-Math.pow(Math.E,-t))}function e(t){return.5*(Math.pow(Math.E,t)+Math.pow(Math.E,-t))}function u(t,e,i){var r,s,n,h,o,a,l,u=e*e;return t===Math.PI?(a=i===q?-(r=e/(1+e)):r=1/(1+e),h=((n=1)-e)/(1+e),o=l=0):(h=2*(t=(n=1)/(1+u-2*(s=Math.cos(t))*e))*(1-u),o=t*(1+u+2*s*e),a=i===q?-2*(r=t*u):2*(r=t),l=r),new G.Filter.Biquad(r,a,l,n,h,o)}function E(t,e,i,r){for(var s=[],n=t%2,h=Math.PI/t,o=.5*(h+Math.PI),a=1/Math.tan(Math.PI*e/i),l=0;l<t/2;++l)s.push(u(o+l*h,a,r));return n&&s.push(u(Math.PI,a,r)),s}function i(t,e,i,r,s){var n,h=[];if(2===s)for(var o=Math.PI/(2*t),a=2*Math.PI*e,l=2*Math.PI*i,u=l-a,p=a*l*4/(u*u),f=t%2?0:1;f<t;f+=2)if(!f&&p<1){var c,m,g,w=(g=1/(m=[new x(.5*u*(1-(c=Math.sqrt(1-p))),0),new x(.5*u*(1+c),0)])[0].mult(.5,0).div(r,0).tan())/(1+g),F=-w,d=(1-g)/(1+g),y=1/(1+(g=1/m[1].mult(.5,0).div(r,0).tan())),v=(1-g)/(1+g),A=w*y,P=F*y+w*(a=y),_=F*a,B=1,T=d+v,L=d*v;h.push(new G.Filter.Biquad(A/B,P/B,_/B,1,T/B,L/B))}else{v=Math.PI-f*o,v=new x(Math.cos(v),Math.sin(v));c=v.mult(v).sub(p,0).sqrt(),m=[v.sub(c).mult(.5*u,0),v.add(c).mult(.5*u,0)];for(var C=0;C<2;++C){var M=m[C].abs(),b=M*(g=1/Math.tan(.5*M/r)),S=M*M,M=m[C].real;if(P=0,_=-(A=u*b),B=S+b*b-2*M*b,T=2*(S-b*b),L=S+b*b+2*M*b,h.push(new G.Filter.Biquad(A/B,P/B,_/B,1,T/B,L/B)),!f)break}}else if(3===s){for(T=E(t,e,r,q),L=E(t,i,r,1),n=T.length,f=0;f<n;++f)h.push(T[f]);for(n=L.length,f=0;f<n;++f)h.push(L[f])}return h}G.Filter.Biquad=function(t,e,i,r,s,n){this.v1=0,this.v2=0,this.a0=t,this.a1=e,this.a2=i,this.b0=r,this.b1=s,this.b2=n},G.Filter.Biquad.prototype={apply:function(t){for(var e=t.length,i=0;i<e;++i){var r=t[i]-this.b1*this.v1-this.b2*this.v2;t[i]=this.a0*r+this.a1*this.v1+this.a2*this.v2,this.v2=this.v1,this.v1=r}},reset:function(){this.v1=0,this.v2=0}},x.prototype={real:0,img:0,add:function(){return 1==arguments.length?new x(this.real+arguments[0].real,this.img+arguments[0].img):new x(this.real+arguments[0],this.img+arguments[1])},sub:function(){return 1==arguments.length?new x(this.real-arguments[0].real,this.img-arguments[0].img):new x(this.real-arguments[0],this.img-arguments[1])},mult:function(){var t=arguments[0];return 1!=arguments.length&&(t=new x(arguments[0],arguments[1])),new x(this.real*t.real-this.img*t.img,this.real*t.img+this.img*t.real)},div:function(){var t=arguments[0],e=1/((t=1!=arguments.length?new x(arguments[0],arguments[1]):t).real*t.real+t.img*t.img);return new x((this.real*t.real+this.img*t.img)*e,(this.img*t.real-this.real*t.img)*e)},abs:function(){return Math.sqrt(this.real*this.real+this.img*this.img)},cos:function(){return new x(Math.cos(this.real)*e(this.img),-(Math.sin(this.real)*t(this.img)))},sin:function(){return new x(Math.sin(this.real)*e(this.img),Math.cos(this.real)*t(this.img))},tan:function(){return this.sin()/this.cos()},sqrt:function(){var t=this.real,e=this.img;if(0===t)return new x(i=Math.sqrt(Math.abs(e)/2),e<0?-i:i);var i,r=(i=Math.sqrt(2*(this.abs()+Math.abs(t))))/2;return 0<t?new x(r,e/i):new x(Math.abs(e)/i,e<0?-r:r)}},G.Filter.Butterworth={},G.Filter.Butterworth.Base=function(t){this.order=t,this.fsamp=0,this.biquads=[]},G.Filter.Butterworth.Base.prototype={reset:function(){for(var t=this.biquads.length,e=0;e<t;++e)this.biquads[e].reset()},apply:function(t){for(var e=this.biquads.length,i=0;i<e;++i)this.biquads[i].apply(t)}},G.Filter.Butterworth.LowPass=function(t,e){this.base=G.Filter.Butterworth.Base,this.base(t),delete this.base,this.order=t,this.fc=e},G.Filter.Butterworth.LowPass.prototype=new G.Filter.Butterworth.Base,G.Filter.Butterworth.LowPass.prototype.setSamplingFrequency=function(t){this.fsamp!==t&&(this.fsamp=t,this.biquads=E(this.order,this.fc,this.fsamp,1))},G.Filter.Butterworth.LowPass.prototype.setParams=function(t){if(2!==t.length)return 2;var e=t[0];return e<=0?-1:(this.order=e,this.fc=t[1],0)},G.Filter.Butterworth.LowPass.prototype.clone=function(){return new G.Filter.Butterworth.LowPass(this.order,this.fc)},G.Filter._factory.BW_LP=G.Filter.Butterworth.LowPass,G.Filter.Butterworth.HighPass=function(t,e){this.base=G.Filter.Butterworth.Base,this.base(t),delete this.base,this.order=t,this.fc=e},G.Filter.Butterworth.HighPass.prototype=new G.Filter.Butterworth.Base,G.Filter.Butterworth.HighPass.prototype.setSamplingFrequency=function(t){this.fsamp!==t&&(this.fsamp=t,this.biquads=E(this.order,this.fc,this.fsamp,q))},G.Filter.Butterworth.HighPass.prototype.setParams=function(t){if(2!==t.length)return 2;var e=t[0];return e<=0?-1:(this.order=e,this.fc=t[1],0)},G.Filter.Butterworth.HighPass.prototype.clone=function(){return new G.Filter.Butterworth.HighPass(this.order,this.fc)},G.Filter._factory.BW_HP=G.Filter.Butterworth.HighPass,G.Filter.Butterworth.HighLowPass=function(t,e,i){this.base=G.Filter.Butterworth.Base,this.base(t),delete this.base,this.fmin=e,this.fmax=i},G.Filter.Butterworth.HighLowPass.prototype=new G.Filter.Butterworth.Base,G.Filter.Butterworth.HighLowPass.prototype.setSamplingFrequency=function(t){this.fsamp!==t&&(this.fsamp=t,this.biquads=i(this.order,this.fmin,this.fmax,this.fsamp,3))},G.Filter.Butterworth.HighLowPass.prototype.setParams=function(t){if(3!==t.length)return 3;var e=t[0];return e<=0?-1:(this.order=e,this.fmin=t[1],this.fmax=t[2],0)},G.Filter.Butterworth.HighLowPass.prototype.clone=function(){return new G.Filter.Butterworth.HighLowPass(this.order,this.fmin,this.fmax)},G.Filter._factory.BW_HLP=G.Filter.Butterworth.HighLowPass,G.Filter._factory.BW=G.Filter._factory.BW_HLP,G.Filter.Butterworth.BandPass=function(t,e,i){this.base=G.Filter.Butterworth.Base,this.base(t),delete this.base,this.fmin=e,this.fmax=i},G.Filter.Butterworth.BandPass.prototype=new G.Filter.Butterworth.Base,G.Filter.Butterworth.BandPass.prototype.setSamplingFrequency=function(t){this.fsamp!==t&&(this.fsamp=t,this.biquads=i(this.order,this.fmin,this.fmax,this.fsamp,2))},G.Filter.Butterworth.BandPass.prototype.setParams=function(t){if(3!==t.length)return 3;var e=t[0];return e<=0?-1:(this.order=e,this.fmin=t[1],this.fmax=t[2],0)},G.Filter.Butterworth.BandPass.prototype.clone=function(){return new G.Filter.Butterworth.BandPass(this.order,this.fmin,this.fmax)},G.Filter._factory.BW_BP=G.Filter.Butterworth.BandPass,G.Filter.RMHP=function(){this.average=0,this.sampleCount=0,this.windowLength=0<arguments.length?arguments[0]:0},G.Filter.RMHP.prototype.setSamplingFrequency=function(t){this.windowLengthI=Math.floor(this.windowLength*t)},G.Filter.RMHP.prototype.setParams=function(t){return 1!==t.length?1:(this.windowLength=t[0],0)},G.Filter.RMHP.prototype.reset=function(){this.average=0,this.sampleCount=0},G.Filter.RMHP.prototype.apply=function(t){if(this.sampleCount<this.windowLengthI)for(var e=this.windowLengthI-this.sampleCount,i=e>t.length?t.length:e,r=0;r<i;++r)this.average=(this.average*this.sampleCount+t[r])/(this.sampleCount+1),t[r]-=this.average,++this.sampleCount;else r=0;for(var s=t.length;r<s;++r)this.average=(this.average*(this.windowLengthI-1)+t[r])/this.windowLengthI,t[r]-=this.average},G.Filter.RMHP.prototype.clone=function(){return new G.Filter.RMHP(this.windowLength)},G.Filter._factory.RMHP=G.Filter.RMHP,G.Filter.ITAPER=function(){this.sampleCount=0,this.windowLength=0<arguments.length?arguments[0]:0,this.offset=1<arguments.length?arguments[1]:0},G.Filter.ITAPER.prototype.setSamplingFrequency=function(t){this.windowLengthI=Math.floor(this.windowLength*t)},G.Filter.ITAPER.prototype.setParams=function(t){return t.length<1||2<t.length?1:(this.windowLength=t[0],1<t.length?this.offset=t[1]:this.offset=0,0)},G.Filter.ITAPER.prototype.reset=function(){this.sampleCount=0},G.Filter.ITAPER.prototype.apply=function(t){if(this.sampleCount<this.windowLengthI)for(var e=this.windowLengthI-this.sampleCount,i=e>t.length?t.length:e,r=0;r<i;++r){var s=this.sampleCount/this.windowLengthI;t[r]=.5*(t[r]-this.offset)*(1-Math.cos(Math.PI*s))+this.offset,++this.sampleCount}},G.Filter.ITAPER.prototype.clone=function(){return new G.Filter.ITAPER(this.windowLength,this.offset)},G.Filter._factory.ITAPER=G.Filter.ITAPER,G.Filter.Envelope=function(){this.fsamp=0,this.buffer=[],this.timeSpan=0<arguments.length?arguments[0]:1},G.Filter.Envelope.prototype.reset=function(){this.buffer=[];for(var t=this.buffer[this.sampleCount-1]=0;t<this.sampleCount;++t)this.buffer[t]=0},G.Filter.Envelope.prototype.setSamplingFrequency=function(t){t!==this.fsamp&&(this.fsamp=t,this.sampleCount=Math.floor(this.fsamp*this.timeSpan),this.sampleCount<1&&(this.sampleCount=1),this.sum=0,this.index=0,this.oocount=2/this.sampleCount,this.reset())},G.Filter.Envelope.prototype.apply=function(t){if(0===this.fsamp)throw"Envelope sample rate not initialized";for(var e=t.length,i=0;i<e;++i){var r=t[i]*t[i],s=this.buffer[this.index];this.buffer[this.index]=r,++this.index,this.index>=this.sampleCount&&(this.index=0),this.sum=this.sum+r-s,t[i]=Math.sqrt(this.sum*this.oocount)}},G.Filter.Envelope.prototype.setParams=function(t){return 1!==t.length?1:(this.timeSpan=t[0],0)},G.Filter.Envelope.prototype.clone=function(){return new G.Filter.Envelope(this.timeSpan)},G.Filter._factory.ENV=G.Filter.Envelope,G.Filter.STALTA=function(){this._lenSTA=2,this._lenLTA=50,this._fsamp=1,this._numSTA=0,this._numLTA=0,this._sampleCount=0,this._STA=0,(this._LTA=0)<arguments.length&&(this._lenSTA=null!=arguments[0]?arguments[0]:2),1<arguments.length&&(this._lenLTA=null!=arguments[1]?arguments[1]:50),2<arguments.length&&(this._fsamp=null!=arguments[2]?arguments[2]:1),this.setSamplingFrequency(this._fsamp)},G.Filter.STALTA.prototype.reset=function(){this._sampleCount=0,this._STA=this._LTA=0},G.Filter.STALTA.prototype.setSamplingFrequency=function(t){if(t!==this.fsamp){if(t<=0)throw"Sampling frequency must be positive";this._fsamp=t,this._numSTA=Math.floor(this._lenSTA*t+.5),this._numLTA=Math.floor(this._lenLTA*t+.5),this.reset()}},G.Filter.STALTA.prototype.apply=function(t){if(0===this.fsamp)throw"STALTA sample rate not initialized";for(var e=1/this._numLTA,i=1/this._numSTA,r=t.length,s=0;s<r;++s){var n=Math.abs(t[s]),h=!0;this._sampleCount<this._numSTA?(i=1/(this._sampleCount+1),this._STA=(this._STA*this._sampleCount+n)*i,h=!1):this._STA+=(n-this._STA)*i,this._sampleCount<this._numLTA?(e=1/(this._sampleCount+1),this._LTA=(this._LTA*this._sampleCount+n)*e,h=!1):this._LTA+=(this._STA-this._LTA)*e,h||++this._sampleCount,this._LTA<Number.EPSILON?t[s]=1e6*this._STA:t[s]=this._sampleCount<this._numSTA?1:this._STA/this._LTA}},G.Filter.STALTA.prototype.setParams=function(t){return 2!==t.length?2:(this._lenSTA=t[0],this._lenSTA<=0?-1:(this._lenLTA=t[1],this._lenLTA<=0?-2:0))},G.Filter.STALTA.prototype.clone=function(){return new G.Filter.STALTA(this.timeSpan)},G.Filter._factory.STALTA=G.Filter.STALTA,G.Filter.Chain=function(){this.filters=[];for(var t=0;t<arguments.length;++t)this.filters.push(arguments[t])},G.Filter.Chain.prototype.add=function(t){this.filters.push(t)},G.Filter.Chain.prototype.reset=function(){for(var t=this.filters.length,e=0;e<t;++e)this.filters[e].reset()},G.Filter.Chain.prototype.setSamplingFrequency=function(t){for(var e=this.filters.length,i=0;i<e;++i)this.filters[i].setSamplingFrequency(t)},G.Filter.Chain.prototype.apply=function(t){for(var e=this.filters.length,i=0;i<e;++i)this.filters[i].apply(t)},G.Filter.Chain.prototype.clone=function(){for(var t=new G.Filter.Chain,e=this.filters.length,i=0;i<e;++i)t.add(this.filters[i].clone());return t},G.Filter.Parser=function(){function $(t,e,i,r,s,n){this.message=t,this.expected=e,this.found=i,this.offset=r,this.line=s,this.column=n,this.name="SyntaxError"}function t(){this.constructor=e}var e,i;return e=$,i=Error,t.prototype=i.prototype,e.prototype=new t,{SyntaxError:$,parse:function(n){function s(t,e){return parseFloat(t+"."+e)}var t=1<arguments.length?arguments[1]:{},h={},e={start:V},i=V,o=h,a="(",l={type:"literal",value:"(",description:'"("'},u=")",p={type:"literal",value:")",description:'")"'},f=/^[a-z]/i,c={type:"class",value:"[a-z]i",description:"[a-z]i"},m=/^[a-z0-9_\-]/i,g={type:"class",value:"[a-z0-9_\\-]i",description:"[a-z0-9_\\-]i"},w=function(t,e){return t+e.join("")},r={type:"other",description:"positive"},F=/^[0-9]/,d={type:"class",value:"[0-9]",description:"[0-9]"},y={type:"other",description:"negative"},v={type:"literal",value:"-",description:'"-"'},A={type:"other",description:"integer"},P={type:"other",description:"float"},_=".",B={type:"literal",value:".",description:'"."'},T={type:"other",description:"parameters"},L=",",C={type:"literal",value:",",description:'","'},M=function(t,e){return[t].concat(e)},b=function(t){return[t]},S=">>",q={type:"literal",value:">>",description:'">>"'},x="->",E={type:"literal",value:"->",description:'"->"'},I=function(t,e){var i=new G.Filter.Chain;return i.add(t),i.add(e),i},R=0,H=0,z={line:1,column:1,seenCR:!1},W=0,j=[],N=0;if("startRule"in t){if(!(t.startRule in e))throw new Error("Can't start parsing from rule \""+t.startRule+'".');i=e[t.startRule]}function O(t){return H!==t&&(t<H&&(H=0,z={line:1,column:1,seenCR:!1}),function(t,e,i){for(var r,s=e;s<i;s++)"\n"===(r=n.charAt(s))?(t.seenCR||t.line++,t.column=1,t.seenCR=!1):"\r"===r||"\u2028"===r||"\u2029"===r?(t.line++,t.column=1,t.seenCR=!0):(t.column++,t.seenCR=!1)}(z,H,t),H=t),z}function k(t){R<W||(W<R&&(W=R,j=[]),j.push(t))}function U(t,e,i){var r=O(i),s=i<n.length?n.charAt(i):null;return null!==e&&function(t){var e=1;for(t.sort(function(t,e){return t.description<e.description?-1:t.description>e.description?1:0});e<t.length;)t[e-1]===t[e]?t.splice(e,1):e++}(e),new $(null!==t?t:function(t,e){for(var i=new Array(t.length),r=0;r<t.length;r++)i[r]=t[r].description;function s(t){return t.charCodeAt(0).toString(16).toUpperCase()}return"Expected "+(1<t.length?i.slice(0,-1).join(", ")+" or "+i[t.length-1]:i[0])+" but "+(e?'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(t){return"\\x0"+s(t)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(t){return"\\x"+s(t)}).replace(/[\u0180-\u0FFF]/g,function(t){return"\\u0"+s(t)}).replace(/[\u1080-\uFFFF]/g,function(t){return"\\u"+s(t)})+'"':"end of input")+" found."}(e,s),e,s,i,r.line,r.column)}function V(){return Y()}function D(){var t,e,i,r=R,s=function(){var t,e,i,r;t=R,f.test(n.charAt(R))?(e=n.charAt(R),R++):(e=h,0===N&&k(c));if(e!==h){for(i=[],m.test(n.charAt(R))?(r=n.charAt(R),R++):(r=h,0===N&&k(g));r!==h;)i.push(r),m.test(n.charAt(R))?(r=n.charAt(R),R++):(r=h,0===N&&k(g));t=i!==h?e=w(e,i):(R=t,o)}else R=t,t=o;return t}();return r=s!==h?(40===n.charCodeAt(R)?(t=a,R++):(t=h,0===N&&k(l)),t!==h&&(e=function t(){var e,i,r;N++;e=R;i=X();e=i!==h?(44===n.charCodeAt(R)?(r=L,R++):(r=h,0===N&&k(C)),r!==h?(r=t())!==h?i=M(i,r):(R=e,o):(R=e,o)):(R=e,o);e===h&&(e=R,(i=X())!==h&&(i=b(i)),e=i);N--;e===h&&(i=h,0===N&&k(T));return e}())!==h?(41===n.charCodeAt(R)?(i=u,R++):(i=h,0===N&&k(p)),i!==h?function(t,e){var i=G.Filter.create(t);if(!i)throw"Filter "+t+" is not declared";e=i.setParams(e);if(0===e)return i;throw 0<e?"Filter "+t+" expects "+e+" parameter(s)":"Invalid parameter "+-e+" for filter "+t}(s,e):(R=r,o)):(R=r,o)):(R=r,o)}function J(){var t,e,i;if(N++,t=R,e=[],F.test(n.charAt(R))?(i=n.charAt(R),R++):(i=h,0===N&&k(d)),i!==h)for(;i!==h;)e.push(i),F.test(n.charAt(R))?(i=n.charAt(R),R++):(i=h,0===N&&k(d));else e=o;return e!==h&&(e=parseFloat(e.join(""))),N--,(t=e)===h&&(e=h,0===N&&k(r)),t}function K(){var t,e,i,r;if(N++,t=R,45===n.charCodeAt(R)?(e="-",R++):(e=h,0===N&&k(v)),e!==h){if(i=[],F.test(n.charAt(R))?(r=n.charAt(R),R++):(r=h,0===N&&k(d)),r!==h)for(;r!==h;)i.push(r),F.test(n.charAt(R))?(r=n.charAt(R),R++):(r=h,0===N&&k(d));else i=o;t=i!==h?e=parseFloat("-"+i.join("")):(R=t,o)}else R=t,t=o;return N--,t===h&&(e=h,0===N&&k(y)),t}function Q(){var t;return N++,(t=J())===h&&(t=K()),N--,t===h&&(0===N&&k(A)),t}function X(){var t,e,i,r;return N++,t=R,(t=(e=Q())!==h?(46===n.charCodeAt(R)?(i=_,R++):(i=h,0===N&&k(B)),i!==h&&(r=J())!==h?e=s(e,r):(R=t,o)):(R=t,o))===h&&(t=Q()),N--,t===h&&(e=h,0===N&&k(P)),t}function Y(){var t,e,i=R,r=Z();return i=(i=r!==h?(n.substr(R,2)===S?(t=S,R+=2):(t=h,0===N&&k(q)),t===h&&(n.substr(R,2)===x?(t=x,R+=2):(t=h,0===N&&k(E))),t!==h&&(e=Y())!==h?I(r,e):(R=i,o)):(R=i,o))===h?Z():i}function Z(){var t,e,i,r=D();return r===h&&(r=R,40===n.charCodeAt(R)?(t=a,R++):(t=h,0===N&&k(l)),r=t!==h&&(e=Y())!==h?(41===n.charCodeAt(R)?(i=u,R++):(i=h,0===N&&k(p)),i!==h?t=e:(R=r,o)):(R=r,o)),r}if((i=i())!==h&&R===n.length)return i;throw i!==h&&R<n.length&&k({type:"end",description:"end of input"}),U(null,j,W)}}},G.Filter._parser=new G.Filter.Parser,G.Filter.build=function(t){return G.Filter._parser.parse(t)}}();
"use strict";!function(){function h(e,t,i,r){if(!(t<0)){t=e[t];if(i.srNum!==t.srNum||i.srDen!==t.srDen)return r.reset(),void r.setSamplingFrequency(i.srNum/i.srDen);.001*Math.abs(i.startTime-t.endTime)*i.srNum>i.srDen&&r.reset()}}function f(e){return $.extend(!0,{},e)}G.RecordUtils={},G.RecordUtils.toPowerSpectrum=function(e,t){var i,r,s,h=t?1/t:1;if("f"!==e.domain){for(s=(r=e.samples).length,i=0;i<s;++i)r[i]*=h;return!1}for(s=(r=e.samples).length,e.sr=e.srNum/e.srDen,i=0;i<s;++i){var f=r[i][0]*r[i][0]+r[i][1]*r[i][1];r[i]=f*h}return!0},G.RecordBuffer=function(e,t){this.bufferSize=e,this.raw=[],this.filtered=[],this.filter=void 0,this.keepRaw=void 0===t||t},G.RecordBuffer.prototype.clear=function(){this.raw.length=0,this.filtered.length=0},G.RecordBuffer.prototype.setFilter=function(e){if(0<this.raw.length&&this.filter&&!this.keepRaw)return!1;this.filter=e,this.filtered.length=0,this.filtered=[];for(var t=this.raw.length,i=0;i<t;++i){var r,s=this.raw[i];0===i&&this.filter.setSamplingFrequency(s.srNum/s.srDen),h(this.raw,i-1,s,this.filter),this.keepRaw?(r=f(s),this.filter.apply(r.samples),this.filtered.push(r)):(this.filter.apply(s.samples),this.raw[i]=r)}return!0},G.RecordBuffer.prototype.feed=function(e){if(this.filter){var t=f(e),i=this.keepRaw?(this.raw.push(e),this.filtered):this.raw;if(0===i.length?this.filter.setSamplingFrequency(e.srNum/e.srDen):h(i,i.length-1,e,this.filter),this.filter.apply(t.samples),i.push(t),0<this.bufferSize)for(;1<this.filtered.length&&this.filtered[this.filtered.length-1].endTime-this.filtered[0].endTime>this.bufferSize;)this.filtered.shift().samples.length=0,0}else this.raw.push(e);if(0<this.bufferSize)for(;1<this.raw.length&&this.raw[this.raw.length-1].endTime-this.raw[0].endTime>this.bufferSize;)this.raw.shift().samples.length=0,0}}();
"use strict";G.Geo={delandaz2coord:function(a,t,h,M){h*=G.Geo.PI180,M*=G.Geo.PI180,t*=G.Geo.PI180,a*=G.Geo.PI180;var o=Math.asin(Math.sin(h)*Math.cos(a)+Math.cos(h)*Math.sin(a)*Math.cos(t)),h=M+Math.atan2(Math.sin(t)*Math.sin(a)*Math.cos(h),Math.cos(a)-Math.sin(h)*Math.sin(o));return[o*G.Geo.iPI180,h*G.Geo.iPI180]},delazi:function(a,t,h,M){var o,s,e,i,n,I,P,c,r,u;return a===h&&t===M?o=s=e=0:(a*=G.Geo.PI180,t*=G.Geo.PI180,h*=G.Geo.PI180,M*=G.Geo.PI180,P=.5*Math.PI-h,u=.5*Math.PI-a,i=t-M,n=Math.cos(P),I=Math.cos(u),c=Math.sin(P),P=n*I+(r=Math.sin(u))*c*Math.cos(i),o=Math.acos(P),u=Math.sin(o),s=Math.acos((n-I*P)/(r*u)),e=Math.acos((I-n*P)/(c*u)),(isNaN(s)||isNaN(e))&&Math.abs(M-t)<1e-6?e=h<a?(s=Math.PI,0):(s=0,Math.PI):Math.sin(i)<0?e=Math.PI+Math.PI-e:s=Math.PI+Math.PI-s),{dist:o*G.Geo.iPI180,az:s*G.Geo.iPI180,baz:e*G.Geo.iPI180}},deg2km:function(a){return 111.13291490135191*a},km2deg:function(a){return.00899823423949294*a}},G.Geo.PI180=Math.PI/180,G.Geo.iPI180=180/Math.PI;
"use strict";!function(){function k(e,t,r,a){var n=function(e,t,r){var a=e[r];if(!a)for(var n=t.length,o=0;o<n;++o){var i=t[o];if(i.publicID===r){e[(a=i).publicID]=a;break}}return a}(t,r,a);if(!n)return!1;var o=!1;if(n.baseID&&(o=k(e,t,r,n.baseID)||o),!n.parameter)return o;for(var i=n.parameter.length,d=0;d<i;++d){var s=n.parameter[d];s.name&&(e[s.name]=s.value,o=!0)}return o}G.Bindings=function(e,t,r,a){this.networks={};var n={};if(e.module)for(var o=e.module.length,i=0;i<o;++i){var d=e.module[i];if(d.enabled&&d.name===t&&d.station){for(var s=d.station.length,f=0;f<s;++f){var c=d.station[f];if(c.networkCode&&c.stationCode){for(var m,u,v=c.setup.length,l=0;l<v;++l){var w=c.setup[l];if(w.enabled){if(w.name===r){m=w;break}a&&"default"===w.name&&(m=w)}}!m||k(u={},n,e.parameterSet,m.parameterSetID)&&(this.networks[c.networkCode]||(this.networks[c.networkCode]={}),this.networks[c.networkCode][c.stationCode]=u)}}break}}},G.Bindings.prototype={getParams:function(e,t){e=this.networks[e];if(e)return e[t]},injectDetecStream:function(e,t){for(var r=e.network?e.network.length:0,a=0;a<r;++a){var n=e.network[a];if(!(new Date(n.start)>t)&&!(n.end&&new Date(n.end)<t))for(var o=n.station.length,i=0;i<o;++i){var d,s=n.station[i];new Date(s.start)>t||s.end&&new Date(s.end)<t||(d=this.getParams(n.code,s.code))&&(d.detecStream&&(s.detecStream=d.detecStream,s.detecStream.length<3&&(s.detecStream+="Z")),d.detecLocid&&(s.detecLocid=d.detecLocid))}}}}}();
angular.element(document).ready(function(){document.getElementById("app").style.display="block"});var traceview=angular.module("TraceView",["browsercheck","timeseries","mapwidget-ll","notice-service","quakelink","recordstream"]);
traceview.controller("Ctrl",["$scope","$http","$timeout","$interval","gmNotice","quakelink","recordstream",function(c,t,u,e,f,r,o){var i;c.applyFilter=function(e){if(e)if(c.viewOptions.useFilter=!0,c.currentFilter!==e[1])for(var t in c.currentFilter=e[1],c.traces){var r=c.currentFilter.clone();c.traces[t].buffer.setFilter(r),c.traces[t].data[0].records=c.traces[t].buffer.filtered}else for(t in c.traces)c.traces[t].data[0].records=c.traces[t].buffer.filtered;else for(t in c.viewOptions.useFilter=!1,c.traces)c.traces[t].data[0].records=c.traces[t].buffer.raw};var n=!(c.toggleMap=function(){c.viewOptions.showMap=!c.viewOptions.showMap});c.setConfigVisibility=function(e){"hide"===e?(n=!1,c.viewOptions.showMap?c.viewOptions.showConfig=!0:u(function(){n||(c.viewOptions.showConfig=!1)},300)):(n=!0,c.viewOptions.showConfig=!0)},c.resetView=function(){var e=new Date,t=new Date(e.getTime()-c.bufferSize);c.lastTimeStep=e,c.status.xaxis.max=e.getTime(),c.status.xaxis.min=t.getTime(),c.rulerOptions.xaxis.min=c.status.xaxis.min,c.rulerOptions.xaxis.max=c.status.xaxis.max,c.options.xaxis.referenceTime=e,c.viewOptions.minHeight=30},c.incRowSize=function(){var e=2*c.viewOptions.minHeight;c.viewOptions.minHeight=e=1e3<e?1e3:e},c.decRowSize=function(){var e=c.viewOptions.minHeight/2;c.viewOptions.minHeight=e=e<30?30:e},c.eventTimeout=10,c.qlConf={tspan:c.eventTimeout/60},c.fetchEvents=function(){c.poller=r.createStream(c.config.quakelinkURL,c.qlConf),c.poller.receive(function(e){var t=c.currentEvent;angular.forEach(e,function(e){(!t||e.otime>t.otime||e.eventID===t.eventID)&&(t=e)}),c.setCurrentEvent(t)}).error(function(e,t){0===t?(f.warning("Quakelink","Server not reachable. Next try in 10s.",5e3),u(function(){c.poller.resume()},1e4)):500<=t&&t<600?u(function(){c.poller.resume()},1e3):f.error("Quakelink","No events available. Contact your administrator!",5e3)}).start()},c.fetchStations=function(){c.progressMsg="Station information requested, hold on a second ...",t.get(c.config.serverAPI+"query/stations.json").then(function(e){e=e.data;e.Inventory?(c.tmpInventory=e.Inventory,c.fetchBindings()):f.error("Load stations","No stations available"),void 0!==c.progress&&(c.progress=50,u(function(){delete c.progress},500))}).catch(function(e){f.error("Load stations","Error "+e.status+": "+e.data+"Trying again in 10 seconds."),u(c.fetchStations,1e4)})},c.fetchBindings=function(){c.progressMsg="Bindings requested, hold on a second ...",t.get(c.config.serverAPI+"query/config.json").then(function(e){e=e.data;e.Config?(c.bindings=new G.Bindings(e.Config,"trunk","gaps",!0),c.fetchObjects(),c.fetchEvents(),c.bindings.injectDetecStream(c.tmpInventory)):f.error("Load bindings","No bindings available"),c.inventory=c.tmpInventory,(c.tmpInventory=void 0)!==c.progress&&(c.progress=100,u(function(){delete c.progress},500))}).catch(function(e){f.error("Load bindings","Error "+e.status+": "+e.data+"Trying again in 10 seconds."),u(c.fetchBindings,1e4)})},c.addPickToTrace=function(e){var t=e._time;try{var r=e.waveformID.networkCode+"."+e.waveformID.stationCode;if(r in c.traceStationMap){var i,n=c.traceStationMap[r];try{i=e.phaseHint.code}catch(e){i=""}n.markers.push({x:t,type:"P",annotation:i})}}catch(e){}},c.fetchObjects=function(e){t.get(c.config.serverAPI+"query/objects.json"+(e?"?last="+encodeURIComponent(e):"")).then(function(e){var t=e.data;if(t.request&&t.request.objects&&t.request.objects.list){for(var r,i=(new Date).getTime(),n=[],s=0;s<t.request.objects.list.length;++s){var a,o=t.request.objects.list[s];o.Pick&&(a=o.Pick.time.value)&&(i-(a=new Date(o.Pick.time.value).getTime())>c.bufferSize||(o.Pick._time=a,c.picks.push(o.Pick),c.addPickToTrace(o.Pick),n.push(o.Pick)))}0<n.length&&c.mapInterface.map.addTriggers(n),t.request.objects.id&&(r=t.request.objects.id,u(function(){c.fetchObjects(r)},2e3))}else f.error("Listener","Got unexpected reply? Wrong protocol version? Stopping listener.")}).catch(function(e){0===e.status?f.error("Listener","Lost connection.Trying again in 10 seconds."):f.error("Listener","Error "+e.status+": "+e.data+"Trying again in 10 seconds."),u(c.fetchObjects,1e4)})},c.showData=function(){c.requests={ids:[],streams:[]},c.rs&&(c.rs.cancel(),c.rs=null);try{for(var e=0;e<c.inventory.network.length;++e){for(var t=c.inventory.network[e],r=0;r<t.station.length;++r){var i=t.station[r];if(i._selected&&i.detecStream){if(100<=c.requests.ids.length)break;var n=t.code+"."+i.code+"."+(i.detecLocid||"")+"."+i.detecStream;c.requests.ids.push(n),c.requests.streams.push({id:n,net:t,sta:i})}}if(100<=c.requests.ids.length)break}}catch(e){}0<c.requests.ids.length&&(c.viewOptions.showMap=!1,c.viewOptions.showConfig=!0,c.viewOptions.showNotes=!1),c.fetchData()},c.fetchData=function(){if(c.rs)f.error("Data acquisition","Already active");else{if(0===c.requests.ids.length)return f.error("Data acquisition","No stations selected"),c.traces=[],c.orderedTraces=[],c.traceMap={},c.traceStationMap={},c.rowCount=0,void(c.layoutComplete=!1);for(var e=c.traces.length,t=0;t<e;++t)c.traces[t].buffer.clear();var n=[],s={},a={};for(t=0;t<c.requests.streams.length;++t){var r=new G.RecordBuffer(c.bufferSize,!0);c.currentFilter&&r.setFilter(c.currentFilter.clone());r={sid:c.requests.streams[t].id,net:c.requests.streams[t].net,sta:c.requests.streams[t].sta,buffer:r,data:[{records:c.viewOptions.useFilter?r.filtered:r.raw,options:c.traceOptions}],markers:[],isVisible:function(){return 0<this.data[0].records.length}};n.push(r),s[r.sid]=r,a[r.net.code+"."+r.sta.code]=r}c.traces.length=0,c.orderedTraces=[],c.traceMap={},c.traceStationMap={},c.rowCount=0,c.layoutComplete=!1,u(function(){c.traces=n,c.traceMap=s,c.traceStationMap=a,c.orderedTraces=[],c.setCurrentEvent(c.currentEvent);for(var e=c.filters.length,t=0;t<e;++t){var r=c.filters[t];if(2<r.length&&r[2]){c.applyFilter(r);break}}for(t=0;t<c.picks.length;++t)c.addPickToTrace(c.picks[t]);var i=new Date;i.setTime(i.getTime());i=new Date(i.getTime()-c.bufferSize);c.rs=o.run(c.config.serverAPI,c.config.serverWSAPI,c.requests.ids,{start:i,forceHTTP:c.config.forceHTTP}),c.rs.promise.then(function(e){c.rs=null,"Disconnected"===e||"Error"===e?u(c.fetchData,1e4):"Proxy"===e&&u(c.fetchData,1e3)},function(e){f.error("Acquisition","Error "+status+": "+e)},function(e){c.feedData(e)})},400)}},c.feedData=function(e){for(var t in e){var r,i,n=e[t];n.sid in c.traceMap?(i=c.traceMap[n.sid]).buffer.feed(n):(r=new G.RecordBuffer(c.bufferSize,!0),c.currentFilter&&r.setFilter(c.currentFilter.clone()),r.feed(n),t=c.viewOptions.useFilter?r.filtered:r.raw,i={sid:n.sid,buffer:r,data:[{records:t,options:c.traceOptions}],markers:[],isVisible:function(){return 0<this.data[0].records.length}},c.traces.push(i),c.traceMap[n.sid]=i)}},c.traceLayoutComplete=function(){c.layoutComplete=!0},c.setCurrentEvent=function(e){if(e&&.001*((new Date).getTime()-e.otime)>=60*c.eventTimeout)return;c.currentEvent=e;var t,r=c.traces.length;if(c.currentEvent?c.mapEvents=[c.currentEvent]:c.mapEvents=null,c.currentEvent){for(c.orderedTraces=[],t=0;t<r;++t){for(var i=c.traces[t],n=!1,s=0;s<i.markers.length;++s)"E"===i.markers[s].type&&(n?(i.markers.splice(s,1),--s):(i.markers[s].x=c.currentEvent.otime,n=!(i.markers[s].annotation=null)));n||i.markers.push({x:c.currentEvent.otime,type:"E",annotation:null});try{i.dist=G.Geo.delazi(c.currentEvent.lat,c.currentEvent.lon,i.sta.latitude,i.sta.longitude).dist}catch(e){i.dist=999}c.orderedTraces.push(i)}c.rulerMarkers=[{x:c.currentEvent.otime,type:"E",annotation:c.currentEvent.region+(c.currentEvent.mag?" M"+c.currentEvent.mag.toFixed(1):"")}],c.orderedTraces.sort(function(e,t){return e.dist-t.dist})}else{for(t=0;t<r;++t)for(i=c.traces[t],s=0;s<i.markers.length;++s)"E"===i.markers[s].type&&(i.markers.splice(s,1),--s);c.rulerMarkers=[],c.orderedTraces=c.traces}},c.stepData=function(){var e,t,r=c.status.xaxis.max-c.status.xaxis.min,i=(new Date).getTime(),n=i-c.lastTimeStep;for(c.lastTimeStep=i,c.status.xaxis.max+=n,c.status.xaxis.min=c.status.xaxis.max-r,c.rulerOptions.xaxis.min=c.status.xaxis.min,c.rulerOptions.xaxis.max=c.status.xaxis.max,c.options.xaxis.referenceTime=i,a=0;a<c.picks.length;++a)i-c.picks[a]._time>c.bufferSize&&(c.picks.splice(a,1),--a);for(t in c.traceMap)for(var s=c.traceMap[t],a=0;a<s.markers.length;++a)"P"===s.markers[a].type&&i-s.markers[a].x>c.bufferSize&&(s.markers.splice(a,1),--a);if(c.currentEvent&&.001*(i-c.currentEvent.otime)>=60*c.eventTimeout&&c.setCurrentEvent(null),c.orderedTraces)for(e=c.orderedTraces.length,a=c.rowCount=0;a<e;++a)c.orderedTraces[a].isVisible()&&++c.rowCount},c.progress=0,c.bufferSize=6e5,c.mapInterface={},c.map=null,c.currentEvent=null,c.config={serverAPI:"../",map:{triggerDuration:c.bufferSize,currentPosition:!0,mapURI:"",maxZoom:12,eventHours:1,showEvents:!0}};var l={P:{color:"#f00",lineWidth:2},E:{color:"#080",lineWidth:1}};c.options={interactive:!1,xaxis:{ruler:{enable:!1}},yaxis:{autoScale:!0},grid:{show:!0},marker:l},c.rulerMarkers=[],c.traceOptions={color:"#888",optimize:!0},c.viewOptions={minHeight:30,showMap:!0,showNotes:!0,useFilter:!1,mapSelect:!0,showConfig:!0};var p=new Date;c.mapEvents=[],c.status={},c.traces=[],c.traceMap={},c.traceStationMap={},c.rowCount=0,c.requests={ids:[],streams:[]},c.picks=[],c.filters=[],c.$watch("status",function(e,t){c.status.xaxis&&(c.options.xaxis.min=c.status.xaxis.min,c.options.xaxis.max=c.status.xaxis.max)},!0),c.lastTimeStep=p.getTime(),i=e(c.stepData,1e3),c.progressMsg="Configuring TraceView ...",t.get("config.json?app=traceview").then(function(e){var t=e.data;if(c.config.quakelinkURL=t.traceview.quakelink,c.config.serverAPI=t.traceview.serverAPI,c.config.serverWSAPI=t.traceview.serverWSAPI||t.traceview.serverAPI,c.config.forceHTTP=t.traceview.forceHTTP,c.config.map.mapURI=t.traceview.mapURI,c.config.map.maxZoom=t.traceview.mapMaxZoom,c.config.map.maxLevel=t.traceview.mapMaxLevel,t.traceview.mapBounds&&(c.config.map.maxBounds=t.traceview.mapBounds),c.filters=[],t.traceview.filters)for(var r=t.traceview.filters.length,i=0;i<r;++i){var n=t.traceview.filters[i].indexOf(";");if(!(n<0)){var s=t.traceview.filters[i].substr(0,n),a=null;try{a=G.Filter.build(t.traceview.filters[i].substr(n+1))}catch(e){f.error("Filter","'"+s+"' ignored: "+e.toString())}a&&("@"===s[0]?c.filters.push([s.substr(1),a,!0]):c.filters.push([s,a]))}}t.traceview.timeSpan&&(c.bufferSize=1e3*t.traceview.timeSpan);e=new Date(p.getTime()-c.bufferSize);c.rulerOptions={xaxis:{min:e.getTime()+1e3,max:p.getTime()+1e3,ruler:{enable:!0,drawMarker:!0}},marker:l},c.initMap=!0,c.progress=50,c.fetchStations()}).catch(function(e){notice.error("Init","Loading settings failed.")}),c.$on("$destroy",function(){angular.isDefined(i)&&(e.cancel(i),i=void 0)})}]);
traceview.directive("jqShow",["$timeout",function(r){return{restrict:"A",link:function(e,a,d){var i=e.$eval(d.jqOptions),t={type:"fade",duration:200,delay:0,fadeDelay:0,hideImmediately:!1,callback:null};$.extend(t,i);var n=t.type,l=t.duration,o=t.callback,f=t.delay,c=t.hideImmediately,u=a;e.$watch(d.jqShow,function(e){c&&!e?u.hide(0,o):r(function(){"fade"===n?e?t.fadeDelay?u.fadeTo(0,0,function(){r(function(){u.fadeTo(l,1,o)},t.fadeDelay)}):u.fadeIn(l,o):u.fadeOut(l,o):"slide"===n?e?u.slideDown(l,o):u.slideUp(l,o):e?u.show(l,o):u.hide(l,o)},f)})}}}]);
