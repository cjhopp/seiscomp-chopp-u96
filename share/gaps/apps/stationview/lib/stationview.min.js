"use strict";var G={};
"use strict";G.TravelTimes={P:{maxDist:110,step:5,table:[[0,.00110045],[5,76.3638],[10,145.064],[15,213.475],[20,274.431],[25,325.825],[30,370.752],[35,414.491],[40,456.858],[45,497.58],[50,536.543],[55,573.692],[60,609.029],[65,642.548],[70,674.246],[75,704.112],[80,732.108],[85,758.199],[90,782.284],[95,805.343],[100,827.742],[105,848.961],[110,871.155]]},S:{maxDist:15,step:5,table:[[0,.00189813],[5,136.057],[10,259.397],[15,381.772]]},maxTime:function(){return Math.max(this.P.table[this.P.table.length-1][1],this.S.table[this.S.table.length-1][1])},getDist:function(t,i){for(var e=t.table.length,s=0;s<e;++s){var a=t.table[s];if(i<=a[1]){if(0===s)return a[0];var r=t.table[s-1][0],o=a[0],h=t.table[s-1][1];return(o-r)*(i-h)/(a[1]-h)+r}}return-1}},G.TravelTimes.Decorator=function(t,i){this.deltaAzi=t,this.phase=i,this.points=[],this.points.length=360/t+1|0,this.time=0,this.lat=0,this.lon=0,this.maxDist=-1},G.TravelTimes.Decorator.prototype.setCenter=function(t,i){this.lat=t,this.lon=i,this.maxDist=90-Math.abs(t)},G.TravelTimes.Decorator.prototype.setTime=function(t){this.time=t},G.TravelTimes.Decorator.prototype.step=function(t){this.time+=t},G.TravelTimes.Decorator.prototype.update=function(){var t,i=this.points.length-1,e=G.TravelTimes.getDist(this.phase,this.time);if(e<0)return!1;if(0<=this.maxDist&&e>this.maxDist)return!1;for(t=0;t<i;++t)this.points[t]=G.Geo.delandaz2coord(e,this.deltaAzi*t,this.lat,this.lon);return this.points[i]=this.points[0],!0};
"use strict";G.Geo={delandaz2coord:function(a,t,h,M){h*=G.Geo.PI180,M*=G.Geo.PI180,t*=G.Geo.PI180,a*=G.Geo.PI180;var o=Math.asin(Math.sin(h)*Math.cos(a)+Math.cos(h)*Math.sin(a)*Math.cos(t)),h=M+Math.atan2(Math.sin(t)*Math.sin(a)*Math.cos(h),Math.cos(a)-Math.sin(h)*Math.sin(o));return[o*G.Geo.iPI180,h*G.Geo.iPI180]},delazi:function(a,t,h,M){var o,s,e,i,n,I,P,c,r,u;return a===h&&t===M?o=s=e=0:(a*=G.Geo.PI180,t*=G.Geo.PI180,h*=G.Geo.PI180,M*=G.Geo.PI180,P=.5*Math.PI-h,u=.5*Math.PI-a,i=t-M,n=Math.cos(P),I=Math.cos(u),c=Math.sin(P),P=n*I+(r=Math.sin(u))*c*Math.cos(i),o=Math.acos(P),u=Math.sin(o),s=Math.acos((n-I*P)/(r*u)),e=Math.acos((I-n*P)/(c*u)),(isNaN(s)||isNaN(e))&&Math.abs(M-t)<1e-6?e=h<a?(s=Math.PI,0):(s=0,Math.PI):Math.sin(i)<0?e=Math.PI+Math.PI-e:s=Math.PI+Math.PI-s),{dist:o*G.Geo.iPI180,az:s*G.Geo.iPI180,baz:e*G.Geo.iPI180}},deg2km:function(a){return 111.13291490135191*a},km2deg:function(a){return.00899823423949294*a}},G.Geo.PI180=Math.PI/180,G.Geo.iPI180=180/Math.PI;
"use strict";!function(){function _(t,h){return[[t[0][0]*h[0][0]+t[1][0]*h[0][1]+t[2][0]*h[0][2],t[0][1]*h[0][0]+t[1][1]*h[0][1]+t[2][1]*h[0][2],t[0][2]*h[0][0]+t[1][2]*h[0][1]+t[2][2]*h[0][2]],[t[0][0]*h[1][0]+t[1][0]*h[1][1]+t[2][0]*h[1][2],t[0][1]*h[1][0]+t[1][1]*h[1][1]+t[2][1]*h[1][2],t[0][2]*h[1][0]+t[1][2]*h[1][1]+t[2][2]*h[1][2]],[t[0][0]*h[2][0]+t[1][0]*h[2][1]+t[2][0]*h[2][2],t[0][1]*h[2][0]+t[1][1]*h[2][1]+t[2][1]*h[2][2],t[0][2]*h[2][0]+t[1][2]*h[2][1]+t[2][2]*h[2][2]]]}G.Tensor=function(t,h,s){var i=Math.PI*h/180,M=Math.PI*t/180,a=Math.PI*s/180,n=-Math.sin(i)*Math.sin(M),o=Math.sin(i)*Math.cos(M),r=-Math.cos(i),h=Math.cos(a)*Math.cos(M)+Math.cos(i)*Math.sin(a)*Math.sin(M),t=Math.cos(a)*Math.sin(M)-Math.cos(i)*Math.sin(a)*Math.cos(M),s=-Math.sin(i)*Math.sin(a);this._11=2*h*n,this._12=h*o+t*n,this._13=h*r+s*n,this._22=2*t*o,this._23=t*r+s*o,this._33=2*s*r;s=(this._11+this._22+this._33)/3;this.Mxx=this._11-s,this.Myy=this._22-s,this.Mzz=this._33-s;r=Math.cos(a),s=Math.sin(a),a=[[r,s,0],[-s,r,0],[0,0,1]],i=[[1,0,0],[0,r=Math.cos(i),s=Math.sin(i)],[0,-s,r]];r=Math.cos(M),s=Math.sin(M),this.Mrot=_(_([[-r,-s,0],[-s,r,0],[0,0,1]],i),a)},G.Tensor.prototype.norm=function(){return Math.sqrt(this._11*this._11+this._22*this._22+this._33*this._33+2*(this._12*this._12+this._13*this._13+this._23*this._23))},G.Tensor.prototype.sign=function(t,h,s){return t*t*this.Mxx+h*h*this.Myy+s*s*this.Mzz+2*(t*h*this._12+t*s*this._13+h*s*this._23)},G.Tensor.prototype.render=function(t,h,s,i,M,a,n){var o,r,_,c,e,u=t.width,f=t.height,y=t.data,p=1/((.5*Math.min(u,f)|0)-2*M),a=a*p,v=1/a,T=1.5*p,q=1/T,x=(1-a)*(1-a),z=(1+a)*(1+a),G=-(.5*u-.5)*p,a=-(.5*f-.5)*p,d=(this.norm(),a),g=0,m=[0,0,0,0],I=[-1,1,-2],a=1/Math.sqrt(I[0]*I[0]+I[1]*I[1]+I[2]*I[2]);I[0]*=a,I[1]*=a,I[2]*=a;var P,l,w,Q,R=[];for(R.length=3,_=0;_<f;++_,d+=p)for(var S=G,b=0;b<u;++b,S+=p){var j,k,A,B,C=S*S+d*d;1<C?C<=z?(o=(Math.sqrt(C)-1)*v,o*=o,y[g++]=i[0],y[g++]=i[1],y[g++]=i[2],y[g++]=(1-o)*i[3]|0):g+=4:(B=1/(1+C),A=Math.SQRT2*B,P=R,l=this.Mrot,w=j=d*A,Q=k=-S*A,B=A=-(1-C)*B,P[0]=l[0][0]*w+l[0][1]*Q+l[0][2]*B,P[1]=l[2][0]*w+l[2][1]*Q+l[2][2]*B,P[2]=l[1][0]*w+l[1][1]*Q+l[1][2]*B,B=0<=R[0]*R[1]?h:s,0<R[0]&&R[0]<T&&(e=0<R[1]?(c=h,s):(c=s,h),o=R[0]*q,m[0]=e[0]*(r=1-o)+c[0]*o|0,m[1]=e[1]*r+c[1]*o|0,m[2]=e[2]*r+c[2]*o|0,m[3]=e[3]*r+c[3]*o|0,B=m),0<R[1]&&R[1]<T&&(e=0<R[0]?(c=h,s):(c=s,h),o=R[1]*q,m[0]=e[0]*(r=1-o)+c[0]*o|0,m[1]=e[1]*r+c[1]*o|0,m[2]=e[2]*r+c[2]*o|0,m[3]=e[3]*r+c[3]*o|0,B=m),n&&((o=.5*(j*I[0]+k*I[1]+A*I[2])+.75)<0&&(o=0),m[0]=B[0]*o|0,m[1]=B[1]*o|0,m[2]=B[2]*o|0,m[3]=B[3],B=m),x<C&&(o=(Math.sqrt(C)-1)*v+1,(o=1<(o*=o)?1:o)<0&&(o=0),m[0]=B[0]*(r=1-o)+i[0]*o|0,m[1]=B[1]*r+i[1]*o|0,m[2]=B[2]*r+i[2]*o|0,m[3]=B[3]*r+i[3]*o|0,B=m),y[g++]=B[0],y[g++]=B[1],y[g++]=B[2],y[g++]=B[3])}}}();
"use strict";G.Inventory=function(t){this._data=t},G.Inventory.prototype={matchEpoch:function(t,n){return!(new Date(t.start)>n)&&!(t.end&&new Date(t.end)<n)},data:function(){return this._data},findNetwork:function(t,n){for(var r=this._data.network.length,e=0;e<r;++e){var a=this._data.network[e];if(a.code===t&&this.matchEpoch(a,n))return a}return null},findStation:function(t,n,r){var e;if("string"==typeof t){if(!(e=this.findNetwork(t,r)))return null}else e=t;if(e.station)for(var a=e.station.length,i=0;i<a;++i){var o=e.station[i];if(o.code===n&&this.matchEpoch(o,r))return o}return null},findSensorLocation:function(t,n,r,e){var a;if("string"==typeof n){if(!(a=this.findStation(t,n,e)))return null}else a=n;if(a.sensorLocation)for(var i=a.sensorLocation.length,o=0;o<i;++o){var s=a.sensorLocation[o];if(s.code===r&&this.matchEpoch(s,e))return s}return null},findStream:function(t,n,r,e,a){var i;if("string"==typeof r){if(!(i=this.findSensorLocation(t,n,r,a)))return null}else i=r;if(i.stream)for(var o=i.stream.length,s=0;s<o;++s){var h=i.stream[s];if(h.code===e&&this.matchEpoch(h,a))return h}return null},getThreeComponents:function(t,n,r){n.length;var e,a,i=-100,o=100,s=100,h=[null,null,null],f=[0,0,0],u=[0,0,0],c=[0,0,0];if(!t.stream)return h;for(a=t.stream.length,e=0;e<a;++e){var l,d,v,M,m=t.stream[e];m.end&&new Date(m.end)<r||new Date(m.start)>r||!function(t,n){var r,e=t.length,a=n.length;if(!(e<a)){for(r=0;r<a;++r)if(t[r]!==n[r])return;return 1}}(m.code,n)||void 0===m.azimuth||void 0===m.dip||(l=Math.PI*m.azimuth/180,d=Math.PI*m.dip/180,v=Math.sin(-d),i<(M=Math.abs(v))&&(i=M,h[0]=m,f[0]=Math.cos(-d)*Math.sin(l),f[1]=Math.cos(-d)*Math.cos(l),f[2]=v),M<o?(h[1]=m,o=M,u[0]=Math.cos(-d)*Math.sin(l),u[1]=Math.cos(-d)*Math.cos(l),u[2]=v):M<s&&(h[2]=m,s=M,c[0]=Math.cos(-d)*Math.sin(l),c[1]=Math.cos(-d)*Math.cos(l),c[2]=v))}if(h[0]===h[1])return h[1]=h[2],h[2]=null,h;if(!h[0]||!h[2])return h;var p=[0,0,0];return p[0]=u[1]*c[2]-u[2]*c[1],p[1]=u[2]*c[0]-u[0]*c[2],p[2]=u[0]*c[1]-u[1]*c[0],0<p[0]*f[0]+p[1]*f[1]+p[2]*f[2]&&(p=h[1],h[1]=h[2],h[2]=p),h}};
"use strict";G.EventBuffer=function(t){this._bufferSize=t,this._addedCallback=null,this._updatedCallback=null,this._removedCallback=null,this._force=!1,this._revision=0,this.pool={},this.first=void 0,this.last=void 0,this.latest=null},G.EventBuffer.prototype.getBufferSize=function(){return this._bufferSize},G.EventBuffer.prototype.added=function(t){return this._addedCallback=t,this},G.EventBuffer.prototype.updated=function(t){return this._updatedCallback=t,this},G.EventBuffer.prototype.removed=function(t){return this._removedCallback=t,this},G.EventBuffer.prototype.feed=function(t,e){return!!t.eventID&&(e=e||new Date,!!(t=this._push(t,e))&&(this._removeExpiredEvents(e),!0))},G.EventBuffer.prototype.feedList=function(t){for(var e=new Date,i=t.length,s=!1,o=0;o<i;++o)t[o].eventID&&this._push(t[o],e)&&(s=!0);return s&&this._removeExpiredEvents(e),s},G.EventBuffer.prototype._rejectEvent=function(t,e){return t.otime<e.getTime()-this._bufferSize},G.EventBuffer.prototype._push=function(t,e){var i;return t.deleted||this._rejectEvent(t,e)?t.eventID in this.pool?(i=this.pool[t.eventID],delete this.pool[t.eventID],++this._revision,this._removedCallback&&this._removedCallback(i),this._force=!0,i):null:(t.eventID in this.pool?(function(t,e){for(var i in e)"_"!==i[0]&&"$"!==i[0]&&e.hasOwnProperty(i)&&(t[i]=e[i]);for(i in t)"_"!==i[0]&&"$"!==i[0]&&(e.hasOwnProperty(i)||delete t[i])}(i=this.pool[t.eventID],t),this._updatedCallback&&this._updatedCallback(i)):(this.pool[(i=t).eventID]=t,++this._revision,this._addedCallback&&this._addedCallback(i)),(!this.first||this.first>i.otime)&&(this.first=i.otime),(!this.last||this.last<i.otime)&&(this.last=i.otime,this.latest=i),i)},G.EventBuffer.prototype._removeExpiredEvents=function(t){if(this._force||!(t.getTime()-this.first<=this._bufferSize)){this._force=!1;var e,i=t.getTime()-this._bufferSize;for(e in this.first=void 0,this.last=void 0,this.latest=null,this.pool){var s=this.pool[e];s.otime<i?(this._removedCallback&&this._removedCallback(s),delete this.pool[e],++this._revision):((void 0===this.first||s.otime<this.first)&&(this.first=s.otime),(void 0===this.last||s.otime>this.last)&&(this.last=s.otime,this.latest=s))}}};
"use strict";!function(){function k(e,t,r,a){var n=function(e,t,r){var a=e[r];if(!a)for(var n=t.length,o=0;o<n;++o){var i=t[o];if(i.publicID===r){e[(a=i).publicID]=a;break}}return a}(t,r,a);if(!n)return!1;var o=!1;if(n.baseID&&(o=k(e,t,r,n.baseID)||o),!n.parameter)return o;for(var i=n.parameter.length,d=0;d<i;++d){var s=n.parameter[d];s.name&&(e[s.name]=s.value,o=!0)}return o}G.Bindings=function(e,t,r,a){this.networks={};var n={};if(e.module)for(var o=e.module.length,i=0;i<o;++i){var d=e.module[i];if(d.enabled&&d.name===t&&d.station){for(var s=d.station.length,f=0;f<s;++f){var c=d.station[f];if(c.networkCode&&c.stationCode){for(var m,u,v=c.setup.length,l=0;l<v;++l){var w=c.setup[l];if(w.enabled){if(w.name===r){m=w;break}a&&"default"===w.name&&(m=w)}}!m||k(u={},n,e.parameterSet,m.parameterSetID)&&(this.networks[c.networkCode]||(this.networks[c.networkCode]={}),this.networks[c.networkCode][c.stationCode]=u)}}break}}},G.Bindings.prototype={getParams:function(e,t){e=this.networks[e];if(e)return e[t]},injectDetecStream:function(e,t){for(var r=e.network?e.network.length:0,a=0;a<r;++a){var n=e.network[a];if(!(new Date(n.start)>t)&&!(n.end&&new Date(n.end)<t))for(var o=n.station.length,i=0;i<o;++i){var d,s=n.station[i];new Date(s.start)>t||s.end&&new Date(s.end)<t||(d=this.getParams(n.code,s.code))&&(d.detecStream&&(s.detecStream=d.detecStream,s.detecStream.length<3&&(s.detecStream+="Z")),d.detecLocid&&(s.detecLocid=d.detecLocid))}}}}}();
!function(r){"use strict";var i=r||{},e=navigator.userAgent;i.ISFF=-1!=e.indexOf("Firefox"),i.ISOPERA=-1!=e.indexOf("Opera"),i.ISCHROME=-1!=e.indexOf("Chrome"),i.ISSAFARI=-1!=e.indexOf("Safari")&&!i.ISCHROME,i.ISWEBKIT=-1!=e.indexOf("WebKit"),i.ISIE=0<e.indexOf("Trident")||0<navigator.userAgent.indexOf("MSIE"),i.ISIE6=0<e.indexOf("MSIE 6"),i.ISIE7=0<e.indexOf("MSIE 7"),i.ISIE8=0<e.indexOf("MSIE 8"),i.ISIE9=0<e.indexOf("MSIE 9"),i.ISIE10=0<e.indexOf("MSIE 10"),i.ISOLD=i.ISIE6||i.ISIE7||i.ISIE8,i.ISIE11UP=-1==e.indexOf("MSIE")&&0<e.indexOf("Trident"),i.ISIE10UP=i.ISIE10||i.ISIE11UP,i.ISIE9UP=i.ISIE9||i.ISIE10UP,r.module("browsercheck",[]).directive("browserCheck",function(){return{restrict:"E",template:'<div class="alert" ng-if="warn"><span ng-click="close()" class="close"><i class="icon glyphicon glyphicon-remove"></i></span><div class="symbol"><i class="icon glyphicon glyphicon-warning-sign"></i></div><div class="text"><strong>Your browser is not supported officially!</strong><br/>You can use it at your own risk but be aware that visual distortions or even browser crashes or freezes may occur. We recommend to use Firefox or Chromium.</div></div>',scope:{},link:function(i,e,n){i.warn=!r.ISFF&&!r.ISCHROME,i.close=function(){i.warn=!1}}}})}((window,window.angular));
"use strict";angular.module("quakelink",[]).factory("quakelink",["$http","$q",function(r,i){function p(e){var t,n=0,r=[1,4,5,6,7,10,11];if(t=/^(\d{4}|[+\-]\d{6})(?:-(\d{2})(?:-(\d{2}))?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(?:\.(\d+))?)?(?:(Z)|([+\-])(\d{2})(?::(\d{2}))?)?)?$/.exec(e)){for(var i,a=t[7].length,o=0;i=r[o];++o)t[i]=+t[i]||0;for(t[2]=(+t[2]||1)-1,t[3]=+t[3]||1,"Z"!==t[8]&&void 0!==t[9]&&(n=60*t[10]+t[11],"+"===t[9]&&(n=0-n)),o=a;o<3;++o)t[7]*=10;for(o=3;o<a;++o)t[7]/=10;return Date.UTC(t[1],t[2],t[3],t[4],t[5]+n,t[6],t[7])}return null}function a(e,t){if(window.ActiveXObject)(n=new ActiveXObject("Microsoft.XMLDOM")).async="false",n.loadXML(e);else{if(!document.implementation||!document.implementation.createDocument)return null;var n=(new DOMParser).parseFromString(e,"text/xml")}if(n.hasChildNodes())for(var r=0;r<n.childNodes.length;++r){var i=n.childNodes[r];if("seiscomp"===i.nodeName&&i.hasChildNodes())for(var a=0;a<i.childNodes.length;++a){var o=i.childNodes[a];if(o.nodeName===t)return o}}return null}function v(e,t){var n=[];if(!e.hasChildNodes())return n;for(var r=e.childNodes.length,i=0;i<r;++i)e.childNodes[i].nodeName===t&&n.push(e.childNodes[i]);return n}function m(e,t){if(!t||!e.hasChildNodes())return null;for(var n=e.childNodes.length,r=0;r<n;++r)if(e.childNodes[r].getAttribute("publicID")===t)return e.childNodes[r];return null}function g(e,t){if(!e.hasChildNodes())return null;for(var n=e.childNodes.length,r=0;r<n;++r)if(e.childNodes[r].nodeName===t){var i=e.childNodes[r];if(!i.hasChildNodes())return null;for(var a=i.childNodes.length,o=0;o<a;++o)if(3===i.childNodes[o].nodeType)return i.childNodes[o].data;break}return null}function o(r,e){var i=[];return angular.forEach(e,function(e,t){var n;switch(e=angular.isDate(e)?(n=e).getUTCFullYear()+","+(1+n.getUTCMonth())+","+n.getUTCDate()+","+n.getUTCHours()+","+n.getUTCMinutes()+","+n.getUTCSeconds()+","+n.getUTCMilliseconds():e,t){case"min":i.push(r+">="+e);break;case"max":i.push(r+"<"+e)}}),i.join(" and ")}function s(e){var n=[],r=["otime","lat","lon","depth","mag","tspan"];return angular.forEach(e,function(e,t){r.indexOf(t)<0||("tspan"===t?n.push(o("otime",{min:new Date(Date.now()-3600*e*1e3)})):n.push(o(t,e)))}),n.join(" and ")}function n(e,t){var n;this.url=e,this.url.endsWith("/")&&(this.url+="events/query"),this.query=(t=t,n=[],angular.isArray(t)?(angular.forEach(t,function(e){n.push("("+s(e)+")")}),n.join(" or ")):s(t)),this.needStop=!1,this.lastEventUpdate=this.rcb=this.ercb=null}return angular.extend(n.prototype,{start:function(){return this.canceller=i.defer(),this.lastEventUpdate=void 0,this.resume(),this},stop:function(){this.needStop=!0,this.canceller.resolve("stop")},resume:function(){var d=this,t=this.query;this.needStop=!1,function u(){var e=d.url;void 0===d.lastEventUpdate?e+="?archived":null!==d.lastEventUpdate&&(t="("+d.query+") and updated>"+d.lastEventUpdate),r.post(e,t,{timeout:d.canceller.promise}).then(function(e){if(200===e.status){var t=e.data,e=e.headers("Content-Type"),n=!1;if(e)for(var r=e.split(";"),i=r.length,a=0;a<i;++a){var o=r[a].trim();0===o.indexOf("version=")&&2<=(0|o.substr(8))&&(n=!0)}if(d.post=null,n)for(i=t.seiscomp.events.length,a=0;a<i;++a){var s=t.seiscomp.events[a];s.otime=new Date(s.otime).getTime(),s.updated=new Date(s.updated).getTime(),s.fm&&(s.fm.otime=new Date(s.fm.otime).getTime())}t.seiscomp.lastUpdate?d.lastEventUpdate=t.seiscomp.lastUpdate:d.lastEventUpdate=null,d.rcb&&d.rcb(t.seiscomp.events)}d.needStop?d.ercb&&d.ercb(t,"Poller stopped on demand."):u()}).catch(function(e){d.post=null,d.ercb&&d.ercb(e.data,e.status,d.needStop)})}()},receive:function(e){return this.rcb=e,this},error:function(e){return this.ercb=e,this}}),{createStream:function(e,t){if(void 0===t)throw new Error("You must pass at least one configuration object!");return new n(e,t)},getEventOnsets:function(e,t){var n=i.defer();return r.get(e+"?id="+t+"&include=picks,arrs").then(function(e){e=function(e,t){var n=[];if(t=m(e,t)){t=g(t,"preferredOriginID");if(t)for(var r=v(m(e,t),"arrival"),i=r.length,a=0;a<i;++a){var o,s,u,d,l,c=r[a],h=parseFloat(g(c,"distance")),f=g(c,"phase");f&&(o=1e3*parseFloat(g(c,"timeResidual")),!(s=m(e,g(c,"pickID")))||(d=v(s,"waveformID")).length&&(!(u=v(s,"time")).length||(l=(l=g(u[0],"value"))&&p(l))&&(s=(c=d[0]).getAttribute("networkCode")||"",u=c.getAttribute("stationCode")||"",d=c.getAttribute("locationCode")||"",c=c.getAttribute("channelCode")||"",n.push({net:s,sta:u,loc:d,cha:c.length<3?c+"Z":c,time:l,ph:f,residual:o,dist:h}))))}}return n}(a(e.data,"EventParameters"),t);e.sort(function(e,t){return e.time-t.time}),n.resolve(e)}).catch(function(e){n.reject(e.status)}),n.promise},shortPhaseName:function(e){for(var t=e.length-1;0<=t;--t)if(e[t]===e[t].toUpperCase())return e[t];return""},getEvent:function(e,t){var n=i.defer();return r.get(e+"?id="+t+"&include=picks,arrs").then(function(e){e=a(e.data,"EventParameters");n.resolve(e)}).catch(function(e){n.reject(e.status)}),n.promise},isoptime:p}}]);
"use strict";angular.module("recordstream",[]).factory("recordstream",["$q","$http","$timeout",function(e,D,s){return{run:function(p,f,h,g){var v="",w=e.defer(),m="Refused",q="WebSocket"in window;g.forceHTTP&&(q=!1);var y=null,t=null,j=!1;function n(e){return e<10?"0"+e:e}function T(e){return e.getUTCFullYear()+"-"+n(e.getUTCMonth()+1)+"-"+n(e.getUTCDate())+"T"+n(e.getUTCHours())+":"+n(e.getUTCMinutes())+":"+n(e.getUTCSeconds())}function r(){return v?(D.get(p+"query/streams/"+v+".json").then(function(e){e=e.data;0<e.request.records.length&&!j&&w.notify(e.request.records),e=null,m="Finished",t=s(r,0)}).catch(function(e){e.data;v=null,e.status<=0?(m="Disconnected",w.resolve(m)):502===e.status?(m="Proxy",w.resolve(m)):404===e.status?w.resolve(m):(v=null,m="Error",w.resolve(m,e.status))}),!0):(w.reject("No request to continue"),!1)}function C(e){D.post(p+"query/streams.json",e).then(function(e){e=e.data;v=e.request.id,0<e.request.records.length&&w.notify(e.request.records),e=null,r()}).catch(function(e){var t=e.data;e.status<=0||502===e.status?(m="Disconnected",w.resolve(m)):503===e.status?(m="Error",w.resolve(m)):w.reject(t)})}return{promise:w.promise,request:function(){if(!h||0===h.length)return w.reject("Empty request"),"";var e,t;g.start&&(e=T(g.start)),g.end&&(t=T(g.end));var n=[];g.spec&&n.push("spec=true"),g.spec&&g.raw&&n.push("raw=true"),g.specLength&&n.push("spec-window-length="+g.specLength),g.specOverlap&&n.push("spec-window-overlap="+g.specOverlap),g.specN&&n.push("spec-n-samples="+g.specN);for(var r,s,o,c,u=0;u<h.length;++u){var a,l,i,d=h[u];if(d instanceof Array?(a=d[0].split("."),1<d.length&&(l=T(d[1])),2<d.length&&(i=T(d[2]))):a=d.split("."),l=l||e,i=i||t,4!==a.length)return void w.reject("Invalid streamID: "+d);d=a[0]+" "+a[1]+" "+(a[2]||"--")+" "+a[3];l&&(d+=" "+l,i&&(d+=" "+i)),n.push(d)}return n=n.join("\n"),r=n,q?(y&&(y.close(),y=null),j=!1,"ws://"!==(s=f||p).slice(0,5)&&"wss://"!==s.slice(0,6)&&(c=-1!==(o=(c=window.location.pathname).lastIndexOf("/"))?c.substr(0,o+1):"/",c+=s,s=window.location.host+c,s="https:"===window.location.protocol?"wss://"+s:"ws://"+s),s+="query/streams",(y=new WebSocket(s,"acqui-json")).onopen=function(){if("acqui-json"!==y.protocol)return console.log("Protocol mismatch"),m="Wrong server protocol",void y.close();m="Finished",y.send(r)},y.onerror=function(e){w.resolve("Disconnected"),y=null},y.onmessage=function(e){if(!j)try{var t=JSON.parse(e.data);0<t.request.records.length&&w.notify(t.request.records)}catch(e){m=e.toString(),y.close()}},y.onclose=function(e){y=null,j||1006===e.code&&(m="Disconnected"),w.resolve(m)}):v?D.get(p+"purge/streams/"+v+".json").then(function(e){C(r)}).catch(function(e){console.error("Failed to purge request: "+e.data+"("+e.status+")"),C(r)}):C(r),n}(),cancel:function(){t&&(s.cancel(t),t=null),q?y&&(m="Cancelled",j=!0,y.close()):v&&(j=!0,D.get(p+"purge/streams/"+v+".json").then(function(e){}).catch(function(e){console.error("Failed to purge request: "+e.data+"("+e.status+")")}).finally(function(){w.resolve("Cancelled")}))}}}}}]);
!function(){"use strict";angular.module("gm.date",[]).factory("gmDate",function(){var e=!1;return{toLocalString:function(t,n){return new Date(t).strftime(n)},toUTCString:function(t,n){return new Date(t).strftime(n,!0)},toString:function(t,n,e){return new Date(t).strftime(n,e)},toDefaultString:function(t,n){return new Date(t).strftime(n,e)},setDefaultToLocal:function(){e=!1},setDefaultToUTC:function(){e=!0}}}).filter("gmdate",["gmDate",function(e){return function(t,n){return e.toDefaultString(t,n)}}])}();
!function(o){function t(e){var t=e||window.event,i=[].slice.call(arguments,1),a=0,n=0,r=0;return(e=o.event.fix(t)).type="mousewheel",t.wheelDelta&&(a=t.wheelDelta/120),r=a=t.detail?-t.detail/3:a,void 0!==t.axis&&t.axis===t.HORIZONTAL_AXIS&&(r=0,n=-1*a),void 0!==t.wheelDeltaY&&(r=t.wheelDeltaY/120),void 0!==t.wheelDeltaX&&(n=-1*t.wheelDeltaX/120),i.unshift(e,a,n,r),(o.event.dispatch||o.event.handle).apply(this,i)}var i=["DOMMouseScroll","mousewheel"];if(o.event.fixHooks)for(var e=i.length;e;)o.event.fixHooks[i[--e]]=o.event.mouseHooks;o.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var e=i.length;e;)this.addEventListener(i[--e],t,!1);else this.onmousewheel=t},teardown:function(){if(this.removeEventListener)for(var e=i.length;e;)this.removeEventListener(i[--e],t,!1);else this.onmousewheel=null}},o.fn.extend({mousewheel:function(e){return e?this.bind("mousewheel",e):this.trigger("mousewheel")},unmousewheel:function(e){return this.unbind("mousewheel",e)}})}(jQuery),function(m){m.fn.drag=function(e,t,i){var a="string"==typeof e?e:"",n=m.isFunction(e)?e:m.isFunction(t)?t:null;return 0!==a.indexOf("drag")&&(a="drag"+a),i=(e==n?t:i)||{},n?this.bind(a,i,n):this.trigger(a)};var u=m.event,a=u.special,h=a.drag={defaults:{which:1,distance:0,not:":input",handle:null,relative:!1,drop:!0,click:!1},datakey:"dragdata",noBubble:!0,add:function(e){var i=m.data(this,h.datakey),a=e.data||{};i.related+=1,m.each(h.defaults,function(e,t){void 0!==a[e]&&(i[e]=a[e])})},remove:function(){--m.data(this,h.datakey).related},setup:function(){var e;m.data(this,h.datakey)||(e=m.extend({related:0},h.defaults),m.data(this,h.datakey,e),u.add(this,"touchstart mousedown",h.init,e),this.attachEvent&&this.attachEvent("ondragstart",h.dontstart))},teardown:function(){(m.data(this,h.datakey)||{}).related||(m.removeData(this,h.datakey),u.remove(this,"touchstart mousedown",h.init),h.textselect(!0),this.detachEvent&&this.detachEvent("ondragstart",h.dontstart))},init:function(e){if(!h.touched){var t,i=e.data;if(!(0!=e.which&&0<i.which&&e.which!=i.which)&&!m(e.target).is(i.not)&&(!i.handle||m(e.target).closest(i.handle,e.currentTarget).length)&&(h.touched="touchstart"==e.type?this:null,i.propagates=1,i.mousedown=this,i.interactions=[h.interaction(this,i)],i.target=e.target,i.pageX=e.pageX,i.pageY=e.pageY,i.dragging=null,t=h.hijack(e,"draginit",i),i.propagates))return(t=h.flatten(t))&&t.length&&(i.interactions=[],m.each(t,function(){i.interactions.push(h.interaction(this,i))})),i.propagates=i.interactions.length,!1!==i.drop&&a.drop&&a.drop.handler(e,i),h.textselect(!1),h.touched?u.add(h.touched,"touchmove touchend",h.handler,i):u.add(document,"mousemove mouseup",h.handler,i),!(!h.touched||i.live)&&void 0}},interaction:function(e,t){t=m(e)[t.relative?"position":"offset"]()||{top:0,left:0};return{drag:e,callback:new h.callback,droppable:[],offset:t}},handler:function(e){var t=e.data;switch(e.type){case!t.dragging&&"touchmove":e.preventDefault();case!t.dragging&&"mousemove":if(Math.pow(e.pageX-t.pageX,2)+Math.pow(e.pageY-t.pageY,2)<Math.pow(t.distance,2))break;e.target=t.target,h.hijack(e,"dragstart",t),t.propagates&&(t.dragging=!0);case"touchmove":e.preventDefault();case"mousemove":if(t.dragging){if(h.hijack(e,"drag",t),t.propagates){!1!==t.drop&&a.drop&&a.drop.handler(e,t);break}e.type="mouseup"}default:h.touched?u.remove(h.touched,"touchmove touchend",h.handler):u.remove(document,"mousemove mouseup",h.handler),t.dragging&&(!1!==t.drop&&a.drop&&a.drop.handler(e,t),h.hijack(e,"dragend",t)),h.textselect(!0),!1===t.click&&t.dragging&&m.data(t.mousedown,"suppress.click",(new Date).getTime()+5),t.dragging=h.touched=!1}},hijack:function(i,a,n,e,t){if(n){var r,o,s,l={event:i.originalEvent,type:i.type},d=a.indexOf("drop")?"drag":"drop",x=e||0,c=isNaN(e)?n.interactions.length:e;i.type=a,i.originalEvent=null,n.results=[];do{if(o=n.interactions[x]){if("dragend"!==a&&o.cancelled)continue;s=h.properties(i,n,o),o.results=[],m(t||o[d]||n.droppable).each(function(e,t){if(s.target=t,!(i.isPropagationStopped=function(){return!1})===(r=t?u.dispatch.call(t,i,s):null)?("drag"==d&&(o.cancelled=!0,--n.propagates),"drop"==a&&(o[d][e]=null)):"dropinit"==a&&o.droppable.push(h.element(r)||t),"dragstart"==a&&(o.proxy=m(h.element(r)||o.drag)[0]),o.results.push(r),delete i.result,"dropinit"!==a)return r}),n.results[x]=h.flatten(o.results),"dropinit"==a&&(o.droppable=h.flatten(o.droppable)),"dragstart"!=a||o.cancelled||s.update()}}while(++x<c);return i.type=l.type,i.originalEvent=l.event,h.flatten(n.results)}},properties:function(e,t,i){var a=i.callback;return a.drag=i.drag,a.proxy=i.proxy||i.drag,a.startX=t.pageX,a.startY=t.pageY,a.deltaX=e.pageX-t.pageX,a.deltaY=e.pageY-t.pageY,a.originalX=i.offset.left,a.originalY=i.offset.top,a.offsetX=a.originalX+a.deltaX,a.offsetY=a.originalY+a.deltaY,a.drop=h.flatten((i.drop||[]).slice()),a.available=h.flatten((i.droppable||[]).slice()),a},element:function(e){if(e&&(e.jquery||1==e.nodeType))return e},flatten:function(e){return m.map(e,function(e){return e&&e.jquery?m.makeArray(e):e&&e.length?h.flatten(e):e})},textselect:function(e){m(document)[e?"unbind":"bind"]("selectstart",h.dontstart).css("MozUserSelect",e?"":"none"),document.unselectable=e?"off":"on"},dontstart:function(){return!1},callback:function(){}};h.callback.prototype={update:function(){a.drop&&this.available.length&&m.each(this.available,function(e){a.drop.locate(this,e)})}};var t=u.dispatch;u.dispatch=function(e){if(!(0<m.data(this,"suppress."+e.type)-(new Date).getTime()))return t.apply(this,arguments);m.removeData(this,"suppress."+e.type)};var n=u.fixHooks.touchstart=u.fixHooks.touchmove=u.fixHooks.touchend=u.fixHooks.touchcancel={props:"clientX clientY pageX pageY screenX screenY".split(" "),filter:function(i,e){var a;return!e||(a=e.touches&&e.touches[0]||e.changedTouches&&e.changedTouches[0]||null)&&m.each(n.props,function(e,t){i[t]=a[t]}),i}};a.draginit=a.dragstart=a.dragend=h}(jQuery),angular.module("timeseries",["gm.date"]).directive("timeseries",["$compile","$rootScope","gmDate",function(s,A,N){return{restrict:"A",scope:{data:"=",markers:"=",options:"=",status:"=",api:"="},link:function(y,b,e){var t=s('<canvas style="display:block"></canvas>')(y);b.append(t);function M(e,t,i,a,n){var r=t/((n*=.001)-(a*=.001));if(!(r<=0)){var o,s=l.length;for(P.drx=[l[s-1].major,l[s-1].minor],P.primaryTimeFormat=l[s-1][2],P.secondaryTimeFormat=l[s-1][3],P.relativeTimeFormat=l[s-1][4],P.fontHeight=(i-8)/2,12<P.fontHeight?P.fontHeight=12:P.fontHeight<8&&(P.fontHeight=8),P.longTick=i-8-2*P.fontHeight,P.longTick<0&&(P.longTick=0),P.shortTick=.5*P.longTick,e.font=P.fontHeight+"px Sans-Serif",P.minLabelWidth=e.measureText("  XXXX-XX-XX.X  ").width,o=0;o<s;++o)if(l[o][0]*r>=P.minLabelWidth){P.drx[0]=l[o][0],P.drx[1]=l[o][1],P.primaryTimeFormat=l[o][2],P.secondaryTimeFormat=l[o][3],P.relativeTimeFormat=l[o][4];break}if(o===s&&0<r)for(P.drx[0]=l[s-1][0],P.drx[1]=l[s-1][1],P.primaryTimeFormat=l[s-1][2],P.secondaryTimeFormat=l[s-1][3],P.relativeTimeFormat=l[s-1][4];P.drx[0]*r<P.minLabelWidth;)P.drx[0]*=2,P.drx[1]*=2}}function S(e,t,i,a,n,r,o,s,l,d,x){var c=a/((o*=.001)-(r*=.001));if(!(c<=0)){d<x&&(x=(.001*x-r)*c,(d=(.001*d-r)*c)<a&&0<x&&(e.fillStyle="rgba(0,0,0,0.2)",e.fillRect(t+d,i+n-20,x-d,20)));for(var m=r+0,u=m-m%P.drx[0],h=Math.floor((u-m)*c);h<a;)0<=h&&(e.beginPath(),e.moveTo(t+h+.5,i+.5),e.lineTo(t+h+.5,i+n+.5),e.stroke()),u+=P.drx[0],h=Math.floor((u-m)*c)}}function Y(t,e,i,a,n,r,o,s,l,d){if(!(n<=0)){var x=a/((o*=.001)-(r*=.001));if(!(x<=0)){t.beginPath(),t.moveTo(e+.5,i+.5),t.lineTo(e+a+.5,i+.5),t.stroke(),t.textBaseline="top",t.textAlign="center";for(var c=r+0,m=i+P.longTick+4+.5,u=i+P.longTick+4+P.fontHeight+2-1+.5,h="",f=0;f<2;++f)if(!(P.drx[f]<=0))for(var p,g,v,T=c-c%P.drx[f],k=0===f?P.longTick:P.shortTick,w=Math.floor((T-c)*x);w<a;)0<=w&&(t.beginPath(),t.moveTo(e+w+.5,i+.5),t.lineTo(e+w+.5,i+k+.5),t.stroke(),0===f&&(d?(g=parseFloat((1e-6*Math.floor(Math.round(1e6*T))).toFixed(3)),e<=w-(v=.5*t.measureText(g).width)&&w+v<=a&&t.fillText(g,e+w+.5,m)):(p=1e3*T,g=void 0!==l.xaxis.ruler.useUTC?N.toString(p,P.primaryTimeFormat,l.xaxis.ruler.useUTC):N.toDefaultString(p,P.primaryTimeFormat),e<=w-(v=.5*t.measureText(g).width)&&w+v<=a&&t.fillText(g,e+w+.5,m),P.secondaryTimeFormat&&w-.5*P.minLabelWidth>=e&&w+.5*P.minLabelWidth<=a&&((p=void 0!==l.xaxis.ruler.useUTC?N.toString(p,P.secondaryTimeFormat,l.xaxis.ruler.useUTC):N.toDefaultString(p,P.secondaryTimeFormat))!==h&&(t.fillText(p,e+w+.5,u),h=p))))),T+=P.drx[f],w=Math.floor((T-c)*x);if(s){t.save(),t.font="bold "+P.fontHeight+"px Sans-Serif";for(var y=s?s.length:0,b=0;b<y;++b){var M=s[b];w=C(.001*(M.x-d),r,o,a);var S=2;try{t.strokeStyle=l.marker[M.type].color}catch(e){t.strokeStyle="#f00"}try{S=l.marker[M.type].lineWidth}catch(e){}t.lineWidth=S,t.fillText(M.annotation,e+w-.5,u)}t.restore()}}}}var D=t[0],H=0,X=[],R={xaxis:{min:null,max:null},yaxis:{min:null,max:null},trace:{sampleCount:null,fromRecord:null,toRecord:null,offset:null}},a="default",L=null,F=null,E=null,l=[[.001,2e-4,"%S.%3","%Y-%m-%d %H:%M",""],[.005,.001,"%S.%3","%Y-%m-%d %H:%M",""],[.01,.002,"%S.%2","%Y-%m-%d %H:%M",""],[.05,.01,"%S.%2","%Y-%m-%d %H:%M",""],[.1,.02,"%T.%1","%Y-%m-%d",""],[.5,.1,"%T.%1","%Y-%m-%d",""],[1,.2,"%T","%Y-%m-%d",""],[2,.5,"%T","%Y-%m-%d",""],[5,1,"%T","%Y-%m-%d",""],[10,2,"%T","%Y-%m-%d",""],[15,3,"%T","%Y-%m-%d",""],[30,5,"%T","%Y-%m-%d",""],[60,10,"%T","%Y-%m-%d",""],[120,20,"%T","%Y-%m-%d",""],[300,60,"%T","%Y-%m-%d",""],[600,120,"%T","%Y-%m-%d",""],[900,300,"%T","%Y-%m-%d",""],[1800,300,"%T","%Y-%m-%d",""],[3600,600,"%T","%Y-%m-%d",""],[7200,1200,"%T","%Y-%m-%d",""],[21600,3600,"%T","%Y-%m-%d",""],[43200,7200,"%T","%Y-%m-%d",""],[86400,21600,"%b, %d","%Y",""],[172800,43200,"%b, %d","%Y",""],[604800,86400,"%b, %d","%Y",""],[1209600,172800,"%b, %d","%Y",""]],P={fontHeight:0,longTick:0,shortTick:0,drx:[0,0],primaryTimeFormat:"",secondaryTimeFormat:"",relativeTimeFormat:"",minLabelWidth:0},W={update:function(){x()},setCursor:function(e){e!==L&&(e?(L=e,b.css("cursor","crosshair")):(L=null,b.css("cursor","pointer")),x())},currentMarker:null},C=function(e,t,i,a){return Math.floor((e-t)*a/(i-t))},z=0,x=function(){var t=D.getContext("2d");t.clearRect(0,0,D.width,D.height);var e={interactive:!0,showAllData:!0,xaxis:{color:"black",ruler:{enable:!0,height:36,drawMarker:!1},referenceTime:null},yaxis:{autoScale:!1},grid:{color:"lightGray",show:!0,relative:!1}};$.extend(!0,e,y.options),e.interactive||(null!==e.xaxis.min?(R.xaxis.min=e.xaxis.min,null!==e.xaxis.max?R.xaxis.max=e.xaxis.max:R.xaxis.max=e.xaxis.min+6e5):null!==e.xaxis.max&&(R.xaxis.max=e.xaxis.max,null!==e.xaxis.min?R.xaxis.min=e.xaxis.min:R.xaxis.min=e.xaxis.max-6e5)),null!==R.xaxis.max&&null!==R.xaxis.min&&R.xaxis.max-R.xaxis.min<100&&(p=.5*(R.xaxis.min+R.xaxis.max),R.xaxis.min=p-50,R.xaxis.max=50+p),D.width!==b.width()&&(D.width=b.width()),D.height!==b.height()&&(D.height=b.height());var i=e.xaxis.ruler.height;e.xaxis.ruler.enable||(i=0),z=0,e.xaxis.referenceTime&&e.grid.relative&&(z=e.xaxis.referenceTime);var a=(e.xaxis.smin||0)-z,n=(e.xaxis.smax||0)-z;if(X.length=0,y.data){var r=y.data.length;H=D.height-i;for(var o=0,s=0;s<r;++s)(e.showAllData||y.data[s].active)&&++o;var l=H/o,d=0;t.save();var x,c,m,u,h,f,p,g=0;for(s=0;s<r;++s)e.showAllData||y.data[s].active?(X[s]=[d,d+l],h=y.data[s].records?function(e,t,i){var a={timeMin:null,timeMax:null,amplMin:null,amplMax:null,samples:0,firstRecord:-1,lastRecord:-1,offset:0};if(!e)return a;for(var n=0,r=0;r<e.length;++r){var o=e[r];if(0!==o.samples.length&&!(t&&o.endTime<=t)){if(i&&o.startTime>=i)break;var s=t?.001*(t-o.startTime):0,l=i?.001*(o.endTime-i):0,d=0,x=o.samples.length;if(0<s){if(x<=(d=Math.floor(s*o.srNum/o.srDen)))continue;x-=d}if(!(0<l&&(x-=Math.floor(l*o.srNum/o.srDen))<=0)){a.firstRecord<0&&(a.firstRecord=r),a.lastRecord=r,(null===a.timeMin||a.timeMin>o.startTime)&&(a.timeMin=o.startTime),(null===a.timeMax||a.timeMax<o.endTime)&&(a.timeMax=o.endTime),null===a.amplMin&&(a.amplMin=o.samples[d]),null===a.amplMax&&(a.amplMax=o.samples[d]);for(var c=d,m=0;m<x;++m,++c)o.samples[c]<a.amplMin&&(a.amplMin=o.samples[c]),o.samples[c]>a.amplMax&&(a.amplMax=o.samples[c]),n+=o.samples[c];a.samples+=x}}}return 0<a.samples&&(a.offset=n/a.samples),a}(y.data[s].records,e.yaxis.autoScale?R.xaxis.min+(z||0):null,e.yaxis.autoScale?R.xaxis.max+(z||0):null):{samples:0,offset:0,firstRecord:-1,lastRecord:-1,timeMin:R.xaxis.min,timeMax:R.xaxis.max,amplMin:-1,amplMax:1},g||(R.trace.sampleCount=h.samples,R.trace.fromRecord=h.firstRecord,R.trace.toRecord=h.lastRecord,R.trace.offset=h.offset),null===R.xaxis.min&&(R.xaxis.min=h.timeMin),null===R.xaxis.max&&(R.xaxis.max=h.timeMax),(null===R.yaxis.min||e.yaxis.autoScale&&h.amplMin)&&(R.yaxis.min=h.amplMin),(null===R.yaxis.max||e.yaxis.autoScale&&h.amplMax)&&(R.yaxis.max=h.amplMax),null!==R.xaxis.min&&null!==R.xaxis.max&&(x=R.yaxis.min,c=R.yaxis.max,m=1e3*+D.width/(R.xaxis.max-R.xaxis.min),0===g&&(M(t,D.width,i,R.xaxis.min,R.xaxis.max),e.grid.show&&(t.strokeStyle=e.grid.color,S(t,0,0,+D.width,D.height-i,R.xaxis.min,R.xaxis.max,0,0,a,n)),e.xaxis.referenceTime&&(u=C(e.xaxis.referenceTime-z,R.xaxis.min,R.xaxis.max,+D.width)+0+.5,t.strokeStyle="red",t.beginPath(),t.moveTo(u,0),t.lineTo(u,H),t.stroke())),f=h.offset,h=Math.floor(l-(f-x)*l/(c-x)),f={color:"#eee",offsetColor:"lightBlue",lineWidth:1,optimize:!0},$.extend(!0,f,y.data[s].options),0<=h&&h<l&&(t.strokeStyle=f.offsetColor,t.beginPath(),t.moveTo(0,d+h+.5),t.lineTo(+D.width,d+h+.5),t.stroke()),t.strokeStyle=f.color,t.lineWidth=f.lineWidth,function(e,t,i,a,n,r,o,s,l,d,x,c){if(null!==t&&0!==t.length){var n=r-n,m=0==n?0:(d-1)/n;c&&(i+=c,a+=c);for(var u=null,h=!1,f=100,p=f,g=t.length,v=0;v<g;++v){var T=t[v];if(0!==T.samples.length&&!(i&&T.endTime<=i)){if(a&&T.startTime>=a)break;u&&.001*Math.abs(T.startTime-u.endTime)*T.srNum>T.srDen&&h&&(e.stroke(),h=!1);var k=.001*(i?i-T.startTime:t[0].startTime-T.startTime),w=.001*(a?T.endTime-a:0),y=0,b=T.samples.length;if(0<k){if(b<=(y=Math.floor(k*T.srNum/T.srDen)))continue;b-=y,k-=y*T.srDen/T.srNum}if(!(0<w&&(b-=Math.floor(w*T.srNum/T.srDen))<=0)){var M,k=Math.floor(o*k),S=o*T.srDen/T.srNum,$=s-k,Y=Math.floor(m*(r-T.samples[y]))+.5+l,D=Y,H=Y,X=$,R=Y,u=T;h?e.lineTo($,Y):(e.beginPath(),e.moveTo($,Y),h=!0);var L=S+s-k,F=y+1;if(x){for(M=1;M<b;++M,L+=S,++F){var E=Math.floor(L)+.5,P=Math.floor(m*(r-T.samples[F]))+.5+l;P!==R?(X!==$&&(X=$,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R))),X!==E?(D!==R&&(R=D,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R))),H!==R&&(R=H,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R))),Y!==R&&(R=Y,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R))),X=E,P!==R&&(e.lineTo(X,R=P),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R))),D=H=R):P<D?D=P:H<P&&(H=P)):(D!==R&&(R=D,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R)),D=R),H!==R&&(R=H,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R)),H=R),Y!==R&&(R=D=H=Y,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R)))),$=E,Y=P}X!==$&&e.lineTo($,Y)}else for(M=1;M<b;++M)X=L,R=m*(r-T.samples[F])+l,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R)),L+=S,++F}}}h&&e.stroke()}}(t,y.data[s].records,R.xaxis.min,R.xaxis.max,x,c,m,0,d,l,f.optimize,z),d+=l,++g)):X[s]=null;if(y.markers){t.textBaseline="top",t.textAlign="left",t.font="12px sans-serif";for(var v=y.markers?y.markers.length:0,T=0;T<v;++T){var k=y.markers[T],w=2;try{t.strokeStyle=e.marker[k.type].color}catch(e){t.strokeStyle="#f00"}try{if(!(w=e.marker[k.type].lineWidth))continue}catch(e){}t.lineWidth=w,u=C(k.x-z,R.xaxis.min,R.xaxis.max,+D.width)+0-.5*w,k===W.currentMarker&&(t.fillStyle="rgba(0,0,0,0.2)",t.fillRect(u-3,0,6,D.height-i)),t.beginPath(),t.moveTo(u,0),t.lineTo(u,D.height-i),t.stroke(),k.annotation&&(w=k.align||0,t.fillStyle=t.strokeStyle,w?1===w?t.fillText(k.annotation,u+2,.5*(D.height-i-12)):2===w&&t.fillText(k.annotation,u+2,D.height-i-12-2):t.fillText(k.annotation,u+2,0))}}F&&L&&(t.strokeStyle="#000",t.fillStyle=t.strokeStyle,t.lineWidth=1,u=C(F,R.xaxis.min,R.xaxis.max,+D.width)+0+.5,t.beginPath(),t.moveTo(u,0),t.lineTo(u,D.height-i),t.stroke(),t.fillText(L,u+2,0),p=void 0!==e.xaxis.ruler.useUTC?N.toString(F,"%H:%M:%S.%3",e.xaxis.ruler.useUTC):N.toDefaultString(F,"%H:%M:%S.%3"),null!=E&&y.data[E].id&&(p+=" #"+y.data[E].id),t.fillStyle="#fff",t.rect(u,D.height-i-14,t.measureText(p).width+4,14),t.stroke(),t.fill(),t.fillStyle="#000",t.fillText(p,u+2,D.height-i-12-2)),t.restore(),t.strokeStyle=e.xaxis.color,t.fillStyle=e.xaxis.color,Y(t,0,D.height-i,+D.width,i,R.xaxis.min,R.xaxis.max,e.xaxis.ruler.drawMarker?y.markers:null,e,z)}else null!==R.xaxis.min&&null!==R.xaxis.max&&(H=0,M(t,D.width,i,R.xaxis.min,R.xaxis.max),e.grid.show&&(t.strokeStyle=e.grid.color,S(t,0,0,+D.width,D.height-i,R.xaxis.min,R.xaxis.max,0,0,a,n)),t.strokeStyle=e.xaxis.color,t.fillStyle=e.xaxis.color,Y(t,0,D.height-i,+D.width,i,R.xaxis.min,R.xaxis.max,e.xaxis.ruler.drawMarker?y.markers:null,e,z));y.status&&("$digest"===A.$$phase||"$apply"===A.$$phase?y.status=R:y.$apply(y.status=R))};try{null!==y.options.xaxis.min?(R.xaxis.min=y.options.xaxis.min,null!==y.options.xaxis.max?R.xaxis.max=y.options.xaxis.max:R.xaxis.max=y.options.xaxis.min+6e5):null!==y.options.xaxis.max&&(R.xaxis.max=y.options.xaxis.max,null!==y.options.xaxis.min?R.xaxis.min=y.options.xaxis.min:R.xaxis.min=y.options.xaxis.max-6e5)}catch(e){}e.complete&&y.$parent.$last&&y.$parent.$evalAsync(e.complete),e.deferUpdate||x(),window.addResizeListener?window.addResizeListener(b[0],x):y.$watch(function(){return b.innerWidth()+";"+b.innerHeight()},function(e,t){x()}),y.api&&(y.api.timeSeries=W);var i,n,t=!0;try{y.options.hasOwnProperty("interactive")&&(t=y.options.interactive)}catch(e){}t&&(W.evWheel=b.bind("mousewheel",function(e,t,i,a){if(e.preventDefault&&e.preventDefault(),R.xaxis.min&&R.xaxis.max){var n,e=(e.pageX-$(D).offset().left)/D.width,e=(R.xaxis.max-R.xaxis.min)*e+R.xaxis.min;if(0<t)n=.6;else{if(!(t<0))return;n=1.4}R.xaxis.min=(R.xaxis.min-e)*n+e,R.xaxis.max=(R.xaxis.max-e)*n+e,x()}}),W.evDragStart=b.bind("dragstart",function(e,t){var i=b.css("cursor");i&&(a=i),b.css("cursor","move")}),W.evDragEnd=b.bind("dragend",function(e,t){b.css("cursor",a)}),W.evDrag=b.bind("drag",function(e,t){var i;R.xaxis.min&&R.xaxis.max&&(i=void 0!==t.lastDeltaX?t.deltaX-t.lastDeltaX:t.deltaX,t.lastDeltaX=t.deltaX,i=i/D.width*(R.xaxis.max-R.xaxis.min),R.xaxis.min-=i,R.xaxis.max-=i,x())}),n=i=void 0,W.evTouchStart=b.bind("touchstart",function(e){e.preventDefault&&e.preventDefault();e=b.css("cursor");e&&(a=e),b.css("cursor","move")}),W.evTouchEnd=b.bind("touchend",function(e){b.css("cursor",a),n=i=void 0}),W.evTouchMove=b.bind("touchmove",function(e){var t;e.preventDefault&&e.preventDefault(),R.xaxis.min&&R.xaxis.max&&(!e.originalEvent.touches||e.originalEvent.touches.length<1||(i=i||[e.originalEvent.touches[0].pageX,e.originalEvent.touches[0].pageY],t=[e.originalEvent.touches[0].pageX,e.originalEvent.touches[0].pageY][0]-i[0],e=void 0!==n?t-n:t,n=t,e=e/D.width*(R.xaxis.max-R.xaxis.min),R.xaxis.min-=e,R.xaxis.max-=e,x()))}),y.api&&(W.evMove=b.bind("mousemove",function(e){if(R.xaxis.min&&R.xaxis.max){var t=R.xaxis.max-R.xaxis.min,i=e.pageY-$(D).offset().top;if(!(H<=i)){for(var a=e.pageX-$(D).offset().left,n=!1,r=!1,o=y.markers?y.markers.length:0,s=0;s<o;++s){var l=y.markers[s],d=l.x-R.xaxis.min;if(!(d<0||t<d)&&(d/=t,d*=D.width,Math.abs(d-a-1)<3&&(r=!0,l!==W.currentMarker))){W.currentMarker=l,n=!0;break}}if(!r&&W.currentMarker&&(n=!(W.currentMarker=null)),L){e=(e.pageX-$(D).offset().left)/D.width;if(F=t*e+R.xaxis.min,E=null,y.data)for(o=X.length,s=0;s<o;++s)if(X[s]&&i>=X[s][0]&&i<X[s][1]){E=s;break}n=!0}n&&x()}}}),W.evClick=b.bind("click",function(e){try{b[0].focus()}catch(e){}if(R.xaxis.min&&R.xaxis.max&&y.api.clicked){var t,i=(e.pageX-$(D).offset().left)/D.width,a=e.pageY-$(D).offset().top;if(!(H<=a)){if(y.data)for(var n=X.length,r=0;r<n;++r)if(X[r]&&a>=X[r][0]&&a<X[r][1]){t=r;break}i=(R.xaxis.max-R.xaxis.min)*i+R.xaxis.min;y.api.clicked(e,i,t,W.currentMarker)}}}),W.evDblClick=b.bind("dblclick",function(e){if(R.xaxis.min&&R.xaxis.max&&y.api.selected){var t,i=(e.pageX-$(D).offset().left)/D.width,a=e.pageY-$(D).offset().top;if(!(H<=a)){if(y.data)for(var n=X.length,r=0;r<n;++r)if(X[r]&&a>=X[r][0]&&a<X[r][1]){t=r;break}i=(R.xaxis.max-R.xaxis.min)*i+R.xaxis.min;y.api.selected(e,i,t,W.currentMarker)}}}))),e.plotreset&&setTimeout(function(){$("#"+e.plotreset).click(function(){R.xaxis.min=null,R.xaxis.max=null,x()})},10);function r(e,t){e!==t&&x()}var o=[];y.$watch("data",function(e,t){for(var i=o.length,a=0;a<i;++a)o[a]();if(o.length=0,y.data){for(i=y.data.length,a=0;a<i;++a)o.push(y.$watch("data["+a+"].records",r)),o.push(y.$watch("data["+a+"].records.length",r)),o.push(y.$watch("data["+a+"].options",r)),o.push(y.$watch("data["+a+"].active",r));x()}}),y.$watch("markers",r),y.$watch("markers.length",r),y.$watch("options",function(e,t){y.status&&y.options&&(null!==y.options.xaxis.min&&(y.status.xaxis.min=y.options.xaxis.min),null!==y.options.xaxis.max&&(y.status.xaxis.max=y.options.xaxis.max)),r(e,t)},!0),y.$on("updateLayout",function(){x()}),y.$on("$destroy",function(){y.data=null,y.api&&(y.api.timeSeries=null,y.api=null),window.removeResizeListener&&window.removeResizeListener(b[0],x),W.evWheel&&b.unbind("mousewheel"),W.evDragStart&&b.unbind("dragstart"),W.evDragEnd&&b.unbind("dragend"),W.evDrag&&b.unbind("drag"),W.evTouchStart&&b.unbind("touchstart"),W.evTouchEnd&&b.unbind("touchend"),W.evTouchMove&&b.unbind("touchmove"),W.evMove&&b.unbind("mousemove"),W.evClick&&b.unbind("click"),W.evDblClick&&b.unbind("dblclick")})}}}]).directive("autoHeight",function(){return{restrict:"A",link:function(s,l,d){function i(){d.minHeight&&(c=parseFloat(s.$eval(d.minHeight)))<10&&(c=10)}var x=-1,c=30;i();function a(e){var t=l.innerHeight();if(e||t!==x){x=t;var i=0,e=l.children(d.children);if(e.each(function(){"none"!==$(this).css("display")&&++i}),!(t<=0||0===i)){var a=t/i;try{a<c&&(a=c)}catch(e){}var n,r=0,o=0;e.each(function(e,t){r+=a;var i=(n=Math.floor(r))-o;$(t).height(i),o=n}),0<o&&d.layoutComplete&&s.$evalAsync(d.layoutComplete)}}}d.rows&&s.$watch(d.rows,function(e,t){a(!0)}),d.minHeight&&s.$watch(d.minHeight,function(e,t){i(),a(!0)}),window.addResizeListener?window.addResizeListener(l[0],a):s.$watch(function(){return 1e6*l.innerWidth()+l.innerHeight()},function(e,t){a()}),s.$on("updateLayout",function(){a(!0)}),s.$on("$destroy",function(){window.removeResizeListener&&window.removeResizeListener(l[0],a)}),a()}}}).directive("autoHeightNoScope",function(){return{restrict:"A",link:function(e,s,i){function a(){i.minHeight&&(d=parseFloat(e.$eval(i.minHeight)))<10&&(d=10)}var l=-1,d=30;a();function n(e){var t=s.innerHeight();if(e||t!==l){l=t;e=s.children(i.children).size();if(!(t<=0||0===e)){var a=t/e;try{a<d&&(a=d)}catch(e){}var n,r=0,o=0;s.children(i.children).each(function(e,t){r+=a;var i=(n=Math.floor(r))-o;$(t).height(i),o=n})}}}i.rows&&e.$watch(i.rows,function(e,t){n(!0)}),i.minHeight&&e.$watch(i.minHeight,function(e,t){a(),n(!0)}),window.addResizeListener?window.addResizeListener(s[0],n):e.$watch(function(){return 1e6*s.innerWidth()+s.innerHeight()},function(e,t){n()}),i.hasOwnProperty("stretchY")&&e.$watch(function(){return s.parent().innerWidth()+";"+s.parent().innerHeight()},function(e,t){var i=s.parent().innerHeight()-s.position().top;i!==l&&s.height(i)}),e.$on("updateLayout",function(){n(!0)}),e.$on("$destroy",function(){window.removeResizeListener&&window.removeResizeListener(s[0],n)})}}});
L.Map.mergeOptions({boxSelect:!1}),L.Map.BoxSelect=L.Handler.extend({initialize:function(t){this._map=t,this._container=t._container,this._pane=t._panes.objectsPane,this._multiple=!1},addHooks:function(){L.DomEvent.on(this._container,"mousedown",this._onMouseDown,this),L.DomEvent.on(this._container,"touchstart",this._onTouchStart,this)},removeHooks:function(){L.DomEvent.off(this._container,"mousedown",this._onMouseDown),L.DomEvent.off(this._container,"touchstart",this._onTouchStart)},_onMouseDown:function(t){if(1!==t.which&&1!==t.button)return!1;t.shiftKey?this._multiple=!0:this._multiple=!1,this._startLayerPoint=this._map.mouseEventToLayerPoint(t),this._startDragging(t)},_onTouchStart:function(t){!t.touches||t.touches.length<1||(this._multiple=!1,this._startLayerPoint=this._map.mouseEventToLayerPoint(t.touches[0]),this._startDragging(t))},_startDragging:function(t){L.DomUtil.disableTextSelection(),this._box||(this._box=L.DomUtil.create("div","leaflet-select-box",this._pane)),L.DomUtil.setPosition(this._box,this._startLayerPoint),this._box.style.width="0px",this._box.style.height="0px",this._container.style.cursor="crosshair",L.DomEvent.on(document,"mousemove",this._onMouseMove,this).on(document,"mouseup",this._onMouseUp,this).on(document,"touchmove",this._onTouchMove,this).on(document,"touchend",this._onTouchEnd,this).on(document,"keydown",this._onKeyDown,this).preventDefault(t),this._map.fire("boxselectstart")},_onMouseMove:function(t){this._onMove(this._map.mouseEventToLayerPoint(t))},_onTouchMove:function(t){this._moveLayerPoint=this._map.mouseEventToLayerPoint(t.touches[0]),this._onMove(this._moveLayerPoint)},_onMove:function(t){var e=this._startLayerPoint,s=this._box,n=t.subtract(e),e=new L.Point(Math.min(t.x,e.x),Math.min(t.y,e.y));L.DomUtil.setPosition(s,e),s.style.width=Math.max(0,Math.abs(n.x)-4)+"px",s.style.height=Math.max(0,Math.abs(n.y)-4)+"px"},_finish:function(){this._pane.removeChild(this._box),delete this._box,this._container.style.cursor="",L.DomUtil.enableTextSelection(),L.DomEvent.off(document,"mousemove",this._onMouseMove).off(document,"mouseup",this._onMouseUp).off(document,"touchmove",this._onTouchMove).off(document,"touchend",this._onTouchEnd).off(document,"keydown",this._onKeyDown)},_onMouseUp:function(t){this._finishDragging(this._map.mouseEventToLayerPoint(t))},_onTouchEnd:function(t){this._finishDragging(this._moveLayerPoint)},_finishDragging:function(t){this._finish();var e=this._map,t=t;this._startLayerPoint.equals(t)||(t=new L.LatLngBounds(e.layerPointToLatLng(this._startLayerPoint),e.layerPointToLatLng(t)),e.fire("boxselectend",{boxSelectBounds:t,boxSelectMultiple:this._multiple}))},_onKeyDown:function(t){27===t.keyCode&&this._finish()}}),L.Map.addInitHook("addHandler","boxSelect",L.Map.BoxSelect),L.PolygonMarker=L.Polyline.extend({options:{fill:!0,lineJoin:"miter"},initialize:function(t,e,s){L.Path.prototype.initialize.call(this,s),this._latlng=L.latLng(t),this.setPoints(e)},setPoints:function(t){this._points=t,this._originalPoints=[];for(var e=0;e<this._points.length;++e)this._originalPoints[e]=new L.Point(0,0);this._bounds=new L.Bounds(this._originalPoints)},getLatLng:function(){return this._latlng},setLatLng:function(t){return this._latlng=t,this.redraw()},projectLatlngs:function(){for(var t=this._map.latLngToLayerPoint(this._latlng),e=0,s=this._points.length;e<s;e++)this._originalPoints[e].x=t.x+this._points[e][0],this._originalPoints[e].y=t.y-this._points[e][1]},getBounds:function(){var t=this._map,e=this._bounds.max.x-this._bounds.min.x,s=this._bounds.max.y-this._bounds.min.y,n=e*Math.cos(Math.PI/4),i=s*Math.sin(Math.PI/4),e=t.project(this._latlng),s=new L.Point(e.x-n,e.y+i),i=new L.Point(e.x+n,e.y-i),s=t.unproject(s),i=t.unproject(i);return new L.LatLngBounds(s,i)},_getPathPartStr:function(t){return L.Polyline.prototype._getPathPartStr.call(this,t)+(L.Browser.svg?"z":"x")},_clipPoints:function(){this.projectLatlngs(),L.Polyline.prototype._clipPoints.call(this)}}),L.PolygonMarker=L.Path.SVG&&!window.L_PREFER_CANVAS||!L.Browser.canvas?L.PolygonMarker:L.PolygonMarker.extend({_drawPath:function(){var t,e,s,n,i;for(this._ctx.beginPath(),t=0,s=this._parts.length;t<s;t++){for(e=0,n=this._parts[t].length;e<n;e++)i=this._parts[t][e],this._ctx[(0===e?"move":"line")+"To"](i.x,i.y);this._ctx.closePath()}}}),L.polygonMarker=function(t,e,s){return new L.PolygonMarker(t,e,s)},L.ClusterIcon=L.Icon.extend({options:{iconSize:[50,50],className:"leaflet-div-icon",fill:["white",.4],cluster:void 0,text:void 0,textColor:"white"},createIcon:function(t){var e=t&&"DIV"===t.tagName?t:document.createElement("div"),s='<svg viewBox="0 0 100 100" ><polygon points="10,85 90,85 50,15"',n=this.options.fill,t=this.options.textColor;return this.options.cluster&&(this.options.cluster._ll_color&&(n=this.options.cluster._ll_color instanceof Array?this.options.cluster._ll_color:[this.options.cluster._ll_color,1]),this.options.cluster._textColor&&(t=this.options.cluster._textColor)),s+=' fill="'+n[0]+'" fill-opacity="'+n[1]+'"',s+="/>",this.options.text&&(s+='<text x="50" y="72" fill="'+t+'" font-size="24" text-anchor="middle">'+this.options.text+"</text>"),e.innerHTML=s+="</svg>",this._setIconStyles(e,"icon"),e},createShadow:function(){return null}}),L.clusterIcon=function(t){return new L.ClusterIcon(t)},L.EventIcon=L.Icon.extend({options:{fillColor:[0,0,255,255],blankColor:[255,255,255,255],color:[0,0,0,255],radius:16,weight:2,fm:null},createIcon:function(t){return this._canvas=t&&"CANVAS"===t.tagName?t:document.createElement("canvas"),this._canvas.className="leaflet-marker-icon",this._ctx=this._canvas.getContext("2d"),this._applySize(),this._updateImage(),this._canvas},createShadow:function(){return null},setStyle:function(t){var e=t.radius&&this.options.radius!==t.radius;L.setOptions(this,t),this._ctx&&(e&&this._applySize(),this._updateImage())},_applySize:function(){var t=L.point([2*this.options.radius|0,2*this.options.radius|0]),e=t.divideBy(2,!0);this._canvas.width=t.x,this._canvas.height=t.y,this._canvas.style.marginLeft=-e.x+"px",this._canvas.style.marginTop=-e.y+"px",this._canvas.style.width=this._canvas.width+"px",this._canvas.style.height=this._canvas.height+"px"},_updateImage:function(){var t=this.options.fm?new G.Tensor(this.options.fm.strike,this.options.fm.dip,this.options.fm.rake):new G.Tensor(0,0,0);this._ctx.strokeStyle="rgba(0,0,0,0)",this._ctx.fillStyle="rgba(0,0,0,0)",this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height);var e=this._ctx.getImageData(0,0,this._canvas.width,this._canvas.height);t.render(e,this.options.fillColor,this.options.fm?this.options.blankColor:this.options.fillColor,this.options.color,.5*this.options.weight,this.options.weight),this._ctx.putImageData(e,0,0)}}),L.eventIcon=function(t){return new L.EventIcon(t)},L.EventMarker=L.Marker.extend({setStyle:function(t){this.options.icon.setStyle(t)},bringToFront:function(){this.setZIndexOffset(1e4)},restoreOrder:function(){this.setZIndexOffset(0)}}),L.eventMarker=function(t,e){return new L.EventMarker(t,{clickable:e.clickable,icon:L.eventIcon(e)})},L.StarMarker=L.PolygonMarker.extend({initialize:function(t,e){L.PolygonMarker.prototype.initialize.call(this,t,[],e)},setStyle:function(t){if(t.radius){var e=[],s=2*t.radius,n=.5*s;e.length=10;for(var i=0;i<5;++i)e[2*i]=[s*Math.sin(72*i*Math.PI/180),s*Math.cos(72*i*Math.PI/180)],e[2*i+1]=[n*Math.sin((360*i+180)/5*Math.PI/180),n*Math.cos((360*i+180)/5*Math.PI/180)];this.setPoints(e)}L.PolygonMarker.prototype.setStyle.call(this,t)}}),angular.module("mapwidget-ll",[]).directive("mapLl",["$timeout","$interval",function(V,j){return{restrict:"EA",template:'<div><span class="ll-pos" ng-if="cursor && options.currentPosition">{{cursor.text}}</span></div>',replace:!0,scope:{inventory:"=",events:"=",select:"=",currentFeature:"=",options:"=",mapInterface:"="},link:function(r,t,o){var a,s,n=t[0],l={maxZoom:14,showEvents:!1,blinking:!0,autoCenterLastEvent:!1,triggerDuration:6e5,mapURI:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",interactive:!0,zoomControl:!1,currentPosition:!1,maxBounds:[[-90,-225],[90,225]],minimap:{enable:!1},features:{geoJSON:null},inventory:{cluster:{enable:!1,radius:50,maxZoom:7,showCoverageOnHover:!1},allowAll:!1,normalStyle:{fillColor:"#2d69bf"}},events:{showFM:!0,updateInterval:60,colorByAge:!1},magnitudes:{scaleM:4.9,scaleN:-5.88,minSize:6},depths:[[50,[255,0,0]],[100,[255,128,0]],[250,[255,255,0]],[600,[0,127,0]],[null,[0,0,255]]],ages:[[3600,[255,0,0],"hour"],[86400,[255,128,0],"day"],[604800,[255,255,0],"week"],[2592e3,[255,255,255],"month"],[null,[128,128,128],"older"]]};angular.merge(l,r.options),o.hasOwnProperty("clusterInventory")&&(l.inventory.cluster.enable=!0),o.hasOwnProperty("allowAll")&&(l.inventory.allowAll=!0);var c=6e5;l.triggerDuration&&(c=l.triggerDuration);var u,h={lineJoin:"miter",fill:!0,innerRadius:0,opacity:.5,fillOpacity:1,gradient:!1,dropShadow:!0},e={fillColor:"#fff"},f={fillColor:"#edd400"},d={opacity:.5,color:"#444",weight:1.5},m={color:"#f00",weight:5},v=[[0,12],[12*Math.sin(240*Math.PI/180),12*Math.cos(240*Math.PI/180)],[12*Math.sin(120*Math.PI/180),12*Math.cos(120*Math.PI/180)]],p=null,_=null,g=null;function y(t){return t._color?t._color instanceof Array?{fillColor:t._color[0],fillOpacity:t._color[1]}:{fillColor:t._color,fillOpacity:1}:l.inventory.normalStyle}function b(t){if(t._ll_color)return t._ll_color instanceof Array?t._ll_color:[t._ll_color,1];t=t.getChildCount();return 100<=t?["#000",.4]:10<=t?["#111",.4]:["#222",.4]}function x(t){return t._textColor||"white"}function k(t){t.target.setStyle(e),o.currentFeature&&r.$apply(r.currentFeature=t.target)}function w(t){t.target.setStyle(t.target._sta._selected?f:y(t.target._sta)),o.currentFeature&&r.$apply(r.currentFeature=null)}function C(t){t.target._sta._selected=!0,t.target.setStyle(f)}function S(t){t.target._sta._selected=!1,t.target.setStyle(y(t.target._sta))}function M(t){var e=t instanceof Array?t[0]:t;if(void 0===e||"string"!=typeof e)return"white";t=[];return e.startsWith("rgb")?t=e.match(/\d+/g):e.startsWith("#")&&(4===e.length||5===e.length?t=[parseInt(e.substring(1,1),16),parseInt(e.substring(2,1),16),parseInt(e.substring(3,1),16)]:7!==e.length&&9!==e.length||(t=[parseInt(e.substring(1,2),16),parseInt(e.substring(3,2),16),parseInt(e.substring(5,2),16)])),3<=t.length&&125<Math.round((299*parseInt(t[0])+587*parseInt(t[1])+114*parseInt(t[2]))/1e3)?"black":"white"}function P(t){var e,s;t._icon&&(e=b(t),(s=t._icon.firstChild).firstChild.style.fill=e[0],s.firstChild.style.fillOpacity=e[1],1<s.children.length&&(s.children[1].style.fill=x(t)))}function I(t,e){for(var s,n,i,o=t._markers.length,r=0;r<o;++r)i=t._markers[r],(!s||void 0!==i._sta._color_value&&i._sta._color_value>s)&&(s=i._sta._color_value,n=i._sta._color);for(o=t._childClusters.length,r=0;r<o;++r){var a=t._childClusters[r];e&&I(a,!0),(!s||void 0!==a._ll_value&&a._ll_value>s)&&(s=a._ll_value,n=a._ll_color)}t._ll_value=s,t._ll_color=n,t._textColor=M(n),P(t)}function E(t){if(t){if(t[0][1]<=t[1][1])return L.latLngBounds(t);for(var e=t[0][1],s=t[1][1];s<e;)s+=360;return L.latLngBounds([[t[0][0],e],[t[1][0],s]])}}function T(t){var e=!1;try{s=r.options.features.geoJSON}catch(t){s=null}l.features.geoJSON!==s&&(e=!0),angular.merge(l,r.options);var s=E(l.maxBounds);s?(t&&t.fitBounds(s,{animate:!1}),_=s.getWest(),g=s.getEast()):_=g=null,t&&(p&&(t.removeLayer(p),p=null),l.showMaxBounds&&(p=L.rectangle(s,{color:"black",fill:!1,weight:2,dashArray:"2, 4",clickable:!1})).addTo(t),e&&(t=t,u&&(t.removeLayer(u),u=void 0),l.features.geoJSON&&((u=L.geoJson(l.features.geoJSON,{style:function(t){var e=t.properties,t={color:B(e.pen.color),weight:e.pen.width||1,opacity:3<e.pen.color.length?e.pen.color[3]/255:1,clickable:!1};return e.brush?(t.fill=!0,t.fillColor=B(e.brush.color),t.fillOpacity=3<e.brush.color.length?e.brush.color[3]/255:1):t.fill=!1,t}})).setZIndex(-2e7),u.addTo(t))))}function D(t,e,s){for(var n=e.length,i=0;i<n;++i){var o=e[i];if(null===o[0]||t<=o[0])return s?o[1]:"rgb("+o[1][0]+","+o[1][1]+","+o[1][2]+")"}return s?[0,0,0]:"#000"}function O(t,e){return l.events.colorByAge?D(t._age,l.ages,e):D(t._event.depth,l.depths,e)}function A(t){t=l.magnitudes.scaleM*t+l.magnitudes.scaleN;return.5*(t=t<l.magnitudes.minSize?l.magnitudes.minSize:t)}function B(t){return 3<=t.length?"rgb("+t[0]+","+t[1]+","+t[2]+")":"#000"}var z={map:null,tileLayer:null,blinkerActive:!1,stations:{features:{},markers:[],cluster:null,triggers:[],dirty:!1,queuedTriggers:[]},events:{features:{},dirty:!1,current:null},fitBounds:function(t){t=E(t);t&&this.map&&this.map.fitBounds(t,{animate:!1})},clearStations:function(){this.stations.features={};for(var t=this.stations.markers.length,e=0;e<t;++e){var s=this.stations.markers[e];s.off("mouseover",k),s.off("mouseout",w),s.off("selected",C),s.off("unselected",S),s.off("click",Z),s.unbindPopup(),this.map.removeLayer(s)}this.stations.cluster&&(this.stations.cluster.clearLayers(),this.map.removeLayer(this.stations.cluster),this.stations.cluster=null),this.stations.markers=[],this.stations.triggers=[]},addStation:function(t,e,s,n,i){if(!l.inventory.allowAll&&!i)return null;var o=s.code+"."+n.code;if(this.stations.features.hasOwnProperty(o))return null;if(null!==_)for(;e<_;)e+=360;if(null!==g)for(;g<e;)e-=360;null!==_&&null!==g&&(180<(i=e-.5*(_+g))?e-=360:i<-180&&(e+=360));t=L.polygonMarker([t,e],v,h);return t._net=s,t._sta=n,t._staid=o,t._staid2=t._staid+" ",t.on("mouseover",k),t.on("mouseout",w),t.on("selected",C),t.on("unselected",S),this.listener&&this.listener.getStationInfo||t.bindPopup("<strong>"+t._staid+"</strong><br/><i>"+t._sta.description+"<br/>"+t._net.description+"</i>"),t.on("click",Z),t.setStyle(y(t._sta)),t.setStyle(d),this.stations.features[t._staid]=[s,n,t],this.stations.markers.push(t),t},updateStations:function(){if(this.clearStations(),r.inventory){var t=new Date;l.inventory.cluster.enable?this.stations.cluster=L.markerClusterGroup({maxClusterRadius:l.inventory.cluster.radius,showCoverageOnHover:l.inventory.cluster.showCoverageOnHover,spiderfyOnMaxZoom:!0,disableClusteringAtZoom:l.inventory.cluster.maxZoom,iconCreateFunction:function(t){var e=100<=t.getChildCount()?50:10<=t.getChildCount()?40:30;return L.clusterIcon({className:"marker-cluster",fill:b(t),cluster:t,text:t.getChildCount(),textColor:x(t),iconSize:[e,e]})}}):this.stations.cluster=null;for(var e=r.inventory,s=0;s<e.network.length;++s)for(var n=e.network[s],i=0;i<n.station.length;++i){var o=n.station[i];new Date(o.start)>t||o.end&&new Date(o.end)<t||this.addStation(o.latitude,o.longitude,n,o,o.detecStream)}this.stations.markers.sort(function(t,e){return e._sta.latitude-t._sta.latitude}),this.addStationsToMap()}},addStationsToMap:function(){if(this.map){var t;if(this.stations.dirty=!1,this.stations.cluster){for(t=0;t<this.stations.markers.length;++t)this.stations.cluster.addLayer(this.stations.markers[t]);this.map.addLayer(this.stations.cluster)}else for(t=0;t<this.stations.markers.length;++t)this.stations.markers[t].addTo(this.map);z.listener&&z.listener.stationsAdded&&z.listener.stationsAdded()}else this.stations.dirty=!0},clearEvents:function(){if(this.map)for(var t in this.events.features){t=this.events.features[t];t.off("click",F),this.map.removeLayer(t)}this.events.features={}},addEvent:function(t){var e,s,n=t.hasOwnProperty("mag")?A(t.mag):l.magnitudes.minSize,i=t.lon;if(null!==_)for(;i<_;)i+=360;if(null!=g)for(;g<i;)i-=360;return null!==_&&null!==g&&(180<(s=i-.5*(_+g))?i-=360:s<-180&&(i+=360)),(e=new(t._latest?L.StarMarker:L.CircleMarker)([t.lat,i]))._event=t,e._age=.001*((new Date).getTime()-t.otime),n={color:s=O(e),fillColor:s,weight:2,opacity:1,fillOpacity:.5,radius:n,clickable:!o.hasOwnProperty("static")},e._style=n,e.setStyle(e._style),e.on("mouseover",N),e.on("mouseout",$),e.on("click",F),this.events.features[t.eventID]=e},removeEvent:function(t){var e;t in this.events.features&&(this.map&&((e=this.events.features[t]).off("mouseover",N),e.off("mouseout",$),e.off("click",F),this.map.removeLayer(e)),delete this.events.features[t])},updateEvent:function(t){var e,s,n;if(t.eventID in this.events.features){(e=this.events.features[t.eventID])._age=.001*((new Date).getTime()-t.otime),s=t.hasOwnProperty("mag")?A(t.mag):l.magnitudes.minSize,n=O(e),e._style.color=n,e._style.fillColor=n,e._style.radius=s;var i=t.lon;if(null!==_)for(;i<_;)i+=360;if(null!=g)for(;g<i;)i-=360;e.setLatLng([t.lat,i]),e.setStyle(e._style)}else(e=this.addEvent(t))&&this.map&&l.showEvents&&e.addTo(this.map)},setEventSpecialSymbol:function(t,e){var s;t.eventID in this.events.features&&(s=this.events.features[t.eventID],(e=new(e?L.StarMarker:L.CircleMarker)(s.getLatLng()))._event=s._event,e._age=s._age,e._style=s._style,e.setStyle(s._style),s.off("mouseover",N),s.off("mouseout",$),s.off("click",F),e.on("mouseover",N),e.on("mouseout",$),e.on("click",F),this.events.features[t.eventID]=e,this.map&&(this.map.removeLayer(s),e.addTo(this.map)),this.events.current===s&&(this.events.current=e))},bringToFront:function(t){t.bringToFront()},restoreOrder:function(t){t.restoreOrder&&t.restoreOrder()},centerEvent:function(t){var e,s=t.lon;if(null!==_)for(;s<_;)s+=360;if(null!=g)for(;g<s;)s-=360;null!==_&&null!==g&&(180<(e=s-.5*(_+g))?s-=360:e<-180&&(s+=360)),this.map.panTo([t.lat,s],null,{animate:!0})},setCurrentEvent:function(t,e){this.events.current&&(this.events.current.setStyle(this.events.current._style),this.events.current._map&&this.restoreOrder(this.events.current)),t?t in this.events.features?(this.events.current=this.events.features[t],this.events.current._map&&this.bringToFront(this.events.current),e&&this.map&&(e=this.events.current._event,this.centerEvent(e)),l.blinking&&this.setBlinkState()):console.debug("Cannot set current event: "+t+" not found"):this.events.current=null},updateEvents:function(){if(this.clearEvents(),r.events){for(var t in r.events){var e=r.events[t];this.addEvent(e)}this.addEventsToMap(),l.autoCenterLastEvent&&e&&this.setCurrentEvent(e.eventID,!0)}},addEventsToMap:function(){this.map?(this.events.dirty=!1,this.setEventsVisible(l.showEvents),z.listener&&z.listener.eventsAdded&&z.listener.eventsAdded()):this.events.dirty=!0},updateColorsOfEvents:function(){if(l.events.colorByAge){var t=(new Date).getTime();for(i in this.events.features){var e=this.events.features[i];e._age=.001*(t-e._event.otime),color=O(e),e._style.color=color,e._style.fillColor=color,e.setStyle(e._style)}}},setEventsVisible:function(t){if(t){for(var e in this.events.features)this.events.features[e].addTo(this.map);!s&&l.events.updateInterval&&l.events.colorByAge&&(this.updateColorsOfEvents(),s=j(this.updateColorsOfEvents.bind(this),1e3*l.events.updateInterval))}else{for(e in this.events.features)this.map.removeLayer(this.events.features[e]);s&&(j.cancel(s),s=void 0)}},removeBlinkState:function(){if(this.blinkerActive){this.stations.cluster&&!function t(e,s){for(var n=e._childClusters.length-1;0<=n;--n){var i=e._childClusters[n];i._icon&&(i._icon.firstChild.firstChild.style.stroke="rgb(255,255,255)",i._icon.firstChild.firstChild.style.strokeWidth="1",i._icon.firstChild.firstChild.style.strokeOpacity="0.4"),i._ll_opacity=0,t(i,s)}}(this.stations.cluster._topClusterLevel,"marker-cluster-triggering");for(var t=this.stations.triggers.length,e=0;e<t;++e)this.stations.triggers[e].setStyle(d);this.events.current&&this.events.current.setStyle(this.events.current._style),this.blinkerActive=!1}},setBlinkState:function(){if(!this.blinkerActive){for(var t=(new Date).getTime(),e=!1,s=this.stations.triggers.length,n=0;n<s;++n){var i,o=t-this.stations.triggers[n]._sta._trigger;!this.stations.triggers[n]._sta._trigger||c<o?(this.stations.triggers[n]._sta._trigger=void 0,this.stations.triggers[n].setStyle(d),this.stations.triggers.splice(n,1),--n,--s):(i=this.stations.triggers[n],(o=(c-o)/c)<0?o=0:1<o&&(o=1),i.setStyle(m),i.setStyle({opacity:o}),!this.stations.cluster||(i=this.stations.cluster.getVisibleParent(i))&&(!i._ll_opacity||i._ll_opacity<o)&&(i._ll_opacity=o),e=!0)}e&&this.stations.cluster&&!function t(e,s){for(var n=e._childClusters.length-1;0<=n;--n){var i=e._childClusters[n];i._icon&&0<i._ll_opacity&&(i._icon.firstChild.firstChild.style.stroke="rgb(255,0,0)",i._icon.firstChild.firstChild.style.strokeWidth="10%",i._icon.firstChild.firstChild.style.strokeOpacity=i._ll_opacity),t(i,s)}}(this.stations.cluster._topClusterLevel,"marker-cluster-triggering"),this.events.current&&(this.events.current.setStyle({color:"rgb(33,53,81)",fillColor:"rgb(122,212,226)",fillOpacity:.8}),e=!0),this.blinkerActive=e&&l.blinking,!a&&this.blinkerActive&&(a=j(function(){z.blinkerActive?z.removeBlinkState():z.setBlinkState()},1e3))}},addTriggers:function(t){if(0!==t.length)if(this.map){for(var e=0<this.stations.triggers.length,s=(new Date).getTime(),n=t.length,i=0;i<n;++i){var o,r,a=t[i],l=a.waveformID.networkCode+"."+a.waveformID.stationCode;l in this.stations.features&&(o=a._time,(a=(r=this.stations.features[l])[1])._trigger?a._trigger>o||(a._trigger=o):c<(l=s-o)||(a._trigger=o,(r=r[2]).setStyle(m),this.stations.triggers.push(r),(l=(c-l)/c)<0?l=0:1<l&&(l=1),r.setStyle({opacity:l})))}e||this.setBlinkState()}else this.stations.queuedTriggers=t},setColor:function(t,e,s){if(!(t in z.stations.features))return!1;var n=z.stations.features[t],t=n[2];if(n[1]._color!==e){if(void 0===e?delete n[1]._color:n[1]._color=e,void 0===s?delete n[1]._color_value:n[1]._color_value=s,t.setStyle(t._sta._selected?f:y(t._sta)),this.stations.cluster){var i=t.__parent;if(!i)return!0;for(!i._ll_value||s>i._ll_value?(i._ll_value=s,i._ll_color=e,i._textColor=M(e),P(i)):I(i,!1),i=i.__parent;i;)I(i,!1),i=i.__parent}return!0}},resetStationColors:function(){for(var t in z.stations.features){var e=z.stations.features[t],t=e[2];delete e[1]._color,delete e[1]._color_value,t.setStyle(t._sta._selected?f:y(t._sta))}this.stations.cluster&&!function t(e){for(var s=e._childClusters.length-1;0<=s;--s){var n=e._childClusters[s];delete n._ll_color,delete n._ll_value,delete n._textColor,P(n),t(n)}}(this.stations.cluster._topClusterLevel)},setClusterEnabled:function(t){if(l.inventory.cluster.enable!==t){l.inventory.cluster.enable=t,this.updateStations();for(var e=0;e<z.stations.markers.length;++e)z.stations.markers[e]._sta._trigger&&z.stations.triggers.push(z.stations.markers[e]);this.stations.cluster&&I(this.stations.cluster._topClusterLevel,!0)}}};function Z(t){var e,s;z.listener&&(z.listener.getStationInfo&&(e=t.target,(s=z.listener.getStationInfo(e._net,e._sta))&&L.popup().setLatLng(e.getLatLng()).setContent(s).openOn(z.map)),z.listener.stationClicked&&(e=t.target,z.listener.stationClicked(e._net,e._sta)))}function N(t){z.listener&&z.listener.eventMouseOver&&((t=t.target)._symbol&&(t=t._symbol),z.listener.eventMouseOver(t._event))}function $(t){z.listener&&z.listener.eventMouseOut&&((t=t.target)._symbol&&(t=t._symbol),z.listener.eventMouseOut(t._event))}function F(t){z.listener&&z.listener.eventClicked&&((t=t.target)._symbol&&(t=t._symbol),z.listener.eventClicked(t._event))}function U(t){for(var e=z.stations.markers.length,s=0;s<e;++s){var n=z.stations.markers[s];t.boxSelectBounds.contains(n.getLatLng())?z.stations.features[n._staid][1]._selected||(n.fire("selected"),z.stations.features[n._staid][1]._selected=!0):t.boxSelectMultiple||z.stations.features[n._staid][1]._selected&&(n.fire("unselected"),z.stations.features[n._staid][1]._selected=!1)}}function H(t){z.listener&&z.listener.mapClicked&&r.$apply(function(){z.listener.mapClicked(t)})}function J(t){r.$apply(function(){if(t.originalEvent.shiftKey){for(r.cursor=t.latlng;r.cursor.lng<-180;)r.cursor.lng+=360;for(;180<r.cursor.lng;)r.cursor.lng-=360;r.cursor.text=Math.abs(r.cursor.lat).toFixed(4)+"° "+(r.cursor.lat<0?"S":"N")+" "+Math.abs(r.cursor.lng).toFixed(4)+"° "+(r.cursor.lng<0?"W":"E"),z.listener&&z.listener.mapMouseMove&&z.listener.mapMouseMove(t)}else r.cursor=null})}function R(t){r.$apply(function(){r.cursor=null})}r.$watch("options",function(t,e){z.map&&t!==e&&T(z.map)}),r.$watch("options.mapURI",function(t,e){!z.tileLayer&&r.options&&r.options.mapURI&&(z.tileLayer=L.tileLayer(r.options.mapURI,{attribution:"Map data © OpenStreetMap contributors",minZoom:0,maxZoom:l.maxZoom,maxNativeZoom:l.maxLevel}),z.map&&z.map.addLayer(z.tileLayer))}),r.$watch("options.showEvents",function(t){l.showEvents=t,z.setEventsVisible(t)}),T(z.map),V(function(){if(z.map=L.map(n,{zoomControl:l.zoomControl,boxZoom:!0,boxSelect:!0,center:[0,0],zoom:3,worldCopyJump:!1,attributionControl:!1}),z.tileLayer&&z.map.addLayer(z.tileLayer),T(z.map),r.select?(z.map.boxZoom.disable(),z.map.dragging.disable(),z.map.boxSelect.enable()):(z.map.boxZoom.enable(),z.map.dragging.enable(),z.map.boxSelect.disable()),o.hasOwnProperty("static")&&(z.map.dragging.disable(),z.map.touchZoom.disable(),z.map.doubleClickZoom.disable(),z.map.scrollWheelZoom.disable(),z.map.boxZoom.disable(),z.map.keyboard.disable()),z.map.on("boxselectend",U),z.map.on("click",H),z.map.on("mousemove",J),z.map.on("mouseout",R),l.minimap.enable)try{z.minimap=L.control.minimap(l.minimap),z.map.addControl(z.minimap)}catch(t){console.error(t.message)}if(r.mapInterface&&r.mapInterface.initialized&&r.mapInterface.initialized(),z.stations.dirty&&z.addStationsToMap(),z.events.dirty&&z.addEventsToMap(),l.autoCenterLastEvent){var t,e;for(e in r.events)t=r.events[e];t&&z.setCurrentEvent(t.eventID,!0)}0<z.stations.queuedTriggers.length&&(z.addTriggers(z.stations.queuedTriggers),z.stations.queuedTriggers=[])},100),o.hasOwnProperty("mapInterface")&&r.mapInterface&&((r.mapInterface.map=z).listener=r.mapInterface,r.$watch("mapInterface",function(t,e){e&&(e.map=null),r.mapInterface&&(r.mapInterface.map=z),z.listener=r.mapInterface})),r.$watch("events",function(t,e){z.updateEvents()}),r.$watch("inventory",function(t,e){z.updateStations()}),r.$watch("select",function(t,e){z.map&&(t?(z.map.boxZoom.disable(),z.map.dragging.disable(),z.map.boxSelect.enable()):(z.map.boxZoom.enable(),z.map.dragging.enable(),z.map.boxSelect.disable()))}),r.$on("$destroy",function(){angular.isDefined(a)&&(j.cancel(a),a=void 0),angular.isDefined(s)&&(j.cancel(s),s=void 0),z.clearStations(),z.clearEvents(),z.map&&(z.map.off("boxselectend",U),z.map.off("click",H),z.map.off("mousemove",J),z.map.off("mouseout",R),z.map.remove()),r.mapInterface&&(r.mapInterface.map=null),z.listener=null})}}}]).directive("legendLl",function(){return{restrict:"EA",scope:{items:"="},template:'<div class="title">{{items.title}}</div>',link:function(r,a,t){r.$watch("items.labels",function(){a.children().remove(".entries");var t=angular.element('<div class="entries"></div>');if(a.append(t),r.items){for(var e="",s=null,n=0;n<r.items.labels.length;++n){var i,o=Array.isArray&&Array.isArray(r.items.labels[n][1])?(i="background-color:rgb("+r.items.labels[n][1].join(",")+")","color"):angular.isNumber(r.items.labels[n][1])?(i="width:"+r.items.labels[n][1]+"px;height:"+r.items.labels[n][1]+"px","box"):(i="background-color:"+r.items.labels[n][1],"color");e+='<div class="entry"><i class="'+o+'" style="'+i+'"></i> ',2<r.items.labels[n].length?(angular.isNumber(r.items.labels[n][0])&&(s=r.items.labels[n][0]),e+=r.items.labels[n][2]):angular.isNumber(r.items.labels[n][0])?e+="&lt;="+(s=r.items.labels[n][0]):r.items.labels[n][0]?e+=r.items.labels[n][0]:e+="&gt;"+s,e+="</div>"}t.append(e)}})}}});
"use strict";!function(o){o.extend({noticeAdd:function(t){var e=o.extend({},{inEffect:{opacity:"show"},inEffectDuration:600,stayTime:3e3,title:"Notice",text:"",stay:!1,type:"notice"},t),i=o(".notice-wrap").length?o(".notice-wrap"):o("<div></div>").addClass("notice-wrap").appendTo("body"),t=o("<div></div>").addClass("notice-item-wrapper"),n=o("<div></div>").hide().addClass("notice-item "+e.type).appendTo(i).html('<p><span class="notice-title">'+e.title+"</span>"+e.text+"</p>").animate(e.inEffect,e.inEffectDuration).wrap(t);o("<div></div>").addClass("notice-item-close").prependTo(n).html("&times;").click(function(){o.noticeRemove(n)});e.stay||setTimeout(function(){o.noticeRemove(n)},e.stayTime)},noticeRemove:function(t){t.animate({opacity:"0"},600,function(){t.parent().animate({height:"0px"},300,function(){t.parent().remove()})})}})}(jQuery),angular.module("notice-service",[]).factory("gmNotice",function(){var o={stayTime:5e3};function n(t,e,i,n){i={text:e,stay:!1,title:t,stayTime:void 0!==n?n:o.stayTime,type:"notice-"+i,rawtype:i};$.noticeAdd(i)}return{error:function(t,e,i){n(t,e,"error",i)},warning:function(t,e,i){n(t,e,"warning",i)},info:function(t,e,i){n(t,e,"info",i)},success:function(t,e,i){n(t,e,"success",i)},defaults:function(t){o=t}}});
"use strict";angular.module("gm.filters",[]).filter("toArray",function(){return function(t){if(!(t instanceof Object))return t;var r,n=[];for(r in t)t.hasOwnProperty(r)&&n.push(t[r]);return n}}).filter("page",function(){return function(t,r,n){return t?t.slice(r*n,(r+1)*n):[]}}).filter("pages",function(){return function(t,r){return t?((t.length+r-1)/r).toFixed(0):0}}).filter("timeSpan",function(){var a={s:"few seconds",m:"minute",mm:"%d minutes",h:"hour",hh:"%d hours",d:"day",dd:"%d days",M:"month",MM:"%d months",y:"year",yy:"%d years"};return function(t){if(!t)return"";var r=Math.round(Math.abs(3600*t*1e3)/1e3),n=Math.round(r/60),e=Math.round(n/60),u=Math.round(e/24),t=Math.round(u/365),t=(r<45?["s",r]:1===n&&["m"])||n<45&&["mm",n]||1===e&&["h"]||e<22&&["hh",e]||1===u&&["d"]||u<=25&&["dd",u]||u<=45&&["M"]||u<345&&["MM",Math.round(u/30)]||1===t&&["y"]||["yy",t];return t[1]?a[t[0]].replace(/%d/i,t[1]):a[t[0]]}}).filter("ago",function(){var i={s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function t(t){if(!t)return"";var r=(new Date).getTime()-t,n=Math.round(Math.abs(r)/1e3),e=Math.round(n/60),u=Math.round(e/60),a=Math.round(u/24),t=Math.round(a/365),t=(n<45?["s",n]:1===e&&["m"])||e<45&&["mm",e]||1===u&&["h"]||u<22&&["hh",u]||1===a&&["d"]||a<=25&&["dd",a]||a<=45&&["M"]||a<345&&["MM",Math.round(a/30)]||1===t&&["y"]||["yy",t];return 0<=r?(t[1]?i[t[0]].replace(/%d/i,t[1]):i[t[0]])+" ago":"in "+(t[1]?i[t[0]].replace(/%d/i,t[1]):i[t[0]])}return t.$stateful=!0,t}).filter("lat",function(){return function(t){return Math.abs(t).toFixed(2)+"° "+(t<0?"S":"N")}}).filter("lon",function(){return function(t){return Math.abs(t).toFixed(2)+"° "+(t<0?"W":"E")}}).filter("mag",function(){return function(t){return"number"==typeof t?t.toFixed(1):"-.-"}}).filter("magdesc",function(){return function(t){return"number"==typeof t?"M"+t.toFixed(1):"all"}}).filter("characters",function(){return function(t,r,n){if(isNaN(r))return t;if(r<=0)return"";if(t&&t.length>=r){if(t=t.substring(0,r),n)for(;" "===t.charAt(t.length-1);)t=t.substr(0,t.length-1);else{n=t.lastIndexOf(" ");-1!==n&&(t=t.substr(0,n))}return t+"..."}return t}});
angular.module("gm-clock",[]).directive("clock",["$timeout",function(c){return{restrict:"E",replace:!1,template:"<span>{{hours}}:{{minutes}}</span>",link:function(n,e,r){function o(e,t){for(var n=e.toString();n.length<t;)n="0"+n;return n}function i(){if(r.hasOwnProperty("tz"))try{var e=parseInt(r.tz,10),t=new Date;t=new Date(t.getTime()+60*(t.getTimezoneOffset()+60*e)*1e3)}catch(e){return void console.error("invalid tz parameter")}else t=new Date;n.hours=o(t.getHours(),2),n.minutes=o(t.getMinutes(),2),n.seconds=o(t.getSeconds(),2),t=6e4*(Math.floor(t.getTime()/6e4)+1)-t.getTime(),a=c(i,t)}var a;i(),n.$on("destroy",function(){a&&c.cancel(a)})}}}]);
Date.ext={},Date.ext.util={},Date.ext.util.xPad=function(e,t,a){for(void 0===a&&(a=10);parseInt(e,10)<a&&1<a;a/=10)e=t.toString()+e;return e.toString()},Date.prototype.locale="en-GB",document.getElementsByTagName("html")&&document.getElementsByTagName("html")[0].lang&&(Date.prototype.locale=document.getElementsByTagName("html")[0].lang),Date.ext.locales={},Date.ext.locales.en={a:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],A:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],b:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],B:["January","February","March","April","May","June","July","August","September","October","November","December"],c:"%a %d %b %Y %T %Z",p:["AM","PM"],P:["am","pm"],x:"%d/%m/%y",X:"%T"},Date.ext.locales["en-US"]=Date.ext.locales.en,Date.ext.locales["en-US"].c="%a %d %b %Y %r %Z",Date.ext.locales["en-US"].x="%D",Date.ext.locales["en-US"].X="%r",Date.ext.locales["en-GB"]=Date.ext.locales.en,Date.ext.locales["en-AU"]=Date.ext.locales["en-GB"],Date.ext.formats={1:function(e){return Math.round(.01*e.getMilliseconds())},2:function(e){return Date.ext.util.xPad(Math.round(.1*e.getMilliseconds()),0,10)},3:function(e){return Date.ext.util.xPad(Math.round(e.getMilliseconds()),0,100)},a:function(e){return Date.ext.locales[e.locale].a[e.getDay()]},A:function(e){return Date.ext.locales[e.locale].A[e.getDay()]},b:function(e){return Date.ext.locales[e.locale].b[e.getMonth()]},B:function(e){return Date.ext.locales[e.locale].B[e.getMonth()]},c:"toLocaleString",C:function(e){return Date.ext.util.xPad(parseInt(e.getFullYear()/100,10),0)},d:["getDate","0"],e:["getDate"," "],g:function(e){return Date.ext.util.xPad(parseInt(Date.ext.util.G(e)/100,10),0)},G:function(e){var t=e.getFullYear(),a=parseInt(Date.ext.formats.V(e),10),e=parseInt(Date.ext.formats.W(e),10);return a<e?t++:0===e&&52<=a&&t--,t},H:["getHours","0"],I:function(e){e=e.getHours()%12;return Date.ext.util.xPad(0==e?12:e,0)},j:function(e){var t=e-new Date(e.getFullYear()+"/1/1 GMT");t+=6e4*e.getTimezoneOffset();t=parseInt(t/6e4/60/24,10)+1;return Date.ext.util.xPad(t,0,100)},m:function(e){return Date.ext.util.xPad(e.getMonth()+1,0)},M:["getMinutes","0"],p:function(e){return Date.ext.locales[e.locale].p[12<=e.getHours()?1:0]},P:function(e){return Date.ext.locales[e.locale].P[12<=e.getHours()?1:0]},S:["getSeconds","0"],u:function(e){e=e.getDay();return 0===e?7:e},U:function(e){var t=parseInt(Date.ext.formats.j(e),10),e=6-e.getDay(),e=parseInt((t+e)/7,10);return Date.ext.util.xPad(e,0)},V:function(e){var t=parseInt(Date.ext.formats.W(e),10),a=new Date(e.getFullYear()+"/1/1").getDay(),a=t+(4<a||a<=1?0:1);return 53==a&&new Date(e.getFullYear()+"/12/31").getDay()<4?a=1:0===a&&(a=Date.ext.formats.V(new Date(e.getFullYear()-1+"/12/31"))),Date.ext.util.xPad(a,0)},w:"getDay",W:function(e){var t=parseInt(Date.ext.formats.j(e),10),e=7-Date.ext.formats.u(e),e=parseInt((t+e)/7,10);return Date.ext.util.xPad(e,0,10)},y:function(e){return Date.ext.util.xPad(e.getFullYear()%100,0)},Y:"getFullYear",z:function(e){e=e.getTimezoneOffset();return(0<e?"-":"+")+Date.ext.util.xPad(parseInt(Math.abs(e/60),10),0)+Date.ext.util.xPad(e%60,0)},Z:function(e){return e.toString().replace(/^.*\(([^)]+)\)$/,"$1")},"%":function(e){return"%"}},Date.ext.aggregates={c:"locale",D:"%m/%d/%y",h:"%b",n:"\n",r:"%I:%M:%S %p",R:"%H:%M",t:"\t",T:"%H:%M:%S",x:"locale",X:"locale"},Date.ext.aggregates.z=Date.ext.formats.z(new Date),Date.ext.aggregates.Z=Date.ext.formats.Z(new Date),Date.ext.unsupported={},Date.prototype.strftime=function(e,t){if(t)return new Date(this.getTime()+60*this.getTimezoneOffset()*1e3).strftime(e);this.locale in Date.ext.locales||(this.locale.replace(/-[a-zA-Z]+$/,"")in Date.ext.locales?this.locale=this.locale.replace(/-[a-zA-Z]+$/,""):this.locale="en-GB");for(var n=this;e.match(/%[cDhnrRtTxXzZ]/);)e=e.replace(/%([cDhnrRtTxXzZ])/g,function(e,t){var a=Date.ext.aggregates[t];return"locale"==a?Date.ext.locales[n.locale][t]:a});t=e.replace(/%([123aAbBCdegGHIjmMpPSuUVwWyY%])/g,function(e,t){var a=Date.ext.formats[t];return"string"==typeof a?n[a]():"function"==typeof a?a.call(n,n):"object"==typeof a&&"string"==typeof a[0]?Date.ext.util.xPad(n[a[0]](),a[1]):t}),n=null;return t};
!function(){function h(t,i,s){var n,o=this;this._map=i,this.options=s,this.ctx=t.getContext("2d"),this.img=new Image,this.img.onload=function(){o.update()},s.image&&(n=s.image),this.img.src=n,this.lonMin=-180,this.setMap(i)}h.prototype.setMap=function(t){this._map&&(this._map.off("moveend",this._sync,this),this._map.off("move",this._sync,this),this._map.off("movestart",this._sync,this),this._map.off("move",this._sync,this),this._map.off("moveend",this._sync,this)),this._map=t,this.lonMin=-180,this._map?(this.displayRect=this._map.getBounds(),this._map.on("moveend",this._sync,this),this._map.on("move",this._sync,this),this._map.on("movestart",this._sync,this),this._map.on("move",this._sync,this),this._map.on("moveend",this._sync,this)):delete this.displayRect,this.update()},h.prototype._normalizeLon=function(t){for(;t<-180;)t+=360;for(;180<=t;)t-=360;return t},h.prototype._sync=function(){this.displayRect=this._map.getBounds();var t,i=this.displayRect.getEast()-this.displayRect.getWest();this.lonMin=-180,i<360&&(t=.5*i,(i=this.displayRect.getWest()+t)-t<-180?this.lonMin=i-t-1:180<i+t&&(this.lonMin=i+t-360+1)),this.update()},h.prototype.update=function(){this.ctx.save(),this.ctx.canvas.width!==this.ctx.canvas.offsetWidth&&(this.ctx.canvas.width=this.ctx.canvas.offsetWidth),this.ctx.canvas.height!==this.ctx.canvas.offsetHeight&&(this.ctx.canvas.height=this.ctx.canvas.offsetHeight);var t,i=this._normalizeLon(this.lonMin),s=Math.floor(this.img.width*(i+180)/360),n=Math.floor(this.ctx.canvas.width*(i+180)/360);this.ctx.strokeStyle="rgba(0,0,0,0)",this.ctx.fillStyle="rgba(0,0,0,0)",this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),0===s?this.ctx.drawImage(this.img,0,0,this.img.width,this.img.height,0,0,this.ctx.canvas.width,this.ctx.canvas.height):(this.ctx.drawImage(this.img,s,0,this.img.width-s,this.img.height,0,0,this.ctx.canvas.width-n,this.ctx.canvas.height),this.ctx.drawImage(this.img,0,0,s,this.img.height,this.ctx.canvas.width-n,0,n,this.ctx.canvas.height)),this.displayRect&&(this.options.rectOptions.color&&(this.ctx.strokeStyle=this.options.rectOptions.color),this.options.rectOptions.fill&&(this.ctx.fillStyle=this.options.rectOptions.fill),this.options.rectOptions.weight&&(this.ctx.lineWidth=this.options.rectOptions.weight),t=Math.floor(this.ctx.canvas.height-(this.displayRect.getNorth()+90)*this.ctx.canvas.height/180),s=Math.floor((180+this._normalizeLon(this.displayRect.getWest()+180-i))*this.ctx.canvas.width/360),n=Math.floor(this.ctx.canvas.height-(this.displayRect.getSouth()+90)*this.ctx.canvas.height/180),i=Math.floor((180+this._normalizeLon(this.displayRect.getEast()+180-i))*this.ctx.canvas.width/360),360<=this.displayRect.getEast()-this.displayRect.getWest()&&(s=0,i=this.ctx.canvas.width-1),Math.abs(i-s)<2&&(i=s+2),Math.abs(n-t)<2&&(n=t+2),t+=.5,n+=.5,(s+=.5)<=(i+=.5)?(this.ctx.beginPath(),this.ctx.moveTo(s,t),this.ctx.lineTo(i,t),this.ctx.lineTo(i,n),this.ctx.lineTo(s,n),this.ctx.lineTo(s,t)):(this.ctx.beginPath(),this.ctx.moveTo(this.ctx.canvas.width,t),this.ctx.lineTo(s,t),this.ctx.lineTo(s,n),this.ctx.lineTo(this.ctx.canvas.width,n),this.ctx.fill(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(0,t),this.ctx.lineTo(i,t),this.ctx.lineTo(i,n),this.ctx.lineTo(0,n)),this.ctx.fill(),this.ctx.stroke()),this.ctx.restore()},angular.module("leaflet-minimap",[]).directive("minimap",[function(){return{restrict:"EA",replace:!0,template:"<canvas></canvas>",scope:{options:"=",map:"="},link:function(t,o,i){var e=new h(o[0],null,{image:"../share/images/minimap.png",rectOptions:{color:"#213551",fill:"rgba(122,212,226,0.4)",weight:1}}),s=!1;function n(t,i){var s=o[0].getBoundingClientRect(),n=t.clientX-s.left,s=t.clientY-s.top,n=360*n/o[0].offsetWidth-180+(e.lonMin+180),s=180*(o[0].offsetHeight-s)/o[0].offsetHeight-90;e._map.panTo([s,n],{animate:void 0===i||i})}o.bind("click",function(t){n(t)}),o.bind("mousedown",function(t){return(1===t.which||1===t.button)&&void(s=!0)}),o.bind("mouseup",function(t){return(1===t.which||1===t.button)&&void(s=!1)}),o.bind("mousemove",function(t){return(1===t.which||1===t.button)&&(!!s&&(n(t,!1),!0))}),o.bind("mousewheel",function(t){t=L.DomEvent.getWheelDelta(t.originalEvent);e._map.zoomIn(t)}),t.$watch("map",function(t,i){e.setMap(t)}),t.$on("destroy",function(){e.setMap(null),o.unbind("click"),o.unbind("mousedown"),o.unbind("mouseup"),o.unbind("mousemove"),o.unbind("mousewheel")})}}}]),L.Control.MiniMap=L.Control.extend({options:{position:"topleft",width:256,height:128,image:"../share/images/minimap.png",rectOptions:{color:"#213551",fill:"rgba(122,212,226,0.4)",weight:1}},dragging:!1,onAdd:function(t){return this.mw=function(t){self._mousewheel(t)},this.cl=function(t){self._click(t)},this.mm=function(t){self._mousemove(t)},this.md=function(t){self._mousedown(t)},this.mu=function(t){self._mouseup(t)},this.container=L.DomUtil.create("canvas","minimap"),this.container.style.width=this.options.width+"px",this.container.style.height=this.options.height+"px",L.DomEvent.disableClickPropagation(this.container),L.DomEvent.on(this.container,"mousewheel",this.mw),L.DomEvent.on(this.container,"click",this.cl),L.DomEvent.on(this.container,"mousemove",this.mm),L.DomEvent.on(this.container,"mousedown",this.md),L.DomEvent.on(this.container,"mouseup",this.mu),this._minimap=new h(this.container,t,this.options),this.container},onRemove:function(t){L.DomEvent.off(this.container,"mousewheel",this.mw),L.DomEvent.off(this.container,"click",this.cl),L.DomEvent.off(this.container,"mousemove",this.mm),L.DomEvent.off(this.container,"mousedown",this.md),L.DomEvent.off(this.container,"mouseup",this.mu)},_click:function(t,i){var s=L.DomEvent.getMousePosition(t,this.container),n=360*s.x/this.container.offsetWidth-180+(this._minimap.lonMin+180),s=180*(this.container.offsetHeight-s.y)/this.container.offsetHeight-90;this._minimap._map.panTo([s,n],{animate:void 0===i||i}),L.DomEvent.stop(t)},_mousemove:function(t){return(1===t.which||1===t.button)&&(!!this.dragging&&void this._click(t,!1))},_mousedown:function(t){if(1!==t.which&&1!==t.button)return!1;this.dragging=!0},_mouseup:function(t){if(1!==t.which&&1!==t.button)return!1;this.dragging=!1},_mousewheel:function(t){var i=L.DomEvent.getWheelDelta(t);this._minimap._map.zoomIn(i),L.DomEvent.stop(t)}}),L.control.minimap=function(t){return new L.Control.MiniMap(t)}}();
G.TravelTimes.Decorator.prototype.setStyle=function(t){this._style=t},G.TravelTimes.Decorator.prototype.setMap=function(t){this._map!==t&&(this._map&&this._path&&this._map.removeLayer(this._path),this._map=t,this._map&&this._path&&(this._map.addLayer(this._path),this._path.bringToBack()))},G.TravelTimes.Decorator.prototype.updateLL=function(){return this.update()?(this._path&&this._path.setLatLngs(this.points),this._map&&!this._path&&(this._path=L.polyline(this.points,this._style),this._map.addLayer(this._path),this._path.bringToBack()),!0):(this._path&&(this._map&&this._map.removeLayer(this._path),delete this._path),!1)},G.TravelTimes.DecoratorPS=function(){this.ttP=new G.TravelTimes.Decorator(3,G.TravelTimes.P),this.ttS=new G.TravelTimes.Decorator(3,G.TravelTimes.S),this.ttP.setStyle({color:"#ddd",opacity:1,weight:2,fill:!1,fillOpacity:.4,smoothFactor:0}),this.ttS.setStyle({color:"#888",opacity:1,weight:2,fill:!1,fillOpacity:.4,smoothFactor:0})},G.TravelTimes.DecoratorPS.prototype.setCenter=function(t,e){this.ttP.setCenter(t,e),this.ttS.setCenter(t,e)},G.TravelTimes.DecoratorPS.prototype.setTime=function(t){this.ttP.setTime(t),this.ttS.setTime(t)},G.TravelTimes.DecoratorPS.prototype.step=function(t){this.ttP.step(t),this.ttS.step(t)},G.TravelTimes.DecoratorPS.prototype.setMap=function(t){this.ttP.setMap(t),this.ttS.setMap(t)},G.TravelTimes.DecoratorPS.prototype.updateLL=function(){var t=this.ttP.updateLL(),e=this.ttS.updateLL();return t||e};
"use strict";angular.element(document).ready(function(){document.getElementById("app").style.display="block"});var stationView=angular.module("StationView",["browsercheck","timeseries","mapwidget-ll","notice-service","gm.filters","leaflet-minimap","gm-clock","quakelink","recordstream"]).config(["$locationProvider",function(e){e.html5Mode(!1),e.hashPrefix("")}]);
"use strict";stationView.controller("mainCtrl",["$scope","$location","$http","$timeout","gmNotice","quakelink",function(w,a,e,b,S,t){var o=[[[101,101,103],"Not set"],[[99,165,103],"<= 20&thinsp;s",20],[[197,208,52],"<= 1&thinsp;min",60],[[255,231,131],"<= 3&thinsp;min",180],[[247,176,94],"<= 10&thinsp;min",600],[[224,51,71],"<= 0.5&thinsp;d",43200],[[193,194,196],"<= 1&thinsp;d",86400],[[141,141,143],"> 1&thinsp;d"]],s=[[[0,0,0],"Not set"],[[0,0,255],"<=0.2&thinsp;µm/s",.2],[[0,167,255],"0.4&thinsp;µm/s",.4],[[0,238,255],"0.8&thinsp;µm/s",.8],[[0,255,0],"1.5&thinsp;µm/s",1.5],[[255,255,0],"4&thinsp;µm/s",4],[[255,210,0],"12&thinsp;µm/s",12],[[255,160,0],"30&thinsp;µm/s",30],[[255,0,0],"60&thinsp;µm/s",60],[[160,0,60],">=150&thinsp;µm/s",150]];function C(){var e;w.currentStation&&((e=w.currentStation.net.code+"."+w.currentStation.sta.code)in w.qualityParameters?w.currentQuality=w.qualityParameters[e]:w.currentQuality=null,e in w.groundMotions?w.currentGroundMotion=w.groundMotions[e]:w.currentGroundMotion=null,e in w.maxGroundMotions?w.currentMaxGroundMotion=w.maxGroundMotions[e]:w.currentMaxGroundMotion=null)}function n(e){var t=a.search();if(t.net&&t.sta){if(w.inventory)if(w.currentStation&&w.currentStation.net.code===t.net&&w.currentStation.sta.code===t.sta)w.viewOptions.stationDetails=!0;else{var n=new G.Inventory(w.inventory),o=new Date,i=n.findNetwork(t.net,o);if(i){var o=n.findStation(i,t.sta,o);if(o)return i=i,o=o,w.viewOptions.eventDetails=!1,void(w.currentStation&&w.currentStation.sta===o?w.openStationDetails(i,o):(w.openStationDetails(i,o),w.config.stationLink&&(w.currentStation.link=w.config.stationLink.replace("${net}",i.code).replace("${sta}",o.code),w.currentStation.linkName=w.config.stationLinkName),C(),w.$broadcast("clearTrace"),o.detecStream&&w.$broadcast("showTrace",w.config,{net:i.code,sta:o.code,loc:o.detecLocid||"",cha:o.detecStream},w.config.trace,w.config.traceOptions)))}a.search("net",null).search("sta",null),w.viewOptions.stationDetails=!1}}else w.viewOptions.stationDetails=!1,w.$broadcast("clearTrace")}w.getQualityColorTime=function(e){return e<=20?["rgb(99,165,103)",1]:e<=60?["rgb(197, 208, 52)",1]:e<=180?["rgb(255, 231, 131)",1]:e<=600?["rgb(247, 176, 94)",1]:e<=43200?["rgb(224, 51, 71)",1]:e<=86400?["rgb(193, 194, 196)",1]:86400<e?["rgb(141,141,143)",1]:"rgb(101, 101, 103)"},w.getGMColor=function(e){var t=s.length;if(e<s[1][2])return"rgb("+s[1][0].join(",")+")";for(var n,o,i,a=2;a<t;++a)if(e<=s[a][2]){var r=(e-s[a-1][2])/(s[a][2]-s[a-1][2]);return"rgb("+(n=s[a-1][0],o=s[a][0],i=void 0,i=1-r,[n[0]*i+o[0]*r|0,n[1]*i+o[1]*r|0,n[2]*i+o[2]*r|0].join(","))+")"}return"rgb("+s[t-1][0].join(",")+")"},w.config={serverAPI:"../",quakelinkURL:"http://localhost:18080/events/query",mode:"delay",map:{showEvents:!1,triggerDuration:6e5,ampLifeSpan:3e5,eventHours:168,mapURI:"",maxZoom:10,zoomControl:!1,currentPosition:!0,maxBounds:[[-90,-225],[90,225]],minimap:{enable:!1},inventory:{cluster:{enable:!0},allowAll:!0,normalStyle:{fillColor:"#000",fillOpacity:.5}},legend:{title:"Delay",labels:o,position:"topright"},magnitudes:{scaleM:4.9,scaleN:-5.88,minSize:6},depths:[],ages:[]},trace:{interactive:!1,xaxis:{min:0,max:0,ruler:!1,referenceTime:null},yaxis:{autoScale:!0},grid:{show:!0}},traceOptions:{color:"#888",optimize:!0}},w.view={details:!1,map:!0,legend:{depths:{title:"Depth in km",labels:w.config.map.depths},ages:{title:"Event age",labels:w.config.map.ages},magnitudes:{title:"Magnitude",labels:[]}}};var i=w.showConfig=!1;w.setConfigVisibility=function(e){"hide"===e?(i=!1,b(function(){i||(w.showConfig=!1)},300)):(i=!0,w.showConfig=!0)},w.updateEvent=function(e){w.mapHandler.map&&w.mapHandler.map.updateEvent(e)},w.removeEvent=function(e){w.mapHandler.map&&w.mapHandler.map.removeEvent(e.eventID),e._ttDecorator&&e._ttDecorator.setMap(void 0)},w.fetchStations=function(){w.progressMsg="Station information requested, hold on a second ...",e.get(w.config.serverAPI+"query/stations.json").then(function(e){e=e.data;e.Inventory?w.tmpInventory=e.Inventory:S.error("Load stations","No stations available"),void 0!==w.progress&&(w.progress=50,w.fetchBindings())}).catch(function(e){S.error("Load stations","Error "+e.status+": "+e.data+"<br/>Trying again in 10 seconds."),b(w.fetchStations,1e4)})},w.fetchBindings=function(){w.progressMsg="Bindings requested, hold on a second ...",e.get(w.config.serverAPI+"query/config.json").then(function(e){e=e.data;e.Config?(w.bindings=new G.Bindings(e.Config,"trunk","gaps",!0),w.bindings.injectDetecStream(w.tmpInventory,(new Date).toISOString()),w.fetchObjects()):S.error("Load bindings","No bindings available"),w.inventory=w.tmpInventory,(w.tmpInventory=void 0)!==w.progress&&(w.progress=75,w.fetchEvents()),n(),w.mapHandler.map.map&&w.currentStation&&w.mapHandler.map.map.setView([w.currentStation.sta.latitude,w.currentStation.sta.longitude],5)}).catch(function(e){S.error("Load bindings","Error "+e.status+": "+e.data+"<br/>Trying again in 10 seconds."),b(w.fetchBindings,1e4)})},w.fetchEvents=function(){w.poller=t.createStream(w.config.quakelinkURL,{tspan:w.config.map.eventHours}),w.poller.receive(function(e){w.connected=!0,w.events.feedList(e)&&w.mapHandler.map&&w.config.map.showEvents&&w.mapHandler.map.setCurrentEvent(w.events.latest?w.events.latest.eventID:null,!0),void 0!==w.progress&&(w.progress=100,b(function(){delete w.progress},500)),delete e.seiscomp}).error(function(e,t){w.connected=!1,void 0!==w.progress&&(w.progress=100,b(function(){delete w.progress},500)),t<=0?(S.error("Get events","Could not reach server, try again in 10s."),b(function(){w.connected=!0,w.poller.resume()},1e4)):500<=t&&t<600?b(function(){w.connected=!0,w.poller.resume()},1e3):S.error("Get events","Server returned error "+t+".")}).start()},w.fetchObjects=function(h,y,M){e.get(w.config.serverAPI+"query/objects.json?QC"+(h?"&last="+encodeURIComponent(h):"")+(y?"&QCrev="+y:"")+"&GM"+(M?"&GMrev="+M:"")).then(function(e){var t=e.data;if(t.request){var n=(new Date).getTime(),o=0,i=0,a=[],r=null,s=null,l=null;if(t.request.objects){for(r=t.request.objects.id,o=t.request.objects.list.length,i=0;i<o;++i){var c,u=t.request.objects.list[i];u.Pick&&(c=u.Pick.time.value)&&(n-(c=new Date(u.Pick.time.value).getTime())>w.config.map.triggerDuration||(u.Pick._time=c,a.push(u.Pick)))}0<a.length&&w.mapHandler.map.addTriggers(a)}if(t.request.QC){for(s=t.request.QC.revision,o=t.request.QC.list.length,i=0;i<o;++i){var d,p=t.request.QC.list[i];p.id in w.qualityParameters?$.extend(w.qualityParameters[p.id],p.params):w.qualityParameters[p.id]=p.params,w.qualityMode in p.params&&(w.groundMotion||(d=p.params[w.qualityMode].value,w.mapHandler.map.setColor(p.id,w.getQualityColor(d),d)))}!w.currentQuality&&w.currentStation&&C()}if(t.request.GM){for(var m,l=t.request.GM.revision,g=n-w.config.map.ampLifeSpan,o=t.request.GM.list.length,i=0;i<o;++i){var v=t.request.GM.list[i];if(v.id in w.groundMotions?$.extend(w.groundMotions[v.id],v):(m={},$.extend(m,v),w.groundMotions[v.id]=m),!(v.timestamp<g)){if(v.id in w.maxGroundMotions){var f=w.maxGroundMotions[v.id];if(!(f.timestamp<g||f.vel<v.vel))continue;$.extend(f,v)}else m={},$.extend(m,v),w.maxGroundMotions[v.id]=m;w.groundMotion&&w.mapHandler.map.setColor(v.id,w.getGMColor(v.vel),v.vel)}}!w.currentGroundMotion&&w.currentStation&&C()}delete t.request,b(function(){w.fetchObjects(r||h,s||y,l||M)},1e3)}else S.error("Listener","Got unexpected reply? Wrong protocol version?<br/>Stopping listener.")}).catch(function(e){e.status<=0?S.error("Listener","Lost connection.<br/>Trying again in 10 seconds."):S.error("Listener","Error "+e.status+": "+e.data+"<br/>Trying again in 10 seconds."),b(function(){w.fetchObjects(h,y,M)},1e4)})},w.openStationDetails=function(e,t){w.currentStation={net:e,sta:t},w.viewOptions.stationDetails=!0,w.viewOptions.eventDetails=!1},w.closeStationDetails=function(){a.search("net",null).search("sta",null)},w.mapHandler={initialized:function(){w.currentStation&&w.mapHandler.map.map.setView([w.currentStation.sta.latitude,w.currentStation.sta.longitude],5)},eventsAdded:function(){w.events.latest&&w.config.map.showEvents&&this.map.setCurrentEvent(w.events.latest.eventID,!0)},getStationInfo:function(e,t){return null},eventClicked:function(e){w.currentEvent=e,w.viewOptions.eventDetails=!0,w.closeStationDetails()},stationClicked:function(e,t){w.$apply(function(){a.search("net",e.code).search("sta",t.code)})},mapClicked:function(e){w.currentStation=null,w.currentQuality=null,w.currentGroundMotion=null,w.currentEvent=null,w.viewOptions.eventDetails=!1,w.closeStationDetails(),w.$broadcast("clearTrace")}},w.setQCMode=function(e){if(("delay"===e||"latency"===e)&&(w.qualityMode=e,w.groundMotion=!1,w.getQualityColor=w.getQualityColorTime,w.config.map.legend.title=w.qualityMode.charAt(0).toUpperCase()+w.qualityMode.slice(1),w.config.map.legend.labels=o,w.mapHandler.map))for(var t in w.mapHandler.map.resetStationColors(),w.qualityParameters){var n=w.qualityParameters[t];w.qualityMode in n&&(n=n[w.qualityMode].value,w.mapHandler.map.setColor(t,w.getQualityColor(n),n))}},w.setGMMode=function(){if(w.groundMotion=!0,w.config.map.legend.title="Ground motion",w.config.map.legend.labels=s,w.mapHandler.map)for(var e in w.mapHandler.map.resetStationColors(),w.maxGroundMotions){var t=w.maxGroundMotions[e];w.mapHandler.map.setColor(e,w.getGMColor(t.vel),t.vel)}},w.events=new G.EventBuffer(3600*w.config.map.eventHours*1e3),w.events.added(w.updateEvent).updated(w.updateEvent).removed(w.removeEvent),w.progress=0,w.groundMotions={},w.maxGroundMotions={},w.qualityParameters={},w.setQCMode("delay"),w.toggleCluster=function(){w.config.map.inventory.cluster.enable=!w.config.map.inventory.cluster.enable,w.mapHandler.map.setClusterEnabled(w.config.map.inventory.cluster.enable)},w.viewOptions={showNotes:!1,stationDetails:!1,eventDetails:!1},w.progressMsg="Configuring StationView ...",e.get("config.json?app=mapview").then(function(e){e=e.data;w.config.quakelinkURL=e.mapview.quakelink,w.config.serverAPI=e.mapview.serverAPI,w.config.serverWSAPI=e.mapview.serverWSAPI,w.config.forceHTTP=e.mapview.forceHTTP,w.config.logoPath=e.mapview.logoPath,w.config.map.mapURI=e.mapview.mapURI,w.config.map.maxZoom=e.mapview.mapMaxZoom,w.config.map.maxLevel=e.mapview.mapMaxLevel,w.config.map.inventory.cluster.enable=e.mapview.cluster,w.config.mode=e.mapview.mode||"delay",w.config.stationLink=e.mapview.link,w.config.stationLinkName=e.mapview.linkName,e.mapview.mapBounds&&(w.config.map.maxBounds=e.mapview.mapBounds),w.config.map.events={colorByAge:e.mapview.colorByAge},angular.isNumber(e.mapview.colorUpdateInterval)&&(w.config.map.events.updateInterval=e.mapview.colorUpdateInterval),w.config.map.depths=[[50,[255,0,0]],[100,[255,128,0]],[250,[255,255,0]],[600,[0,127,0]],[null,[0,0,255]]],w.config.map.ages=[[3600,[255,0,0],"1 hour"],[86400,[255,128,0],"1 day"],[604800,[255,255,0],"1 week"],[18144e3,[255,255,255],"1 month"],[null,[128,128,128],"older"]];for(var t,n,o,i,a=w.config.map.magnitudes,r=[],s=1;s<=8;++s)r.push([s.toString(),(t=s,n=a.scaleM,o=a.scaleN,i=a.minSize,o=(o=n*t+o)<i?i:o)]);w.view.legend.depths.labels=w.config.map.depths,w.view.legend.ages.labels=w.config.map.ages,w.view.legend.magnitudes.labels=r,w.config.map.events.colorByAge?w.view.legend.colors=w.view.legend.ages:w.view.legend.colors=w.view.legend.depths,w.progress=25,w.initMap=!0,w.fetchStations(),"groundmotion"===w.config.mode?w.setGMMode():w.setQCMode(w.config.mode)}).catch(function(e){S.error("Init","Loading settings failed.")}),function e(){var t,n=new Date;for(t in w.config.trace.xaxis.max=n.getTime(),w.config.trace.xaxis.min=w.config.trace.xaxis.max-w.config.map.triggerDuration,w.events.pool){var o=w.events.pool[t];o._ttDecorator&&(w.mapHandler.map&&o._ttDecorator.setMap(w.mapHandler.map.map),o._ttDecorator.setTime(.001*(n-o.otime)),o._ttDecorator.updateLL()||(o._ttDecorator.setMap(void 0),delete o._ttDecorator))}b(e,1e3)}(),w.$on("$locationChangeSuccess",n)}]);
stationView.controller("TraceCtrl",["$scope","$http","$timeout","gmNotice","recordstream",function(i,r,n,c,a){var s,f,u,d,v,h,l;function m(){i.trace&&(i.trace.raw.length=0,i.trace.markers.length=0,i.trace.sid="")}function p(){v&&(v.cancel(),v=void 0)}function x(r,e){var o,t;u=e,d=r,s?p():(s=e,f=r,o=[],m(),t=h.xaxis.min,h.xaxis.max,r=new Date(t),t=e.net+"."+e.sta+"."+(e.loc||"")+"."+e.cha,i.trace={sid:t,raw:e=[],data:[{records:e,options:l}],markers:[],options:h},o.push([t,r]),(v=a.run(f.serverAPI,f.serverWSAPI,o,{forceHTTP:f.forceHTTP})).promise.then(function(r){var e=s;s=v=void 0,"Disconnected"!==r&&"Error"!==r&&"Proxy"!==r?u=u&&u!==e?void x(d,u):void 0:n(function(){x(f,e)},1e4)},function(r,e){v=void 0,c.error("Acquisition","Error "+e+": "+r)},function(r,e){!function(r){if(i.trace){for(var e=r.length,o=i.trace.raw;0<o.length&&o[0].endTime<=i.trace.options.xaxis.min;)o.shift();for(var t=0;t<e;++t){var n=r[t];n.sid===i.trace.sid&&o.push(n)}}}(r)}))}i.$on("clearTrace",function(r){m(),p()}),i.$on("showTrace",function(r,e,o,t,n){h=t,l=n,x(e,o)})}]);
stationView.directive("gmLegend",function(){return{restrict:"E",scope:{legend:"="},template:'<div class="title">{{legend.title}}</div>',link:function(r,t,e){r.$watch("legend.labels",function(){t.children().remove(".entry");for(var e="",n=0;n<r.legend.labels.length;++n){var l=Array.isArray&&Array.isArray(r.legend.labels[n][0])?"rgb("+r.legend.labels[n][0].join(",")+")":r.legend.labels[n][0];e+='<div class="entry"><i style="background:'+l+'"></i> '+r.legend.labels[n][1]+"</div>"}t.append(e)})}}}).filter("prettyms",function(){return function(e){e/=1e3;return e<60?(0|e)+"s":(e/60|0)+"min"}});
