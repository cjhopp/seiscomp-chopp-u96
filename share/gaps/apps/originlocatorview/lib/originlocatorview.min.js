!function(r){"use strict";var i=r||{},e=navigator.userAgent;i.ISFF=-1!=e.indexOf("Firefox"),i.ISOPERA=-1!=e.indexOf("Opera"),i.ISCHROME=-1!=e.indexOf("Chrome"),i.ISSAFARI=-1!=e.indexOf("Safari")&&!i.ISCHROME,i.ISWEBKIT=-1!=e.indexOf("WebKit"),i.ISIE=0<e.indexOf("Trident")||0<navigator.userAgent.indexOf("MSIE"),i.ISIE6=0<e.indexOf("MSIE 6"),i.ISIE7=0<e.indexOf("MSIE 7"),i.ISIE8=0<e.indexOf("MSIE 8"),i.ISIE9=0<e.indexOf("MSIE 9"),i.ISIE10=0<e.indexOf("MSIE 10"),i.ISOLD=i.ISIE6||i.ISIE7||i.ISIE8,i.ISIE11UP=-1==e.indexOf("MSIE")&&0<e.indexOf("Trident"),i.ISIE10UP=i.ISIE10||i.ISIE11UP,i.ISIE9UP=i.ISIE9||i.ISIE10UP,r.module("browsercheck",[]).directive("browserCheck",function(){return{restrict:"E",template:'<div class="alert" ng-if="warn"><span ng-click="close()" class="close"><i class="icon glyphicon glyphicon-remove"></i></span><div class="symbol"><i class="icon glyphicon glyphicon-warning-sign"></i></div><div class="text"><strong>Your browser is not supported officially!</strong><br/>You can use it at your own risk but be aware that visual distortions or even browser crashes or freezes may occur. We recommend to use Firefox or Chromium.</div></div>',scope:{},link:function(i,e,n){i.warn=!r.ISFF&&!r.ISCHROME,i.close=function(){i.warn=!1}}}})}((window,window.angular));
!function(){"use strict";angular.module("gm.date",[]).factory("gmDate",function(){var e=!1;return{toLocalString:function(t,n){return new Date(t).strftime(n)},toUTCString:function(t,n){return new Date(t).strftime(n,!0)},toString:function(t,n,e){return new Date(t).strftime(n,e)},toDefaultString:function(t,n){return new Date(t).strftime(n,e)},setDefaultToLocal:function(){e=!1},setDefaultToUTC:function(){e=!0}}}).filter("gmdate",["gmDate",function(e){return function(t,n){return e.toDefaultString(t,n)}}])}();
L.Map.mergeOptions({boxSelect:!1}),L.Map.BoxSelect=L.Handler.extend({initialize:function(t){this._map=t,this._container=t._container,this._pane=t._panes.objectsPane,this._multiple=!1},addHooks:function(){L.DomEvent.on(this._container,"mousedown",this._onMouseDown,this),L.DomEvent.on(this._container,"touchstart",this._onTouchStart,this)},removeHooks:function(){L.DomEvent.off(this._container,"mousedown",this._onMouseDown),L.DomEvent.off(this._container,"touchstart",this._onTouchStart)},_onMouseDown:function(t){if(1!==t.which&&1!==t.button)return!1;t.shiftKey?this._multiple=!0:this._multiple=!1,this._startLayerPoint=this._map.mouseEventToLayerPoint(t),this._startDragging(t)},_onTouchStart:function(t){!t.touches||t.touches.length<1||(this._multiple=!1,this._startLayerPoint=this._map.mouseEventToLayerPoint(t.touches[0]),this._startDragging(t))},_startDragging:function(t){L.DomUtil.disableTextSelection(),this._box||(this._box=L.DomUtil.create("div","leaflet-select-box",this._pane)),L.DomUtil.setPosition(this._box,this._startLayerPoint),this._box.style.width="0px",this._box.style.height="0px",this._container.style.cursor="crosshair",L.DomEvent.on(document,"mousemove",this._onMouseMove,this).on(document,"mouseup",this._onMouseUp,this).on(document,"touchmove",this._onTouchMove,this).on(document,"touchend",this._onTouchEnd,this).on(document,"keydown",this._onKeyDown,this).preventDefault(t),this._map.fire("boxselectstart")},_onMouseMove:function(t){this._onMove(this._map.mouseEventToLayerPoint(t))},_onTouchMove:function(t){this._moveLayerPoint=this._map.mouseEventToLayerPoint(t.touches[0]),this._onMove(this._moveLayerPoint)},_onMove:function(t){var e=this._startLayerPoint,s=this._box,n=t.subtract(e),e=new L.Point(Math.min(t.x,e.x),Math.min(t.y,e.y));L.DomUtil.setPosition(s,e),s.style.width=Math.max(0,Math.abs(n.x)-4)+"px",s.style.height=Math.max(0,Math.abs(n.y)-4)+"px"},_finish:function(){this._pane.removeChild(this._box),delete this._box,this._container.style.cursor="",L.DomUtil.enableTextSelection(),L.DomEvent.off(document,"mousemove",this._onMouseMove).off(document,"mouseup",this._onMouseUp).off(document,"touchmove",this._onTouchMove).off(document,"touchend",this._onTouchEnd).off(document,"keydown",this._onKeyDown)},_onMouseUp:function(t){this._finishDragging(this._map.mouseEventToLayerPoint(t))},_onTouchEnd:function(t){this._finishDragging(this._moveLayerPoint)},_finishDragging:function(t){this._finish();var e=this._map,t=t;this._startLayerPoint.equals(t)||(t=new L.LatLngBounds(e.layerPointToLatLng(this._startLayerPoint),e.layerPointToLatLng(t)),e.fire("boxselectend",{boxSelectBounds:t,boxSelectMultiple:this._multiple}))},_onKeyDown:function(t){27===t.keyCode&&this._finish()}}),L.Map.addInitHook("addHandler","boxSelect",L.Map.BoxSelect),L.PolygonMarker=L.Polyline.extend({options:{fill:!0,lineJoin:"miter"},initialize:function(t,e,s){L.Path.prototype.initialize.call(this,s),this._latlng=L.latLng(t),this.setPoints(e)},setPoints:function(t){this._points=t,this._originalPoints=[];for(var e=0;e<this._points.length;++e)this._originalPoints[e]=new L.Point(0,0);this._bounds=new L.Bounds(this._originalPoints)},getLatLng:function(){return this._latlng},setLatLng:function(t){return this._latlng=t,this.redraw()},projectLatlngs:function(){for(var t=this._map.latLngToLayerPoint(this._latlng),e=0,s=this._points.length;e<s;e++)this._originalPoints[e].x=t.x+this._points[e][0],this._originalPoints[e].y=t.y-this._points[e][1]},getBounds:function(){var t=this._map,e=this._bounds.max.x-this._bounds.min.x,s=this._bounds.max.y-this._bounds.min.y,n=e*Math.cos(Math.PI/4),i=s*Math.sin(Math.PI/4),e=t.project(this._latlng),s=new L.Point(e.x-n,e.y+i),i=new L.Point(e.x+n,e.y-i),s=t.unproject(s),i=t.unproject(i);return new L.LatLngBounds(s,i)},_getPathPartStr:function(t){return L.Polyline.prototype._getPathPartStr.call(this,t)+(L.Browser.svg?"z":"x")},_clipPoints:function(){this.projectLatlngs(),L.Polyline.prototype._clipPoints.call(this)}}),L.PolygonMarker=L.Path.SVG&&!window.L_PREFER_CANVAS||!L.Browser.canvas?L.PolygonMarker:L.PolygonMarker.extend({_drawPath:function(){var t,e,s,n,i;for(this._ctx.beginPath(),t=0,s=this._parts.length;t<s;t++){for(e=0,n=this._parts[t].length;e<n;e++)i=this._parts[t][e],this._ctx[(0===e?"move":"line")+"To"](i.x,i.y);this._ctx.closePath()}}}),L.polygonMarker=function(t,e,s){return new L.PolygonMarker(t,e,s)},L.ClusterIcon=L.Icon.extend({options:{iconSize:[50,50],className:"leaflet-div-icon",fill:["white",.4],cluster:void 0,text:void 0,textColor:"white"},createIcon:function(t){var e=t&&"DIV"===t.tagName?t:document.createElement("div"),s='<svg viewBox="0 0 100 100" ><polygon points="10,85 90,85 50,15"',n=this.options.fill,t=this.options.textColor;return this.options.cluster&&(this.options.cluster._ll_color&&(n=this.options.cluster._ll_color instanceof Array?this.options.cluster._ll_color:[this.options.cluster._ll_color,1]),this.options.cluster._textColor&&(t=this.options.cluster._textColor)),s+=' fill="'+n[0]+'" fill-opacity="'+n[1]+'"',s+="/>",this.options.text&&(s+='<text x="50" y="72" fill="'+t+'" font-size="24" text-anchor="middle">'+this.options.text+"</text>"),e.innerHTML=s+="</svg>",this._setIconStyles(e,"icon"),e},createShadow:function(){return null}}),L.clusterIcon=function(t){return new L.ClusterIcon(t)},L.EventIcon=L.Icon.extend({options:{fillColor:[0,0,255,255],blankColor:[255,255,255,255],color:[0,0,0,255],radius:16,weight:2,fm:null},createIcon:function(t){return this._canvas=t&&"CANVAS"===t.tagName?t:document.createElement("canvas"),this._canvas.className="leaflet-marker-icon",this._ctx=this._canvas.getContext("2d"),this._applySize(),this._updateImage(),this._canvas},createShadow:function(){return null},setStyle:function(t){var e=t.radius&&this.options.radius!==t.radius;L.setOptions(this,t),this._ctx&&(e&&this._applySize(),this._updateImage())},_applySize:function(){var t=L.point([2*this.options.radius|0,2*this.options.radius|0]),e=t.divideBy(2,!0);this._canvas.width=t.x,this._canvas.height=t.y,this._canvas.style.marginLeft=-e.x+"px",this._canvas.style.marginTop=-e.y+"px",this._canvas.style.width=this._canvas.width+"px",this._canvas.style.height=this._canvas.height+"px"},_updateImage:function(){var t=this.options.fm?new G.Tensor(this.options.fm.strike,this.options.fm.dip,this.options.fm.rake):new G.Tensor(0,0,0);this._ctx.strokeStyle="rgba(0,0,0,0)",this._ctx.fillStyle="rgba(0,0,0,0)",this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height);var e=this._ctx.getImageData(0,0,this._canvas.width,this._canvas.height);t.render(e,this.options.fillColor,this.options.fm?this.options.blankColor:this.options.fillColor,this.options.color,.5*this.options.weight,this.options.weight),this._ctx.putImageData(e,0,0)}}),L.eventIcon=function(t){return new L.EventIcon(t)},L.EventMarker=L.Marker.extend({setStyle:function(t){this.options.icon.setStyle(t)},bringToFront:function(){this.setZIndexOffset(1e4)},restoreOrder:function(){this.setZIndexOffset(0)}}),L.eventMarker=function(t,e){return new L.EventMarker(t,{clickable:e.clickable,icon:L.eventIcon(e)})},L.StarMarker=L.PolygonMarker.extend({initialize:function(t,e){L.PolygonMarker.prototype.initialize.call(this,t,[],e)},setStyle:function(t){if(t.radius){var e=[],s=2*t.radius,n=.5*s;e.length=10;for(var i=0;i<5;++i)e[2*i]=[s*Math.sin(72*i*Math.PI/180),s*Math.cos(72*i*Math.PI/180)],e[2*i+1]=[n*Math.sin((360*i+180)/5*Math.PI/180),n*Math.cos((360*i+180)/5*Math.PI/180)];this.setPoints(e)}L.PolygonMarker.prototype.setStyle.call(this,t)}}),angular.module("mapwidget-ll",[]).directive("mapLl",["$timeout","$interval",function(V,j){return{restrict:"EA",template:'<div><span class="ll-pos" ng-if="cursor && options.currentPosition">{{cursor.text}}</span></div>',replace:!0,scope:{inventory:"=",events:"=",select:"=",currentFeature:"=",options:"=",mapInterface:"="},link:function(r,t,o){var a,s,n=t[0],l={maxZoom:14,showEvents:!1,blinking:!0,autoCenterLastEvent:!1,triggerDuration:6e5,mapURI:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",interactive:!0,zoomControl:!1,currentPosition:!1,maxBounds:[[-90,-225],[90,225]],minimap:{enable:!1},features:{geoJSON:null},inventory:{cluster:{enable:!1,radius:50,maxZoom:7,showCoverageOnHover:!1},allowAll:!1,normalStyle:{fillColor:"#2d69bf"}},events:{showFM:!0,updateInterval:60,colorByAge:!1},magnitudes:{scaleM:4.9,scaleN:-5.88,minSize:6},depths:[[50,[255,0,0]],[100,[255,128,0]],[250,[255,255,0]],[600,[0,127,0]],[null,[0,0,255]]],ages:[[3600,[255,0,0],"hour"],[86400,[255,128,0],"day"],[604800,[255,255,0],"week"],[2592e3,[255,255,255],"month"],[null,[128,128,128],"older"]]};angular.merge(l,r.options),o.hasOwnProperty("clusterInventory")&&(l.inventory.cluster.enable=!0),o.hasOwnProperty("allowAll")&&(l.inventory.allowAll=!0);var c=6e5;l.triggerDuration&&(c=l.triggerDuration);var u,h={lineJoin:"miter",fill:!0,innerRadius:0,opacity:.5,fillOpacity:1,gradient:!1,dropShadow:!0},e={fillColor:"#fff"},f={fillColor:"#edd400"},d={opacity:.5,color:"#444",weight:1.5},m={color:"#f00",weight:5},v=[[0,12],[12*Math.sin(240*Math.PI/180),12*Math.cos(240*Math.PI/180)],[12*Math.sin(120*Math.PI/180),12*Math.cos(120*Math.PI/180)]],p=null,_=null,g=null;function y(t){return t._color?t._color instanceof Array?{fillColor:t._color[0],fillOpacity:t._color[1]}:{fillColor:t._color,fillOpacity:1}:l.inventory.normalStyle}function b(t){if(t._ll_color)return t._ll_color instanceof Array?t._ll_color:[t._ll_color,1];t=t.getChildCount();return 100<=t?["#000",.4]:10<=t?["#111",.4]:["#222",.4]}function x(t){return t._textColor||"white"}function k(t){t.target.setStyle(e),o.currentFeature&&r.$apply(r.currentFeature=t.target)}function w(t){t.target.setStyle(t.target._sta._selected?f:y(t.target._sta)),o.currentFeature&&r.$apply(r.currentFeature=null)}function C(t){t.target._sta._selected=!0,t.target.setStyle(f)}function S(t){t.target._sta._selected=!1,t.target.setStyle(y(t.target._sta))}function M(t){var e=t instanceof Array?t[0]:t;if(void 0===e||"string"!=typeof e)return"white";t=[];return e.startsWith("rgb")?t=e.match(/\d+/g):e.startsWith("#")&&(4===e.length||5===e.length?t=[parseInt(e.substring(1,1),16),parseInt(e.substring(2,1),16),parseInt(e.substring(3,1),16)]:7!==e.length&&9!==e.length||(t=[parseInt(e.substring(1,2),16),parseInt(e.substring(3,2),16),parseInt(e.substring(5,2),16)])),3<=t.length&&125<Math.round((299*parseInt(t[0])+587*parseInt(t[1])+114*parseInt(t[2]))/1e3)?"black":"white"}function P(t){var e,s;t._icon&&(e=b(t),(s=t._icon.firstChild).firstChild.style.fill=e[0],s.firstChild.style.fillOpacity=e[1],1<s.children.length&&(s.children[1].style.fill=x(t)))}function I(t,e){for(var s,n,i,o=t._markers.length,r=0;r<o;++r)i=t._markers[r],(!s||void 0!==i._sta._color_value&&i._sta._color_value>s)&&(s=i._sta._color_value,n=i._sta._color);for(o=t._childClusters.length,r=0;r<o;++r){var a=t._childClusters[r];e&&I(a,!0),(!s||void 0!==a._ll_value&&a._ll_value>s)&&(s=a._ll_value,n=a._ll_color)}t._ll_value=s,t._ll_color=n,t._textColor=M(n),P(t)}function E(t){if(t){if(t[0][1]<=t[1][1])return L.latLngBounds(t);for(var e=t[0][1],s=t[1][1];s<e;)s+=360;return L.latLngBounds([[t[0][0],e],[t[1][0],s]])}}function T(t){var e=!1;try{s=r.options.features.geoJSON}catch(t){s=null}l.features.geoJSON!==s&&(e=!0),angular.merge(l,r.options);var s=E(l.maxBounds);s?(t&&t.fitBounds(s,{animate:!1}),_=s.getWest(),g=s.getEast()):_=g=null,t&&(p&&(t.removeLayer(p),p=null),l.showMaxBounds&&(p=L.rectangle(s,{color:"black",fill:!1,weight:2,dashArray:"2, 4",clickable:!1})).addTo(t),e&&(t=t,u&&(t.removeLayer(u),u=void 0),l.features.geoJSON&&((u=L.geoJson(l.features.geoJSON,{style:function(t){var e=t.properties,t={color:B(e.pen.color),weight:e.pen.width||1,opacity:3<e.pen.color.length?e.pen.color[3]/255:1,clickable:!1};return e.brush?(t.fill=!0,t.fillColor=B(e.brush.color),t.fillOpacity=3<e.brush.color.length?e.brush.color[3]/255:1):t.fill=!1,t}})).setZIndex(-2e7),u.addTo(t))))}function D(t,e,s){for(var n=e.length,i=0;i<n;++i){var o=e[i];if(null===o[0]||t<=o[0])return s?o[1]:"rgb("+o[1][0]+","+o[1][1]+","+o[1][2]+")"}return s?[0,0,0]:"#000"}function O(t,e){return l.events.colorByAge?D(t._age,l.ages,e):D(t._event.depth,l.depths,e)}function A(t){t=l.magnitudes.scaleM*t+l.magnitudes.scaleN;return.5*(t=t<l.magnitudes.minSize?l.magnitudes.minSize:t)}function B(t){return 3<=t.length?"rgb("+t[0]+","+t[1]+","+t[2]+")":"#000"}var z={map:null,tileLayer:null,blinkerActive:!1,stations:{features:{},markers:[],cluster:null,triggers:[],dirty:!1,queuedTriggers:[]},events:{features:{},dirty:!1,current:null},fitBounds:function(t){t=E(t);t&&this.map&&this.map.fitBounds(t,{animate:!1})},clearStations:function(){this.stations.features={};for(var t=this.stations.markers.length,e=0;e<t;++e){var s=this.stations.markers[e];s.off("mouseover",k),s.off("mouseout",w),s.off("selected",C),s.off("unselected",S),s.off("click",Z),s.unbindPopup(),this.map.removeLayer(s)}this.stations.cluster&&(this.stations.cluster.clearLayers(),this.map.removeLayer(this.stations.cluster),this.stations.cluster=null),this.stations.markers=[],this.stations.triggers=[]},addStation:function(t,e,s,n,i){if(!l.inventory.allowAll&&!i)return null;var o=s.code+"."+n.code;if(this.stations.features.hasOwnProperty(o))return null;if(null!==_)for(;e<_;)e+=360;if(null!==g)for(;g<e;)e-=360;null!==_&&null!==g&&(180<(i=e-.5*(_+g))?e-=360:i<-180&&(e+=360));t=L.polygonMarker([t,e],v,h);return t._net=s,t._sta=n,t._staid=o,t._staid2=t._staid+" ",t.on("mouseover",k),t.on("mouseout",w),t.on("selected",C),t.on("unselected",S),this.listener&&this.listener.getStationInfo||t.bindPopup("<strong>"+t._staid+"</strong><br/><i>"+t._sta.description+"<br/>"+t._net.description+"</i>"),t.on("click",Z),t.setStyle(y(t._sta)),t.setStyle(d),this.stations.features[t._staid]=[s,n,t],this.stations.markers.push(t),t},updateStations:function(){if(this.clearStations(),r.inventory){var t=new Date;l.inventory.cluster.enable?this.stations.cluster=L.markerClusterGroup({maxClusterRadius:l.inventory.cluster.radius,showCoverageOnHover:l.inventory.cluster.showCoverageOnHover,spiderfyOnMaxZoom:!0,disableClusteringAtZoom:l.inventory.cluster.maxZoom,iconCreateFunction:function(t){var e=100<=t.getChildCount()?50:10<=t.getChildCount()?40:30;return L.clusterIcon({className:"marker-cluster",fill:b(t),cluster:t,text:t.getChildCount(),textColor:x(t),iconSize:[e,e]})}}):this.stations.cluster=null;for(var e=r.inventory,s=0;s<e.network.length;++s)for(var n=e.network[s],i=0;i<n.station.length;++i){var o=n.station[i];new Date(o.start)>t||o.end&&new Date(o.end)<t||this.addStation(o.latitude,o.longitude,n,o,o.detecStream)}this.stations.markers.sort(function(t,e){return e._sta.latitude-t._sta.latitude}),this.addStationsToMap()}},addStationsToMap:function(){if(this.map){var t;if(this.stations.dirty=!1,this.stations.cluster){for(t=0;t<this.stations.markers.length;++t)this.stations.cluster.addLayer(this.stations.markers[t]);this.map.addLayer(this.stations.cluster)}else for(t=0;t<this.stations.markers.length;++t)this.stations.markers[t].addTo(this.map);z.listener&&z.listener.stationsAdded&&z.listener.stationsAdded()}else this.stations.dirty=!0},clearEvents:function(){if(this.map)for(var t in this.events.features){t=this.events.features[t];t.off("click",F),this.map.removeLayer(t)}this.events.features={}},addEvent:function(t){var e,s,n=t.hasOwnProperty("mag")?A(t.mag):l.magnitudes.minSize,i=t.lon;if(null!==_)for(;i<_;)i+=360;if(null!=g)for(;g<i;)i-=360;return null!==_&&null!==g&&(180<(s=i-.5*(_+g))?i-=360:s<-180&&(i+=360)),(e=new(t._latest?L.StarMarker:L.CircleMarker)([t.lat,i]))._event=t,e._age=.001*((new Date).getTime()-t.otime),n={color:s=O(e),fillColor:s,weight:2,opacity:1,fillOpacity:.5,radius:n,clickable:!o.hasOwnProperty("static")},e._style=n,e.setStyle(e._style),e.on("mouseover",N),e.on("mouseout",$),e.on("click",F),this.events.features[t.eventID]=e},removeEvent:function(t){var e;t in this.events.features&&(this.map&&((e=this.events.features[t]).off("mouseover",N),e.off("mouseout",$),e.off("click",F),this.map.removeLayer(e)),delete this.events.features[t])},updateEvent:function(t){var e,s,n;if(t.eventID in this.events.features){(e=this.events.features[t.eventID])._age=.001*((new Date).getTime()-t.otime),s=t.hasOwnProperty("mag")?A(t.mag):l.magnitudes.minSize,n=O(e),e._style.color=n,e._style.fillColor=n,e._style.radius=s;var i=t.lon;if(null!==_)for(;i<_;)i+=360;if(null!=g)for(;g<i;)i-=360;e.setLatLng([t.lat,i]),e.setStyle(e._style)}else(e=this.addEvent(t))&&this.map&&l.showEvents&&e.addTo(this.map)},setEventSpecialSymbol:function(t,e){var s;t.eventID in this.events.features&&(s=this.events.features[t.eventID],(e=new(e?L.StarMarker:L.CircleMarker)(s.getLatLng()))._event=s._event,e._age=s._age,e._style=s._style,e.setStyle(s._style),s.off("mouseover",N),s.off("mouseout",$),s.off("click",F),e.on("mouseover",N),e.on("mouseout",$),e.on("click",F),this.events.features[t.eventID]=e,this.map&&(this.map.removeLayer(s),e.addTo(this.map)),this.events.current===s&&(this.events.current=e))},bringToFront:function(t){t.bringToFront()},restoreOrder:function(t){t.restoreOrder&&t.restoreOrder()},centerEvent:function(t){var e,s=t.lon;if(null!==_)for(;s<_;)s+=360;if(null!=g)for(;g<s;)s-=360;null!==_&&null!==g&&(180<(e=s-.5*(_+g))?s-=360:e<-180&&(s+=360)),this.map.panTo([t.lat,s],null,{animate:!0})},setCurrentEvent:function(t,e){this.events.current&&(this.events.current.setStyle(this.events.current._style),this.events.current._map&&this.restoreOrder(this.events.current)),t?t in this.events.features?(this.events.current=this.events.features[t],this.events.current._map&&this.bringToFront(this.events.current),e&&this.map&&(e=this.events.current._event,this.centerEvent(e)),l.blinking&&this.setBlinkState()):console.debug("Cannot set current event: "+t+" not found"):this.events.current=null},updateEvents:function(){if(this.clearEvents(),r.events){for(var t in r.events){var e=r.events[t];this.addEvent(e)}this.addEventsToMap(),l.autoCenterLastEvent&&e&&this.setCurrentEvent(e.eventID,!0)}},addEventsToMap:function(){this.map?(this.events.dirty=!1,this.setEventsVisible(l.showEvents),z.listener&&z.listener.eventsAdded&&z.listener.eventsAdded()):this.events.dirty=!0},updateColorsOfEvents:function(){if(l.events.colorByAge){var t=(new Date).getTime();for(i in this.events.features){var e=this.events.features[i];e._age=.001*(t-e._event.otime),color=O(e),e._style.color=color,e._style.fillColor=color,e.setStyle(e._style)}}},setEventsVisible:function(t){if(t){for(var e in this.events.features)this.events.features[e].addTo(this.map);!s&&l.events.updateInterval&&l.events.colorByAge&&(this.updateColorsOfEvents(),s=j(this.updateColorsOfEvents.bind(this),1e3*l.events.updateInterval))}else{for(e in this.events.features)this.map.removeLayer(this.events.features[e]);s&&(j.cancel(s),s=void 0)}},removeBlinkState:function(){if(this.blinkerActive){this.stations.cluster&&!function t(e,s){for(var n=e._childClusters.length-1;0<=n;--n){var i=e._childClusters[n];i._icon&&(i._icon.firstChild.firstChild.style.stroke="rgb(255,255,255)",i._icon.firstChild.firstChild.style.strokeWidth="1",i._icon.firstChild.firstChild.style.strokeOpacity="0.4"),i._ll_opacity=0,t(i,s)}}(this.stations.cluster._topClusterLevel,"marker-cluster-triggering");for(var t=this.stations.triggers.length,e=0;e<t;++e)this.stations.triggers[e].setStyle(d);this.events.current&&this.events.current.setStyle(this.events.current._style),this.blinkerActive=!1}},setBlinkState:function(){if(!this.blinkerActive){for(var t=(new Date).getTime(),e=!1,s=this.stations.triggers.length,n=0;n<s;++n){var i,o=t-this.stations.triggers[n]._sta._trigger;!this.stations.triggers[n]._sta._trigger||c<o?(this.stations.triggers[n]._sta._trigger=void 0,this.stations.triggers[n].setStyle(d),this.stations.triggers.splice(n,1),--n,--s):(i=this.stations.triggers[n],(o=(c-o)/c)<0?o=0:1<o&&(o=1),i.setStyle(m),i.setStyle({opacity:o}),!this.stations.cluster||(i=this.stations.cluster.getVisibleParent(i))&&(!i._ll_opacity||i._ll_opacity<o)&&(i._ll_opacity=o),e=!0)}e&&this.stations.cluster&&!function t(e,s){for(var n=e._childClusters.length-1;0<=n;--n){var i=e._childClusters[n];i._icon&&0<i._ll_opacity&&(i._icon.firstChild.firstChild.style.stroke="rgb(255,0,0)",i._icon.firstChild.firstChild.style.strokeWidth="10%",i._icon.firstChild.firstChild.style.strokeOpacity=i._ll_opacity),t(i,s)}}(this.stations.cluster._topClusterLevel,"marker-cluster-triggering"),this.events.current&&(this.events.current.setStyle({color:"rgb(33,53,81)",fillColor:"rgb(122,212,226)",fillOpacity:.8}),e=!0),this.blinkerActive=e&&l.blinking,!a&&this.blinkerActive&&(a=j(function(){z.blinkerActive?z.removeBlinkState():z.setBlinkState()},1e3))}},addTriggers:function(t){if(0!==t.length)if(this.map){for(var e=0<this.stations.triggers.length,s=(new Date).getTime(),n=t.length,i=0;i<n;++i){var o,r,a=t[i],l=a.waveformID.networkCode+"."+a.waveformID.stationCode;l in this.stations.features&&(o=a._time,(a=(r=this.stations.features[l])[1])._trigger?a._trigger>o||(a._trigger=o):c<(l=s-o)||(a._trigger=o,(r=r[2]).setStyle(m),this.stations.triggers.push(r),(l=(c-l)/c)<0?l=0:1<l&&(l=1),r.setStyle({opacity:l})))}e||this.setBlinkState()}else this.stations.queuedTriggers=t},setColor:function(t,e,s){if(!(t in z.stations.features))return!1;var n=z.stations.features[t],t=n[2];if(n[1]._color!==e){if(void 0===e?delete n[1]._color:n[1]._color=e,void 0===s?delete n[1]._color_value:n[1]._color_value=s,t.setStyle(t._sta._selected?f:y(t._sta)),this.stations.cluster){var i=t.__parent;if(!i)return!0;for(!i._ll_value||s>i._ll_value?(i._ll_value=s,i._ll_color=e,i._textColor=M(e),P(i)):I(i,!1),i=i.__parent;i;)I(i,!1),i=i.__parent}return!0}},resetStationColors:function(){for(var t in z.stations.features){var e=z.stations.features[t],t=e[2];delete e[1]._color,delete e[1]._color_value,t.setStyle(t._sta._selected?f:y(t._sta))}this.stations.cluster&&!function t(e){for(var s=e._childClusters.length-1;0<=s;--s){var n=e._childClusters[s];delete n._ll_color,delete n._ll_value,delete n._textColor,P(n),t(n)}}(this.stations.cluster._topClusterLevel)},setClusterEnabled:function(t){if(l.inventory.cluster.enable!==t){l.inventory.cluster.enable=t,this.updateStations();for(var e=0;e<z.stations.markers.length;++e)z.stations.markers[e]._sta._trigger&&z.stations.triggers.push(z.stations.markers[e]);this.stations.cluster&&I(this.stations.cluster._topClusterLevel,!0)}}};function Z(t){var e,s;z.listener&&(z.listener.getStationInfo&&(e=t.target,(s=z.listener.getStationInfo(e._net,e._sta))&&L.popup().setLatLng(e.getLatLng()).setContent(s).openOn(z.map)),z.listener.stationClicked&&(e=t.target,z.listener.stationClicked(e._net,e._sta)))}function N(t){z.listener&&z.listener.eventMouseOver&&((t=t.target)._symbol&&(t=t._symbol),z.listener.eventMouseOver(t._event))}function $(t){z.listener&&z.listener.eventMouseOut&&((t=t.target)._symbol&&(t=t._symbol),z.listener.eventMouseOut(t._event))}function F(t){z.listener&&z.listener.eventClicked&&((t=t.target)._symbol&&(t=t._symbol),z.listener.eventClicked(t._event))}function U(t){for(var e=z.stations.markers.length,s=0;s<e;++s){var n=z.stations.markers[s];t.boxSelectBounds.contains(n.getLatLng())?z.stations.features[n._staid][1]._selected||(n.fire("selected"),z.stations.features[n._staid][1]._selected=!0):t.boxSelectMultiple||z.stations.features[n._staid][1]._selected&&(n.fire("unselected"),z.stations.features[n._staid][1]._selected=!1)}}function H(t){z.listener&&z.listener.mapClicked&&r.$apply(function(){z.listener.mapClicked(t)})}function J(t){r.$apply(function(){if(t.originalEvent.shiftKey){for(r.cursor=t.latlng;r.cursor.lng<-180;)r.cursor.lng+=360;for(;180<r.cursor.lng;)r.cursor.lng-=360;r.cursor.text=Math.abs(r.cursor.lat).toFixed(4)+"° "+(r.cursor.lat<0?"S":"N")+" "+Math.abs(r.cursor.lng).toFixed(4)+"° "+(r.cursor.lng<0?"W":"E"),z.listener&&z.listener.mapMouseMove&&z.listener.mapMouseMove(t)}else r.cursor=null})}function R(t){r.$apply(function(){r.cursor=null})}r.$watch("options",function(t,e){z.map&&t!==e&&T(z.map)}),r.$watch("options.mapURI",function(t,e){!z.tileLayer&&r.options&&r.options.mapURI&&(z.tileLayer=L.tileLayer(r.options.mapURI,{attribution:"Map data © OpenStreetMap contributors",minZoom:0,maxZoom:l.maxZoom,maxNativeZoom:l.maxLevel}),z.map&&z.map.addLayer(z.tileLayer))}),r.$watch("options.showEvents",function(t){l.showEvents=t,z.setEventsVisible(t)}),T(z.map),V(function(){if(z.map=L.map(n,{zoomControl:l.zoomControl,boxZoom:!0,boxSelect:!0,center:[0,0],zoom:3,worldCopyJump:!1,attributionControl:!1}),z.tileLayer&&z.map.addLayer(z.tileLayer),T(z.map),r.select?(z.map.boxZoom.disable(),z.map.dragging.disable(),z.map.boxSelect.enable()):(z.map.boxZoom.enable(),z.map.dragging.enable(),z.map.boxSelect.disable()),o.hasOwnProperty("static")&&(z.map.dragging.disable(),z.map.touchZoom.disable(),z.map.doubleClickZoom.disable(),z.map.scrollWheelZoom.disable(),z.map.boxZoom.disable(),z.map.keyboard.disable()),z.map.on("boxselectend",U),z.map.on("click",H),z.map.on("mousemove",J),z.map.on("mouseout",R),l.minimap.enable)try{z.minimap=L.control.minimap(l.minimap),z.map.addControl(z.minimap)}catch(t){console.error(t.message)}if(r.mapInterface&&r.mapInterface.initialized&&r.mapInterface.initialized(),z.stations.dirty&&z.addStationsToMap(),z.events.dirty&&z.addEventsToMap(),l.autoCenterLastEvent){var t,e;for(e in r.events)t=r.events[e];t&&z.setCurrentEvent(t.eventID,!0)}0<z.stations.queuedTriggers.length&&(z.addTriggers(z.stations.queuedTriggers),z.stations.queuedTriggers=[])},100),o.hasOwnProperty("mapInterface")&&r.mapInterface&&((r.mapInterface.map=z).listener=r.mapInterface,r.$watch("mapInterface",function(t,e){e&&(e.map=null),r.mapInterface&&(r.mapInterface.map=z),z.listener=r.mapInterface})),r.$watch("events",function(t,e){z.updateEvents()}),r.$watch("inventory",function(t,e){z.updateStations()}),r.$watch("select",function(t,e){z.map&&(t?(z.map.boxZoom.disable(),z.map.dragging.disable(),z.map.boxSelect.enable()):(z.map.boxZoom.enable(),z.map.dragging.enable(),z.map.boxSelect.disable()))}),r.$on("$destroy",function(){angular.isDefined(a)&&(j.cancel(a),a=void 0),angular.isDefined(s)&&(j.cancel(s),s=void 0),z.clearStations(),z.clearEvents(),z.map&&(z.map.off("boxselectend",U),z.map.off("click",H),z.map.off("mousemove",J),z.map.off("mouseout",R),z.map.remove()),r.mapInterface&&(r.mapInterface.map=null),z.listener=null})}}}]).directive("legendLl",function(){return{restrict:"EA",scope:{items:"="},template:'<div class="title">{{items.title}}</div>',link:function(r,a,t){r.$watch("items.labels",function(){a.children().remove(".entries");var t=angular.element('<div class="entries"></div>');if(a.append(t),r.items){for(var e="",s=null,n=0;n<r.items.labels.length;++n){var i,o=Array.isArray&&Array.isArray(r.items.labels[n][1])?(i="background-color:rgb("+r.items.labels[n][1].join(",")+")","color"):angular.isNumber(r.items.labels[n][1])?(i="width:"+r.items.labels[n][1]+"px;height:"+r.items.labels[n][1]+"px","box"):(i="background-color:"+r.items.labels[n][1],"color");e+='<div class="entry"><i class="'+o+'" style="'+i+'"></i> ',2<r.items.labels[n].length?(angular.isNumber(r.items.labels[n][0])&&(s=r.items.labels[n][0]),e+=r.items.labels[n][2]):angular.isNumber(r.items.labels[n][0])?e+="&lt;="+(s=r.items.labels[n][0]):r.items.labels[n][0]?e+=r.items.labels[n][0]:e+="&gt;"+s,e+="</div>"}t.append(e)}})}}});
"use strict";angular.module("quakelink",[]).factory("quakelink",["$http","$q",function(r,i){function p(e){var t,n=0,r=[1,4,5,6,7,10,11];if(t=/^(\d{4}|[+\-]\d{6})(?:-(\d{2})(?:-(\d{2}))?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(?:\.(\d+))?)?(?:(Z)|([+\-])(\d{2})(?::(\d{2}))?)?)?$/.exec(e)){for(var i,a=t[7].length,o=0;i=r[o];++o)t[i]=+t[i]||0;for(t[2]=(+t[2]||1)-1,t[3]=+t[3]||1,"Z"!==t[8]&&void 0!==t[9]&&(n=60*t[10]+t[11],"+"===t[9]&&(n=0-n)),o=a;o<3;++o)t[7]*=10;for(o=3;o<a;++o)t[7]/=10;return Date.UTC(t[1],t[2],t[3],t[4],t[5]+n,t[6],t[7])}return null}function a(e,t){if(window.ActiveXObject)(n=new ActiveXObject("Microsoft.XMLDOM")).async="false",n.loadXML(e);else{if(!document.implementation||!document.implementation.createDocument)return null;var n=(new DOMParser).parseFromString(e,"text/xml")}if(n.hasChildNodes())for(var r=0;r<n.childNodes.length;++r){var i=n.childNodes[r];if("seiscomp"===i.nodeName&&i.hasChildNodes())for(var a=0;a<i.childNodes.length;++a){var o=i.childNodes[a];if(o.nodeName===t)return o}}return null}function v(e,t){var n=[];if(!e.hasChildNodes())return n;for(var r=e.childNodes.length,i=0;i<r;++i)e.childNodes[i].nodeName===t&&n.push(e.childNodes[i]);return n}function m(e,t){if(!t||!e.hasChildNodes())return null;for(var n=e.childNodes.length,r=0;r<n;++r)if(e.childNodes[r].getAttribute("publicID")===t)return e.childNodes[r];return null}function g(e,t){if(!e.hasChildNodes())return null;for(var n=e.childNodes.length,r=0;r<n;++r)if(e.childNodes[r].nodeName===t){var i=e.childNodes[r];if(!i.hasChildNodes())return null;for(var a=i.childNodes.length,o=0;o<a;++o)if(3===i.childNodes[o].nodeType)return i.childNodes[o].data;break}return null}function o(r,e){var i=[];return angular.forEach(e,function(e,t){var n;switch(e=angular.isDate(e)?(n=e).getUTCFullYear()+","+(1+n.getUTCMonth())+","+n.getUTCDate()+","+n.getUTCHours()+","+n.getUTCMinutes()+","+n.getUTCSeconds()+","+n.getUTCMilliseconds():e,t){case"min":i.push(r+">="+e);break;case"max":i.push(r+"<"+e)}}),i.join(" and ")}function s(e){var n=[],r=["otime","lat","lon","depth","mag","tspan"];return angular.forEach(e,function(e,t){r.indexOf(t)<0||("tspan"===t?n.push(o("otime",{min:new Date(Date.now()-3600*e*1e3)})):n.push(o(t,e)))}),n.join(" and ")}function n(e,t){var n;this.url=e,this.url.endsWith("/")&&(this.url+="events/query"),this.query=(t=t,n=[],angular.isArray(t)?(angular.forEach(t,function(e){n.push("("+s(e)+")")}),n.join(" or ")):s(t)),this.needStop=!1,this.lastEventUpdate=this.rcb=this.ercb=null}return angular.extend(n.prototype,{start:function(){return this.canceller=i.defer(),this.lastEventUpdate=void 0,this.resume(),this},stop:function(){this.needStop=!0,this.canceller.resolve("stop")},resume:function(){var d=this,t=this.query;this.needStop=!1,function u(){var e=d.url;void 0===d.lastEventUpdate?e+="?archived":null!==d.lastEventUpdate&&(t="("+d.query+") and updated>"+d.lastEventUpdate),r.post(e,t,{timeout:d.canceller.promise}).then(function(e){if(200===e.status){var t=e.data,e=e.headers("Content-Type"),n=!1;if(e)for(var r=e.split(";"),i=r.length,a=0;a<i;++a){var o=r[a].trim();0===o.indexOf("version=")&&2<=(0|o.substr(8))&&(n=!0)}if(d.post=null,n)for(i=t.seiscomp.events.length,a=0;a<i;++a){var s=t.seiscomp.events[a];s.otime=new Date(s.otime).getTime(),s.updated=new Date(s.updated).getTime(),s.fm&&(s.fm.otime=new Date(s.fm.otime).getTime())}t.seiscomp.lastUpdate?d.lastEventUpdate=t.seiscomp.lastUpdate:d.lastEventUpdate=null,d.rcb&&d.rcb(t.seiscomp.events)}d.needStop?d.ercb&&d.ercb(t,"Poller stopped on demand."):u()}).catch(function(e){d.post=null,d.ercb&&d.ercb(e.data,e.status,d.needStop)})}()},receive:function(e){return this.rcb=e,this},error:function(e){return this.ercb=e,this}}),{createStream:function(e,t){if(void 0===t)throw new Error("You must pass at least one configuration object!");return new n(e,t)},getEventOnsets:function(e,t){var n=i.defer();return r.get(e+"?id="+t+"&include=picks,arrs").then(function(e){e=function(e,t){var n=[];if(t=m(e,t)){t=g(t,"preferredOriginID");if(t)for(var r=v(m(e,t),"arrival"),i=r.length,a=0;a<i;++a){var o,s,u,d,l,c=r[a],h=parseFloat(g(c,"distance")),f=g(c,"phase");f&&(o=1e3*parseFloat(g(c,"timeResidual")),!(s=m(e,g(c,"pickID")))||(d=v(s,"waveformID")).length&&(!(u=v(s,"time")).length||(l=(l=g(u[0],"value"))&&p(l))&&(s=(c=d[0]).getAttribute("networkCode")||"",u=c.getAttribute("stationCode")||"",d=c.getAttribute("locationCode")||"",c=c.getAttribute("channelCode")||"",n.push({net:s,sta:u,loc:d,cha:c.length<3?c+"Z":c,time:l,ph:f,residual:o,dist:h}))))}}return n}(a(e.data,"EventParameters"),t);e.sort(function(e,t){return e.time-t.time}),n.resolve(e)}).catch(function(e){n.reject(e.status)}),n.promise},shortPhaseName:function(e){for(var t=e.length-1;0<=t;--t)if(e[t]===e[t].toUpperCase())return e[t];return""},getEvent:function(e,t){var n=i.defer();return r.get(e+"?id="+t+"&include=picks,arrs").then(function(e){e=a(e.data,"EventParameters");n.resolve(e)}).catch(function(e){n.reject(e.status)}),n.promise},isoptime:p}}]);
!function(o){function t(e){var t=e||window.event,i=[].slice.call(arguments,1),a=0,n=0,r=0;return(e=o.event.fix(t)).type="mousewheel",t.wheelDelta&&(a=t.wheelDelta/120),r=a=t.detail?-t.detail/3:a,void 0!==t.axis&&t.axis===t.HORIZONTAL_AXIS&&(r=0,n=-1*a),void 0!==t.wheelDeltaY&&(r=t.wheelDeltaY/120),void 0!==t.wheelDeltaX&&(n=-1*t.wheelDeltaX/120),i.unshift(e,a,n,r),(o.event.dispatch||o.event.handle).apply(this,i)}var i=["DOMMouseScroll","mousewheel"];if(o.event.fixHooks)for(var e=i.length;e;)o.event.fixHooks[i[--e]]=o.event.mouseHooks;o.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var e=i.length;e;)this.addEventListener(i[--e],t,!1);else this.onmousewheel=t},teardown:function(){if(this.removeEventListener)for(var e=i.length;e;)this.removeEventListener(i[--e],t,!1);else this.onmousewheel=null}},o.fn.extend({mousewheel:function(e){return e?this.bind("mousewheel",e):this.trigger("mousewheel")},unmousewheel:function(e){return this.unbind("mousewheel",e)}})}(jQuery),function(m){m.fn.drag=function(e,t,i){var a="string"==typeof e?e:"",n=m.isFunction(e)?e:m.isFunction(t)?t:null;return 0!==a.indexOf("drag")&&(a="drag"+a),i=(e==n?t:i)||{},n?this.bind(a,i,n):this.trigger(a)};var u=m.event,a=u.special,h=a.drag={defaults:{which:1,distance:0,not:":input",handle:null,relative:!1,drop:!0,click:!1},datakey:"dragdata",noBubble:!0,add:function(e){var i=m.data(this,h.datakey),a=e.data||{};i.related+=1,m.each(h.defaults,function(e,t){void 0!==a[e]&&(i[e]=a[e])})},remove:function(){--m.data(this,h.datakey).related},setup:function(){var e;m.data(this,h.datakey)||(e=m.extend({related:0},h.defaults),m.data(this,h.datakey,e),u.add(this,"touchstart mousedown",h.init,e),this.attachEvent&&this.attachEvent("ondragstart",h.dontstart))},teardown:function(){(m.data(this,h.datakey)||{}).related||(m.removeData(this,h.datakey),u.remove(this,"touchstart mousedown",h.init),h.textselect(!0),this.detachEvent&&this.detachEvent("ondragstart",h.dontstart))},init:function(e){if(!h.touched){var t,i=e.data;if(!(0!=e.which&&0<i.which&&e.which!=i.which)&&!m(e.target).is(i.not)&&(!i.handle||m(e.target).closest(i.handle,e.currentTarget).length)&&(h.touched="touchstart"==e.type?this:null,i.propagates=1,i.mousedown=this,i.interactions=[h.interaction(this,i)],i.target=e.target,i.pageX=e.pageX,i.pageY=e.pageY,i.dragging=null,t=h.hijack(e,"draginit",i),i.propagates))return(t=h.flatten(t))&&t.length&&(i.interactions=[],m.each(t,function(){i.interactions.push(h.interaction(this,i))})),i.propagates=i.interactions.length,!1!==i.drop&&a.drop&&a.drop.handler(e,i),h.textselect(!1),h.touched?u.add(h.touched,"touchmove touchend",h.handler,i):u.add(document,"mousemove mouseup",h.handler,i),!(!h.touched||i.live)&&void 0}},interaction:function(e,t){t=m(e)[t.relative?"position":"offset"]()||{top:0,left:0};return{drag:e,callback:new h.callback,droppable:[],offset:t}},handler:function(e){var t=e.data;switch(e.type){case!t.dragging&&"touchmove":e.preventDefault();case!t.dragging&&"mousemove":if(Math.pow(e.pageX-t.pageX,2)+Math.pow(e.pageY-t.pageY,2)<Math.pow(t.distance,2))break;e.target=t.target,h.hijack(e,"dragstart",t),t.propagates&&(t.dragging=!0);case"touchmove":e.preventDefault();case"mousemove":if(t.dragging){if(h.hijack(e,"drag",t),t.propagates){!1!==t.drop&&a.drop&&a.drop.handler(e,t);break}e.type="mouseup"}default:h.touched?u.remove(h.touched,"touchmove touchend",h.handler):u.remove(document,"mousemove mouseup",h.handler),t.dragging&&(!1!==t.drop&&a.drop&&a.drop.handler(e,t),h.hijack(e,"dragend",t)),h.textselect(!0),!1===t.click&&t.dragging&&m.data(t.mousedown,"suppress.click",(new Date).getTime()+5),t.dragging=h.touched=!1}},hijack:function(i,a,n,e,t){if(n){var r,o,s,l={event:i.originalEvent,type:i.type},d=a.indexOf("drop")?"drag":"drop",x=e||0,c=isNaN(e)?n.interactions.length:e;i.type=a,i.originalEvent=null,n.results=[];do{if(o=n.interactions[x]){if("dragend"!==a&&o.cancelled)continue;s=h.properties(i,n,o),o.results=[],m(t||o[d]||n.droppable).each(function(e,t){if(s.target=t,!(i.isPropagationStopped=function(){return!1})===(r=t?u.dispatch.call(t,i,s):null)?("drag"==d&&(o.cancelled=!0,--n.propagates),"drop"==a&&(o[d][e]=null)):"dropinit"==a&&o.droppable.push(h.element(r)||t),"dragstart"==a&&(o.proxy=m(h.element(r)||o.drag)[0]),o.results.push(r),delete i.result,"dropinit"!==a)return r}),n.results[x]=h.flatten(o.results),"dropinit"==a&&(o.droppable=h.flatten(o.droppable)),"dragstart"!=a||o.cancelled||s.update()}}while(++x<c);return i.type=l.type,i.originalEvent=l.event,h.flatten(n.results)}},properties:function(e,t,i){var a=i.callback;return a.drag=i.drag,a.proxy=i.proxy||i.drag,a.startX=t.pageX,a.startY=t.pageY,a.deltaX=e.pageX-t.pageX,a.deltaY=e.pageY-t.pageY,a.originalX=i.offset.left,a.originalY=i.offset.top,a.offsetX=a.originalX+a.deltaX,a.offsetY=a.originalY+a.deltaY,a.drop=h.flatten((i.drop||[]).slice()),a.available=h.flatten((i.droppable||[]).slice()),a},element:function(e){if(e&&(e.jquery||1==e.nodeType))return e},flatten:function(e){return m.map(e,function(e){return e&&e.jquery?m.makeArray(e):e&&e.length?h.flatten(e):e})},textselect:function(e){m(document)[e?"unbind":"bind"]("selectstart",h.dontstart).css("MozUserSelect",e?"":"none"),document.unselectable=e?"off":"on"},dontstart:function(){return!1},callback:function(){}};h.callback.prototype={update:function(){a.drop&&this.available.length&&m.each(this.available,function(e){a.drop.locate(this,e)})}};var t=u.dispatch;u.dispatch=function(e){if(!(0<m.data(this,"suppress."+e.type)-(new Date).getTime()))return t.apply(this,arguments);m.removeData(this,"suppress."+e.type)};var n=u.fixHooks.touchstart=u.fixHooks.touchmove=u.fixHooks.touchend=u.fixHooks.touchcancel={props:"clientX clientY pageX pageY screenX screenY".split(" "),filter:function(i,e){var a;return!e||(a=e.touches&&e.touches[0]||e.changedTouches&&e.changedTouches[0]||null)&&m.each(n.props,function(e,t){i[t]=a[t]}),i}};a.draginit=a.dragstart=a.dragend=h}(jQuery),angular.module("timeseries",["gm.date"]).directive("timeseries",["$compile","$rootScope","gmDate",function(s,A,N){return{restrict:"A",scope:{data:"=",markers:"=",options:"=",status:"=",api:"="},link:function(y,b,e){var t=s('<canvas style="display:block"></canvas>')(y);b.append(t);function M(e,t,i,a,n){var r=t/((n*=.001)-(a*=.001));if(!(r<=0)){var o,s=l.length;for(P.drx=[l[s-1].major,l[s-1].minor],P.primaryTimeFormat=l[s-1][2],P.secondaryTimeFormat=l[s-1][3],P.relativeTimeFormat=l[s-1][4],P.fontHeight=(i-8)/2,12<P.fontHeight?P.fontHeight=12:P.fontHeight<8&&(P.fontHeight=8),P.longTick=i-8-2*P.fontHeight,P.longTick<0&&(P.longTick=0),P.shortTick=.5*P.longTick,e.font=P.fontHeight+"px Sans-Serif",P.minLabelWidth=e.measureText("  XXXX-XX-XX.X  ").width,o=0;o<s;++o)if(l[o][0]*r>=P.minLabelWidth){P.drx[0]=l[o][0],P.drx[1]=l[o][1],P.primaryTimeFormat=l[o][2],P.secondaryTimeFormat=l[o][3],P.relativeTimeFormat=l[o][4];break}if(o===s&&0<r)for(P.drx[0]=l[s-1][0],P.drx[1]=l[s-1][1],P.primaryTimeFormat=l[s-1][2],P.secondaryTimeFormat=l[s-1][3],P.relativeTimeFormat=l[s-1][4];P.drx[0]*r<P.minLabelWidth;)P.drx[0]*=2,P.drx[1]*=2}}function S(e,t,i,a,n,r,o,s,l,d,x){var c=a/((o*=.001)-(r*=.001));if(!(c<=0)){d<x&&(x=(.001*x-r)*c,(d=(.001*d-r)*c)<a&&0<x&&(e.fillStyle="rgba(0,0,0,0.2)",e.fillRect(t+d,i+n-20,x-d,20)));for(var m=r+0,u=m-m%P.drx[0],h=Math.floor((u-m)*c);h<a;)0<=h&&(e.beginPath(),e.moveTo(t+h+.5,i+.5),e.lineTo(t+h+.5,i+n+.5),e.stroke()),u+=P.drx[0],h=Math.floor((u-m)*c)}}function Y(t,e,i,a,n,r,o,s,l,d){if(!(n<=0)){var x=a/((o*=.001)-(r*=.001));if(!(x<=0)){t.beginPath(),t.moveTo(e+.5,i+.5),t.lineTo(e+a+.5,i+.5),t.stroke(),t.textBaseline="top",t.textAlign="center";for(var c=r+0,m=i+P.longTick+4+.5,u=i+P.longTick+4+P.fontHeight+2-1+.5,h="",f=0;f<2;++f)if(!(P.drx[f]<=0))for(var p,g,v,T=c-c%P.drx[f],k=0===f?P.longTick:P.shortTick,w=Math.floor((T-c)*x);w<a;)0<=w&&(t.beginPath(),t.moveTo(e+w+.5,i+.5),t.lineTo(e+w+.5,i+k+.5),t.stroke(),0===f&&(d?(g=parseFloat((1e-6*Math.floor(Math.round(1e6*T))).toFixed(3)),e<=w-(v=.5*t.measureText(g).width)&&w+v<=a&&t.fillText(g,e+w+.5,m)):(p=1e3*T,g=void 0!==l.xaxis.ruler.useUTC?N.toString(p,P.primaryTimeFormat,l.xaxis.ruler.useUTC):N.toDefaultString(p,P.primaryTimeFormat),e<=w-(v=.5*t.measureText(g).width)&&w+v<=a&&t.fillText(g,e+w+.5,m),P.secondaryTimeFormat&&w-.5*P.minLabelWidth>=e&&w+.5*P.minLabelWidth<=a&&((p=void 0!==l.xaxis.ruler.useUTC?N.toString(p,P.secondaryTimeFormat,l.xaxis.ruler.useUTC):N.toDefaultString(p,P.secondaryTimeFormat))!==h&&(t.fillText(p,e+w+.5,u),h=p))))),T+=P.drx[f],w=Math.floor((T-c)*x);if(s){t.save(),t.font="bold "+P.fontHeight+"px Sans-Serif";for(var y=s?s.length:0,b=0;b<y;++b){var M=s[b];w=C(.001*(M.x-d),r,o,a);var S=2;try{t.strokeStyle=l.marker[M.type].color}catch(e){t.strokeStyle="#f00"}try{S=l.marker[M.type].lineWidth}catch(e){}t.lineWidth=S,t.fillText(M.annotation,e+w-.5,u)}t.restore()}}}}var D=t[0],H=0,X=[],R={xaxis:{min:null,max:null},yaxis:{min:null,max:null},trace:{sampleCount:null,fromRecord:null,toRecord:null,offset:null}},a="default",L=null,F=null,E=null,l=[[.001,2e-4,"%S.%3","%Y-%m-%d %H:%M",""],[.005,.001,"%S.%3","%Y-%m-%d %H:%M",""],[.01,.002,"%S.%2","%Y-%m-%d %H:%M",""],[.05,.01,"%S.%2","%Y-%m-%d %H:%M",""],[.1,.02,"%T.%1","%Y-%m-%d",""],[.5,.1,"%T.%1","%Y-%m-%d",""],[1,.2,"%T","%Y-%m-%d",""],[2,.5,"%T","%Y-%m-%d",""],[5,1,"%T","%Y-%m-%d",""],[10,2,"%T","%Y-%m-%d",""],[15,3,"%T","%Y-%m-%d",""],[30,5,"%T","%Y-%m-%d",""],[60,10,"%T","%Y-%m-%d",""],[120,20,"%T","%Y-%m-%d",""],[300,60,"%T","%Y-%m-%d",""],[600,120,"%T","%Y-%m-%d",""],[900,300,"%T","%Y-%m-%d",""],[1800,300,"%T","%Y-%m-%d",""],[3600,600,"%T","%Y-%m-%d",""],[7200,1200,"%T","%Y-%m-%d",""],[21600,3600,"%T","%Y-%m-%d",""],[43200,7200,"%T","%Y-%m-%d",""],[86400,21600,"%b, %d","%Y",""],[172800,43200,"%b, %d","%Y",""],[604800,86400,"%b, %d","%Y",""],[1209600,172800,"%b, %d","%Y",""]],P={fontHeight:0,longTick:0,shortTick:0,drx:[0,0],primaryTimeFormat:"",secondaryTimeFormat:"",relativeTimeFormat:"",minLabelWidth:0},W={update:function(){x()},setCursor:function(e){e!==L&&(e?(L=e,b.css("cursor","crosshair")):(L=null,b.css("cursor","pointer")),x())},currentMarker:null},C=function(e,t,i,a){return Math.floor((e-t)*a/(i-t))},z=0,x=function(){var t=D.getContext("2d");t.clearRect(0,0,D.width,D.height);var e={interactive:!0,showAllData:!0,xaxis:{color:"black",ruler:{enable:!0,height:36,drawMarker:!1},referenceTime:null},yaxis:{autoScale:!1},grid:{color:"lightGray",show:!0,relative:!1}};$.extend(!0,e,y.options),e.interactive||(null!==e.xaxis.min?(R.xaxis.min=e.xaxis.min,null!==e.xaxis.max?R.xaxis.max=e.xaxis.max:R.xaxis.max=e.xaxis.min+6e5):null!==e.xaxis.max&&(R.xaxis.max=e.xaxis.max,null!==e.xaxis.min?R.xaxis.min=e.xaxis.min:R.xaxis.min=e.xaxis.max-6e5)),null!==R.xaxis.max&&null!==R.xaxis.min&&R.xaxis.max-R.xaxis.min<100&&(p=.5*(R.xaxis.min+R.xaxis.max),R.xaxis.min=p-50,R.xaxis.max=50+p),D.width!==b.width()&&(D.width=b.width()),D.height!==b.height()&&(D.height=b.height());var i=e.xaxis.ruler.height;e.xaxis.ruler.enable||(i=0),z=0,e.xaxis.referenceTime&&e.grid.relative&&(z=e.xaxis.referenceTime);var a=(e.xaxis.smin||0)-z,n=(e.xaxis.smax||0)-z;if(X.length=0,y.data){var r=y.data.length;H=D.height-i;for(var o=0,s=0;s<r;++s)(e.showAllData||y.data[s].active)&&++o;var l=H/o,d=0;t.save();var x,c,m,u,h,f,p,g=0;for(s=0;s<r;++s)e.showAllData||y.data[s].active?(X[s]=[d,d+l],h=y.data[s].records?function(e,t,i){var a={timeMin:null,timeMax:null,amplMin:null,amplMax:null,samples:0,firstRecord:-1,lastRecord:-1,offset:0};if(!e)return a;for(var n=0,r=0;r<e.length;++r){var o=e[r];if(0!==o.samples.length&&!(t&&o.endTime<=t)){if(i&&o.startTime>=i)break;var s=t?.001*(t-o.startTime):0,l=i?.001*(o.endTime-i):0,d=0,x=o.samples.length;if(0<s){if(x<=(d=Math.floor(s*o.srNum/o.srDen)))continue;x-=d}if(!(0<l&&(x-=Math.floor(l*o.srNum/o.srDen))<=0)){a.firstRecord<0&&(a.firstRecord=r),a.lastRecord=r,(null===a.timeMin||a.timeMin>o.startTime)&&(a.timeMin=o.startTime),(null===a.timeMax||a.timeMax<o.endTime)&&(a.timeMax=o.endTime),null===a.amplMin&&(a.amplMin=o.samples[d]),null===a.amplMax&&(a.amplMax=o.samples[d]);for(var c=d,m=0;m<x;++m,++c)o.samples[c]<a.amplMin&&(a.amplMin=o.samples[c]),o.samples[c]>a.amplMax&&(a.amplMax=o.samples[c]),n+=o.samples[c];a.samples+=x}}}return 0<a.samples&&(a.offset=n/a.samples),a}(y.data[s].records,e.yaxis.autoScale?R.xaxis.min+(z||0):null,e.yaxis.autoScale?R.xaxis.max+(z||0):null):{samples:0,offset:0,firstRecord:-1,lastRecord:-1,timeMin:R.xaxis.min,timeMax:R.xaxis.max,amplMin:-1,amplMax:1},g||(R.trace.sampleCount=h.samples,R.trace.fromRecord=h.firstRecord,R.trace.toRecord=h.lastRecord,R.trace.offset=h.offset),null===R.xaxis.min&&(R.xaxis.min=h.timeMin),null===R.xaxis.max&&(R.xaxis.max=h.timeMax),(null===R.yaxis.min||e.yaxis.autoScale&&h.amplMin)&&(R.yaxis.min=h.amplMin),(null===R.yaxis.max||e.yaxis.autoScale&&h.amplMax)&&(R.yaxis.max=h.amplMax),null!==R.xaxis.min&&null!==R.xaxis.max&&(x=R.yaxis.min,c=R.yaxis.max,m=1e3*+D.width/(R.xaxis.max-R.xaxis.min),0===g&&(M(t,D.width,i,R.xaxis.min,R.xaxis.max),e.grid.show&&(t.strokeStyle=e.grid.color,S(t,0,0,+D.width,D.height-i,R.xaxis.min,R.xaxis.max,0,0,a,n)),e.xaxis.referenceTime&&(u=C(e.xaxis.referenceTime-z,R.xaxis.min,R.xaxis.max,+D.width)+0+.5,t.strokeStyle="red",t.beginPath(),t.moveTo(u,0),t.lineTo(u,H),t.stroke())),f=h.offset,h=Math.floor(l-(f-x)*l/(c-x)),f={color:"#eee",offsetColor:"lightBlue",lineWidth:1,optimize:!0},$.extend(!0,f,y.data[s].options),0<=h&&h<l&&(t.strokeStyle=f.offsetColor,t.beginPath(),t.moveTo(0,d+h+.5),t.lineTo(+D.width,d+h+.5),t.stroke()),t.strokeStyle=f.color,t.lineWidth=f.lineWidth,function(e,t,i,a,n,r,o,s,l,d,x,c){if(null!==t&&0!==t.length){var n=r-n,m=0==n?0:(d-1)/n;c&&(i+=c,a+=c);for(var u=null,h=!1,f=100,p=f,g=t.length,v=0;v<g;++v){var T=t[v];if(0!==T.samples.length&&!(i&&T.endTime<=i)){if(a&&T.startTime>=a)break;u&&.001*Math.abs(T.startTime-u.endTime)*T.srNum>T.srDen&&h&&(e.stroke(),h=!1);var k=.001*(i?i-T.startTime:t[0].startTime-T.startTime),w=.001*(a?T.endTime-a:0),y=0,b=T.samples.length;if(0<k){if(b<=(y=Math.floor(k*T.srNum/T.srDen)))continue;b-=y,k-=y*T.srDen/T.srNum}if(!(0<w&&(b-=Math.floor(w*T.srNum/T.srDen))<=0)){var M,k=Math.floor(o*k),S=o*T.srDen/T.srNum,$=s-k,Y=Math.floor(m*(r-T.samples[y]))+.5+l,D=Y,H=Y,X=$,R=Y,u=T;h?e.lineTo($,Y):(e.beginPath(),e.moveTo($,Y),h=!0);var L=S+s-k,F=y+1;if(x){for(M=1;M<b;++M,L+=S,++F){var E=Math.floor(L)+.5,P=Math.floor(m*(r-T.samples[F]))+.5+l;P!==R?(X!==$&&(X=$,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R))),X!==E?(D!==R&&(R=D,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R))),H!==R&&(R=H,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R))),Y!==R&&(R=Y,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R))),X=E,P!==R&&(e.lineTo(X,R=P),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R))),D=H=R):P<D?D=P:H<P&&(H=P)):(D!==R&&(R=D,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R)),D=R),H!==R&&(R=H,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R)),H=R),Y!==R&&(R=D=H=Y,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R)))),$=E,Y=P}X!==$&&e.lineTo($,Y)}else for(M=1;M<b;++M)X=L,R=m*(r-T.samples[F])+l,e.lineTo(X,R),--p<=0&&(p=f,e.stroke(),e.beginPath(),e.moveTo(X,R)),L+=S,++F}}}h&&e.stroke()}}(t,y.data[s].records,R.xaxis.min,R.xaxis.max,x,c,m,0,d,l,f.optimize,z),d+=l,++g)):X[s]=null;if(y.markers){t.textBaseline="top",t.textAlign="left",t.font="12px sans-serif";for(var v=y.markers?y.markers.length:0,T=0;T<v;++T){var k=y.markers[T],w=2;try{t.strokeStyle=e.marker[k.type].color}catch(e){t.strokeStyle="#f00"}try{if(!(w=e.marker[k.type].lineWidth))continue}catch(e){}t.lineWidth=w,u=C(k.x-z,R.xaxis.min,R.xaxis.max,+D.width)+0-.5*w,k===W.currentMarker&&(t.fillStyle="rgba(0,0,0,0.2)",t.fillRect(u-3,0,6,D.height-i)),t.beginPath(),t.moveTo(u,0),t.lineTo(u,D.height-i),t.stroke(),k.annotation&&(w=k.align||0,t.fillStyle=t.strokeStyle,w?1===w?t.fillText(k.annotation,u+2,.5*(D.height-i-12)):2===w&&t.fillText(k.annotation,u+2,D.height-i-12-2):t.fillText(k.annotation,u+2,0))}}F&&L&&(t.strokeStyle="#000",t.fillStyle=t.strokeStyle,t.lineWidth=1,u=C(F,R.xaxis.min,R.xaxis.max,+D.width)+0+.5,t.beginPath(),t.moveTo(u,0),t.lineTo(u,D.height-i),t.stroke(),t.fillText(L,u+2,0),p=void 0!==e.xaxis.ruler.useUTC?N.toString(F,"%H:%M:%S.%3",e.xaxis.ruler.useUTC):N.toDefaultString(F,"%H:%M:%S.%3"),null!=E&&y.data[E].id&&(p+=" #"+y.data[E].id),t.fillStyle="#fff",t.rect(u,D.height-i-14,t.measureText(p).width+4,14),t.stroke(),t.fill(),t.fillStyle="#000",t.fillText(p,u+2,D.height-i-12-2)),t.restore(),t.strokeStyle=e.xaxis.color,t.fillStyle=e.xaxis.color,Y(t,0,D.height-i,+D.width,i,R.xaxis.min,R.xaxis.max,e.xaxis.ruler.drawMarker?y.markers:null,e,z)}else null!==R.xaxis.min&&null!==R.xaxis.max&&(H=0,M(t,D.width,i,R.xaxis.min,R.xaxis.max),e.grid.show&&(t.strokeStyle=e.grid.color,S(t,0,0,+D.width,D.height-i,R.xaxis.min,R.xaxis.max,0,0,a,n)),t.strokeStyle=e.xaxis.color,t.fillStyle=e.xaxis.color,Y(t,0,D.height-i,+D.width,i,R.xaxis.min,R.xaxis.max,e.xaxis.ruler.drawMarker?y.markers:null,e,z));y.status&&("$digest"===A.$$phase||"$apply"===A.$$phase?y.status=R:y.$apply(y.status=R))};try{null!==y.options.xaxis.min?(R.xaxis.min=y.options.xaxis.min,null!==y.options.xaxis.max?R.xaxis.max=y.options.xaxis.max:R.xaxis.max=y.options.xaxis.min+6e5):null!==y.options.xaxis.max&&(R.xaxis.max=y.options.xaxis.max,null!==y.options.xaxis.min?R.xaxis.min=y.options.xaxis.min:R.xaxis.min=y.options.xaxis.max-6e5)}catch(e){}e.complete&&y.$parent.$last&&y.$parent.$evalAsync(e.complete),e.deferUpdate||x(),window.addResizeListener?window.addResizeListener(b[0],x):y.$watch(function(){return b.innerWidth()+";"+b.innerHeight()},function(e,t){x()}),y.api&&(y.api.timeSeries=W);var i,n,t=!0;try{y.options.hasOwnProperty("interactive")&&(t=y.options.interactive)}catch(e){}t&&(W.evWheel=b.bind("mousewheel",function(e,t,i,a){if(e.preventDefault&&e.preventDefault(),R.xaxis.min&&R.xaxis.max){var n,e=(e.pageX-$(D).offset().left)/D.width,e=(R.xaxis.max-R.xaxis.min)*e+R.xaxis.min;if(0<t)n=.6;else{if(!(t<0))return;n=1.4}R.xaxis.min=(R.xaxis.min-e)*n+e,R.xaxis.max=(R.xaxis.max-e)*n+e,x()}}),W.evDragStart=b.bind("dragstart",function(e,t){var i=b.css("cursor");i&&(a=i),b.css("cursor","move")}),W.evDragEnd=b.bind("dragend",function(e,t){b.css("cursor",a)}),W.evDrag=b.bind("drag",function(e,t){var i;R.xaxis.min&&R.xaxis.max&&(i=void 0!==t.lastDeltaX?t.deltaX-t.lastDeltaX:t.deltaX,t.lastDeltaX=t.deltaX,i=i/D.width*(R.xaxis.max-R.xaxis.min),R.xaxis.min-=i,R.xaxis.max-=i,x())}),n=i=void 0,W.evTouchStart=b.bind("touchstart",function(e){e.preventDefault&&e.preventDefault();e=b.css("cursor");e&&(a=e),b.css("cursor","move")}),W.evTouchEnd=b.bind("touchend",function(e){b.css("cursor",a),n=i=void 0}),W.evTouchMove=b.bind("touchmove",function(e){var t;e.preventDefault&&e.preventDefault(),R.xaxis.min&&R.xaxis.max&&(!e.originalEvent.touches||e.originalEvent.touches.length<1||(i=i||[e.originalEvent.touches[0].pageX,e.originalEvent.touches[0].pageY],t=[e.originalEvent.touches[0].pageX,e.originalEvent.touches[0].pageY][0]-i[0],e=void 0!==n?t-n:t,n=t,e=e/D.width*(R.xaxis.max-R.xaxis.min),R.xaxis.min-=e,R.xaxis.max-=e,x()))}),y.api&&(W.evMove=b.bind("mousemove",function(e){if(R.xaxis.min&&R.xaxis.max){var t=R.xaxis.max-R.xaxis.min,i=e.pageY-$(D).offset().top;if(!(H<=i)){for(var a=e.pageX-$(D).offset().left,n=!1,r=!1,o=y.markers?y.markers.length:0,s=0;s<o;++s){var l=y.markers[s],d=l.x-R.xaxis.min;if(!(d<0||t<d)&&(d/=t,d*=D.width,Math.abs(d-a-1)<3&&(r=!0,l!==W.currentMarker))){W.currentMarker=l,n=!0;break}}if(!r&&W.currentMarker&&(n=!(W.currentMarker=null)),L){e=(e.pageX-$(D).offset().left)/D.width;if(F=t*e+R.xaxis.min,E=null,y.data)for(o=X.length,s=0;s<o;++s)if(X[s]&&i>=X[s][0]&&i<X[s][1]){E=s;break}n=!0}n&&x()}}}),W.evClick=b.bind("click",function(e){try{b[0].focus()}catch(e){}if(R.xaxis.min&&R.xaxis.max&&y.api.clicked){var t,i=(e.pageX-$(D).offset().left)/D.width,a=e.pageY-$(D).offset().top;if(!(H<=a)){if(y.data)for(var n=X.length,r=0;r<n;++r)if(X[r]&&a>=X[r][0]&&a<X[r][1]){t=r;break}i=(R.xaxis.max-R.xaxis.min)*i+R.xaxis.min;y.api.clicked(e,i,t,W.currentMarker)}}}),W.evDblClick=b.bind("dblclick",function(e){if(R.xaxis.min&&R.xaxis.max&&y.api.selected){var t,i=(e.pageX-$(D).offset().left)/D.width,a=e.pageY-$(D).offset().top;if(!(H<=a)){if(y.data)for(var n=X.length,r=0;r<n;++r)if(X[r]&&a>=X[r][0]&&a<X[r][1]){t=r;break}i=(R.xaxis.max-R.xaxis.min)*i+R.xaxis.min;y.api.selected(e,i,t,W.currentMarker)}}}))),e.plotreset&&setTimeout(function(){$("#"+e.plotreset).click(function(){R.xaxis.min=null,R.xaxis.max=null,x()})},10);function r(e,t){e!==t&&x()}var o=[];y.$watch("data",function(e,t){for(var i=o.length,a=0;a<i;++a)o[a]();if(o.length=0,y.data){for(i=y.data.length,a=0;a<i;++a)o.push(y.$watch("data["+a+"].records",r)),o.push(y.$watch("data["+a+"].records.length",r)),o.push(y.$watch("data["+a+"].options",r)),o.push(y.$watch("data["+a+"].active",r));x()}}),y.$watch("markers",r),y.$watch("markers.length",r),y.$watch("options",function(e,t){y.status&&y.options&&(null!==y.options.xaxis.min&&(y.status.xaxis.min=y.options.xaxis.min),null!==y.options.xaxis.max&&(y.status.xaxis.max=y.options.xaxis.max)),r(e,t)},!0),y.$on("updateLayout",function(){x()}),y.$on("$destroy",function(){y.data=null,y.api&&(y.api.timeSeries=null,y.api=null),window.removeResizeListener&&window.removeResizeListener(b[0],x),W.evWheel&&b.unbind("mousewheel"),W.evDragStart&&b.unbind("dragstart"),W.evDragEnd&&b.unbind("dragend"),W.evDrag&&b.unbind("drag"),W.evTouchStart&&b.unbind("touchstart"),W.evTouchEnd&&b.unbind("touchend"),W.evTouchMove&&b.unbind("touchmove"),W.evMove&&b.unbind("mousemove"),W.evClick&&b.unbind("click"),W.evDblClick&&b.unbind("dblclick")})}}}]).directive("autoHeight",function(){return{restrict:"A",link:function(s,l,d){function i(){d.minHeight&&(c=parseFloat(s.$eval(d.minHeight)))<10&&(c=10)}var x=-1,c=30;i();function a(e){var t=l.innerHeight();if(e||t!==x){x=t;var i=0,e=l.children(d.children);if(e.each(function(){"none"!==$(this).css("display")&&++i}),!(t<=0||0===i)){var a=t/i;try{a<c&&(a=c)}catch(e){}var n,r=0,o=0;e.each(function(e,t){r+=a;var i=(n=Math.floor(r))-o;$(t).height(i),o=n}),0<o&&d.layoutComplete&&s.$evalAsync(d.layoutComplete)}}}d.rows&&s.$watch(d.rows,function(e,t){a(!0)}),d.minHeight&&s.$watch(d.minHeight,function(e,t){i(),a(!0)}),window.addResizeListener?window.addResizeListener(l[0],a):s.$watch(function(){return 1e6*l.innerWidth()+l.innerHeight()},function(e,t){a()}),s.$on("updateLayout",function(){a(!0)}),s.$on("$destroy",function(){window.removeResizeListener&&window.removeResizeListener(l[0],a)}),a()}}}).directive("autoHeightNoScope",function(){return{restrict:"A",link:function(e,s,i){function a(){i.minHeight&&(d=parseFloat(e.$eval(i.minHeight)))<10&&(d=10)}var l=-1,d=30;a();function n(e){var t=s.innerHeight();if(e||t!==l){l=t;e=s.children(i.children).size();if(!(t<=0||0===e)){var a=t/e;try{a<d&&(a=d)}catch(e){}var n,r=0,o=0;s.children(i.children).each(function(e,t){r+=a;var i=(n=Math.floor(r))-o;$(t).height(i),o=n})}}}i.rows&&e.$watch(i.rows,function(e,t){n(!0)}),i.minHeight&&e.$watch(i.minHeight,function(e,t){a(),n(!0)}),window.addResizeListener?window.addResizeListener(s[0],n):e.$watch(function(){return 1e6*s.innerWidth()+s.innerHeight()},function(e,t){n()}),i.hasOwnProperty("stretchY")&&e.$watch(function(){return s.parent().innerWidth()+";"+s.parent().innerHeight()},function(e,t){var i=s.parent().innerHeight()-s.position().top;i!==l&&s.height(i)}),e.$on("updateLayout",function(){n(!0)}),e.$on("$destroy",function(){window.removeResizeListener&&window.removeResizeListener(s[0],n)})}}});
angular.module("plot",[]).directive("plot",["$timeout",function(f){function A(t,i){return t/=i,i=0|Math.floor(Math.log(t)/Math.LN10),t/=Math.pow(10,i),5!=(t=0|Math.round(t))&&t%2&&++t,t*Math.pow(10,i)}function v(t,i){this.elem=t,this.canvas=i,this.xCol=0,this.xLabel="X",this.yCol=1,this.ySym=!1,this.yLabel="Y",this.bbox=null,this.displayRect=null,this.valueRect=null,this.dragging=!1,this.dragStart=null,this.dragStroke="rgb(32,32,32)",this.dragFill="rgba(32,32,32,0.2)"}return v.prototype.setData=function(t){this.data=t,this.curRow=null,this.dragBox=null,this._updateBbox()},v.prototype.setAxis=function(t,i,e,s,a,o){this.xAxis=t,this.xLabel=i,this.xRange=e,this.yAxis=s,this.yLabel=a,this.yRange=o,this._updateBbox()},v.prototype.zoomReset=function(){this.curRow=null,this.dragBox=null,this._updateBbox(),this.update()},v.prototype.zoomActive=function(){this.curRow=null,this.dragBox=null,this._updateBbox(!0),this.update()},v.prototype._updateBbox=function(t){if(this.data){var i,e,s=0,a=this.data.length,o=[0,0],l=[0,0];for(this.bbox=null,i=0;i<a;++i){var h,n=this.data[i];t&&!n.active||(h=n.cols[this.xAxis],n=n.cols[this.yAxis],void 0!==h&&void 0!==n&&(s?(h<o[0]?o[0]=h:h>l[0]&&(l[0]=h),n<o[1]?o[1]=n:n>l[1]&&(l[1]=n)):this.bbox=[o=[h,n],l=[h,n]],++s))}this.ySym&&(e=Math.abs(o[1]),Math.abs(l[1])>e&&(e=Math.abs(l[1])),o[1]=-e,l[1]=e)}else this.bbox=null},v.prototype.isInside=function(t,i){var e=this.data[i],i=e.cols[this.xAxis],e=e.cols[this.yAxis];return i>=t[0][0]&&i<=t[1][0]&&e>=t[0][1]&&e<=t[1][1]},v.prototype.setCursor=function(t,i){if(this.data&&this.valueRect){var e=(this.displayRect[1][0]-this.displayRect[0][0])/(this.valueRect[1][0]-this.valueRect[0][0]),s=(this.displayRect[1][1]-this.displayRect[0][1])/(this.valueRect[1][1]-this.valueRect[0][1]);if(this.dragging){if(this.dragStart||(this.dragStart=[t,i]),Math.abs(t-this.dragStart[0])<8||Math.abs(i-this.dragStart[1])<8){var a=this.dragBox;return this.dragBox=null,a!==this.dragBox}var o,l=(t-this.displayRect[0][0])/e+this.valueRect[0][0],h=(this.displayRect[1][1]-i)/s+this.valueRect[0][1];return l<this.valueRect[0][0]?l=this.valueRect[0][0]:l>this.valueRect[1][0]&&(l=this.valueRect[1][0]),h<this.valueRect[0][1]?h=this.valueRect[0][1]:h>this.valueRect[1][1]&&(h=this.valueRect[1][1]),this.dragBox?this.dragBox[1]=[l,h]:((o=(this.dragStart[0]-this.displayRect[0][0])/e+this.valueRect[0][0])<this.valueRect[0][0]?o=this.valueRect[0][0]:o>this.valueRect[1][0]&&(o=this.valueRect[1][0]),(a=(this.displayRect[1][1]-this.dragStart[1])/s+this.valueRect[0][1])<this.valueRect[0][1]?a=this.valueRect[0][1]:a>this.valueRect[1][1]&&(a=this.valueRect[1][1]),this.dragBox=[[o,a],[l,h]]),!0}for(var n=null,r=this.data.length-1;0<=r;--r){var c=this.data[r];if(c.valid){l=c.cols[this.xAxis],h=c.cols[this.yAxis];var u=this.displayRect[0][0]+((l-this.valueRect[0][0])*e|0)+.5,d=this.displayRect[1][1]-((h-this.valueRect[0][1])*s|0)+.5;if(Math.abs(u-t)<=3&&Math.abs(d-i)<=3){n=c;break}}}return this.curRow!==n&&(this.curRow=n,!0)}},v.prototype.setDragging=function(t){if(this.dragging!==t){this.dragging=t;t=null;return!this.dragging&&this.dragBox&&(t=[[Math.min(this.dragBox[0][0],this.dragBox[1][0]),Math.min(this.dragBox[0][1],this.dragBox[1][1])],[Math.max(this.dragBox[0][0],this.dragBox[1][0]),Math.max(this.dragBox[0][1],this.dragBox[1][1])]]),this.dragStart=null,this.dragBox=null,t}},v.prototype.update=function(){var t=this.elem.width(),i=this.elem.height(),e=!0;this.canvas.width!==t&&(e=!1,this.canvas.width=t),this.canvas.height!==i&&(e=!1,this.canvas.height=i);var s=this.canvas.width,a=this.canvas.height;if(!(s<=0||a<=0)){var o=this.canvas.getContext("2d");e&&o.clearRect(0,0,s,a);o.save(),o.font="10px Sans-Serif",this.displayRect=[[18.5,5.5],[s+.5,a-10-8+.5]];var l,h,n,r,c=this.displayRect,t=c[1][0]-c[0][0],i=c[1][1]-c[0][1];if(this.bbox){this.valueRect=[[this.bbox[0][0],this.bbox[0][1]],[this.bbox[1][0],this.bbox[1][1]]],r=this.valueRect,this.xRange&&(null!==this.xRange[0]&&(r[0][0]=this.xRange[0]),null!==this.xRange[1]&&(r[1][0]=this.xRange[1]),r[0][0]>r[1][0]&&(r[0][0]=r[1][0])),this.yRange&&(null!==this.yRange[0]&&(r[0][1]=this.yRange[0]),null!==this.yRange[1]&&(r[1][1]=this.yRange[1]),r[0][1]>r[1][1]&&(r[0][1]=r[1][1]));var u=r[1][0]-r[0][0],d=r[1][1]-r[0][1],g=A(u,6),f=A(d,6),e=.05*u,s=.05*d;if(r[0][0]-=e,r[1][0]+=e,r[0][1]-=s,r[1][1]+=s,u=r[1][0]-r[0][0],d=r[1][1]-r[0][1],0<f){(l=(0|Math.floor(r[0][1]/f))*f)<r[0][1]&&(l+=f);for(var v=0;l<r[1][1];){var x=(Math.abs(l)<1e-10?o.measureText("0"):o.measureText(l.toPrecision(3))).width;v<x&&(v=x),l+=f}0<v&&(v+=4),c[0][0]+=v,t-=v}0<g&&(c[1][1]-=14,i-=14),h=t/u,n=i/d,o.fillStyle="#fff",o.fillRect(c[0][0],c[0][1],t,i),o.strokeStyle="#c0c0c0";try{var R=o.getLineDash();o.setLineDash([2])}catch(t){}if(0<g)for((l=(0|Math.floor(r[0][0]/g))*g)<r[0][0]&&(l+=g);l<r[1][0];)w=c[0][0]+((l-r[0][0])*h|0),o.beginPath(),o.moveTo(w,c[0][1]),o.lineTo(w,c[1][1]),o.stroke(),l+=g;if(0<f)for((l=(0|Math.floor(r[0][1]/f))*f)<r[0][1]&&(l+=f);l<r[1][1];)B=c[1][1]-((l-r[0][1])*n|0),o.beginPath(),o.moveTo(c[0][0],B),o.lineTo(c[1][0],B),o.stroke(),l+=f;try{o.setLineDash(R)}catch(t){}}else this.valueRect=null,o.fillStyle="#fff",o.fillRect(c[0][0],c[0][1],t,i);if(o.strokeStyle="#222",o.lineWidth=1,o.beginPath(),o.moveTo(c[0][0],c[0][1]),o.lineTo(c[0][0],c[1][1]),o.lineTo(c[1][0],c[1][1]),o.stroke(),o.textAlign="center",o.textBaseline="bottom",o.fillStyle=o.strokeStyle,o.fillText(this.xLabel,.5*(c[0][0]+c[1][0]),a),o.textBaseline="top",o.save(),o.translate(0,.5*(c[0][1]+c[1][1])),o.rotate(-Math.PI/2),o.fillText(this.yLabel,0,0),o.restore(),r){if(0<g)for((l=(0|Math.floor(r[0][0]/g))*g)<r[0][0]&&(l+=g);l<r[1][0];)w=c[0][0]+((l-r[0][0])*h|0),o.beginPath(),o.moveTo(w,c[1][1]),o.lineTo(w,c[1][1]+4),o.stroke(),Math.abs(l)<1e-10?o.fillText("0",w,c[1][1]+4+2):o.fillText(l.toPrecision(3),w,c[1][1]+4+2),l+=g;if(0<f)for(o.textBaseline="middle",o.textAlign="right",(l=(0|Math.floor(r[0][1]/f))*f)<r[0][1]&&(l+=f);l<r[1][1];)B=c[1][1]-((l-r[0][1])*n|0),o.beginPath(),o.moveTo(c[0][0],B),o.lineTo(c[0][0]-4,B),o.stroke(),Math.abs(l)<1e-10?o.fillText("0",c[0][0]-4-2,B):o.fillText(l.toPrecision(3),c[0][0]-4-2,B),l+=f;o.strokeStyle="#222",o.lineWidth=1;for(var p,b,y,m,w,B,S=this.data.length,k=0;k<S;++k){var M=this.data[k];M.valid&&M!==this.curRow&&(o.fillStyle=M.active?M.color:"#888",p=M.cols[this.xAxis],b=M.cols[this.yAxis],y=c[0][0]+((p-r[0][0])*h|0)+.5,m=c[1][1]-((b-r[0][1])*n|0)+.5,o.beginPath(),"rect"===M.shape?o.rect(y-3.5,m-3.5,7,7):o.arc(y,m,4,0,2*Math.PI),o.fill(),o.stroke())}null!==this.curRow&&(o.strokeStyle="#aaa",o.lineWidth=2,o.fillStyle=this.curRow.active?this.curRow.color:"#888",p=this.curRow.cols[this.xAxis],b=this.curRow.cols[this.yAxis],y=c[0][0]+((p-r[0][0])*h|0)+.5,m=c[1][1]-((b-r[0][1])*n|0)+.5,o.beginPath(),"rect"===this.curRow.shape?o.rect(y-6,m-6,12,12):o.arc(y,m,6,0,2*Math.PI),o.fill(),o.stroke()),this.dragBox&&(w=this.dragBox[0][0],B=this.dragBox[0][1],R=c[0][0]+((this.dragBox[0][0]-r[0][0])*h|0)+.5,t=c[1][1]-((this.dragBox[0][1]-r[0][1])*n|0)+.5,i=c[0][0]+((this.dragBox[1][0]-r[0][0])*h|0)+.5,a=c[1][1]-((this.dragBox[1][1]-r[0][1])*n|0)+.5,0<u&&0<d&&(o.strokeStyle=this.dragStroke,o.lineWidth=1,o.fillStyle=this.dragFill,o.beginPath(),o.rect(R+.5,.5+t,i-R,a-t),o.fill(),o.stroke())),o.restore()}}},{restrict:"EA",scope:{data:"=",options:"=",updateEvent:"="},template:"<canvas></canvas>",link:function(s,a,t){var i=a[0].children[0],o=new v(a,i);function e(){o.update()}function l(t){t.shiftKey?(o.dragStroke="rgb(0,188,112)",o.dragFill="rgba(0,188,112,0.2)"):t.ctrlKey?(o.dragStroke="rgb(188,112,0)",o.dragFill="rgba(188,112,0,0.2)"):(o.dragStroke="rgb(0,112,188)",o.dragFill="rgba(0,112,188,0.2)")}function h(t){o.dragging&&(l(t),e())}function n(t){o.dragging&&(l(t),e())}function r(t){t.preventDefault();var i=a[0].getBoundingClientRect(),e=t.clientX-i.left|0,i=t.clientY-i.top|0;1===t.which&&o.setDragging(!0),o.setCursor(e,i)&&o.update()}function c(t){var i;1!==t.which||(i=o.setDragging(!1))&&s.$apply(function(){s.$emit("plotRectSelected",t,i,o)})}function u(t){var i=a[0].getBoundingClientRect(),e=t.clientX-i.left|0,i=t.clientY-i.top|0;l(t);t=o.curRow;o.setCursor(e,i)&&o.update(),t!==o.curRow&&s.$apply(function(){s.$emit("plotHover",o.curRow)})}function d(t){u(t),o.curRow&&s.$apply(function(){s.$emit("plotSelected",o.curRow)})}function g(t){u(t),o.curRow&&s.$apply(function(){s.$emit("plotDblClicked",o.curRow)})}window.addResizeListener&&window.addResizeListener(a[0],e),a.bind("keyup",n),a.bind("keydown",h),a.bind("mousedown",r),a.bind("mouseup",c),a.bind("mousemove",u),a.bind("click",d),a.bind("dblclick",g),s.$on("$destroy",function(){window.removeResizeListener&&window.removeResizeListener(a[0],e),a.unbind("keyup",n),a.unbind("keydown",h),a.unbind("mousedown",r),a.unbind("mouseup",c),a.unbind("mousemove",u),a.unbind("click",d),a.unbind("dblclick",g)}),e(),s.$watch("data",function(t,i){f(function(){o.setData(t),e()},100)}),s.$watch("options",function(t,i){f(function(){t&&(o.ySym=s.options.ySym,o.setAxis(s.options.xCol,s.options.xLabel,s.options.xRange,s.options.yCol,s.options.yLabel,s.options.yRange),e())},100)}),s.updateEvent&&s.$on(s.updateEvent,function(){e()}),s.$on("plotZoomActive",function(){o.zoomActive()}),s.$on("plotZoomReset",function(){o.zoomReset()})}}}]);
"use strict";angular.module("recordstream",[]).factory("recordstream",["$q","$http","$timeout",function(e,D,s){return{run:function(p,f,h,g){var v="",w=e.defer(),m="Refused",q="WebSocket"in window;g.forceHTTP&&(q=!1);var y=null,t=null,j=!1;function n(e){return e<10?"0"+e:e}function T(e){return e.getUTCFullYear()+"-"+n(e.getUTCMonth()+1)+"-"+n(e.getUTCDate())+"T"+n(e.getUTCHours())+":"+n(e.getUTCMinutes())+":"+n(e.getUTCSeconds())}function r(){return v?(D.get(p+"query/streams/"+v+".json").then(function(e){e=e.data;0<e.request.records.length&&!j&&w.notify(e.request.records),e=null,m="Finished",t=s(r,0)}).catch(function(e){e.data;v=null,e.status<=0?(m="Disconnected",w.resolve(m)):502===e.status?(m="Proxy",w.resolve(m)):404===e.status?w.resolve(m):(v=null,m="Error",w.resolve(m,e.status))}),!0):(w.reject("No request to continue"),!1)}function C(e){D.post(p+"query/streams.json",e).then(function(e){e=e.data;v=e.request.id,0<e.request.records.length&&w.notify(e.request.records),e=null,r()}).catch(function(e){var t=e.data;e.status<=0||502===e.status?(m="Disconnected",w.resolve(m)):503===e.status?(m="Error",w.resolve(m)):w.reject(t)})}return{promise:w.promise,request:function(){if(!h||0===h.length)return w.reject("Empty request"),"";var e,t;g.start&&(e=T(g.start)),g.end&&(t=T(g.end));var n=[];g.spec&&n.push("spec=true"),g.spec&&g.raw&&n.push("raw=true"),g.specLength&&n.push("spec-window-length="+g.specLength),g.specOverlap&&n.push("spec-window-overlap="+g.specOverlap),g.specN&&n.push("spec-n-samples="+g.specN);for(var r,s,o,c,u=0;u<h.length;++u){var a,l,i,d=h[u];if(d instanceof Array?(a=d[0].split("."),1<d.length&&(l=T(d[1])),2<d.length&&(i=T(d[2]))):a=d.split("."),l=l||e,i=i||t,4!==a.length)return void w.reject("Invalid streamID: "+d);d=a[0]+" "+a[1]+" "+(a[2]||"--")+" "+a[3];l&&(d+=" "+l,i&&(d+=" "+i)),n.push(d)}return n=n.join("\n"),r=n,q?(y&&(y.close(),y=null),j=!1,"ws://"!==(s=f||p).slice(0,5)&&"wss://"!==s.slice(0,6)&&(c=-1!==(o=(c=window.location.pathname).lastIndexOf("/"))?c.substr(0,o+1):"/",c+=s,s=window.location.host+c,s="https:"===window.location.protocol?"wss://"+s:"ws://"+s),s+="query/streams",(y=new WebSocket(s,"acqui-json")).onopen=function(){if("acqui-json"!==y.protocol)return console.log("Protocol mismatch"),m="Wrong server protocol",void y.close();m="Finished",y.send(r)},y.onerror=function(e){w.resolve("Disconnected"),y=null},y.onmessage=function(e){if(!j)try{var t=JSON.parse(e.data);0<t.request.records.length&&w.notify(t.request.records)}catch(e){m=e.toString(),y.close()}},y.onclose=function(e){y=null,j||1006===e.code&&(m="Disconnected"),w.resolve(m)}):v?D.get(p+"purge/streams/"+v+".json").then(function(e){C(r)}).catch(function(e){console.error("Failed to purge request: "+e.data+"("+e.status+")"),C(r)}):C(r),n}(),cancel:function(){t&&(s.cancel(t),t=null),q?y&&(m="Cancelled",j=!0,y.close()):v&&(j=!0,D.get(p+"purge/streams/"+v+".json").then(function(e){}).catch(function(e){console.error("Failed to purge request: "+e.data+"("+e.status+")")}).finally(function(){w.resolve("Cancelled")}))}}}}}]);
"use strict";!function(o){o.extend({noticeAdd:function(t){var e=o.extend({},{inEffect:{opacity:"show"},inEffectDuration:600,stayTime:3e3,title:"Notice",text:"",stay:!1,type:"notice"},t),i=o(".notice-wrap").length?o(".notice-wrap"):o("<div></div>").addClass("notice-wrap").appendTo("body"),t=o("<div></div>").addClass("notice-item-wrapper"),n=o("<div></div>").hide().addClass("notice-item "+e.type).appendTo(i).html('<p><span class="notice-title">'+e.title+"</span>"+e.text+"</p>").animate(e.inEffect,e.inEffectDuration).wrap(t);o("<div></div>").addClass("notice-item-close").prependTo(n).html("&times;").click(function(){o.noticeRemove(n)});e.stay||setTimeout(function(){o.noticeRemove(n)},e.stayTime)},noticeRemove:function(t){t.animate({opacity:"0"},600,function(){t.parent().animate({height:"0px"},300,function(){t.parent().remove()})})}})}(jQuery),angular.module("notice-service",[]).factory("gmNotice",function(){var o={stayTime:5e3};function n(t,e,i,n){i={text:e,stay:!1,title:t,stayTime:void 0!==n?n:o.stayTime,type:"notice-"+i,rawtype:i};$.noticeAdd(i)}return{error:function(t,e,i){n(t,e,"error",i)},warning:function(t,e,i){n(t,e,"warning",i)},info:function(t,e,i){n(t,e,"info",i)},success:function(t,e,i){n(t,e,"success",i)},defaults:function(t){o=t}}});
"use strict";angular.module("gm.filters",[]).filter("toArray",function(){return function(t){if(!(t instanceof Object))return t;var r,n=[];for(r in t)t.hasOwnProperty(r)&&n.push(t[r]);return n}}).filter("page",function(){return function(t,r,n){return t?t.slice(r*n,(r+1)*n):[]}}).filter("pages",function(){return function(t,r){return t?((t.length+r-1)/r).toFixed(0):0}}).filter("timeSpan",function(){var a={s:"few seconds",m:"minute",mm:"%d minutes",h:"hour",hh:"%d hours",d:"day",dd:"%d days",M:"month",MM:"%d months",y:"year",yy:"%d years"};return function(t){if(!t)return"";var r=Math.round(Math.abs(3600*t*1e3)/1e3),n=Math.round(r/60),e=Math.round(n/60),u=Math.round(e/24),t=Math.round(u/365),t=(r<45?["s",r]:1===n&&["m"])||n<45&&["mm",n]||1===e&&["h"]||e<22&&["hh",e]||1===u&&["d"]||u<=25&&["dd",u]||u<=45&&["M"]||u<345&&["MM",Math.round(u/30)]||1===t&&["y"]||["yy",t];return t[1]?a[t[0]].replace(/%d/i,t[1]):a[t[0]]}}).filter("ago",function(){var i={s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function t(t){if(!t)return"";var r=(new Date).getTime()-t,n=Math.round(Math.abs(r)/1e3),e=Math.round(n/60),u=Math.round(e/60),a=Math.round(u/24),t=Math.round(a/365),t=(n<45?["s",n]:1===e&&["m"])||e<45&&["mm",e]||1===u&&["h"]||u<22&&["hh",u]||1===a&&["d"]||a<=25&&["dd",a]||a<=45&&["M"]||a<345&&["MM",Math.round(a/30)]||1===t&&["y"]||["yy",t];return 0<=r?(t[1]?i[t[0]].replace(/%d/i,t[1]):i[t[0]])+" ago":"in "+(t[1]?i[t[0]].replace(/%d/i,t[1]):i[t[0]])}return t.$stateful=!0,t}).filter("lat",function(){return function(t){return Math.abs(t).toFixed(2)+"° "+(t<0?"S":"N")}}).filter("lon",function(){return function(t){return Math.abs(t).toFixed(2)+"° "+(t<0?"W":"E")}}).filter("mag",function(){return function(t){return"number"==typeof t?t.toFixed(1):"-.-"}}).filter("magdesc",function(){return function(t){return"number"==typeof t?"M"+t.toFixed(1):"all"}}).filter("characters",function(){return function(t,r,n){if(isNaN(r))return t;if(r<=0)return"";if(t&&t.length>=r){if(t=t.substring(0,r),n)for(;" "===t.charAt(t.length-1);)t=t.substr(0,t.length-1);else{n=t.lastIndexOf(" ");-1!==n&&(t=t.substr(0,n))}return t+"..."}return t}});
angular.module("gm-clock",[]).directive("clock",["$timeout",function(c){return{restrict:"E",replace:!1,template:"<span>{{hours}}:{{minutes}}</span>",link:function(n,e,r){function o(e,t){for(var n=e.toString();n.length<t;)n="0"+n;return n}function i(){if(r.hasOwnProperty("tz"))try{var e=parseInt(r.tz,10),t=new Date;t=new Date(t.getTime()+60*(t.getTimezoneOffset()+60*e)*1e3)}catch(e){return void console.error("invalid tz parameter")}else t=new Date;n.hours=o(t.getHours(),2),n.minutes=o(t.getMinutes(),2),n.seconds=o(t.getSeconds(),2),t=6e4*(Math.floor(t.getTime()/6e4)+1)-t.getTime(),a=c(i,t)}var a;i(),n.$on("destroy",function(){a&&c.cancel(a)})}}}]);
angular.module("ngContextMenu",[]).factory("ContextMenuService",function(){return{element:null,menuElement:null}}).directive("contextMenu",["$document","ContextMenuService",function(d,p){return{restrict:"A",scope:{callback:"&contextMenu",disabled:"&contextMenuDisabled",closeCallback:"&contextMenuClose"},link:function(n,e,t){var m=!1;function l(e){e.removeClass("open"),m&&n.closeCallback(),m=!1}function o(a){n.disabled()||(null!==p.menuElement&&l(p.menuElement),p.menuElement=angular.element(document.getElementById(t.target)),p.element=a.target,a.preventDefault(),a.stopPropagation(),n.$apply(function(){n.callback({$event:a})}),n.$apply(function(){var e,n,t,l,o,u,c,i;e=a,(n=p.menuElement)[0]&&(n.addClass("open"),l=d[0].documentElement,c=(window.pageXOffset||l.scrollLeft)-(l.clientLeft||0),i=(window.pageYOffset||l.scrollTop)-(l.clientTop||0),o=n[0].scrollWidth,u=n[0].scrollHeight,t=l.clientWidth+c,l=l.clientHeight+i,o=o+e.pageX,u=u+e.pageY,c=Math.max(e.pageX-c,0),i=Math.max(e.pageY-i,0),t<o&&(c-=o-t),l<u&&(i-=u-l),n.css("top",i+"px"),n.css("left",c+"px"),m=!0)}))}function u(e){m&&27===e.keyCode&&n.$apply(function(){l(p.menuElement)})}function c(e){m&&p.menuElement&&!function(e,n){for(;n;){if(n===e)return 1;n=n.parentNode}}(p.menuElement[0],e.target)&&n.$apply(function(){l(p.menuElement)})}function i(e){!m||2===e.button&&e.target===p.element||n.$apply(function(){l(p.menuElement)})}e.bind("contextmenu",o),d.bind("keyup",u),d.bind("mousedown",c),d.bind("click",i),d.bind("contextmenu",i),n.$on("$destroy",function(){m&&n.closeCallback(),d.unbind("keyup",u),d.unbind("mousedown",c),d.unbind("click",i),d.unbind("contextmenu",i),e.unbind("contextmenu",o)})}}}]);
!function(){"use strict";angular.module("ngDateTimePicker",[]);function e(e,t,n){var a=n("DatetimePickerCtrl");return{open:function(e){a.openDatetimePicker(e)},close:function(){a.closeDatetimePicker()}}}e.$inject=["$compile","$document","$controller"],angular.module("ngDateTimePicker").factory("DatetimePicker",e);function t(a,i){function o(e){e&&angular.element(e).remove(),i[0].body.removeEventListener("click",t.closeDatetimePicker),i[0].body.removeEventListener("keyup",t.closeByESCKey)}var l,t=this;this.openDatetimePicker=function(e){this.closeDatetimePicker();var t=angular.element("<div datetime-picker-popup ng-cloak></div>");e.dateFormat&&t.attr("date-format",e.dateFormat),e.ngModel&&t.attr("ng-model",e.ngModel),e.year&&t.attr("year",parseInt(e.year)),e.month&&t.attr("month",parseInt(e.month)),e.day&&t.attr("day",parseInt(e.day)),e.hour&&t.attr("hour",parseInt(e.hour)),e.minute&&t.attr("minute",parseInt(e.minute)),t.attr("ng-model",e.ngModel),""!==e.dateOnly&&!0!==e.dateOnly||t.attr("date-only","true"),"false"===e.closeOnSelect&&t.attr("close-on-select","false");var n=e.triggerEl;e.scope=e.scope||angular.element(n).scope(),(l=a(t)(e.scope)[0]).triggerEl=e.triggerEl,i[0].body.appendChild(l);n=n.getBoundingClientRect();e.scope.$apply();e=l.getBoundingClientRect();l.style.position="absolute",l.style.left=n.left+window.scrollX+"px",n.top<300||300<window.innerHeight-n.bottom?l.style.top=n.bottom+window.scrollY+"px":l.style.top=n.top-e.height+window.scrollY+"px",i[0].body.addEventListener("click",this.closeDatetimePicker),i[0].body.addEventListener("keyup",this.closeByESCKey)};var n=this;this.closeByESCKey=function(e){27==e.keyCode&&n.closeDatetimePicker()},this.closeDatetimePicker=function(e){var t=e&&e.target,n=i[0].querySelector("div[datetime-picker-popup]");e&&t&&(t.hasAttribute("datetime-picker")||n&&n.contains(t))||o(n)}}t.$inject=["$compile","$document"],angular.module("ngDateTimePicker").controller("DatetimePickerCtrl",t);function n(a,s){function u(e,t){11<t?e++:t<0&&e--,t=(t+12)%12;var n=new Date(e,t,1),a=new Date(e,t+1,0),i=new Date(e,t,0),o=a.getDate(),a=i.getDate(),i=(n.getDay()-p+7)%7||7,n=g.slice(0,42-(i+o));return{year:e,month:t,days:g.slice(0,o),leadingDays:g.slice(-i-(31-a),a),trailingDays:n}}var g,i,o,p;return{restrict:"A",template:l,controller:"DatetimePickerCtrl",replace:!0,scope:{ngModel:"=",year:"=",month:"=",day:"=",hour:"=",minute:"=",dateOnly:"=",closeOnSelect:"="},link:function(l,d,c,r){var n=c.dateFormat||"short";!function(){g=[],i=[],o=[];for(var e=p=1;e<=31;e++)g.push(e);for(e=0;e<12;e++)i.push({fullName:a.DATETIME_FORMATS.MONTH[e],shortName:a.DATETIME_FORMATS.SHORTMONTH[e]});for(e=0;e<7;++e){var t=a.DATETIME_FORMATS.DAY[(e+p)%7];o.push({fullName:t,firstLetter:t.substr(0,1)})}}(),l.months=i,l.daysOfWeek=o,l.inputHour,l.inputMinute,l.inputSecond,l.$watch("ngModel",function(e){var e=e.toString();e&&(e.match(/[0-9]{2}:/)||(e+=" 00:00:00"),e=(e=(e=(e=(e=e.replace(/([0-9]{2}-[0-9]{2})-([0-9]{4})/,"$2-$1")).replace(/([\/-][0-9]{2,4})\ ([0-9]{2}\:[0-9]{2}\:)/,"$1T$2")).replace(/EDT|EST|CDT|CST|MDT|PDT|PST|UT|GMT/g,"")).replace(/\s*\(\)\s*/,"")).replace(/[\-\+][0-9]{2}:?[0-9]{2}$/,""),e+=".000Z",e=new Date(e),isNaN(e.getTime())||(l.selectedDate=new Date(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()),l.inputHour=l.selectedDate.getHours(),l.inputMinute=l.selectedDate.getMinutes(),l.inputSecond=l.selectedDate.getSeconds(),l.mv=u(l.selectedDate.getFullYear(),l.selectedDate.getMonth()),l.today=s(new Date,"yyyy-M-d"),l.mv.year==l.selectedDate.getFullYear()&&l.mv.month==l.selectedDate.getMonth()?l.selectedDay=l.selectedDate.getDate():l.selectedDay=null))}),l.$applyAsync(function(){var e,t,n,a,i,o;r.triggerEl=angular.element(d[0].triggerEl),!c.ngModel||(a=""+r.triggerEl.scope().$eval(c.ngModel))&&(a.match(/[0-9]{2}:/)||(a+=" 00:00:00"),a=(a=(a=(a=(a=a.replace(/([0-9]{2}-[0-9]{2})-([0-9]{4})/,"$2-$1")).replace(/([\/-][0-9]{2,4})\ ([0-9]{2}\:[0-9]{2}\:)/,"$1T$2")).replace(/EDT|EST|CDT|CST|MDT|PDT|PST|UT|GMT/g,"")).replace(/\s*\(\)\s*/,"")).replace(/[\-\+][0-9]{2}:?[0-9]{2}$/,""),a+=".000Z",i=new Date(a),l.selectedDate=new Date(i.getUTCFullYear(),i.getUTCMonth(),i.getUTCDate(),i.getUTCHours(),i.getUTCMinutes(),i.getUTCSeconds())),l.selectedDate&&!isNaN(l.selectedDate.getTime())||(o=new Date,e=l.year||o.getFullYear(),t=l.month?l.month-1:o.getMonth(),n=l.day||o.getDate(),a=l.hour||o.getHours(),i=l.minute||o.getMinutes(),o=l.second||o.getSeconds(),l.selectedDate=new Date(e,t,n,a,i,o)),l.inputHour=l.selectedDate.getHours(),l.inputMinute=l.selectedDate.getMinutes(),l.inputSecond=l.selectedDate.getSeconds(),l.mv=u(l.selectedDate.getFullYear(),l.selectedDate.getMonth()),l.today=s(new Date,"yyyy-M-d"),l.mv.year==l.selectedDate.getFullYear()&&l.mv.month==l.selectedDate.getMonth()?l.selectedDay=l.selectedDate.getDate():l.selectedDay=null}),l.addMonth=function(e){l.mv=u(l.mv.year,l.mv.month+e)},l.addHour=function(e){l.inputHour+=e,23<l.inputHour?l.inputHour=23:l.inputHour<0&&(l.inputHour=0),l.updateNgModel()},l.addMinute=function(e){l.inputMinute+=e,59<l.inputMinute?l.inputMinute=59:l.inputMinute<0&&(l.inputMinute=0),l.updateNgModel()},l.addSecond=function(e){l.inputSecond+=e,59<l.inputSecond?l.inputSecond=59:l.inputSecond<0&&(l.inputSecond=0),l.updateNgModel()},l.nowTime=function(){var e=new Date;l.inputHour=e.getUTCHours(),l.inputMinute=e.getUTCMinutes(),l.inputSecond=e.getUTCSeconds(),l.updateNgModel()},l.resetTime=function(){l.inputHour=0,l.inputMinute=0,l.inputSecond=0,l.updateNgModel()},l.setDate=function(e){e=angular.element(e.target)[0];-1!==e.className.indexOf("selectable")&&(l.updateNgModel(parseInt(e.innerHTML)),!1!==l.closeOnSelect&&r.closeDatetimePicker())},l.updateNgModel=function(e){var t;e=e||l.selectedDate.getDate(),l.selectedDate=new Date(l.mv.year,l.mv.month,e,l.inputHour,l.inputMinute,l.inputSecond),l.selectedDay=l.selectedDate.getDate(),c.ngModel&&(e=(t=r.triggerEl.scope()).$eval(c.ngModel)&&"Date"===t.$eval(c.ngModel).constructor.name?new Date(s(l.selectedDate,n)):s(l.selectedDate,n),t.$eval(c.ngModel+"= date",{date:e}))},l.$on("$destroy",r.closeDatetimePicker)}}}var l=['<div class="adp widget">','  <div class="adp-month header">','    <div class="content">','      <button type="button" class="adp-prev" ng-click="addMonth(-1)"><i class="glyphicon glyphicon-chevron-left"></i></button>','      <span title="{{months[mv.month].fullName}}">{{months[mv.month].shortName}}</span> {{mv.year}}','      <button type="button" class="adp-next" ng-click="addMonth(1)"><i class="glyphicon glyphicon-chevron-right"></i></button>',"    </div>","  </div>",'  <div class="segment">','    <div class="content" ng-click="setDate($event)">','      <div class="adp-day-of-week" ng-repeat="dayOfWeek in ::daysOfWeek" title="{{::dayOfWeek.fullName}}">{{::dayOfWeek.firstLetter}}</div>','      <div class="adp-day" ng-repeat="day in mv.leadingDays">{{::day}}</div>','      <div class="adp-day selectable" ng-repeat="day in mv.days" ',"        today=\"{{today}}\" d2=\"{{mv.year + '-' + (mv.month + 1) + '-' + day}}\"",'        ng-class="{',"          selected: (day == selectedDay),","          today: (today == (mv.year + '-' + (mv.month + 1) + '-' + day)),","          weekend: (mv.leadingDays.length + day)%7 == 1 || (mv.leadingDays.length + day)%7 == 0",'        }">',"        {{::day}}","      </div>",'      <div class="adp-day" ng-repeat="day in mv.trailingDays">{{::day}}</div>',"    </div>","  </div>",'  <div class="segment" ng-hide="dateOnly">','    <div class="content">','      <table cellspacing="0" cellpadding="0" border="0">',"        <tr>","          <td></td>",'          <td><button type="button" ng-click="addHour(1)"><i class="glyphicon glyphicon-chevron-up"></i></button></td>',"          <td></td>",'          <td><button type="button" ng-click="addMinute(1)"><i class="glyphicon glyphicon-chevron-up"></i></button></td>',"          <td></td>",'          <td><button type="button" ng-click="addSecond(1)"><i class="glyphicon glyphicon-chevron-up"></i></button></td>',"          <td></td>","        </tr>","        <tr>",'          <td><button title="Set time to now" ng-click="nowTime()"><i class="glyphicon glyphicon-time"></button></td>','          <td><span class="timeValue">{{("0"+inputHour).slice(-2)}}</span></td>',"          <td>:</td>",'          <td><span class="timeValue">{{("0"+inputMinute).slice(-2)}}</span></td>',"          <td>:</td>",'          <td><span class="timeValue">{{("0"+inputSecond).slice(-2)}}</span></td>','          <td><button title="Set time to midnight" ng-click="resetTime()"><i class="glyphicon glyphicon-remove"></button></td>',"        </tr>","        <tr>","          <td></td>",'          <td><button type="button" ng-click="addHour(-1)"><i class="glyphicon glyphicon-chevron-down"></i></button></td>',"          <td></td>",'          <td><button type="button" ng-click="addMinute(-1)"><i class="glyphicon glyphicon-chevron-down"></i></button></td>',"          <td></td>",'          <td><button type="button" ng-click="addSecond(-1)"><i class="glyphicon glyphicon-chevron-down"></i></button></td>',"          <td></td>","        </tr>","      </table>","    </div>","  </div>","</div>"].join("\n");n.$inject=["$locale","dateFilter"],angular.module("ngDateTimePicker").directive("datetimePickerPopup",n);function a(e,i){return{require:"ngModel",link:function(e,t,n,a){e.$watch(n.ngModel,function(e){var t;e&&""!=e&&(t=new Date(e),a.$setValidity("date",!!t),e=new Date,n.hasOwnProperty("futureOnly")&&a.$setValidity("future-only",!(t<e)))}),t[0].addEventListener("click",function(){i.open({triggerEl:t[0],dateFormat:n.dateFormat,ngModel:n.ngModel,year:n.year,month:n.month,day:n.day,hour:n.hour,minute:n.minute,dateOnly:n.dateOnly,futureOnly:n.futureOnly,closeOnSelect:n.closeOnSelect})})}}}a.$inject=["$parse","DatetimePicker"],angular.module("ngDateTimePicker").directive("datetimePicker",a)}();
Date.ext={},Date.ext.util={},Date.ext.util.xPad=function(e,t,a){for(void 0===a&&(a=10);parseInt(e,10)<a&&1<a;a/=10)e=t.toString()+e;return e.toString()},Date.prototype.locale="en-GB",document.getElementsByTagName("html")&&document.getElementsByTagName("html")[0].lang&&(Date.prototype.locale=document.getElementsByTagName("html")[0].lang),Date.ext.locales={},Date.ext.locales.en={a:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],A:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],b:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],B:["January","February","March","April","May","June","July","August","September","October","November","December"],c:"%a %d %b %Y %T %Z",p:["AM","PM"],P:["am","pm"],x:"%d/%m/%y",X:"%T"},Date.ext.locales["en-US"]=Date.ext.locales.en,Date.ext.locales["en-US"].c="%a %d %b %Y %r %Z",Date.ext.locales["en-US"].x="%D",Date.ext.locales["en-US"].X="%r",Date.ext.locales["en-GB"]=Date.ext.locales.en,Date.ext.locales["en-AU"]=Date.ext.locales["en-GB"],Date.ext.formats={1:function(e){return Math.round(.01*e.getMilliseconds())},2:function(e){return Date.ext.util.xPad(Math.round(.1*e.getMilliseconds()),0,10)},3:function(e){return Date.ext.util.xPad(Math.round(e.getMilliseconds()),0,100)},a:function(e){return Date.ext.locales[e.locale].a[e.getDay()]},A:function(e){return Date.ext.locales[e.locale].A[e.getDay()]},b:function(e){return Date.ext.locales[e.locale].b[e.getMonth()]},B:function(e){return Date.ext.locales[e.locale].B[e.getMonth()]},c:"toLocaleString",C:function(e){return Date.ext.util.xPad(parseInt(e.getFullYear()/100,10),0)},d:["getDate","0"],e:["getDate"," "],g:function(e){return Date.ext.util.xPad(parseInt(Date.ext.util.G(e)/100,10),0)},G:function(e){var t=e.getFullYear(),a=parseInt(Date.ext.formats.V(e),10),e=parseInt(Date.ext.formats.W(e),10);return a<e?t++:0===e&&52<=a&&t--,t},H:["getHours","0"],I:function(e){e=e.getHours()%12;return Date.ext.util.xPad(0==e?12:e,0)},j:function(e){var t=e-new Date(e.getFullYear()+"/1/1 GMT");t+=6e4*e.getTimezoneOffset();t=parseInt(t/6e4/60/24,10)+1;return Date.ext.util.xPad(t,0,100)},m:function(e){return Date.ext.util.xPad(e.getMonth()+1,0)},M:["getMinutes","0"],p:function(e){return Date.ext.locales[e.locale].p[12<=e.getHours()?1:0]},P:function(e){return Date.ext.locales[e.locale].P[12<=e.getHours()?1:0]},S:["getSeconds","0"],u:function(e){e=e.getDay();return 0===e?7:e},U:function(e){var t=parseInt(Date.ext.formats.j(e),10),e=6-e.getDay(),e=parseInt((t+e)/7,10);return Date.ext.util.xPad(e,0)},V:function(e){var t=parseInt(Date.ext.formats.W(e),10),a=new Date(e.getFullYear()+"/1/1").getDay(),a=t+(4<a||a<=1?0:1);return 53==a&&new Date(e.getFullYear()+"/12/31").getDay()<4?a=1:0===a&&(a=Date.ext.formats.V(new Date(e.getFullYear()-1+"/12/31"))),Date.ext.util.xPad(a,0)},w:"getDay",W:function(e){var t=parseInt(Date.ext.formats.j(e),10),e=7-Date.ext.formats.u(e),e=parseInt((t+e)/7,10);return Date.ext.util.xPad(e,0,10)},y:function(e){return Date.ext.util.xPad(e.getFullYear()%100,0)},Y:"getFullYear",z:function(e){e=e.getTimezoneOffset();return(0<e?"-":"+")+Date.ext.util.xPad(parseInt(Math.abs(e/60),10),0)+Date.ext.util.xPad(e%60,0)},Z:function(e){return e.toString().replace(/^.*\(([^)]+)\)$/,"$1")},"%":function(e){return"%"}},Date.ext.aggregates={c:"locale",D:"%m/%d/%y",h:"%b",n:"\n",r:"%I:%M:%S %p",R:"%H:%M",t:"\t",T:"%H:%M:%S",x:"locale",X:"locale"},Date.ext.aggregates.z=Date.ext.formats.z(new Date),Date.ext.aggregates.Z=Date.ext.formats.Z(new Date),Date.ext.unsupported={},Date.prototype.strftime=function(e,t){if(t)return new Date(this.getTime()+60*this.getTimezoneOffset()*1e3).strftime(e);this.locale in Date.ext.locales||(this.locale.replace(/-[a-zA-Z]+$/,"")in Date.ext.locales?this.locale=this.locale.replace(/-[a-zA-Z]+$/,""):this.locale="en-GB");for(var n=this;e.match(/%[cDhnrRtTxXzZ]/);)e=e.replace(/%([cDhnrRtTxXzZ])/g,function(e,t){var a=Date.ext.aggregates[t];return"locale"==a?Date.ext.locales[n.locale][t]:a});t=e.replace(/%([123aAbBCdegGHIjmMpPSuUVwWyY%])/g,function(e,t){var a=Date.ext.formats[t];return"string"==typeof a?n[a]():"function"==typeof a?a.call(n,n):"object"==typeof a&&"string"==typeof a[0]?Date.ext.util.xPad(n[a[0]](),a[1]):t}),n=null;return t};
!function(){var n=document.attachEvent,o=!1;var i,t,e=(i=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(e){return window.setTimeout(e,20)},function(e){return i(e)}),r=(t=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.clearTimeout,function(e){return t(e)});function a(e){var i=e.__resizeTriggers__,t=i.firstElementChild,e=i.lastElementChild,i=t.firstElementChild;e.scrollLeft=e.scrollWidth,e.scrollTop=e.scrollHeight,i.style.width=t.offsetWidth+1+"px",i.style.height=t.offsetHeight+1+"px",t.scrollLeft=t.scrollWidth,t.scrollTop=t.scrollHeight}function _(i){var t=this;a(this),this.__resizeRAF__&&r(this.__resizeRAF__),this.__resizeRAF__=e(function(){var e;(e=t).offsetWidth==e.__resizeLast__.width&&e.offsetHeight==e.__resizeLast__.height||(t.__resizeLast__.width=t.offsetWidth,t.__resizeLast__.height=t.offsetHeight,t.__resizeListeners__.forEach(function(e){e.call(t,i)}))})}if(!n){var s=!1,d="",l="animationstart",c="Webkit Moz O ms".split(" "),m="webkitAnimationStart animationstart oAnimationStart MSAnimationStart".split(" "),g="",h=document.createElement("fakeelement");if(!1===(s=void 0!==h.style.animationName?!0:s))for(var f=0;f<c.length;f++)if(void 0!==h.style[c[f]+"AnimationName"]){g=c[f],d="-"+g.toLowerCase()+"-",l=m[f],s=!0;break}var z="resizeanim",v="@"+d+"keyframes "+z+" { from { opacity: 0; } to { opacity: 0; } } ",u=d+"animation: 1ms "+z+"; "}window.addResizeListener=function(i,e){var t,r,s;n?i.attachEvent("onresize",e):(i.__resizeTriggers__||("static"==getComputedStyle(i).position&&(i.style.position="relative"),o||(t=(v||"")+".resize-triggers { "+(u||"")+'visibility: hidden; opacity: 0; } .resize-triggers, .resize-triggers > div, .contract-trigger:before { content: " "; display: block; position: absolute; top: 0; left: 0; height: 100%; width: 100%; overflow: hidden; } .resize-triggers > div { background: #eee; overflow: auto; } .contract-trigger:before { width: 200%; height: 200%; }',r=document.head||document.getElementsByTagName("head")[0],(s=document.createElement("style")).type="text/css",s.styleSheet?s.styleSheet.cssText=t:s.appendChild(document.createTextNode(t)),r.appendChild(s),o=!0),i.__resizeLast__={},i.__resizeListeners__=[],(i.__resizeTriggers__=document.createElement("div")).className="resize-triggers",i.__resizeTriggers__.innerHTML='<div class="expand-trigger"><div></div></div><div class="contract-trigger"></div>',i.appendChild(i.__resizeTriggers__),a(i),i.addEventListener("scroll",_,!0),l&&i.__resizeTriggers__.addEventListener(l,function(e){e.animationName==z&&a(i)})),i.__resizeListeners__.push(e))},window.removeResizeListener=function(e,i){n?e.detachEvent("onresize",i):(e.__resizeListeners__.splice(e.__resizeListeners__.indexOf(i),1),e.__resizeListeners__.length||(e.removeEventListener("scroll",_),e.__resizeTriggers__=!e.removeChild(e.__resizeTriggers__)))}}();
"use strict";var G={};
"use strict";G.Geo={delandaz2coord:function(a,t,h,M){h*=G.Geo.PI180,M*=G.Geo.PI180,t*=G.Geo.PI180,a*=G.Geo.PI180;var o=Math.asin(Math.sin(h)*Math.cos(a)+Math.cos(h)*Math.sin(a)*Math.cos(t)),h=M+Math.atan2(Math.sin(t)*Math.sin(a)*Math.cos(h),Math.cos(a)-Math.sin(h)*Math.sin(o));return[o*G.Geo.iPI180,h*G.Geo.iPI180]},delazi:function(a,t,h,M){var o,s,e,i,n,I,P,c,r,u;return a===h&&t===M?o=s=e=0:(a*=G.Geo.PI180,t*=G.Geo.PI180,h*=G.Geo.PI180,M*=G.Geo.PI180,P=.5*Math.PI-h,u=.5*Math.PI-a,i=t-M,n=Math.cos(P),I=Math.cos(u),c=Math.sin(P),P=n*I+(r=Math.sin(u))*c*Math.cos(i),o=Math.acos(P),u=Math.sin(o),s=Math.acos((n-I*P)/(r*u)),e=Math.acos((I-n*P)/(c*u)),(isNaN(s)||isNaN(e))&&Math.abs(M-t)<1e-6?e=h<a?(s=Math.PI,0):(s=0,Math.PI):Math.sin(i)<0?e=Math.PI+Math.PI-e:s=Math.PI+Math.PI-s),{dist:o*G.Geo.iPI180,az:s*G.Geo.iPI180,baz:e*G.Geo.iPI180}},deg2km:function(a){return 111.13291490135191*a},km2deg:function(a){return.00899823423949294*a}},G.Geo.PI180=Math.PI/180,G.Geo.iPI180=180/Math.PI;
"use strict";!function(){G.Filter={_factory:{},create:function(t){return G.Filter._factory.hasOwnProperty(t)?new G.Filter._factory[t]:null}};var q=0;function x(t,e){this.real=t,this.img=e}function t(t){return.5*(Math.pow(Math.E,t)-Math.pow(Math.E,-t))}function e(t){return.5*(Math.pow(Math.E,t)+Math.pow(Math.E,-t))}function u(t,e,i){var r,s,n,h,o,a,l,u=e*e;return t===Math.PI?(a=i===q?-(r=e/(1+e)):r=1/(1+e),h=((n=1)-e)/(1+e),o=l=0):(h=2*(t=(n=1)/(1+u-2*(s=Math.cos(t))*e))*(1-u),o=t*(1+u+2*s*e),a=i===q?-2*(r=t*u):2*(r=t),l=r),new G.Filter.Biquad(r,a,l,n,h,o)}function E(t,e,i,r){for(var s=[],n=t%2,h=Math.PI/t,o=.5*(h+Math.PI),a=1/Math.tan(Math.PI*e/i),l=0;l<t/2;++l)s.push(u(o+l*h,a,r));return n&&s.push(u(Math.PI,a,r)),s}function i(t,e,i,r,s){var n,h=[];if(2===s)for(var o=Math.PI/(2*t),a=2*Math.PI*e,l=2*Math.PI*i,u=l-a,p=a*l*4/(u*u),f=t%2?0:1;f<t;f+=2)if(!f&&p<1){var c,m,g,w=(g=1/(m=[new x(.5*u*(1-(c=Math.sqrt(1-p))),0),new x(.5*u*(1+c),0)])[0].mult(.5,0).div(r,0).tan())/(1+g),F=-w,d=(1-g)/(1+g),y=1/(1+(g=1/m[1].mult(.5,0).div(r,0).tan())),v=(1-g)/(1+g),A=w*y,P=F*y+w*(a=y),_=F*a,B=1,T=d+v,L=d*v;h.push(new G.Filter.Biquad(A/B,P/B,_/B,1,T/B,L/B))}else{v=Math.PI-f*o,v=new x(Math.cos(v),Math.sin(v));c=v.mult(v).sub(p,0).sqrt(),m=[v.sub(c).mult(.5*u,0),v.add(c).mult(.5*u,0)];for(var C=0;C<2;++C){var M=m[C].abs(),b=M*(g=1/Math.tan(.5*M/r)),S=M*M,M=m[C].real;if(P=0,_=-(A=u*b),B=S+b*b-2*M*b,T=2*(S-b*b),L=S+b*b+2*M*b,h.push(new G.Filter.Biquad(A/B,P/B,_/B,1,T/B,L/B)),!f)break}}else if(3===s){for(T=E(t,e,r,q),L=E(t,i,r,1),n=T.length,f=0;f<n;++f)h.push(T[f]);for(n=L.length,f=0;f<n;++f)h.push(L[f])}return h}G.Filter.Biquad=function(t,e,i,r,s,n){this.v1=0,this.v2=0,this.a0=t,this.a1=e,this.a2=i,this.b0=r,this.b1=s,this.b2=n},G.Filter.Biquad.prototype={apply:function(t){for(var e=t.length,i=0;i<e;++i){var r=t[i]-this.b1*this.v1-this.b2*this.v2;t[i]=this.a0*r+this.a1*this.v1+this.a2*this.v2,this.v2=this.v1,this.v1=r}},reset:function(){this.v1=0,this.v2=0}},x.prototype={real:0,img:0,add:function(){return 1==arguments.length?new x(this.real+arguments[0].real,this.img+arguments[0].img):new x(this.real+arguments[0],this.img+arguments[1])},sub:function(){return 1==arguments.length?new x(this.real-arguments[0].real,this.img-arguments[0].img):new x(this.real-arguments[0],this.img-arguments[1])},mult:function(){var t=arguments[0];return 1!=arguments.length&&(t=new x(arguments[0],arguments[1])),new x(this.real*t.real-this.img*t.img,this.real*t.img+this.img*t.real)},div:function(){var t=arguments[0],e=1/((t=1!=arguments.length?new x(arguments[0],arguments[1]):t).real*t.real+t.img*t.img);return new x((this.real*t.real+this.img*t.img)*e,(this.img*t.real-this.real*t.img)*e)},abs:function(){return Math.sqrt(this.real*this.real+this.img*this.img)},cos:function(){return new x(Math.cos(this.real)*e(this.img),-(Math.sin(this.real)*t(this.img)))},sin:function(){return new x(Math.sin(this.real)*e(this.img),Math.cos(this.real)*t(this.img))},tan:function(){return this.sin()/this.cos()},sqrt:function(){var t=this.real,e=this.img;if(0===t)return new x(i=Math.sqrt(Math.abs(e)/2),e<0?-i:i);var i,r=(i=Math.sqrt(2*(this.abs()+Math.abs(t))))/2;return 0<t?new x(r,e/i):new x(Math.abs(e)/i,e<0?-r:r)}},G.Filter.Butterworth={},G.Filter.Butterworth.Base=function(t){this.order=t,this.fsamp=0,this.biquads=[]},G.Filter.Butterworth.Base.prototype={reset:function(){for(var t=this.biquads.length,e=0;e<t;++e)this.biquads[e].reset()},apply:function(t){for(var e=this.biquads.length,i=0;i<e;++i)this.biquads[i].apply(t)}},G.Filter.Butterworth.LowPass=function(t,e){this.base=G.Filter.Butterworth.Base,this.base(t),delete this.base,this.order=t,this.fc=e},G.Filter.Butterworth.LowPass.prototype=new G.Filter.Butterworth.Base,G.Filter.Butterworth.LowPass.prototype.setSamplingFrequency=function(t){this.fsamp!==t&&(this.fsamp=t,this.biquads=E(this.order,this.fc,this.fsamp,1))},G.Filter.Butterworth.LowPass.prototype.setParams=function(t){if(2!==t.length)return 2;var e=t[0];return e<=0?-1:(this.order=e,this.fc=t[1],0)},G.Filter.Butterworth.LowPass.prototype.clone=function(){return new G.Filter.Butterworth.LowPass(this.order,this.fc)},G.Filter._factory.BW_LP=G.Filter.Butterworth.LowPass,G.Filter.Butterworth.HighPass=function(t,e){this.base=G.Filter.Butterworth.Base,this.base(t),delete this.base,this.order=t,this.fc=e},G.Filter.Butterworth.HighPass.prototype=new G.Filter.Butterworth.Base,G.Filter.Butterworth.HighPass.prototype.setSamplingFrequency=function(t){this.fsamp!==t&&(this.fsamp=t,this.biquads=E(this.order,this.fc,this.fsamp,q))},G.Filter.Butterworth.HighPass.prototype.setParams=function(t){if(2!==t.length)return 2;var e=t[0];return e<=0?-1:(this.order=e,this.fc=t[1],0)},G.Filter.Butterworth.HighPass.prototype.clone=function(){return new G.Filter.Butterworth.HighPass(this.order,this.fc)},G.Filter._factory.BW_HP=G.Filter.Butterworth.HighPass,G.Filter.Butterworth.HighLowPass=function(t,e,i){this.base=G.Filter.Butterworth.Base,this.base(t),delete this.base,this.fmin=e,this.fmax=i},G.Filter.Butterworth.HighLowPass.prototype=new G.Filter.Butterworth.Base,G.Filter.Butterworth.HighLowPass.prototype.setSamplingFrequency=function(t){this.fsamp!==t&&(this.fsamp=t,this.biquads=i(this.order,this.fmin,this.fmax,this.fsamp,3))},G.Filter.Butterworth.HighLowPass.prototype.setParams=function(t){if(3!==t.length)return 3;var e=t[0];return e<=0?-1:(this.order=e,this.fmin=t[1],this.fmax=t[2],0)},G.Filter.Butterworth.HighLowPass.prototype.clone=function(){return new G.Filter.Butterworth.HighLowPass(this.order,this.fmin,this.fmax)},G.Filter._factory.BW_HLP=G.Filter.Butterworth.HighLowPass,G.Filter._factory.BW=G.Filter._factory.BW_HLP,G.Filter.Butterworth.BandPass=function(t,e,i){this.base=G.Filter.Butterworth.Base,this.base(t),delete this.base,this.fmin=e,this.fmax=i},G.Filter.Butterworth.BandPass.prototype=new G.Filter.Butterworth.Base,G.Filter.Butterworth.BandPass.prototype.setSamplingFrequency=function(t){this.fsamp!==t&&(this.fsamp=t,this.biquads=i(this.order,this.fmin,this.fmax,this.fsamp,2))},G.Filter.Butterworth.BandPass.prototype.setParams=function(t){if(3!==t.length)return 3;var e=t[0];return e<=0?-1:(this.order=e,this.fmin=t[1],this.fmax=t[2],0)},G.Filter.Butterworth.BandPass.prototype.clone=function(){return new G.Filter.Butterworth.BandPass(this.order,this.fmin,this.fmax)},G.Filter._factory.BW_BP=G.Filter.Butterworth.BandPass,G.Filter.RMHP=function(){this.average=0,this.sampleCount=0,this.windowLength=0<arguments.length?arguments[0]:0},G.Filter.RMHP.prototype.setSamplingFrequency=function(t){this.windowLengthI=Math.floor(this.windowLength*t)},G.Filter.RMHP.prototype.setParams=function(t){return 1!==t.length?1:(this.windowLength=t[0],0)},G.Filter.RMHP.prototype.reset=function(){this.average=0,this.sampleCount=0},G.Filter.RMHP.prototype.apply=function(t){if(this.sampleCount<this.windowLengthI)for(var e=this.windowLengthI-this.sampleCount,i=e>t.length?t.length:e,r=0;r<i;++r)this.average=(this.average*this.sampleCount+t[r])/(this.sampleCount+1),t[r]-=this.average,++this.sampleCount;else r=0;for(var s=t.length;r<s;++r)this.average=(this.average*(this.windowLengthI-1)+t[r])/this.windowLengthI,t[r]-=this.average},G.Filter.RMHP.prototype.clone=function(){return new G.Filter.RMHP(this.windowLength)},G.Filter._factory.RMHP=G.Filter.RMHP,G.Filter.ITAPER=function(){this.sampleCount=0,this.windowLength=0<arguments.length?arguments[0]:0,this.offset=1<arguments.length?arguments[1]:0},G.Filter.ITAPER.prototype.setSamplingFrequency=function(t){this.windowLengthI=Math.floor(this.windowLength*t)},G.Filter.ITAPER.prototype.setParams=function(t){return t.length<1||2<t.length?1:(this.windowLength=t[0],1<t.length?this.offset=t[1]:this.offset=0,0)},G.Filter.ITAPER.prototype.reset=function(){this.sampleCount=0},G.Filter.ITAPER.prototype.apply=function(t){if(this.sampleCount<this.windowLengthI)for(var e=this.windowLengthI-this.sampleCount,i=e>t.length?t.length:e,r=0;r<i;++r){var s=this.sampleCount/this.windowLengthI;t[r]=.5*(t[r]-this.offset)*(1-Math.cos(Math.PI*s))+this.offset,++this.sampleCount}},G.Filter.ITAPER.prototype.clone=function(){return new G.Filter.ITAPER(this.windowLength,this.offset)},G.Filter._factory.ITAPER=G.Filter.ITAPER,G.Filter.Envelope=function(){this.fsamp=0,this.buffer=[],this.timeSpan=0<arguments.length?arguments[0]:1},G.Filter.Envelope.prototype.reset=function(){this.buffer=[];for(var t=this.buffer[this.sampleCount-1]=0;t<this.sampleCount;++t)this.buffer[t]=0},G.Filter.Envelope.prototype.setSamplingFrequency=function(t){t!==this.fsamp&&(this.fsamp=t,this.sampleCount=Math.floor(this.fsamp*this.timeSpan),this.sampleCount<1&&(this.sampleCount=1),this.sum=0,this.index=0,this.oocount=2/this.sampleCount,this.reset())},G.Filter.Envelope.prototype.apply=function(t){if(0===this.fsamp)throw"Envelope sample rate not initialized";for(var e=t.length,i=0;i<e;++i){var r=t[i]*t[i],s=this.buffer[this.index];this.buffer[this.index]=r,++this.index,this.index>=this.sampleCount&&(this.index=0),this.sum=this.sum+r-s,t[i]=Math.sqrt(this.sum*this.oocount)}},G.Filter.Envelope.prototype.setParams=function(t){return 1!==t.length?1:(this.timeSpan=t[0],0)},G.Filter.Envelope.prototype.clone=function(){return new G.Filter.Envelope(this.timeSpan)},G.Filter._factory.ENV=G.Filter.Envelope,G.Filter.STALTA=function(){this._lenSTA=2,this._lenLTA=50,this._fsamp=1,this._numSTA=0,this._numLTA=0,this._sampleCount=0,this._STA=0,(this._LTA=0)<arguments.length&&(this._lenSTA=null!=arguments[0]?arguments[0]:2),1<arguments.length&&(this._lenLTA=null!=arguments[1]?arguments[1]:50),2<arguments.length&&(this._fsamp=null!=arguments[2]?arguments[2]:1),this.setSamplingFrequency(this._fsamp)},G.Filter.STALTA.prototype.reset=function(){this._sampleCount=0,this._STA=this._LTA=0},G.Filter.STALTA.prototype.setSamplingFrequency=function(t){if(t!==this.fsamp){if(t<=0)throw"Sampling frequency must be positive";this._fsamp=t,this._numSTA=Math.floor(this._lenSTA*t+.5),this._numLTA=Math.floor(this._lenLTA*t+.5),this.reset()}},G.Filter.STALTA.prototype.apply=function(t){if(0===this.fsamp)throw"STALTA sample rate not initialized";for(var e=1/this._numLTA,i=1/this._numSTA,r=t.length,s=0;s<r;++s){var n=Math.abs(t[s]),h=!0;this._sampleCount<this._numSTA?(i=1/(this._sampleCount+1),this._STA=(this._STA*this._sampleCount+n)*i,h=!1):this._STA+=(n-this._STA)*i,this._sampleCount<this._numLTA?(e=1/(this._sampleCount+1),this._LTA=(this._LTA*this._sampleCount+n)*e,h=!1):this._LTA+=(this._STA-this._LTA)*e,h||++this._sampleCount,this._LTA<Number.EPSILON?t[s]=1e6*this._STA:t[s]=this._sampleCount<this._numSTA?1:this._STA/this._LTA}},G.Filter.STALTA.prototype.setParams=function(t){return 2!==t.length?2:(this._lenSTA=t[0],this._lenSTA<=0?-1:(this._lenLTA=t[1],this._lenLTA<=0?-2:0))},G.Filter.STALTA.prototype.clone=function(){return new G.Filter.STALTA(this.timeSpan)},G.Filter._factory.STALTA=G.Filter.STALTA,G.Filter.Chain=function(){this.filters=[];for(var t=0;t<arguments.length;++t)this.filters.push(arguments[t])},G.Filter.Chain.prototype.add=function(t){this.filters.push(t)},G.Filter.Chain.prototype.reset=function(){for(var t=this.filters.length,e=0;e<t;++e)this.filters[e].reset()},G.Filter.Chain.prototype.setSamplingFrequency=function(t){for(var e=this.filters.length,i=0;i<e;++i)this.filters[i].setSamplingFrequency(t)},G.Filter.Chain.prototype.apply=function(t){for(var e=this.filters.length,i=0;i<e;++i)this.filters[i].apply(t)},G.Filter.Chain.prototype.clone=function(){for(var t=new G.Filter.Chain,e=this.filters.length,i=0;i<e;++i)t.add(this.filters[i].clone());return t},G.Filter.Parser=function(){function $(t,e,i,r,s,n){this.message=t,this.expected=e,this.found=i,this.offset=r,this.line=s,this.column=n,this.name="SyntaxError"}function t(){this.constructor=e}var e,i;return e=$,i=Error,t.prototype=i.prototype,e.prototype=new t,{SyntaxError:$,parse:function(n){function s(t,e){return parseFloat(t+"."+e)}var t=1<arguments.length?arguments[1]:{},h={},e={start:V},i=V,o=h,a="(",l={type:"literal",value:"(",description:'"("'},u=")",p={type:"literal",value:")",description:'")"'},f=/^[a-z]/i,c={type:"class",value:"[a-z]i",description:"[a-z]i"},m=/^[a-z0-9_\-]/i,g={type:"class",value:"[a-z0-9_\\-]i",description:"[a-z0-9_\\-]i"},w=function(t,e){return t+e.join("")},r={type:"other",description:"positive"},F=/^[0-9]/,d={type:"class",value:"[0-9]",description:"[0-9]"},y={type:"other",description:"negative"},v={type:"literal",value:"-",description:'"-"'},A={type:"other",description:"integer"},P={type:"other",description:"float"},_=".",B={type:"literal",value:".",description:'"."'},T={type:"other",description:"parameters"},L=",",C={type:"literal",value:",",description:'","'},M=function(t,e){return[t].concat(e)},b=function(t){return[t]},S=">>",q={type:"literal",value:">>",description:'">>"'},x="->",E={type:"literal",value:"->",description:'"->"'},I=function(t,e){var i=new G.Filter.Chain;return i.add(t),i.add(e),i},R=0,H=0,z={line:1,column:1,seenCR:!1},W=0,j=[],N=0;if("startRule"in t){if(!(t.startRule in e))throw new Error("Can't start parsing from rule \""+t.startRule+'".');i=e[t.startRule]}function O(t){return H!==t&&(t<H&&(H=0,z={line:1,column:1,seenCR:!1}),function(t,e,i){for(var r,s=e;s<i;s++)"\n"===(r=n.charAt(s))?(t.seenCR||t.line++,t.column=1,t.seenCR=!1):"\r"===r||"\u2028"===r||"\u2029"===r?(t.line++,t.column=1,t.seenCR=!0):(t.column++,t.seenCR=!1)}(z,H,t),H=t),z}function k(t){R<W||(W<R&&(W=R,j=[]),j.push(t))}function U(t,e,i){var r=O(i),s=i<n.length?n.charAt(i):null;return null!==e&&function(t){var e=1;for(t.sort(function(t,e){return t.description<e.description?-1:t.description>e.description?1:0});e<t.length;)t[e-1]===t[e]?t.splice(e,1):e++}(e),new $(null!==t?t:function(t,e){for(var i=new Array(t.length),r=0;r<t.length;r++)i[r]=t[r].description;function s(t){return t.charCodeAt(0).toString(16).toUpperCase()}return"Expected "+(1<t.length?i.slice(0,-1).join(", ")+" or "+i[t.length-1]:i[0])+" but "+(e?'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(t){return"\\x0"+s(t)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(t){return"\\x"+s(t)}).replace(/[\u0180-\u0FFF]/g,function(t){return"\\u0"+s(t)}).replace(/[\u1080-\uFFFF]/g,function(t){return"\\u"+s(t)})+'"':"end of input")+" found."}(e,s),e,s,i,r.line,r.column)}function V(){return Y()}function D(){var t,e,i,r=R,s=function(){var t,e,i,r;t=R,f.test(n.charAt(R))?(e=n.charAt(R),R++):(e=h,0===N&&k(c));if(e!==h){for(i=[],m.test(n.charAt(R))?(r=n.charAt(R),R++):(r=h,0===N&&k(g));r!==h;)i.push(r),m.test(n.charAt(R))?(r=n.charAt(R),R++):(r=h,0===N&&k(g));t=i!==h?e=w(e,i):(R=t,o)}else R=t,t=o;return t}();return r=s!==h?(40===n.charCodeAt(R)?(t=a,R++):(t=h,0===N&&k(l)),t!==h&&(e=function t(){var e,i,r;N++;e=R;i=X();e=i!==h?(44===n.charCodeAt(R)?(r=L,R++):(r=h,0===N&&k(C)),r!==h?(r=t())!==h?i=M(i,r):(R=e,o):(R=e,o)):(R=e,o);e===h&&(e=R,(i=X())!==h&&(i=b(i)),e=i);N--;e===h&&(i=h,0===N&&k(T));return e}())!==h?(41===n.charCodeAt(R)?(i=u,R++):(i=h,0===N&&k(p)),i!==h?function(t,e){var i=G.Filter.create(t);if(!i)throw"Filter "+t+" is not declared";e=i.setParams(e);if(0===e)return i;throw 0<e?"Filter "+t+" expects "+e+" parameter(s)":"Invalid parameter "+-e+" for filter "+t}(s,e):(R=r,o)):(R=r,o)):(R=r,o)}function J(){var t,e,i;if(N++,t=R,e=[],F.test(n.charAt(R))?(i=n.charAt(R),R++):(i=h,0===N&&k(d)),i!==h)for(;i!==h;)e.push(i),F.test(n.charAt(R))?(i=n.charAt(R),R++):(i=h,0===N&&k(d));else e=o;return e!==h&&(e=parseFloat(e.join(""))),N--,(t=e)===h&&(e=h,0===N&&k(r)),t}function K(){var t,e,i,r;if(N++,t=R,45===n.charCodeAt(R)?(e="-",R++):(e=h,0===N&&k(v)),e!==h){if(i=[],F.test(n.charAt(R))?(r=n.charAt(R),R++):(r=h,0===N&&k(d)),r!==h)for(;r!==h;)i.push(r),F.test(n.charAt(R))?(r=n.charAt(R),R++):(r=h,0===N&&k(d));else i=o;t=i!==h?e=parseFloat("-"+i.join("")):(R=t,o)}else R=t,t=o;return N--,t===h&&(e=h,0===N&&k(y)),t}function Q(){var t;return N++,(t=J())===h&&(t=K()),N--,t===h&&(0===N&&k(A)),t}function X(){var t,e,i,r;return N++,t=R,(t=(e=Q())!==h?(46===n.charCodeAt(R)?(i=_,R++):(i=h,0===N&&k(B)),i!==h&&(r=J())!==h?e=s(e,r):(R=t,o)):(R=t,o))===h&&(t=Q()),N--,t===h&&(e=h,0===N&&k(P)),t}function Y(){var t,e,i=R,r=Z();return i=(i=r!==h?(n.substr(R,2)===S?(t=S,R+=2):(t=h,0===N&&k(q)),t===h&&(n.substr(R,2)===x?(t=x,R+=2):(t=h,0===N&&k(E))),t!==h&&(e=Y())!==h?I(r,e):(R=i,o)):(R=i,o))===h?Z():i}function Z(){var t,e,i,r=D();return r===h&&(r=R,40===n.charCodeAt(R)?(t=a,R++):(t=h,0===N&&k(l)),r=t!==h&&(e=Y())!==h?(41===n.charCodeAt(R)?(i=u,R++):(i=h,0===N&&k(p)),i!==h?t=e:(R=r,o)):(R=r,o)),r}if((i=i())!==h&&R===n.length)return i;throw i!==h&&R<n.length&&k({type:"end",description:"end of input"}),U(null,j,W)}}},G.Filter._parser=new G.Filter.Parser,G.Filter.build=function(t){return G.Filter._parser.parse(t)}}();
"use strict";G.EventBuffer=function(t){this._bufferSize=t,this._addedCallback=null,this._updatedCallback=null,this._removedCallback=null,this._force=!1,this._revision=0,this.pool={},this.first=void 0,this.last=void 0,this.latest=null},G.EventBuffer.prototype.getBufferSize=function(){return this._bufferSize},G.EventBuffer.prototype.added=function(t){return this._addedCallback=t,this},G.EventBuffer.prototype.updated=function(t){return this._updatedCallback=t,this},G.EventBuffer.prototype.removed=function(t){return this._removedCallback=t,this},G.EventBuffer.prototype.feed=function(t,e){return!!t.eventID&&(e=e||new Date,!!(t=this._push(t,e))&&(this._removeExpiredEvents(e),!0))},G.EventBuffer.prototype.feedList=function(t){for(var e=new Date,i=t.length,s=!1,o=0;o<i;++o)t[o].eventID&&this._push(t[o],e)&&(s=!0);return s&&this._removeExpiredEvents(e),s},G.EventBuffer.prototype._rejectEvent=function(t,e){return t.otime<e.getTime()-this._bufferSize},G.EventBuffer.prototype._push=function(t,e){var i;return t.deleted||this._rejectEvent(t,e)?t.eventID in this.pool?(i=this.pool[t.eventID],delete this.pool[t.eventID],++this._revision,this._removedCallback&&this._removedCallback(i),this._force=!0,i):null:(t.eventID in this.pool?(function(t,e){for(var i in e)"_"!==i[0]&&"$"!==i[0]&&e.hasOwnProperty(i)&&(t[i]=e[i]);for(i in t)"_"!==i[0]&&"$"!==i[0]&&(e.hasOwnProperty(i)||delete t[i])}(i=this.pool[t.eventID],t),this._updatedCallback&&this._updatedCallback(i)):(this.pool[(i=t).eventID]=t,++this._revision,this._addedCallback&&this._addedCallback(i)),(!this.first||this.first>i.otime)&&(this.first=i.otime),(!this.last||this.last<i.otime)&&(this.last=i.otime,this.latest=i),i)},G.EventBuffer.prototype._removeExpiredEvents=function(t){if(this._force||!(t.getTime()-this.first<=this._bufferSize)){this._force=!1;var e,i=t.getTime()-this._bufferSize;for(e in this.first=void 0,this.last=void 0,this.latest=null,this.pool){var s=this.pool[e];s.otime<i?(this._removedCallback&&this._removedCallback(s),delete this.pool[e],++this._revision):((void 0===this.first||s.otime<this.first)&&(this.first=s.otime),(void 0===this.last||s.otime>this.last)&&(this.last=s.otime,this.latest=s))}}};
"use strict";!function(){function h(e,t,i,r){if(!(t<0)){t=e[t];if(i.srNum!==t.srNum||i.srDen!==t.srDen)return r.reset(),void r.setSamplingFrequency(i.srNum/i.srDen);.001*Math.abs(i.startTime-t.endTime)*i.srNum>i.srDen&&r.reset()}}function f(e){return $.extend(!0,{},e)}G.RecordUtils={},G.RecordUtils.toPowerSpectrum=function(e,t){var i,r,s,h=t?1/t:1;if("f"!==e.domain){for(s=(r=e.samples).length,i=0;i<s;++i)r[i]*=h;return!1}for(s=(r=e.samples).length,e.sr=e.srNum/e.srDen,i=0;i<s;++i){var f=r[i][0]*r[i][0]+r[i][1]*r[i][1];r[i]=f*h}return!0},G.RecordBuffer=function(e,t){this.bufferSize=e,this.raw=[],this.filtered=[],this.filter=void 0,this.keepRaw=void 0===t||t},G.RecordBuffer.prototype.clear=function(){this.raw.length=0,this.filtered.length=0},G.RecordBuffer.prototype.setFilter=function(e){if(0<this.raw.length&&this.filter&&!this.keepRaw)return!1;this.filter=e,this.filtered.length=0,this.filtered=[];for(var t=this.raw.length,i=0;i<t;++i){var r,s=this.raw[i];0===i&&this.filter.setSamplingFrequency(s.srNum/s.srDen),h(this.raw,i-1,s,this.filter),this.keepRaw?(r=f(s),this.filter.apply(r.samples),this.filtered.push(r)):(this.filter.apply(s.samples),this.raw[i]=r)}return!0},G.RecordBuffer.prototype.feed=function(e){if(this.filter){var t=f(e),i=this.keepRaw?(this.raw.push(e),this.filtered):this.raw;if(0===i.length?this.filter.setSamplingFrequency(e.srNum/e.srDen):h(i,i.length-1,e,this.filter),this.filter.apply(t.samples),i.push(t),0<this.bufferSize)for(;1<this.filtered.length&&this.filtered[this.filtered.length-1].endTime-this.filtered[0].endTime>this.bufferSize;)this.filtered.shift().samples.length=0,0}else this.raw.push(e);if(0<this.bufferSize)for(;1<this.raw.length&&this.raw[this.raw.length-1].endTime-this.raw[0].endTime>this.bufferSize;)this.raw.shift().samples.length=0,0}}();
"use strict";G.Inventory=function(t){this._data=t},G.Inventory.prototype={matchEpoch:function(t,n){return!(new Date(t.start)>n)&&!(t.end&&new Date(t.end)<n)},data:function(){return this._data},findNetwork:function(t,n){for(var r=this._data.network.length,e=0;e<r;++e){var a=this._data.network[e];if(a.code===t&&this.matchEpoch(a,n))return a}return null},findStation:function(t,n,r){var e;if("string"==typeof t){if(!(e=this.findNetwork(t,r)))return null}else e=t;if(e.station)for(var a=e.station.length,i=0;i<a;++i){var o=e.station[i];if(o.code===n&&this.matchEpoch(o,r))return o}return null},findSensorLocation:function(t,n,r,e){var a;if("string"==typeof n){if(!(a=this.findStation(t,n,e)))return null}else a=n;if(a.sensorLocation)for(var i=a.sensorLocation.length,o=0;o<i;++o){var s=a.sensorLocation[o];if(s.code===r&&this.matchEpoch(s,e))return s}return null},findStream:function(t,n,r,e,a){var i;if("string"==typeof r){if(!(i=this.findSensorLocation(t,n,r,a)))return null}else i=r;if(i.stream)for(var o=i.stream.length,s=0;s<o;++s){var h=i.stream[s];if(h.code===e&&this.matchEpoch(h,a))return h}return null},getThreeComponents:function(t,n,r){n.length;var e,a,i=-100,o=100,s=100,h=[null,null,null],f=[0,0,0],u=[0,0,0],c=[0,0,0];if(!t.stream)return h;for(a=t.stream.length,e=0;e<a;++e){var l,d,v,M,m=t.stream[e];m.end&&new Date(m.end)<r||new Date(m.start)>r||!function(t,n){var r,e=t.length,a=n.length;if(!(e<a)){for(r=0;r<a;++r)if(t[r]!==n[r])return;return 1}}(m.code,n)||void 0===m.azimuth||void 0===m.dip||(l=Math.PI*m.azimuth/180,d=Math.PI*m.dip/180,v=Math.sin(-d),i<(M=Math.abs(v))&&(i=M,h[0]=m,f[0]=Math.cos(-d)*Math.sin(l),f[1]=Math.cos(-d)*Math.cos(l),f[2]=v),M<o?(h[1]=m,o=M,u[0]=Math.cos(-d)*Math.sin(l),u[1]=Math.cos(-d)*Math.cos(l),u[2]=v):M<s&&(h[2]=m,s=M,c[0]=Math.cos(-d)*Math.sin(l),c[1]=Math.cos(-d)*Math.cos(l),c[2]=v))}if(h[0]===h[1])return h[1]=h[2],h[2]=null,h;if(!h[0]||!h[2])return h;var p=[0,0,0];return p[0]=u[1]*c[2]-u[2]*c[1],p[1]=u[2]*c[0]-u[0]*c[2],p[2]=u[0]*c[1]-u[1]*c[0],0<p[0]*f[0]+p[1]*f[1]+p[2]*f[2]&&(p=h[1],h[1]=h[2],h[2]=p),h}};
"use strict";!function(){function k(e,t,r,a){var n=function(e,t,r){var a=e[r];if(!a)for(var n=t.length,o=0;o<n;++o){var i=t[o];if(i.publicID===r){e[(a=i).publicID]=a;break}}return a}(t,r,a);if(!n)return!1;var o=!1;if(n.baseID&&(o=k(e,t,r,n.baseID)||o),!n.parameter)return o;for(var i=n.parameter.length,d=0;d<i;++d){var s=n.parameter[d];s.name&&(e[s.name]=s.value,o=!0)}return o}G.Bindings=function(e,t,r,a){this.networks={};var n={};if(e.module)for(var o=e.module.length,i=0;i<o;++i){var d=e.module[i];if(d.enabled&&d.name===t&&d.station){for(var s=d.station.length,f=0;f<s;++f){var c=d.station[f];if(c.networkCode&&c.stationCode){for(var m,u,v=c.setup.length,l=0;l<v;++l){var w=c.setup[l];if(w.enabled){if(w.name===r){m=w;break}a&&"default"===w.name&&(m=w)}}!m||k(u={},n,e.parameterSet,m.parameterSetID)&&(this.networks[c.networkCode]||(this.networks[c.networkCode]={}),this.networks[c.networkCode][c.stationCode]=u)}}break}}},G.Bindings.prototype={getParams:function(e,t){e=this.networks[e];if(e)return e[t]},injectDetecStream:function(e,t){for(var r=e.network?e.network.length:0,a=0;a<r;++a){var n=e.network[a];if(!(new Date(n.start)>t)&&!(n.end&&new Date(n.end)<t))for(var o=n.station.length,i=0;i<o;++i){var d,s=n.station[i];new Date(s.start)>t||s.end&&new Date(s.end)<t||(d=this.getParams(n.code,s.code))&&(d.detecStream&&(s.detecStream=d.detecStream,s.detecStream.length<3&&(s.detecStream+="Z")),d.detecLocid&&(s.detecLocid=d.detecLocid))}}}}}();
angular.element(document).ready(function(){document.getElementById("app").style.display="block",window.onbeforeunload=function(){return"Leaving the page will destroy all you local modifications.\nBe aware that this web page is a single page application and reload will restart the whole application."}});var scolv=angular.module("OriginLocatorView",["browsercheck","cfp.hotkeys","ngContextMenu","ngDateTimePicker","timeseries","plot","mapwidget-ll","notice-service","quakelink","recordstream","gm.filters","gm.date"]).config(["hotkeysProvider",function(e){e.template="<hotkeys></hotkeys>"}]);
scolv.directive("autoScroll",function(){return{restrict:"A",link:function(e,r,t){e.$watch(t.autoScroll,function(e){var t;e&&(e=(t=r[0].parentNode).scrollTop,r[0].offsetTop<t.offsetTop+e?t.scrollTop=r[0].offsetTop-t.offsetTop:r[0].offsetTop+r[0].offsetHeight>t.offsetTop+t.offsetHeight+e&&(t.scrollTop=r[0].offsetTop+r[0].offsetHeight-(t.offsetTop+t.offsetHeight)))})}}}).directive("eventTable",function(){return{restrict:"E",replace:!0,templateUrl:"templates/evtable.tpl"}}).directive("eventSummary",function(){return{restrict:"E",replace:!0,templateUrl:"templates/summary.tpl"}}).directive("arrivalTable",function(){return{restrict:"E",replace:!0,templateUrl:"templates/artable.tpl"}}).directive("originInfo",function(){return{restrict:"E",replace:!0,templateUrl:"templates/orginfo.tpl"}}).directive("picker",function(){return{restrict:"E",replace:!0,scope:{inventory:"=",bindings:"=",config:"=",origin:"="},controller:"PickerCtrl",templateUrl:"templates/picker.tpl"}}).directive("dialogCommit",function(){return{restrict:"E",replace:!0,templateUrl:"templates/dialogs/commit.tpl"}}).directive("hotkeys",function(){return{restrict:"E",replace:!0,templateUrl:"templates/hotkeys.tpl",link:function(e,t,r){e.tab="sc"}}}).directive("help",function(){return{restrict:"EA",replace:!0,templateUrl:"templates/help.tpl"}}).directive("lastUpdateLayout",function(){return{restrict:"A",link:function(e,t,r){e.$last&&e.$emit("updateLayout")}}}).directive("vsplitter",["$window",function(f){return{restrict:"EA",replace:!0,template:"<div></div>",link:function(e,t,r){var i,n,l,o,c,a=t[0].previousElementSibling,s=t[0].nextElementSibling;function u(e){var t=e.clientY-i,e=l-(t=l-(t=n+t<o?o-n:t)<c?l-c:t);a.style.height=n+t+"px",s.style.height=e+"px"}function p(e){f.removeEventListener("mousemove",u),f.removeEventListener("mouseup",p)}a&&s&&t[0].addEventListener("mousedown",function(e){e.preventDefault();var t=f.getComputedStyle(a,null),r=f.getComputedStyle(s,null);i=e.clientY,n=parseInt(t.getPropertyValue("height"),10),o=parseInt(t.getPropertyValue("min-height"),10),l=parseInt(r.getPropertyValue("height"),10),c=parseInt(r.getPropertyValue("min-height"),10),f.addEventListener("mousemove",u),f.addEventListener("mouseup",p)})}}}]).directive("open",["$document",function(e){return{restrict:"A",scope:{},link:function(e,t,r){var i=t.bind("click",function(e){var t=angular.element(document.getElementById(r.target));e.preventDefault(),t.addClass("open")});e.$on("$destroy",function(){t.unbind("click",i)})}}}]).directive("close",["$document",function(e){return{restrict:"A",scope:{},link:function(e,t,r){var i=t.bind("click",function(e){var t=angular.element(document.getElementById(r.target));e.preventDefault(),t.removeClass("open")});e.$on("$destroy",function(){t.unbind("click",i)})}}}]).directive("legend",function(){return{restrict:"EA",scope:{items:"="},template:'<div class="title">{{items.title}}</div>',link:function(l,o,e){l.$watch("items.labels",function(){o.children().remove(".entries");var e=angular.element('<div class="entries"></div>');o.append(e);for(var t="",r=0;r<l.items.labels.length;++r){var i,n=Array.isArray&&Array.isArray(l.items.labels[r][0])?(i="background-color:rgb("+l.items.labels[r][0].join(",")+")","color"):angular.isNumber(l.items.labels[r][0])?(i="width:"+l.items.labels[r][0]+"px;height:"+l.items.labels[r][0]+"px","box"):(i="background-color:"+l.items.labels[r][0],"color");t+='<div class="entry"><i class="'+n+'" style="'+i+'"></i> '+l.items.labels[r][1]+"</div>"}e.append(t)})}}}).filter("strfdatetime",["gmDate",function(t){return function(e){return t.toDefaultString(e,"%Y-%m-%d %H:%M:%S")}}]).filter("strftime",["gmDate",function(t){return function(e){return t.toDefaultString(e,"%H:%M:%S.%3")}}]).filter("kmerr",function(){return function(e){if(!e)return"+/- - km";e=parseFloat(e.uncertainty);return e?"+/- "+e.toFixed(1)+" km":"fixed"}}).filter("ciup",function(){return function(e){return e?e.modificationTime||e.creationTime:void 0}});
"use strict";scolv.controller("MainCtrl",["$scope","$http","$timeout","$interval","hotkeys","gmNotice","gmDate","quakelink",function(g,a,l,e,t,v,c,f){function p(e){if(null===e||"object"!=typeof e)return e;var t,o=e.constructor();for(t in e)"$"!==t[0]&&e.hasOwnProperty(t)&&(o[t]=e[t]);return o}function o(e,t){e=4.9*(e-1.2);return e=e<t?t:e}t.bindTo(g).add({combo:"p",description:"Toggle picker",callback:function(){g.corg&&(g.wfShown?g.wfShown=!1:g.openWaveforms())}}),g.showHelp=function(){t.toggleCheatSheet()},g.eventTypes=["","not existing","not locatable","outside of network interest","earthquake","induced earthquake","quarry blast","explosion","chemical explosion","nuclear explosion","landslide","rockslide","snow avalanche","debris avalanche","mine collapse","building collapse","volcanic eruption","meteor impact","plane crash","sonic boom","duplicate","other"],g.eventTypeCertainties=["","known","suspected"],g.originStatus=["preliminary","confirmed","reviewed","final","rejected","reported"],g.config={ql:"http://localhost:18080/",serverAPI:"../",eventTS:void 0,eventOtime:void 0,otherEventTypes:{"not existing":"",other:""},hideOtherEventTypes:!1,forceHTTP:!1,filters:[["0.7Hz - 2Hz","RMHP(10)>>BW_HLP(4,0.7,2)"],["1Hz - 3Hz","RMHP(10)>>BW_HLP(4,1,3)"],["2Hz - 4Hz","RMHP(10)>>BW_HLP(4,2,4)"],["4Hz - 8Hz","RMHP(10)>>BW_HLP(4,4,8)"]],useUTC:!0,distInKM:!1,phases:[],ttables:[["libtau",["iasp91","ak135"]],["LOCSAT",["iasp91","tab"]]],locator:[["LOCSAT",["iasp91","tab"]]],traces:{preOnsetTimeWindow:300,postOnsetTimeWindow:600,preAlignTimeWindow:30,postAlignTimeWindow:90},visual:{residuals:[[-8,[0,0,100]],[-4,[0,0,255]],[-3,[100,100,255]],[-2,[170,170,255]],[-1,[220,220,255]],[0,[255,255,255]],[1,[255,220,220]],[2,[255,170,170]],[3,[255,100,100]],[4,[255,0,0]],[8,[100,0,0]]]}},g.options={map:{mapURI:"../tiles/{z}/{y}/{x}",maxBounds:[[-10,-10],[10,10]],showEvents:!0,blinking:!1,autoCenterLastEvent:!0},legend:{depths:{title:"Depth in km",labels:[[[255,0,0],"<= 50"],[[255,128,0],"<= 100"],[[255,255,0],"<= 250"],[[0,127,0],"<= 600"],[[0,0,255],"> 600"]]},ages:{title:"Event age",labels:[[[255,0,0],"1 hour"],[[255,128,0],"1 day"],[[255,255,0],"1 week"],[[255,255,255],"1 month"],[[128,128,128],"older"]]},magnitudes:{title:"Magnitude",labels:[[o(1,6),"1"],[o(2,6),"2"],[o(3,6),"3"],[o(4,6),"4"],[o(5,6),"5"],[o(6,6),"6"],[o(7,6),"7"],[o(8,6),"8"]]}}},g.loadInventory=function(){g.progressMsg="Station information requested, hold on a second ...",a.get(g.config.serverAPI+"query/stations.json").then(function(e){e=e.data;e.Inventory?(v.info("Stations","Stations loaded"),g.inventory=new G.Inventory(e.Inventory)):v.error("Load stations","No stations available"),void 0!==g.progress&&(g.progress=25,g.loadBindings())}).catch(function(e){v.error("Load stations","Error "+e.status+": "+e.data+"<br/>Trying again in 10 seconds."),l(g.loadInventory,1e4)})},g.loadBindings=function(){g.progressMsg="Bindings requested, hold on a second ...",a.get(g.config.serverAPI+"query/config.json").then(function(e){e=e.data;e.Config?(v.info("Bindings","Bindings loaded"),g.bindings=new G.Bindings(e.Config,"trunk","scolv",!0)):v.error("Load bindings","No bindings available"),void 0!==g.progress&&(g.progress=50,g.loadConfig())}).catch(function(e){v.error("Load Bindings","Error "+e.status+": "+e.data+"<br/>Trying again in 10 seconds."),l(g.loadBindings,1e4)})},g.loadConfig=function(){g.progressMsg="Application configuration requested, hold on a second ...",a.get("config.json?app=scolv").then(function(e){var t=e.data;if(t.scolv||(v.error("Config","Error in configuration,<br/>Trying again in 10 seconds."),l(g.loadConfig,1e4)),v.info("Config","Configuration loaded"),t.gaps&&(g.gaps=t.gaps),g.config.ql=t.scolv.quakelink||g.config.ql,g.config.serverAPI=t.scolv.serverAPI||g.config.serverAPI,g.config.serverWSAPI=t.scolv.serverWSAPI||g.config.serverAPI,g.config.forceHTTP=t.scolv.forceHTTP,g.options.map.mapURI=t.scolv.mapURI||g.options.map.mapURI,g.options.map.maxLevel=t.scolv.mapMaxLevel,g.options.map.maxZoom=t.scolv.mapMaxZoom,g.list.days=t.scolv.loadEventDB||g.list.days,g.config.useUTC=t.scolv.useUTC,g.config.distInKM=t.scolv.distInKM,g.config.ttables=t.scolv.ttables||g.config.ttables,g.config.locator=t.scolv.locator||g.config.locator,t.scolv.otherEventTypes){g.config.otherEventTypes={};for(var o=0,r=t.scolv.otherEventTypes.length;o<r;++o)g.config.otherEventTypes[t.scolv.otherEventTypes[o]]=""}if(g.config.hideOtherEventTypes=t.scolv.hideOtherEventTypes||g.config.hideOtherEventTypes,t.scolv.traces&&angular.merge(g.config.traces,t.scolv.traces),g.config.eventTS=24*g.list.days,t.scolv.colorByAge?(g.options.map.events={colorByAge:t.scolv.colorByAge},angular.isNumber(t.scolv.colorUpdateInterval)&&(g.options.map.events.updateInterval=t.scolv.colorUpdateInterval),g.options.legend.colors=g.options.legend.ages):g.options.legend.colors=g.options.legend.depths,g.config.useUTC?c.setDefaultToUTC():c.setDefaultToLocal(),g.list.from=c.toDefaultString(new Date(new Date-864e5*g.list.days),"%Y-%m-%d %H:%M:%S"),g.list.to=c.toDefaultString(new Date,"%Y-%m-%d %H:%M:%S"),g.list.filter=g.config.hideOtherEventTypes?"hide_o":"all",t.scolv.filters)for(g.config.filters=[],r=t.scolv.filters.length,o=0;o<r;++o){var i,n,a=t.scolv.filters[o],s=a.indexOf(";");s<0?i=n=a:(i=a.substr(0,s),n=a.substr(s+1)),"@"===i[0]?g.config.filters.push([i.substr(1),n,!0]):g.config.filters.push([i,n])}t.scolv.phases&&(g.config.phases=t.scolv.phases),t.scolv.eventTypes&&(g.eventTypes=t.scolv.eventTypes,g.eventTypes.sort()),t.scolv.eventTypeCertainties&&(g.eventTypeCertainties=t.scolv.eventTypeCertainties),g.plotTab(g.ltab),g.currentLocator=g.config.locator[0],g.applyLocator(),void 0!==g.progress&&(g.progress=75,g.loadDays())}).catch(function(e){v.error("Load Config","Error "+e.status+": "+e.data+"<br/>Trying again in 10 seconds."),l(g.loadConfig,1e4)})},g.loadEvents=function(){g.tab="events",g.mapEvents=[],g.events=new G.EventBuffer(3600*g.config.eventTS*1e3),g.events.updated(g.eventUpdated),g.config.eventTS?g.poller=f.createStream(g.config.ql,{tspan:g.config.eventTS}):g.poller=f.createStream(g.config.ql,{otime:g.config.eventOtime}),g.poller.receive(function(e){g.events.feedList(e),void 0!==g.progress&&(g.progress=100,g.progressMsg="Starting application",l(function(){delete g.progress},500)),delete e.seiscomp}).error(function(e,t,o){void 0!==g.progress&&(g.progress=100,l(function(){delete g.progress},500)),t<=0?o?g.loadEvents():(v.error("Events","Could not reach server, try again in 10s."),l(function(){g.poller.resume()},1e4)):500<=t&&t<600?o?g.loadEvents():l(function(){g.poller.resume()},1e3):(v.error("Events","Server returned error "+t+"."),g.poller=null)}).start()},g.eventUpdated=function(e){g.ces===e&&v.info("Update","The current event has received an update")},g.loadSpan=function(){var e,t;!g.list.from|g.list.to?v.error("Load events","<strong>From</strong> and <strong>To</strong> must be set."):(e=new Date(g.list.from.replace(" ","T")+"Z"),t=new Date(g.list.to.replace(" ","T")+"Z"),g.config.useUTC||(e=new Date(e.getTime()+6e4*e.getTimezoneOffset()),t=new Date(t.getTime()+6e4*t.getTimezoneOffset())),isNaN(e.getTime())?v.error("Load events","<strong>From</strong> is not a valid date."):isNaN(t.getTime())?v.error("Load events","<strong>To</strong> is not a valid date."):(g.config.eventTS=void 0,g.config.eventOtime={min:e,max:t},g.poller?g.poller.stop():g.loadEvents()))},g.loadDays=function(){g.list.days?(g.config.eventTS=24*g.list.days,g.config.eventOtime=void 0,g.list.from=c.toDefaultString(new Date(new Date-864e5*g.list.days),"%Y-%m-%d %H:%M:%S"),g.list.to=c.toDefaultString(new Date,"%Y-%m-%d %H:%M:%S"),g.poller?g.poller.stop():g.loadEvents()):v.error("Load events","Number of days must be greater than zero")},g.openWaveforms=function(){g.wf||(g.wf=!0),g.wfShown=!0},g.minimizeWaveforms=function(){g.wfShown=!1},g.closeWaveforms=function(){g.wf=!1,g.wfShown=!1},g.arrivalSelected=function(e){e&&(g.$broadcast("selectArrival",e),g.wf&&g.openWaveforms())},g.toggleArrival=function(e){e._used=!e._used,g.arrivalChanged(e,!0,!0)},g.deleteSelectedArrivals=function(){if(g.corg){for(var e=[],t=g.corg.arrival?g.corg.arrival.length:0,o=0;o<t;++o)g.corg.arrival[o]._selected||e.push({arrival:g.corg.arrival[o],phase:g.corg.arrival[o].phase.code});g.applyArrivals(g.corg,e)}},g.activateSelectedArrivals=function(){if(g.corg)for(var e=g.corg.arrival?g.corg.arrival.length:0,t=0;t<e;++t)g.corg.arrival[t]._selected&&(g.corg.arrival[t]._used||(g.corg.arrival[t]._used=!0,g.arrivalChanged(g.corg.arrival[t],!0,!0)))},g.deactivateSelectedArrivals=function(){if(g.corg)for(var e=g.corg.arrival?g.corg.arrival.length:0,t=0;t<e;++t)g.corg.arrival[t]._selected&&g.corg.arrival[t]._used&&(g.corg.arrival[t]._used=!1,g.arrivalChanged(g.corg.arrival[t],!0,!0))},g.mapArrivalClicked=function(e){var t=e.target;g.$apply(function(){g.arrivalSelected(t.arrival)})},g.mapArrivalOver=function(e){g.$apply(function(){g.mapTitle=e.target.arrival._sid+" "+e.target.arrival.phase.code})},g.mapArrivalOut=function(e){g.$apply(function(){g.mapTitle=""})},g.arrivalChanged=function(e,t,o){if(o)for(var r=g.plotData.length,i=0;i<r;++i)if(g.plotData[i].arrival===e){g.plotData[i].active=e._used,g.$broadcast("updatePlot");break}if(g.mapAPI.map&&g.mapAPI.map.map){try{e.pick.evaluationMode[0].toUpperCase()}catch(e){}t&&g.$broadcast("arrivalChanged",e);var n,t={color:"#eee",fillColor:e._used?"rgb("+(n=function(e,t){for(var o=e.length,r=0;r<o;++r){if(e[r][0]===t)return e[r][1];if(e[r][0]>t){if(0===r)return e[r][1];var i=(t-e[r][0])/(e[r][0]-e[r-1][0]),n=1-i,a=e[r-1][1],s=e[r][1];return[a[0]*n+i*s[0]|0,a[1]*n+i*s[1]|0,a[2]*n+i*s[2]|0]}}return e[o-1][1]}(g.config.visual.residuals,e.timeResidual))[0]+","+n[1]+","+n[2]+")":"#888",weight:1,opacity:1,fillOpacity:1,radius:6,clickable:!0};e._symbol?e._symbol.setStyle(t):(n=G.Geo.delandaz2coord(e.distance,e.azimuth,g.corg.latitude.value,g.corg.longitude.value),e._symbol=new L.CircleMarker(n,t),(e._symbol.arrival=e)._symbol.on("click",g.mapArrivalClicked),e._symbol.on("mouseover",g.mapArrivalOver),e._symbol.on("mouseout",g.mapArrivalOut),e._symbol.addTo(g.mapAPI.map.map))}},g.plotTab=function(e){g.ltab=e,g.plotOptions={},"dist"===e?(g.plotOptions.xCol=0,g.plotOptions.xLabel=g.config.distInKM?"Distance (km)":"Distance (deg)",g.plotOptions.xRange=[0,null],g.plotOptions.yCol=1,g.plotOptions.ySym=!0,g.plotOptions.yLabel="Time residual (s)"):"az"===e?(g.plotOptions.xCol=2,g.plotOptions.xLabel="Azimuth (deg)",g.plotOptions.xRange=[0,360],g.plotOptions.yCol=1,g.plotOptions.ySym=!0,g.plotOptions.yLabel="Time residual (s)"):"tt"===e&&(g.plotOptions.xCol=0,g.plotOptions.xLabel=g.config.distInKM?"Distance (km)":"Distance (deg)",g.plotOptions.xRange=[0,null],g.plotOptions.yCol=3,g.plotOptions.ySym=!1,g.plotOptions.yLabel="Travel time (s)")},g.setOrigin=function(e,t,o){var r,i,n,a,s,l,c;if(g.corg)for(n=g.corg.arrival?g.corg.arrival.length:0,r=0;r<n;++r)(l=g.corg.arrival[r])._symbol&&(l._symbol.off("click",g.mapArrivalClicked),l._symbol.off("mouseover",g.mapArrivalOver),l._symbol.off("mouseout",g.mapArrivalOut),g.mapAPI.map.map.removeLayer(l._symbol),l._symbol.arrival=null,delete l._symbol);if(g.plotData=[],g.corg=e,g.corg)for(n=e.arrival?e.arrival.length:0,a=t?t.length:0,s=o?o.length:0,r=0;r<n;++r){(l=e.arrival[r])._used=void 0===l.weight||.5<=l.weight;var v="A";if(!l.pick)for(i=0;i<a;++i)if(c=t[i],l.pickID===c.publicID){l.pick=c;break}if(!l.pick)for(i=0;i<s;++i)if(c=o[i],l.pickID===c.publicID){l.pick=c;break}var p=-1,d=l.distance;g.config.distInKM&&(d*=111.13291490135191),l.pick?(v=l.pick.evaluationMode?l.pick.evaluationMode[0].toUpperCase():"A",l._net=l.pick.waveformID.networkCode,l._sta=l.pick.waveformID.stationCode,l._loc=l.pick.waveformID.locationCode||"",l._cha=l.pick.waveformID.channelCode,l._sid=l._net+"."+l._sta+"."+l._loc+"."+l._cha,l.pick.waveformID.locationCode?l._chaid=l.pick.waveformID.locationCode+".":l._chaid="",l._chaid+=l.pick.waveformID.channelCode,p=.001*(new Date(l.pick.time.value)-new Date(e.time.value))):console.error("Arrival "+r+": pick "+l.pickID+" not found"),g.plotData.push({valid:!0,active:l._used,color:"M"===v?"#080":"#800",cols:[d,l.timeResidual,l.azimuth,p],shape:"S"===f.shortPhaseName(l.phase.code)?"rect":null,arrival:l}),g.arrivalChanged(l,!1,!0)}},g.$on("eventSelected",function(e,n){g.ces=n,g.ced=null,g.fixDepth=!1,g.fixDepthValue=void 0,g.ignoreInitial=!1,g.commitOpts={update:!0,associate:!0,fix:!1,eventType:"",eventTypeCertainty:"",originStatus:"confirmed",name:"",comment:"",eventList:!1},a.get(g.config.serverAPI+"query/event/"+n.eventID+".json").then(function(e){var t,o,r,e=e.data;if(e.EventParameters)if((r=e.EventParameters).event&&r.event.length)if(r.event=r.event[0],r.event.preferredOrigin=function(e){var t,o;if(!angular.isArray(e.origin))return e.origin;for(o=e.origin.length,t=0;t<o;++t){var r=e.origin[t];if(r.publicID===e.event.preferredOriginID)return r}}(r),r.event.preferredMagnitude=function(e){var t,o,r,i,n,a;if(angular.isArray(e.origin)){for(o=e.origin.length,t=0;t<o;++t)if((n=e.origin[t]).magnitude)if(angular.isArray(n.magnitude)){for(i=n.magnitude.length,r=0;r<i;++r)if((a=n.magnitude[r]).publicID===e.event.preferredMagnitudeID)return a}else if(n.magnitude.publicID===e.event.preferredMagnitudeID)return n.magnitude}else if((n=e.origin).magnitude)if(angular.isArray(n.magnitude)){for(i=n.magnitude.length,r=0;r<i;++r)if((a=n.magnitude[r]).publicID===e.event.preferredMagnitudeID)return a}else if(n.magnitude.publicID===e.event.preferredMagnitudeID)return n.magnitude}(r),r.event.preferredOrigin){for(v.success(n.eventID,"Loaded"),g.ced=r,o=g.ced.event.description.length||0,t=0;t<o;++t){var i=g.ced.event.description[t];if("region name"===i.type){g.ced.event.region=i.text;break}}for(o=g.eventTypes.length,t=0;t<o;++t)if(g.eventTypes[t]===r.event.type){g.commitOpts.eventType=g.eventTypes[t];break}for(o=g.eventTypeCertainties.length,t=0;t<o;++t)if(g.eventTypeCertainties[t]===r.event.typeCertainty){g.commitOpts.eventTypeCertainty=g.eventTypeCertainties[t];break}for(o=r.event.description?r.event.description.length:0,t=0;t<o;++t)if("earthquake name"===r.event.description[t].type){g.commitOpts.name=r.event.description[t].text;break}for(o=r.event.comment?r.event.comment.length:0,t=0;t<o;++t)if("Operator"===r.event.comment[t].id){g.commitOpts.comment=r.event.comment[t].text;break}g.extraPicks=[],g.setOrigin(r.event.preferredOrigin,r.pick),g.isLocalOrigin=!1,g.tab="loc",g.mapInit=!0,g.mapSummaryEvents={},g.mapSummaryEvents[n.eventID]=g.ces,g.mapEvents={},g.mapEvents[n.eventID]=g.ces}else v.error(n.eventID,"Preferred origin not found");else v.error(n.eventID,"No event in response");else v.error(n.eventID,"Invalid")}).catch(function(e){var t=e.data;e.status?401===e.status?v.error("GAPS","Login failed"):v.error("GAPS",t):v.error("GAPS","Server connection error")})}),g.$on("newArrivals",function(e,t,o){g.applyArrivals(t,o)}),g.applyArrivals=function(e,t){if(g.minimizeWaveforms(),e===g.corg){var o=p(g.corg);o.publicID="",o.quality={},o.arrival=[];for(var r=0,i=0,n=t.length,a=0;a<n;++a){var s,l,c=t[a];c.arrival?((s=p(c.arrival)).phase={code:c.phase},s._symbol=void 0,s.weight=s._used?1:0,o.arrival.push(s),s._used&&++i):((l={publicID:""}).waveformID={networkCode:c.wid[0],stationCode:c.wid[1],locationCode:c.wid[2],channelCode:c.wid[3]},l.time={value:new Date(c.time).toISOString()},l.phaseHint={code:c.phase},l.evaluationMode="manual",(s={}).pick=l,s.phase={code:l.phaseHint.code},s.weight=1,s.distance=c.dist,s.azimuth=c.azi,s.timeResidual=c.res,o.arrival.push(s),++i),++r}o.quality.usedPhaseCount=i,o.quality.associatedPhaseCount=r,g.setOrigin(o),g.isLocalOrigin=!0}else v.error("Locator","Picked arrivals do not correspond to the current loaded origin")},g.applyLocator=function(){g.currentLocator&&(g.currentLocatorProfile=g.currentLocator[1][0])},g.relocate=function(){if(g.corg){if(g.fixDepth){var e=parseFloat(g.fixDepthValue);if(isNaN(e))return void v.error("Locator","Depth fixed but no depth given")}var t={type:g.currentLocator[0],profile:g.currentLocatorProfile,initial:{lat:g.corg.latitude.value,lon:g.corg.longitude.value,dep:g.corg.depth?g.corg.depth.value:void 0,time:g.corg.time.value},options:{},assocs:[],picks:g.extraPicks};g.fixDepth&&(t.options.fixDepth=e),g.ignoreInitial&&(t.options.ignoreInitial=!!g.ignoreInitial);for(var o=g.corg.arrival.length,r=0;r<o;++r){var i=g.corg.arrival[r],n={};i._used?n.weight=1:n.weight=0;try{n.phase=i.phase.code}catch(e){}if(!i.pick)return void v.error("Locator","Pick not found for arrival "+r);i.pick.publicID?n.pick={publicID:i.pick.publicID}:n.pick=i.pick,t.assocs.push(n)}g.blockRelocate=!0,a.post(g.config.serverAPI+"api/relocate.json",JSON.stringify(t)).then(function(t){t=t.data;if(t.Origin){v.info("Locator","OK"),g.extraPicks=t.picks,g.setOrigin(t.Origin,g.ced.pick,g.extraPicks),g.isLocalOrigin=!0;t=p(g.ces);t.lat=g.corg.latitude.value,t.lon=g.corg.longitude.value;try{t.depth=g.corg.depth.value}catch(e){t.depth=10}g.mapEvents={},g.mapEvents[g.ces.eventID]=t}else v.error("Locator","Empty result");g.blockRelocate=!1}).catch(function(e){var t=e.data;e.status?401===e.status?v.error("Locator","You are not logged in"):v.error("Locator",t):v.error("Locator","Server connection error"),g.blockRelocate=!1})}else v.error("Locator","No origin loaded")},g.commit=function(r){var e={origin:function e(t){if(null===t)return t;if(angular.isArray(t)){for(var o=[],r=0,i=t.length;r<i;++r)o.push(e(t[r]));return o}if("object"!=typeof t)return t;for(var n in o=t.constructor(),t)"_"!==n[0]&&"$"!==n[0]&&t.hasOwnProperty(n)&&(o[n]=e(t[n]));return o}(g.corg),isLocal:g.isLocalOrigin};g.extraPicks&&(e.picks=g.extraPicks),g.ces&&g.ces.eventID&&(e.event=g.ces.eventID);for(var t=e.origin.arrival?e.origin.arrival.length:0,o=0;o<t;++o)if(!e.origin.arrival[o].pickID)return void v.error("Commit","The origin contains local picks that have not been relocated. Origin can't be committed.",5e3);r&&(e.options=r),a.post(g.config.serverAPI+"api/commit.json",JSON.stringify(e)).then(function(e){e.data;v.success("Commit","OK");for(var t=g.extraPicks.length,o=0;o<t;++o)g.ced.pick.push(g.extraPicks[o]);g.extraPicks=[],g.isLocalOrigin=!1,r&&r.eventList&&(g.tab="events")}).catch(function(e){var t=e.data;401===e.status?v.error("Commit","Authorization required"):v.error("Commit",t)})},g.commitWithOptions=function(){g.commit(g.commitOpts)},g.zoomSelected=function(){g.$broadcast("plotZoomActive")},g.zoomReset=function(){g.$broadcast("plotZoomReset")},g.$on("arrivalSelected",function(e,t){g.arrivalSelected(t)}),g.$on("plotHover",function(e,t){g.plotTitle=t?t.arrival._sid+" "+t.arrival.phase.code:""}),g.$on("plotSelected",function(e,t){g.arrivalSelected(t.arrival)}),g.$on("plotRectSelected",function(e,t,o,r){for(var i=t.shiftKey,t=t.ctrlKey,n=!i&&!t,a=!t||i,s=g.plotData.length,l=0;l<s;++l)r.isInside(o,l)?(g.plotData[l].arrival._used=a,g.plotData[l].active=a):n&&(g.plotData[l].arrival._used=!1,g.plotData[l].active=!1),g.arrivalChanged(g.plotData[l].arrival,!0,!1);g.$broadcast("updatePlot")}),g.$on("plotDblClicked",function(e,t){g.toggleArrival(t.arrival)}),v.defaults({stayTime:1500}),g.ces=null,g.mapInit=!1,g.progress=0,g.mapAPI={initialized:function(){if(g.corg)for(var e=g.corg.arrival?g.corg.arrival.length:0,t=0;t<e;++t)g.arrivalChanged(g.corg.arrival[t],!1,!0)},eventsAdded:function(){}},g.mapGlobalAPI={eventClicked:function(e){g.$emit("eventSelected",e)},eventMouseOver:function(e){g.$apply(function(){g.hoveredEvent=e.eventID})},eventMouseOut:function(e){g.$apply(function(){g.hoveredEvent=null})}},g.list={days:1,from:new Date(new Date-864e5),to:new Date},g.mapEvents=[],g.events=void 0,g.eventTab="list",g.commitOpts={update:!0,associate:!0,fix:!1,eventType:"",eventTypeCertainty:"",originStatus:"confirmed",name:"",comment:"",eventList:!1},g.config.useUTC?c.setDefaultToUTC():c.setDefaultToLocal(),g.loadInventory(),g.$on("$destroy",function(){g.setOrigin(null)})}]);
"use strict";scolv.controller("PickerCtrl",["$scope","$http","hotkeys","gmNotice","recordstream",function(A,i,e,D,a){var t=e.bindTo(A);t.add({combo:"up",description:"Go to previous trace",callback:function(){A.traceUp()}}).add({combo:"down",description:"Go to next trace",callback:function(){A.traceDown()}}).add({combo:"left",description:"Move zoom trace left",callback:function(){A.traceLeft()}}).add({combo:"right",description:"Move zoom trace right",callback:function(){A.traceRight()}}).add({combo:"ctrl+left",description:"Zoom into current trace",callback:function(){A.traceIn()}}).add({combo:"ctrl+right",description:"Zoom out of current trace",callback:function(){A.traceOut()}}).add({combo:"f",description:"Toggle filter",callback:function(){A.toggleFilter()}}).add({combo:"d",description:"Previous filter",callback:function(){A.previousFilter()}}).add({combo:"g",description:"Next filter",callback:function(){A.nextFilter()}}).add({combo:"z",description:"Show Z (vertical) component",callback:function(){A.activateData(0)}}).add({combo:"n",description:"Show N/1 (first horizontal) component",callback:function(){A.activateData(1)}}).add({combo:"e",description:"Show E/2 (second horizontal) component",callback:function(){A.activateData(2)}}).add({combo:"del",description:"Delete pick with current phase or deactivate arrival hovered with mouse",callback:function(){A.deletePh()}}).add({combo:"ins",description:"Activate arrival for current phase or hovered with mouse (if pick mode is not active)",callback:function(){A.activatePh()}});for(var r=A.config.phases.length,o=0;o<r&&!(8<o);++o)t.add({combo:(o+1).toString(),description:"Pick "+A.config.phases[o]+" phase",callback:function(e){return function(){A.setPickMode(e)}}(A.config.phases[o])});function h(e,t){return!e._used&&t?"x":"manual"===e.pick.evaluationMode?t?"MA":"MP":t?"AA":"AP"}function n(e){e.arrival?e.type=h(e.arrival,e.associated):e.associated?e.type=e.local?"MA":"T":e.type=e.local?"MP":"T"}function s(e,t,i){for(var a=e.length,r=0;r<a;++r){var o=e[r];if(o.annotation===t&&("T"!==o.type&&(!i||o.local===i)))return r}return-1}function c(e,t){for(var i=e.length,a=0;a<i;++a)if(e[a].arrival===t)return a;return-1}function l(e,t){for(var i=e.length,a=0;a<i;++a){var r=e[a];r.annotation===t&&r.associated&&(r.associated=!1,n(r))}}t.add({combo:"esc",description:"Disable picking",callback:function(e){e.preventDefault(),A.setPickMode("")}}),A.markerStyle={AP:{color:"#f00",lineWidth:2},AA:{color:"#800",lineWidth:2},MP:{color:"#0f0",lineWidth:2},MA:{color:"#080",lineWidth:2},T:{color:"#008",lineWidth:1},m:{color:"#080",lineWidth:2},x:{color:"#222",lineWidth:2}},A.options={ruler:{xaxis:{min:0,max:0,ruler:{enable:!0}},grid:{relative:!1}},traces:{interactive:!1,showAllData:!1,xaxis:{referenceTime:null,min:0,max:0,ruler:{enable:!1}},yaxis:{autoScale:!0},grid:{relative:!1},marker:A.markerStyle},tdata:[{color:"#888",optimize:!0},{color:"#668",optimize:!0},{color:"#686",optimize:!0}],ctrace:{interactive:!0,xaxis:{referenceTime:null,min:0,max:0,ruler:{enable:!0}},yaxis:{autoScale:!0},grid:{relative:!1},marker:A.markerStyle},view:{filter:null,showTT:!0}},A.tracesStatus={xaxis:{min:0,max:0}},A.ctraceStatus={xaxis:{min:0,max:0}},A.currentTTable=A.config.ttables[0],A.currentTProfile=A.currentTTable[1][0],A.zoomTrace={clicked:function(e,t,i,a){if(!A.pickMode&&a)if(a.arrival){var r="Phase: <strong>"+a.annotation+"</strong><br/>";try{r+="Method: "+a.arrival.pick.methodID+"<br/>"}catch(e){}try{r+="Author: <strong>"+a.arrival.pick.creationInfo.author+"</strong><br/>"}catch(e){}try{r+="Agency: "+a.arrival.pick.creationInfo.agencyID+"<br/>"}catch(e){}D.info("Arrival",r,5e3)}else"T"===a.type?D.info("Predicted arrival",a.annotation,5e3):D.info("Pick",a.annotation,5e3)},selected:function(e,t,i,a){var r;A.pickMode&&(-1===(r=s(A.ctrace.markers,A.pickMode,!0))?(l(A.ctrace.markers,A.pickMode),A.ctrace.markers.push({x:t,type:"m",annotation:A.pickMode,local:!0,c:i,associated:!0})):((r=A.ctrace.markers[r]).x=t,r.c=i,r.associated||(l(A.ctrace.markers,A.pickMode),r.associated=!0,n(r)),A.ctrace.api.timeSeries.update()),this.timeSeries.update())}},A.setPickMode=function(e){A.pickMode=e,A.zoomTrace.timeSeries.setCursor(A.pickMode)},A.activatePh=function(){var e;if(!A.pickMode){if(!(e=A.zoomTrace.timeSeries.currentMarker))return;var t=!1;return e.associated||(l(A.ctrace.markers,e.annotation),t=e.associated=!0),void((t=e.arrival&&!e.arrival._used?e.arrival._used=!0:t)&&(n(e),A.ctrace.api.timeSeries.update(),A.zoomTrace.timeSeries.update()))}0<=(t=s(A.ctrace.markers,A.pickMode,!0))||0<=(t=s(A.ctrace.markers,A.pickMode,!1))&&(e=A.ctrace.markers[t]).arrival&&!e.arrival._used&&(e.arrival._used=!0,n(e),A.ctrace.api.timeSeries.update(),A.zoomTrace.timeSeries.update())},A.deletePh=function(){var e,t;A.pickMode?0<=(t=s(A.ctrace.markers,A.pickMode,!0))?A.ctrace.markers.splice(t,1):0<=(t=s(A.ctrace.markers,A.pickMode,!1))&&(e=A.ctrace.markers[t]).arrival&&e.arrival._used&&(e.arrival._used=!1,n(e),A.ctrace.api.timeSeries.update(),A.zoomTrace.timeSeries.update()):(e=A.zoomTrace.timeSeries.currentMarker)&&(e.arrival||e.local)&&0<=(t=A.ctrace.markers.indexOf(e))&&(e.local?A.ctrace.markers.splice(t,1):e.associated&&e.arrival._used&&(e.arrival._used=!1,n(e),A.ctrace.api.timeSeries.update(),A.zoomTrace.timeSeries.update()))},A.traceUp=function(){var e;A.ctrace&&((e=A.traces.indexOf(A.ctrace))<=0||A.setCurrentTrace(A.traces[e-1]))},A.traceDown=function(){var e;A.ctrace&&((e=A.traces.indexOf(A.ctrace))<0||e>=A.traces.length-1||A.setCurrentTrace(A.traces[e+1]))},A.traceLeft=function(){var e;A.ctrace&&(e=A.options.ctrace.xaxis.max-A.options.ctrace.xaxis.min,A.options.ctrace.xaxis.min-=.1*e,A.options.ctrace.xaxis.max-=.1*e,A.ctraceStatus.xaxis.min=A.options.ctrace.xaxis.min,A.ctraceStatus.xaxis.max=A.options.ctrace.xaxis.max)},A.traceRight=function(){var e;A.ctrace&&(e=A.options.ctrace.xaxis.max-A.options.ctrace.xaxis.min,A.options.ctrace.xaxis.min+=.1*e,A.options.ctrace.xaxis.max+=.1*e,A.ctraceStatus.xaxis.min=A.options.ctrace.xaxis.min,A.ctraceStatus.xaxis.max=A.options.ctrace.xaxis.max)},A.traceIn=function(){var e;A.ctrace&&(e=A.options.ctrace.xaxis.max-A.options.ctrace.xaxis.min,A.options.ctrace.xaxis.min+=.5*e*.25,A.options.ctrace.xaxis.max-=.5*e*.25,A.ctraceStatus.xaxis.min=A.options.ctrace.xaxis.min,A.ctraceStatus.xaxis.max=A.options.ctrace.xaxis.max)},A.traceOut=function(){var e;A.ctrace&&(e=A.options.ctrace.xaxis.max-A.options.ctrace.xaxis.min,A.options.ctrace.xaxis.min-=.5*e*.25,A.options.ctrace.xaxis.max+=.5*e*.25,A.ctraceStatus.xaxis.min=A.options.ctrace.xaxis.min,A.ctraceStatus.xaxis.max=A.options.ctrace.xaxis.max)},A.hasContextMenu=function(){return A.contextOptions=null,A.contextMarker=null,A.contextMarker=A.zoomTrace.timeSeries.currentMarker,!A.contextMarker||("T"===A.contextMarker.type||(A.contextOptions=[],A.contextMarker.associated?(A.contextOptions.push(["Delete arrival","deleteArrival","Deletes the arrival state and converts the marker to a pick. Picks are not part of the new origin created when accepting the solution."]),A.pickMode&&A.pickMode!==A.contextMarker.annotation&&A.contextOptions.push(["Declare "+A.pickMode+" phase","redeclareArrival","Changes the phase of the arrival. This option is only available if the current pick mode is different than the arrivals phase. Note that an arrivals phase can be different than the phase hint of the pick itself."]),A.contextMarker.arrival&&(A.contextMarker.arrival._used?A.contextOptions.push(["Deactivate arrival","deactivateArrival","Sets the weight of the association to 0. This option is only available for arrival markers."]):A.contextOptions.push(["Activate arrival","activateArrival","Sets the weight of the association to 1. This option is only available for arrival markers."]))):A.pickMode?A.contextOptions.push(["Declare "+A.pickMode+" arrival","createArrival","Binds a pick with the given phase to the solution and creates an arrival. The phase is either the currently active pick mode or the phase of the pick if picking is not active."]):A.contextOptions.push(["Declare "+A.contextMarker.annotation+" arrival","createArrival","Binds a pick with the given phase to the solution and creates an arrival. The phase is either the currently active pick mode or the phase of the pick if picking is not active."]),A.contextMarker.local&&A.contextOptions.push(["Delete pick","deletePick","Deletes the pick from the trace. If the pick is an arrival, the arrival is deleted as well."]),!1))},A.call=function(e){e[1]&&(A.contextMarker?A.hasOwnProperty(e[1])&&A[e[1]](A.ctrace.markers,A.contextMarker):D.error("Internal confusion","No target marker in context menu action"))},A.closeContextMenu=function(){A.contextMarker=null},A.deleteArrival=function(e,t){t.associated&&(t.associated=!1,n(t),A.ctrace.api.timeSeries.update(),A.zoomTrace.timeSeries.update())},A.redeclareArrival=function(e,t){t.associated&&A.pickMode&&(l(e,A.pickMode),t.associated=!0,t.annotation=A.pickMode,t.arrival._used=!0,n(t),A.ctrace.api.timeSeries.update(),A.zoomTrace.timeSeries.update())},A.deactivateArrival=function(e,t){t.associated&&t.arrival&&t.arrival._used&&(t.arrival._used=!1,n(t),A.ctrace.api.timeSeries.update(),A.zoomTrace.timeSeries.update())},A.activateArrival=function(e,t){t.associated&&t.arrival&&(t.arrival._used||(t.arrival._used=!0,n(t),A.ctrace.api.timeSeries.update(),A.zoomTrace.timeSeries.update()))},A.createArrival=function(e,t){t.associated||(A.pickMode&&(t.annotation=A.pickMode),l(e,t.annotation),t.associated=!0,n(t),A.ctrace.api.timeSeries.update(),A.zoomTrace.timeSeries.update())},A.deletePick=function(e,t){t.local&&(e.splice(e.indexOf(t),1),A.ctrace.api.timeSeries.update(),A.zoomTrace.timeSeries.update())},A.toggleFilter=function(){if(0!==A.config.filters.length){if(A.options.view.filter)A.cf=-1;else if(A.cf=0,A.options.view.lastFilter)for(var e=A.config.filters.length,t=0;t<e;++t)if(A.config.filters[t][1]===A.options.view.lastFilter){A.cf=t;break}A.applyFilter(A.cf)}},A.previousFilter=function(){if(0!==A.config.filters.length&&A.options.view.filter){A.cf=0;for(var e=A.config.filters.length,t=0;t<e;++t)if(A.config.filters[t][1]===A.options.view.filter){A.cf=t;break}--A.cf,A.cf<0&&(A.cf=e-1),A.applyFilter(A.cf)}},A.nextFilter=function(){if(0!==A.config.filters.length&&A.options.view.filter){A.cf=0;for(var e=A.config.filters.length,t=0;t<e;++t)if(A.config.filters[t][1]===A.options.view.filter){A.cf=t;break}++A.cf,A.cf>=e&&(A.cf=0),A.applyFilter(A.cf)}},A.activateData=function(e){A.activeComponent=e;for(var t=A.traces.length,i=0;i<t;++i)A.traces[i].setActiveData(e)},A.alignOT=function(){var e,t,i=A.dataWindow/(A.config.traces.postAlignTimeWindow+A.config.traces.preAlignTimeWindow);for(A.options.ruler.xaxis.referenceTime=new Date(A.origin.time.value).getTime(),A.options.ruler.grid.relative=!1,A.options.ruler.xaxis.min=A.options.ruler.xaxis.referenceTime-A.config.traces.preAlignTimeWindow*i,A.options.ruler.xaxis.max=A.options.ruler.xaxis.referenceTime+A.config.traces.postAlignTimeWindow*i,t=A.traces.length,e=0;e<t;++e){var a=A.traces[e];a.options.xaxis.referenceTime=A.options.ruler.xaxis.referenceTime,a.options.grid.relative=!1,a.options.xaxis.min=A.options.ruler.xaxis.min,a.options.xaxis.max=A.options.ruler.xaxis.max}A.tracesStatus.xaxis.min=A.options.ruler.xaxis.min,A.tracesStatus.xaxis.max=A.options.ruler.xaxis.max,A.options.ctrace.xaxis.min=A.tracesStatus.xaxis.min,A.options.ctrace.xaxis.max=A.tracesStatus.xaxis.max,A.ctraceStatus.xaxis.min=A.tracesStatus.xaxis.min,A.ctraceStatus.xaxis.max=A.tracesStatus.xaxis.max},A.alignOnPhase=function(e){var t,i,a=A.dataWindow/(A.config.traces.postAlignTimeWindow+A.config.traces.preAlignTimeWindow);for(A.options.ruler.grid.relative=!0,A.options.ruler.xaxis.min=-A.config.traces.preAlignTimeWindow*a,A.options.ruler.xaxis.max=+A.config.traces.postAlignTimeWindow*a,i=A.traces.length,t=0;t<i;++t){var r=A.traces[t];r.options.grid.relative=!0;for(var o=null,n=null,s=r.markers.length,c=0;c<s;++c){var l=r.markers[c];l.arrival&&!l.arrival._used||function(e){for(var t=e.length-1;0<=t;--t)if(e[t]===e[t].toUpperCase())return e[t];return""}(l.annotation)===e&&("T"!==l.type?(null===o||l.x<o)&&(o=l.x):(null===n||l.x<n)&&(n=l.x))}null!==o?r.options.xaxis.referenceTime=o:null!==n&&(r.options.xaxis.referenceTime=n),null===r.options.xaxis.referenceTime&&(r.options.xaxis.referenceTime=new Date(A.origin.time.value).getTime()),r.options.xaxis.min=A.options.ruler.xaxis.min,r.options.xaxis.max=A.options.ruler.xaxis.max}A.options.traces.grid.relative=!0,A.options.traces.xaxis.min=A.options.ruler.xaxis.min,A.options.traces.xaxis.max=A.options.ruler.xaxis.max,A.tracesStatus.xaxis.min=A.options.ruler.xaxis.min,A.tracesStatus.xaxis.max=A.options.ruler.xaxis.max,A.options.ctrace.xaxis.min=A.options.ruler.xaxis.min+A.ctrace.options.xaxis.referenceTime,A.options.ctrace.xaxis.max=A.options.ruler.xaxis.max+A.ctrace.options.xaxis.referenceTime,A.ctraceStatus.xaxis.min=A.options.ctrace.xaxis.min,A.ctraceStatus.xaxis.max=A.options.ctrace.xaxis.max},A.applyFilter=function(e){var t,i=parseInt(e);if(!isNaN(i))if(i<0)for(A.options.view.filter=null,t=A.traces.length,i=0;i<t;++i)A.traces[i].showFiltered(!1);else{A.options.view.filter=A.config.filters[i][1];var a,r=A.options.view.filter!==A.options.view.lastFilter;try{var o=G.Filter.build(A.options.view.filter)}catch(e){return void D.error("Filter",e)}for(t=A.traces?A.traces.length:0,i=0;i<t;++i)r&&(a=o.clone(),A.traces[i].setFilter(a)),A.traces[i].showFiltered(!0);A.options.view.lastFilter=A.options.view.filter}},A.applyTT=function(){A.currentTProfile=A.currentTTable[1][0],A.ttt.type=A.currentTTable[0],A.currentTProfile?A.ttt.model=A.currentTProfile:delete A.ttt.model,A.removeTravelTimes(),A.loadTravelTimes(A.ttt,function(e){A.addTravelTimes(e)})},A.applyTP=function(){A.currentTProfile?A.ttt.model=A.currentTProfile:delete A.ttt.model,A.removeTravelTimes(),A.loadTravelTimes(A.ttt,function(e){A.addTravelTimes(e)})},A.removeTravelTimes=function(){for(var e=A.traces.length,t=0;t<e;++t)for(var i=A.traces[t],a=i.markers.length||0,r=0;r<a;)"T"===i.markers[r].type?(i.markers.splice(r,1),--a):++r},A.addTravelTimes=function(e){if(e)for(var t=new Date(A.origin.time.value).getTime(),i=e.length,a=0;a<i;++a){var r=e[a];if(A.traceMap.hasOwnProperty(r.id)){var o=A.traceMap[r.id];try{for(var n=r.phases.length||0;n;--n){var s=r.phases[n-1];A.config.phases.indexOf(s.ph)<0||o.markers.unshift({x:t+1e3*s.t,annotation:s.ph,type:"T",align:2})}}catch(e){}}}},A.loadTravelTimes=function(e,t){i.post(A.config.serverAPI+"query/traveltimes.json",JSON.stringify(e)).then(function(e){t&&t(e.data.ttt)}).catch(function(e){e.status?401===e.status?D.error("Travel times","You are not logged in"):D.error("Travel times",e.data):D.error("Travel times","Server connection error")})},A.$watch("options.view.showTT",function(){A.markerStyle.T.lineWidth=A.options.view.showTT?1:0}),A.loadWaveforms=function(){if(A.origin){var e,t;A.cancelDataRequests(),t=A.origin.arrival?A.origin.arrival.length:0,A.traces=[],A.traceMap={},A.stationMap={};var i=[];A.ttt={type:A.currentTTable[0],model:A.currentTProfile||void 0,source:{lat:A.origin.latitude.value,lon:A.origin.longitude.value},targets:[]},A.origin.depth&&A.origin.depth.value&&(A.ttt.source.depth=A.origin.depth.value);var a=(a=A.options.view.filter)||A.options.view.lastFilter;try{var r=G.Filter.build(a)}catch(e){r=null}for(e=0;e<t;++e){var o,n=A.origin.arrival[e],s=n._sid.slice(0,-1),c=new Date(n.pick.time.value).getTime();if(A.traceMap.hasOwnProperty(s))o=A.traceMap[s];else{var l=c,f=[];for(v=0;v<3;++v)f[v]=new G.RecordBuffer(1e3*(A.config.traces.preOnsetTimeWindow+2*A.config.traces.postOnsetTimeWindow),!0),r&&f[v].setFilter(r.clone());var d,u=[l-1e3*A.config.traces.preOnsetTimeWindow,l+1e3*A.config.traces.postOnsetTimeWindow],l=A.inventory.findSensorLocation(n._net,n._sta,n._loc,c),p={},x=[];if(l){A.ttt.targets.push({id:s,lat:l.latitude,lon:l.longitude,elev:l.elevation||0});for(var m=A.inventory.getThreeComponents(l,n._cha.slice(0,-1),c),v=0;v<3;++v)m[v]&&(x[v]=m[v].code[m[v].code.length-1],p[x[v]]=v)}else D.warning("Inventory","SensorLocation "+n._net+"."+n._sta+"."+(n._loc||"--")+" not found in inventory, cannot map trace components.",5e3);for(d in(o={sid:s,asid:s,net:n._net,sta:n._sta,loc:n._loc,cha:n._cha.slice(0,-1),dist:n.distance,distKM:G.Geo.deg2km(n.distance),azi:n.azimuth,c3:p,ccodes:x,buffers:f,data:[{records:A.options.view.filter?f[0].filtered:f[0].raw,options:A.options.tdata[0],id:x[0]},{records:A.options.view.filter?f[1].filtered:f[1].raw,options:A.options.tdata[1],id:x[1]},{records:A.options.view.filter?f[2].filtered:f[2].raw,options:A.options.tdata[2],id:x[2]}],markers:[],isVisible:function(){return 0<this.data[0].records.length},tw:u,options:angular.copy(A.options.traces),api:{},clear:function(){for(var e=0;e<3;++e)this.buffers[e].clear();this.data.length=0,this.buffers.length=0},feed:function(e){var t=this.c3[e.sid[e.sid.length-1]];void 0!==t&&this.buffers[t].feed(e)},setFilter:function(e){for(var t=0;t<3;++t)this.buffers[t].setFilter(e)},showFiltered:function(e){for(var t=0;t<3;++t)this.data[t].records=e?this.buffers[t].filtered:this.buffers[t].raw},setActiveData:function(e){this.asid=this.sid;for(var t=0;t<3;++t)t===e?(this.data[t].active=!0,this.asid=this.sid+(this.ccodes[t]||"")):this.data[t].active=!1}}).options.marker=A.markerStyle,A.traces.push(o),A.traceMap[s]=o,A.stationMap[o.net+"."+o.sta]=!0,p)i.push([s+d,new Date(u[0]),new Date(u[1])])}l=h(n,!0),o.markers.push({x:c,annotation:n.phase.code,type:l,arrival:n,associated:!0})}A.loadTravelTimes(A.ttt,function(e){A.addTravelTimes(e),A.alignOT()}),A.traces.sort(function(e,t){return e.dist-t.dist}),A.alignOT(),A.activateData(0),A.options.ctrace.xaxis.referenceTime=A.options.ruler.xaxis.referenceTime,A.traces.length&&(A.ctrace=A.traces[0]),A.requestData(i)}else D.error("Picker","No origin loaded")},A.setCurrentTrace=function(e){var t,i;A.ctrace&&(A.ctrace.options.xaxis.smin=A.ctrace.options.xaxis.smax=null,A.ctrace.options.grid.relative&&e&&(t=A.ctraceStatus.xaxis.min,i=A.ctraceStatus.xaxis.max,t-=A.ctrace.options.xaxis.referenceTime,i-=A.ctrace.options.xaxis.referenceTime,t+=e.options.xaxis.referenceTime,i+=e.options.xaxis.referenceTime,A.ctraceStatus.xaxis.min=t,A.ctraceStatus.xaxis.max=i)),A.ctrace=e,A.options.ctrace.showAllData=A.ctrace.dist<10,A.ctrace.options.xaxis.smin=A.ctraceStatus.xaxis.min,A.ctrace.options.xaxis.smax=A.ctraceStatus.xaxis.max},A.loadStationsInRange=function(){if(!A.stationRange||A.stationRange<0)D.error("Add stations","Invalid distance");else{var e=G.Geo.km2deg(A.stationRange),t=A.inventory.data();if(t){if(t.network){for(var i=!1,a=[],r=[],o=t.network.length,n=0;n<o;++n){var s=t.network[n];if(A.inventory.matchEpoch(s,A.origin.time.value))for(var c=s.station.length,l=0;l<c;++l){var f=s.station[l];if(A.inventory.matchEpoch(f,A.origin.time.value)&&!A.stationMap.hasOwnProperty(s.code+"."+f.code)){var d=G.Geo.delazi(f.latitude,f.longitude,A.origin.latitude.value,A.origin.longitude.value),u=d.dist;if(!(e<u)){var p=A.bindings.getParams(s.code,f.code);if(p&&p.detecStream){var x=A.inventory.findSensorLocation("",f,p.detecLocid||"",p.detecStream);if(x){var m=A.inventory.getThreeComponents(x,p.detecStream,A.origin.time.value);if(m[0]){var v=(s.code+"."+f.code+"."+x.code+"."+m[0].code).slice(0,-1),h={},g=[];a.push({id:v,lat:x.latitude,lon:x.longitude,elev:x.elevation||0});for(var k=0;k<3;++k)m[k]&&(g[k]=m[k].code[m[k].code.length-1],h[g[k]]=k);var T=[],p=(p=A.options.view.filter)||A.options.view.lastFilter;try{var w=G.Filter.build(p)}catch(e){w=null}for(k=0;k<3;++k)T[k]=new G.RecordBuffer(1e3*(A.config.traces.preOnsetTimeWindow+2*A.config.traces.postOnsetTimeWindow),!0),w&&T[k].setFilter(w.clone());var S,p=new Date(A.origin.time.value).getTime()+G.Geo.deg2km(u)/.008,b=[p-1e3*A.config.traces.preOnsetTimeWindow,p+1e3*A.config.traces.postOnsetTimeWindow],d={sid:v,asid:v,net:s.code,sta:f.code,loc:x.code,cha:m[0].code.slice(0,-1),dist:u,distKM:G.Geo.deg2km(u),azi:d.az,c3:h,ccodes:g,buffers:T,data:[{records:A.options.view.filter?T[0].filtered:T[0].raw,options:A.options.tdata[0],id:g[0]},{records:A.options.view.filter?T[1].filtered:T[1].raw,options:A.options.tdata[1],id:g[1]},{records:A.options.view.filter?T[2].filtered:T[2].raw,options:A.options.tdata[2],id:g[2]}],markers:[],isVisible:function(){return 0<this.data[0].records.length},tw:b,options:angular.copy(A.options.traces),api:{},clear:function(){for(var e=0;e<3;++e)this.buffers[e].clear();this.data.length=0,this.buffers.length=0},feed:function(e){var t=this.c3[e.sid[e.sid.length-1]];void 0!==t&&this.buffers[t].feed(e)},setFilter:function(e){for(var t=0;t<3;++t)this.buffers[t].setFilter(e)},showFiltered:function(e){for(var t=0;t<3;++t)this.data[t].records=e?this.buffers[t].filtered:this.buffers[t].raw},setActiveData:function(e){this.asid=this.sid;for(var t=0;t<3;++t)t===e?(this.data[t].active=!0,this.asid=this.sid+(this.ccodes[t]||"")):this.data[t].active=!1}};for(S in d.options.marker=A.markerStyle,d.setActiveData(A.activeComponent),A.traces.push(d),A.traceMap[v]=d,A.stationMap[d.net+"."+d.sta]=!0,h)r.push([v+S,new Date(b[0]),new Date(b[1])]);i=!0}}}}}}}if(i){A.alignOT(),A.traces.sort(function(e,t){return e.dist-t.dist});var P=A.ttt.targets;A.ttt.targets=a,A.loadTravelTimes(A.ttt,function(e){A.addTravelTimes(e),A.alignOT()}),A.ttt.targets=P;for(var M=a.length,y=0;y<M;++y)A.ttt.targets.push(a[y]);A.requestData(r)}}}else D.error("Add stations","No inventory available")}},A.requestData=function(e){var t;e.length&&((t=a.run(A.config.serverAPI,A.config.serverWSAPI,e,{forceHTTP:A.config.forceHTTP})).promise.then(function(e){D.info("Acquisition",e),A.dataFinished(t)},function(e){D.error("Acquisition",e),A.dataFinished(t)},function(e,t){for(var i=e.length,a=0;a<i;++a){var r=e[a],o=r.sid.slice(0,-1);o in A.traceMap&&A.traceMap[o].feed(r)}}),A.rs.push(t))},A.cancelDataRequests=function(){for(var e in A.rs)A.rs[e].cancel();A.rs.length=0},A.dataFinished=function(e){e=A.rs.indexOf(e);0<=e&&A.rs.splice(e,1)},A.apply=function(){if(A.traces){for(var e=[],t=A.traces.length,i=0;i<t;++i){for(var a=A.traces[i],r=a.markers.length,o={},n=0;n<r;++n){var s,c=a.markers[n];(c.arrival||c.local)&&c.associated&&(o[c.annotation]&&!c.local||(s={phase:c.annotation},c.arrival?s.arrival=c.arrival:(s.time=c.x,s.dist=a.dist,s.azi=a.azi,s.wid=[a.net,a.sta,a.loc,a.cha+a.ccodes[c.c]],c=function(e,t,i){for(var a=t.length,r=0;r<a;++r){var o=t[r];if("T"===o.type){if(o.annotation===e)return o;if(e[0]===o.annotation[0])if("P"===e){if(i<120){if("Pn"===o.annotation)return o;if("Pb"===o.annotation)return o;if("Pg"===o.annotation)return o;if("Pdiff"===o.annotation)return o}else if("PKP"===o.annotation.substring(0,3))return o}else if("pP"===e){if(i<120){if("pPn"===o.annotation)return o;if("pPb"===o.annotation)return o;if("pPg"===o.annotation)return o;if("pPdiff"===o.annotation)return o}else if("pPKP"===o.annotation.substring(0,4))return o}else if("PKP"===e){if(100<i){if("PKPab"===o.annotation)return o;if("PKPbc"===o.annotation)return o;if("PKPdf"===o.annotation)return o}}else if("PKKP"===e){if(100<i&&i<130){if("PKKPab"===o.annotation)return o;if("PKKPbc"===o.annotation)return o;if("PKKPdf"===o.annotation)return o}}else if("SKP"===e){if(115<i&&i<145){if("SKPab"===o.annotation)return o;if("SKPbc"===o.annotation)return o;if("SKPdf"===o.annotation)return o}}else if("PP"===e){if("PnPn"===o.annotation)return o}else if("sP"===e){if(i<120){if("sPn"===o.annotation)return o;if("sPb"===o.annotation)return o;if("sPg"===o.annotation)return o;if("sPdiff"===o.annotation)return o}else if("sPKP"===o.annotation.substring(0,4))return o}else if("S"===e){if("Sn"===o.annotation)return o;if("Sb"===o.annotation)return o;if("Sg"===o.annotation)return o;if("S"===o.annotation)return o;if("Sdiff"===o.annotation)return o;if("SKS"===o.annotation.substring(0,3))return o}}}}(s.phase,a.markers,s.dist),s.res=c?.001*(s.time-c.x):0),o[s.phase]=s))}for(r in o)e.push(o[r])}A.$emit("newArrivals",A.origin,e)}},A.$watch("tracesStatus",function(e,t){var i,a;if(A.tracesStatus.xaxis&&A.traces)for(A.dataWindow=A.tracesStatus.xaxis.max-A.tracesStatus.xaxis.min,a=A.traces.length,i=0;i<a;++i){var r=A.traces[i];r.options.xaxis.min=A.tracesStatus.xaxis.min,r.options.xaxis.max=A.tracesStatus.xaxis.max}},!0),A.$watch("ctraceStatus",function(e,t){A.ctraceStatus.xaxis&&A.ctrace&&(A.ctrace.options.xaxis.smin=A.ctraceStatus.xaxis.min,A.ctrace.options.xaxis.smax=A.ctraceStatus.xaxis.max)},!0),A.$watch("origin",function(){A.loadWaveforms()}),A.$on("selectArrival",function(e,t){if(A.traces)for(var i=A.traces.length,a=0;a<i;++a){var r=A.traces[a];if(!(c(r.markers,t)<0)){A.setCurrentTrace(r);break}}}),A.$on("arrivalChanged",function(e,t){if(A.traces)for(var i=A.traces.length,a=0;a<i;++a){var r=A.traces[a],o=c(r.markers,t);if(!(o<0)){n(r.markers[o]),r.api.timeSeries.update(),r===A.ctrace&&A.zoomTrace.timeSeries.update();break}}}),A.$on("$destroy",function(){if(A.cancelDataRequests(),A.traces){for(var e=A.traces.length,t=0;t<e;++t)A.traces[t].clear();A.traces.length=0}A.ctrace=null,A.traceMap=null,A.stationMap=null}),A.defaultFilter=function(){for(var e=A.config.filters.length,t=0;t<e;++t){var i=A.config.filters[t];if(2<i.length&&i[2])return A.applyFilter(t),t}return-1},A.dataWindow=1e3*(A.config.traces.postAlignTimeWindow+A.config.traces.preAlignTimeWindow),A.stationRange=Math.floor(G.Geo.deg2km(10)),A.rs=[]}]);
"use strict";!function(){function t(n,e){function r(e,t){for(var n=t.split(".");n.length&&(e=e[n.shift()]););return e}return e?function(e,t){return e=r(e,n),t=r(t,n),void 0===e&&void 0===t?0:void 0===e?1:void 0===t?-1:e<t?1:t<e?-1:0}:function(e,t){return e=r(e,n),t=r(t,n),void 0===e&&void 0===t?0:void 0===e?-1:void 0===t||t<e?1:e<t?-1:0}}scolv.controller("EvtTableCtrl",["$scope",function(s){s.itemsPerPage=-1,s.value=function(e){return e[s.col]},s.updateItems=function(){if(s.tableItems=[],s.$parent.events){for(var e in s.$parent.events.pool)s.$parent.events.pool.hasOwnProperty(e)&&(e=s.$parent.events.pool[e],"hide_x"===s.filter&&"X"===e.status||"show_x"===s.filter&&"X"!==e.status||"hide_o"===s.filter&&s.$parent.config.otherEventTypes.hasOwnProperty(e.type)||"show_o"===s.filter&&!s.$parent.config.otherEventTypes.hasOwnProperty(e.type)||s.tableItems.push(e));s.tableItems.sort(t(s.col,s.reverse)),0<s.itemsPerPage&&(s.tableItems=s.tableItems.slice(s.page*s.itemsPerPage,(s.page+1)*s.itemsPerPage))}},s.set=function(e){e===s.col?s.reverse=!s.reverse:(s.reverse=!1,s.col=e),s.page=0,s.updateItems()},s.select=function(e){s.$emit("eventSelected",e)},s.start=function(){s.page=0,s.updateItems()},s.prev=function(){0<s.page&&(--s.page,s.updateItems())},s.next=function(e,t){var n,r=0;for(n in e)++r;t=((r+t-1)/t).toFixed(0);s.page<t-1&&(++s.page,s.updateItems())},s.end=function(e,t){var n,r=0;for(n in e)++r;s.page=((r+t-1)/t).toFixed(0)-1,s.updateItems()},s.download=function(e){var t,n,r,s=[];for(t in e)e.hasOwnProperty(t)&&(n=e[t],(r=[]).push(n.eventID),r.push(n.lat||""),r.push(n.lon||""),r.push(n.depth||""),r.push(n.mag||""),r.push(n.agency||""),r.push(n.status||""),r.push(n.phaseCount||""),r.push(n.region||""),s.push(r.join(";")));var a=s.join("\n"),a="data:application/csv;filename=events.csv;charset=UTF-8,"+encodeURIComponent(a);window.location.assign(a)},s.$watch("$parent.events._revision",function(){s.page=0,s.updateItems()}),s.$watch("$parent.list.filter",function(){s.filter=s.$parent.list.filter,s.page=0,s.updateItems()}),s.filter="all",s.reverse=!0,s.col="otime",s.page=0,s.updateItems()}]).controller("ArrTableCtrl",["$scope",function(a){a.value=function(e){return e[a.col]},a.updateItems=function(){try{a.tableItems=a.$parent.corg.arrival}catch(e){a.tableItems=[]}a.tableItems.sort(t(a.col,a.reverse))},a.set=function(e){e===a.col?a.reverse=!a.reverse:(a.reverse=!1,a.col=e),a.updateItems()},a.deselect=function(){for(var e=a.tableItems.length,t=0;t<e;++t)a.tableItems[t]._selected=!1},a.select=function(e,t){var n,r;if(t.ctrlKey)e._selected=!e._selected;else{if(t.shiftKey){var t=a.tableItems.indexOf(a._cItem),s=a.tableItems.indexOf(e);for((s=s<0?0:s)<(t=t<0?0:t)&&(n=t,t=s,s=n),n=t;n<=s;++n)a.tableItems[n]._selected=!0}else{for(r=a.tableItems.length,n=0;n<r;++n)a.tableItems[n]._selected=!1;a.$emit("arrivalSelected",e)}e._selected=!0}a._cItem=e},a.$watch("$parent.corg.arrival",function(){a._cItem=void 0,a.updateItems()}),a.reverse=!1,a.col="distance",a.updateItems()}])}();
